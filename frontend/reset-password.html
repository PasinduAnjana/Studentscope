<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Reset Password - StudentScope</title>
    <link rel="stylesheet" href="/css/login.css" />
    <link rel="stylesheet" href="/css/style.css" />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css"
    />
  </head>
  <body>
    <div class="login-wrapper">
      <!-- Top-right Controls -->
      <div class="login-controls">
        <div class="language-wrapper">
          <div id="language-btn" class="flex" style="gap: 8px; cursor: pointer">
            <span>English</span>
            <i class="language-icon">▼</i>
          </div>
          <div id="language-dropdown" class="dropdown-menu">
            <button class="dropdown-item" data-lang="en">English</button>
            <button class="dropdown-item" data-lang="si">සිංහල</button>
            <button class="dropdown-item" data-lang="ta">தமிழ்</button>
          </div>
        </div>

        <div
          class="darkmode-wrapper flex"
          style="gap: 8px; align-items: center"
        >
          <label class="switch">
            <input type="checkbox" id="darkmode-toggle" />
            <span class="slider round"></span>
          </label>
          <i class="fas fa-moon darkmode-icon"></i>
        </div>
      </div>

      <!-- Reset Password Box -->
      <div class="login-box">
        <!-- Left side: Illustration -->
        <div class="login-illustration">
          <div class="logo">
            <i class="fas fa-key"></i>
            <h2>Reset Password</h2>
          </div>
          <img src="/assets/images/login.svg" alt="Reset Illustration" />
        </div>

        <!-- Right side: Form -->
        <div class="login-form">
          <h1
            data-en="Reset Password"
            data-si="මුරපදය යළි පිහිටුවන්න"
            data-ta="கடவுச்சொல்லை மீட்டமைக்கவும்"
          >
            Reset Password
          </h1>
          <p
            class="subtitle"
            data-en="Enter your username and select your role to reset your password"
            data-si="ඔබේ පරිශීලක නාමය ඇතුළු කරන්න සහ ඔබේ මුරපදය යළි පිහිටුවීමට ඔබේ භූමිකාව තෝරන්න"
            data-ta="உங்கள் பயனர் பெயரை உள்ளிடவும் மற்றும் உங்கள் கடவுச்சொல்லை மீட்டமைக்க உங்கள் பாத்திரத்தைத் தேர்வுசெய்யவும்"
          ></p>

          <!-- Step 1: Select Role and Enter Username -->
          <div id="step1">
            <form id="resetForm1">
              <div style="margin-bottom: 15px">
                <label
                  data-en="Username:"
                  data-si="පරිශීලක නාමය:"
                  data-ta="பயனர் பெயர்:"
                  >Username:</label
                >
                <input
                  type="text"
                  id="username"
                  placeholder="Enter your username"
                  required
                />
              </div>

              <div style="margin-bottom: 15px">
                <label data-en="Role:" data-si="භූමිකාව:" data-ta="பாத்திரம்:"
                  >Role:</label
                >
                <select
                  id="role"
                  required
                  style="
                    padding: 10px;
                    border: 1px solid #ccc;
                    border-radius: 4px;
                    width: 100%;
                  "
                >
                  <option value="">Select your role</option>
                  <option
                    value="student"
                    data-en="Student"
                    data-si="ශිෂ්‍ය"
                    data-ta="மாணவர்"
                  >
                    Student
                  </option>
                  <option
                    value="teacher"
                    data-en="Teacher"
                    data-si="ගුරුවරයා"
                    data-ta="ஆசிரியர்"
                  >
                    Teacher
                  </option>
                  <option
                    value="clerk"
                    data-en="Clerk"
                    data-si="ලේකම්"
                    data-ta="குமாஸ்தா"
                  >
                    Clerk
                  </option>
                  <option
                    value="admin"
                    data-en="Admin"
                    data-si="පරිපාලක"
                    data-ta="நிர்வாகி"
                  >
                    Admin
                  </option>
                </select>
              </div>

              <button
                type="submit"
                class="btn"
                data-en="Next"
                data-si="ඉදිරිපත්"
                data-ta="அடுத்து"
              >
                Next
              </button>
              <p class="text-error" id="error1"></p>
            </form>
            <p style="margin-top: 15px; text-align: center">
              <a
                href="/login.html"
                style="color: #007bff; text-decoration: none; cursor: pointer"
              >
                <span
                  data-en="Back to Login"
                  data-si="ලොගින් වෙත ආපසු"
                  data-ta="உள்நுழைவுக்கு திரும்பவும்"
                  >Back to Login</span
                >
              </a>
            </p>
          </div>

          <!-- Step 2: Enter New Password (All roles) -->
          <div id="step2" style="display: none">
            <form id="resetForm2">
              <div style="margin-bottom: 15px">
                <label
                  data-en="New Password:"
                  data-si="නව මුරපදය:"
                  data-ta="புதிய கடவுச்சொல்:"
                  >New Password:</label
                >
                <input
                  type="password"
                  id="newPassword"
                  placeholder="Enter new password"
                  required
                />
              </div>

              <div style="margin-bottom: 15px">
                <label
                  data-en="Confirm Password:"
                  data-si="මුරපදය තහවුරු කරන්න:"
                  data-ta="கடவுச்சொல்லை உறுதிப்படுத்தவும்:"
                  >Confirm Password:</label
                >
                <input
                  type="password"
                  id="confirmPassword"
                  placeholder="Confirm password"
                  required
                />
              </div>

              <button
                type="submit"
                class="btn"
                data-en="Submit Request"
                data-si="ඉල්ලීම යොමු කරන්න"
                data-ta="கோரிக்கை சமர্పிக்கவும்"
              >
                Submit Request
              </button>
              <button
                type="button"
                class="btn"
                style="background-color: #6c757d; margin-top: 10px"
                onclick="goBackStep1()"
                data-en="Back"
                data-si="ආපසු"
                data-ta="திரும்பவும்"
              >
                Back
              </button>
              <p class="text-error" id="error2"></p>
            </form>
          </div>

          <!-- Step 3: Success Message -->
          <div id="step3" style="display: none; text-align: center">
            <i
              class="fas fa-check-circle"
              style="font-size: 48px; color: #28a745; margin-bottom: 15px"
            ></i>
            <h2
              data-en="Request Submitted!"
              data-si="ඉල්ලීම යොමු කරන්න!"
              data-ta="கோரிக்கை சமர்பிக்கப்பட்டது!"
            >
              Request Submitted!
            </h2>
            <p
              id="successMessage"
              data-en="Your password reset request has been submitted. An administrator will review and approve your request soon."
              data-si="ඔබේ මුරපදය යළි පිහිටුවීමේ ඉල්ලීම යොමු කරන ලද හැකි ය. පරිපාලක ඉතා ඉක්මනින් ඔබේ ඉල්ලීම සමාලෝචනය සහ අනුමත කරනු ඇත."
              data-ta="உங்கள் கடவுச்சொல் மீட்டமைப்பு கோரிக்கை சமர్పிக்கப்பட்டுள்ளது. ஒரு நிர்வாகி விரைவில் உங்கள் கோரிக்கையை ம审查ு செய்து அனுமதிப்பார்."
            ></p>
            <a
              href="/login.html"
              class="btn"
              style="
                margin-top: 15px;
                text-decoration: none;
                display: inline-block;
              "
              data-en="Back to Login"
              data-si="ලොගින් වෙත ආපසු"
              data-ta="உள்நுழைவுக்கு திரும்பவும்"
              >Back to Login</a
            >
          </div>
        </div>
      </div>
    </div>

    <script src="/js/language.js"></script>
    <script src="/js/topbar.js"></script>
    <script>
      // Initialize language & dark mode
      document.addEventListener("DOMContentLoaded", () => {
        setupLanguageDropdown();
        setupDarkModeToggle();
        const savedLang = localStorage.getItem("lang") || "en";
        if (typeof updateLanguage === "function") {
          updateLanguage(savedLang);
        }
      });

      function showToast(message, icon) {
        if (typeof toast === "function") {
          toast(message, icon);
        } else {
          alert(message);
        }
      }

      function goBackStep1() {
        document.getElementById("step1").style.display = "block";
        document.getElementById("step2").style.display = "none";
        document.getElementById("error2").textContent = "";
      }

      // Step 1: Handle role selection and username entry
      document
        .getElementById("resetForm1")
        .addEventListener("submit", async (e) => {
          e.preventDefault();

          const username = document.getElementById("username").value.trim();
          const role = document.getElementById("role").value;
          const error1 = document.getElementById("error1");

          if (!username || !role) {
            error1.textContent = "Username and role are required";
            return;
          }

          try {
            // Verify user exists
            const response = await fetch("/api/auth/verify-user", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ username, role }),
            });

            if (!response.ok) {
              error1.textContent = "User not found with this role";
              return;
            }

            // All roles enter new password and proceed to Step 2
            document.getElementById("step1").style.display = "none";
            document.getElementById("step2").style.display = "block";
            document.getElementById("step2").dataset.role = role;

            // Store username for Step 2
            localStorage.setItem("resetUsername", username);
            localStorage.setItem("resetRole", role);
          } catch (error) {
            console.error("Error:", error);
            error1.textContent = "An error occurred. Please try again.";
          }
        });

      // Step 2: Handle new password submission (All roles)
      document
        .getElementById("resetForm2")
        .addEventListener("submit", async (e) => {
          e.preventDefault();

          const username = localStorage.getItem("resetUsername");
          const role = localStorage.getItem("resetRole");
          const newPassword = document.getElementById("newPassword").value;
          const confirmPassword =
            document.getElementById("confirmPassword").value;
          const error2 = document.getElementById("error2");

          if (newPassword !== confirmPassword) {
            error2.textContent = "Passwords do not match";
            return;
          }

          if (newPassword.length < 6) {
            error2.textContent = "Password must be at least 6 characters";
            return;
          }

          try {
            const response = await fetch("/api/auth/request-password-reset", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({
                username,
                role,
                newPassword,
              }),
            });

            if (!response.ok) {
              error2.textContent = "Failed to submit reset request";
              return;
            }

            document.getElementById("step1").style.display = "none";
            document.getElementById("step2").style.display = "none";
            document.getElementById("step3").style.display = "block";

            // Update success message based on role
            const successMsg = document.getElementById("successMessage");
            if (role === "student") {
              successMsg.textContent =
                "Your password reset request has been submitted. A teacher will review and approve your request soon.";
            } else if (role === "teacher") {
              successMsg.textContent =
                "Your password reset request has been submitted. An administrator will review and approve your request soon.";
            } else if (role === "clerk") {
              successMsg.textContent =
                "Your password reset request has been submitted. An administrator will review and approve your request soon.";
            } else if (role === "admin") {
              successMsg.textContent =
                "Your password reset request has been submitted. Another administrator will review and approve your request soon.";
            }

            localStorage.removeItem("resetUsername");
            localStorage.removeItem("resetRole");
          } catch (error) {
            console.error("Error:", error);
            error2.textContent = "An error occurred. Please try again.";
          }
        });
    </script>
  </body>
</html>

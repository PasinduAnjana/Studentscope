<h2 class="heading">
  <i class="fas fa-user-shield"></i>
  <span
    data-en="Student Behavior Reports"
    data-si="à·à·’à·‚à·Šâ€à¶º à·„à·à·ƒà·’à¶»à·“à¶¸à·Š à·€à·à¶»à·Šà¶­à·"
    data-ta="à®®à®¾à®£à®µà®°à¯ à®¨à®Ÿà®¤à¯à®¤à¯ˆ à®…à®±à®¿à®•à¯à®•à¯ˆà®•à®³à¯"
  >
    Student Behavior Repo</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script></h2>

<div style="display: flex; flex-direction: column; gap: 24px">
  <!-- ðŸ“Š Summary Tiles -->
  <div class="summary-tiles">
    <div class="card dashboard-tile summary-card">
      <div class="icon-title">
        <i class="fas fa-users icon"></i>
        <p
          data-en="Total Students"
          data-si="à¶¸à·”à·…à·” à·ƒà·’à·ƒà·”à¶±à·Š"
          data-ta="à®®à¯Šà®¤à¯à®¤ à®®à®¾à®£à®µà®°à¯à®•à®³à¯"
        >
          Total Students
        </p>
      </div>
      <p class="tile-value" id="totalStudents">120</p>
    </div>
    <div class="card dashboard-tile summary-card">
      <div class="icon-title">
        <i class="fas fa-user-check icon"></i>
        <p data-en="Good Behavior" data-si="à·„à·œà¶³ à·„à·à·ƒà·’à¶»à·“à¶¸" data-ta="à®¨à®²à¯à®² à®¨à®Ÿà®¤à¯à®¤à¯ˆ">
          Good Behavior
        </p>
      </div>
      <p class="tile-value" id="goodBehavior">98</p>
    </div>
    <div class="card dashboard-tile summary-card">
      <div class="icon-title">
        <i class="fas fa-exclamation-triangle icon"></i>
        <p
          data-en="Disciplinary Cases"
          data-si="à·€à·’à¶±à¶º à¶šà·Šâ€à¶»à·’à¶ºà·"
          data-ta="à®’à®´à¯à®™à¯à®•à¯ à®¨à®Ÿà®µà®Ÿà®¿à®•à¯à®•à¯ˆà®•à®³à¯"
        >
          Disciplinary Cases
        </p>
      </div>
      <p class="tile-value" id="disciplinaryCases">17</p>
    </div>
    <div class="card dashboard-tile summary-card">
      <div class="icon-title">
        <i class="fas fa-award icon"></i>
        <p
          data-en="Rewards/ Appreciations"
          data-si="à¶´à·Šâ€à¶»à·à¶‚à·ƒà·/ à¶­à·Šâ€à¶ºà·à¶œ"
          data-ta="à®µà®¾à®´à¯à®¤à¯à®¤à¯à®•à¯à®•à®³à¯/ à®ªà®°à®¿à®šà¯à®•à®³à¯"
        >
          Rewards
        </p>
      </div>
      <p class="tile-value" id="rewards">5</p>
    </div>
  </div>


  <!-- ðŸ“‹ Behavior Records -->
  <div class="card dashboard-tile">
    <div class="icon-title">
      <i class="fas fa-table icon"></i>
      <p
        data-en="Behavior Records"
        data-si="à·„à·à·ƒà·’à¶»à·“à¶¸à·Š à·€à·à¶»à·Šà¶­à·"
        data-ta="à®¨à®Ÿà®¤à¯à®¤à¯ˆ à®ªà®¤à®¿à®µà¯à®•à®³à¯"
      >
        Behavior Records
      </p>
    </div>
    <div class="filter-group">
      <div>
        <select
          id="classFilter"
          class="dropdown-select"
          onchange="filterBehavior()"
        >
          <option value="all" data-en="All Classes">All Classes</option>
          <option value="10A">Grade 10-A</option>
          <option value="10B">Grade 10-B</option>
          <option value="11A">Grade 11-A</option>
        </select>
      </div>
      <div>
        <select
          id="typeFilter"
          class="dropdown-select"
          onchange="filterBehavior()"
        >
          <option value="all" data-en="All Behaviours">All Behaviours</option>
          <option value="Good">Good</option>
          <option value="Disciplinary">Disciplinary</option>
          <option value="Reward">Reward</option>
        </select>
      </div>
      <div class="export-buttons">
        <button class="btn btn-primary" onclick="exportPDF()">
          <i class="fas fa-file-pdf"></i> PDF
        </button>
        <button class="btn btn-primary" onclick="exportCSV()">
          <i class="fas fa-file-excel"></i> Excel
        </button>
      </div>
    </div>
    <div class="table-container">
      <table id="behaviorTable">
        <thead>
          <tr>
            <th>Class</th>
            <th>Student</th>
            <th>Date</th>
            <th>Type</th>
            <th>Severity</th>
            <th>Description</th>
            <th>Reported By</th>
          </tr>
        </thead>
        <tbody id="behaviorBody">
          <tr>
            <td>10A</td>
            <td>Hansa Nirmal</td>
            <td>2025-09-15</td>
            <td>Good</td>
            <td>-</td>
            <td>Helped organize School Exhibition</td>
            <td>Mrs. Fernando</td>
          </tr>
          <tr>
            <td>10A</td>
            <td>Yoshadhi Edirisinghe</td>
            <td>2025-09-14</td>
            <td>Disciplinary</td>
            <td>Minor</td>
            <td>Late for first period repeatedly</td>
            <td>Mr. Silva</td>
          </tr>
          <tr>
            <td>10B</td>
            <td>Chandupa Silva</td>
            <td>2025-09-14</td>
            <td>Reward</td>
            <td>-</td>
            <td>Won Inter-school Quiz Competition</td>
            <td>Admin</td>
          </tr>
          <tr>
            <td>11A</td>
            <td>Pasindu Anjana</td>
            <td>2025-09-13</td>
            <td>Good</td>
            <td>-</td>
            <td>Maintained 100% attendance this term</td>
            <td>Class Teacher</td>
          </tr>
          <tr>
            <td>11A</td>
            <td>Nirmal Kolabage</td>
            <td>2025-09-12</td>
            <td>Disciplinary</td>
            <td>Serious</td>
            <td>Involved in classroom disturbance</td>
            <td>Vice Principal</td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>

  <!-- ðŸ“ˆ Charts -->
  <div class="chart-container">
    <div class="card dashboard-tile chart-tile">
      <div class="icon-title">
        <i class="fas fa-chart-pie icon"></i>
        <p
          data-en="Behavior Distribution"
          data-si="à·„à·à·ƒà·’à¶»à·“à¶¸à·Š à·€à·Šâ€à¶ºà·à¶´à·Šà¶­à·’à¶º"
          data-ta="à®¨à®Ÿà®¤à¯à®¤à¯ˆ à®µà®¿à®¨à®¿à®¯à¯‹à®•à®®à¯"
        >
          Behavior Distribution
        </p>
      </div>
      <canvas id="behaviorChart"></canvas>
    </div>

    <div class="card dashboard-tile chart-tile">
      <div class="icon-title">
        <i class="fas fa-chart-line icon"></i>
        <p
          data-en="Monthly Discipline Trend"
          data-si="à¶¸à·à·ƒà·’à¶š à·€à·’à¶±à¶º à¶´à·Šâ€à¶»à·€à¶«à¶­à·à·€"
          data-ta="à®®à®¾à®¤à®¾à®¨à¯à®¤à®¿à®° à®’à®´à¯à®•à¯à®•à®®à¯ à®ªà¯‹à®•à¯à®•à¯"
        >
          Monthly Trend
        </p>
      </div>
      <canvas id="trendChart"></canvas>
    </div>
  </div>
</div>

<!-- ðŸ”™ Back Button -->
<div class="action-container">
  <a href="layout.html?role=admin&page=dashboard" class="btn back-btn">
    <i class="fas fa-arrow-left"></i>
    <span
      data-en="Back to Dashboard"
      data-si="à¶©à·‘à·‚à·Šà¶¶à·à¶©à·Š à·€à·™à¶­"
      data-ta="à®Ÿà®¾à®·à¯à®ªà¯‹à®°à¯à®Ÿà¯à®•à¯à®•à¯ à®¤à®¿à®°à¯à®®à¯à®ª"
      >Back to Dashboard</span
    >
  </a>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="../../js/dropdown.js"></script>
<script>
  // Get primary color from CSS variables
  const rootStyles = getComputedStyle(document.documentElement);
  const primaryColor = rootStyles.getPropertyValue("--color-primary").trim();
  const secondaryColor = rootStyles.getPropertyValue("--color-border").trim();

  // Custom plugin to draw center text in doughnut chart (like attendance chart)
  const centerTextPlugin = {
    id: "centerText",
    beforeDraw(chart, args, options) {
      if (chart.config.type !== "doughnut") return;
      const { ctx, width, height } = chart;
      ctx.save();
      const fontSize = (height / 160).toFixed(2);
      ctx.font = `${fontSize}em sans-serif`;
      ctx.textBaseline = "middle";
      ctx.textAlign = "center";
      ctx.fillStyle = options.color || primaryColor;
      const text = options.text || "";
      ctx.fillText(
        text,
        width / 2,
        chart.getDatasetMeta(0).data[0]?.y || height / 2
      );
      ctx.restore();
    },
  };

  function filterBehavior() {
    const classFilter = document.getElementById("classFilter").value;
    const typeFilter = document.getElementById("typeFilter").value;
    document.querySelectorAll("#behaviorBody tr").forEach((row) => {
      const matchClass =
        classFilter === "all" || row.cells[0].textContent === classFilter;
      const matchType =
        typeFilter === "all" || row.cells[3].textContent === typeFilter;
      row.style.display = matchClass && matchType ? "" : "none";
    });
  }

  function exportCSV() {
    const rows = Array.from(
      document.querySelectorAll("#behaviorBody tr")
    ).filter((r) => r.style.display !== "none");
    const csv = [["Class,Student,Date,Type,Severity,Description,Reported By"]];
    rows.forEach((r) =>
      csv.push(
        Array.from(r.cells)
          .map((td) => td.innerText)
          .join(",")
      )
    );
    const blob = new Blob([csv.join("\n")], { type: "text/csv" });
    const link = document.createElement("a");
    link.href = URL.createObjectURL(blob);
    link.download = "behavior_report.csv";
    link.click();
  }

  function exportPDF() {
    const visibleRows = Array.from(
      document.querySelectorAll("#behaviorBody tr")
    ).filter((r) => r.style.display !== "none");
    const tempTable = document.createElement("table");
    tempTable.innerHTML =
      "<thead>" +
      document.querySelector("#behaviorTable thead").innerHTML +
      "</thead><tbody>" +
      visibleRows.map((r) => r.outerHTML).join("") +
      "</tbody>";
    const win = window.open("", "", "width=800,height=600");
    win.document.write(
      "<html><head><title>Behavior Report</title></head><body>" +
        tempTable.outerHTML +
        "</body></html>"
    );
    win.document.close();
    win.print();
  }

  // Initialize Behavior Distribution Doughnut Chart with primary color
  new Chart(document.getElementById("behaviorChart"), {
    type: "doughnut",
    data: {
      labels: ["Good", "Disciplinary", "Reward"],
      datasets: [
        {
          data: [80, 15, 5],
          backgroundColor: [
            primaryColor,
            primaryColor + "66",
            primaryColor + "33",
          ],
          borderRadius: 20,
          borderColor: "transparent",
        },
      ],
    },
    options: {
      responsive: true,
      cutout: "85%",
      plugins: {
        legend: { position: "bottom" },
        title: {
          display: true,
          text: "Behavior Distribution",
          font: { size: 14, weight: "bold" },
          position: "bottom",
        },
        centerText: {
          text: "80",
          color: primaryColor,
        },
      },
    },
    plugins: [centerTextPlugin],
  });

  // Initialize Monthly Discipline Trend Line Chart with primary color
  new Chart(document.getElementById("trendChart"), {
    type: "line",
    data: {
      labels: ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep"],
      datasets: [
        {
          label: "Good Behavior",
          data: [12, 15, 13, 18, 14, 20, 16, 17, 19],
          borderColor: primaryColor,
          backgroundColor: primaryColor + "33",
          tension: 0.4,
          fill: true,
          borderWidth: 2,
        },
        {
          label: "Disciplinary Cases",
          data: [4, 6, 5, 7, 5, 6, 3, 4, 3],
          borderColor: primaryColor + "80",
          backgroundColor: primaryColor + "15",
          tension: 0.4,
          fill: true,
          borderWidth: 2,
        },
      ],
    },
    options: {
      responsive: true,
      plugins: {
        legend: { position: "top" },
      },
      scales: {
        y: { beginAtZero: true },
      },
    },
  });

  // âœ… FIXED LANGUAGE SWITCHING (works instantly now)
  function updateText(lang) {
    document.querySelectorAll("[data-en],[data-si],[data-ta]").forEach((el) => {
      el.textContent =
        el.getAttribute(`data-${lang}`) || el.getAttribute("data-en");
    });
  }

  // Apply immediately when storage or custom event changes
  window.addEventListener("storage", (e) => {
    if (e.key === "lang") {
      updateText(e.newValue || "en");
    }
  });
  window.addEventListener("languageChange", (e) => {
    const newLang = e.detail.lang || "en";
    localStorage.setItem("lang", newLang);
    updateText(newLang);
  });

  // Also detect changes every 300ms (failsafe)
  let lastLang = localStorage.getItem("lang") || "en";
  setInterval(() => {
    const currentLang = localStorage.getItem("lang") || "en";
    if (currentLang !== lastLang) {
      updateText(currentLang);
      lastLang = currentLang;
    }
  }, 300);

  // Initialize on load
  updateText(localStorage.getItem("lang") || "en");

  // Initialize searchable dropdowns
  function initializeSearchableDropdowns() {
    const dropdowns = document.querySelectorAll(".dropdown-select");
    dropdowns.forEach((select) => {
      if (typeof makeSearchableDropdown === "function") {
        makeSearchableDropdown(select.id, () => {
          select.dispatchEvent(new Event("change"));
        });
      }
    });
  }

  // Initialize after page loads
  if (document.readyState === "loading") {
    document.addEventListener(
      "DOMContentLoaded",
      initializeSearchableDropdowns
    );
  } else {
    initializeSearchableDropdowns();
  }
</script>

<style>
  .chart-container {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 20px;
    margin-bottom: 20px;
  }
  .chart-tile {
    max-height: 360px;
    display: flex;
    flex-direction: column;
    align-items: center;
  }
  .chart-tile canvas {
    max-width: 100%;
    max-height: 300px;
  }
  .summary-tiles {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 15px;
    margin-bottom: 15px;
  }
  .filter-group {
    display: flex !important;
    flex-direction: row !important;
    gap: 20px;
    margin-bottom: 20px;
    align-items: flex-end;
    width: auto;
  }
  .filter-group > div {
    flex: 0 0 auto;
    min-width: 200px;
    display: flex;
    flex-direction: column;
    gap: 0;
  }
  .filter-group .export-buttons {
    margin-left: auto;
    min-width: auto;
    display: flex;
    flex-direction: row;
    gap: 8px;
    align-items: flex-end;
  }
  .filter-group .export-buttons button {
    margin: 0;
  }
</style>

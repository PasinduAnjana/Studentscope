<section class="section">
  <h2 class="heading">
    <i class="fas fa-bullhorn"></i>
    <span data="sidebar.announcements"></span>
  </h2>
  <style>
    .checkbox-item {
      margin-bottom: 8px;
    }
    .checkbox-item label {
      display: flex;
      align-items: center;
      gap: 8px;
      cursor: pointer;
      padding: 4px;
      border-radius: 4px;
      transition: background-color 0.2s;
    }
    .checkbox-item label:hover {
      background-color: var(--color-hover);
    }
  </style>
  <div class="card">
    <div class="flex-between mb-2">
      <h1 class="title" data="sidebar.announcements"></h1>
      <button id="add-announcement-btn" class="btn btn-primary">
        <i class="fas fa-plus"></i> Add Announcement
      </button>
    </div>
    <div class="announcements-container" id="announcements-container">
      <!-- Announcements will be loaded here dynamically -->
    </div>
  </div>
</section>

<!-- Add/Edit Announcement Modal -->
<div id="announcement-modal" class="modal" style="display: none">
  <div class="modal-content">
    <div class="modal-header">
      <h3 id="modal-title">Add Announcement</h3>
      <span class="modal-close">&times;</span>
    </div>
    <div class="modal-body">
      <div class="mb-2">
        <label for="announcement-title">Title:</label>
        <input
          type="text"
          id="announcement-title"
          placeholder="Enter announcement title..."
          class="mt-1"
        />
      </div>
      <div class="mb-2">
        <label for="announcement-description">Description:</label>
        <textarea
          id="announcement-description"
          placeholder="Enter announcement description..."
          class="mt-1"
        ></textarea>
      </div>
      <div class="mb-2">
        <label for="announcement-audience">Audience:</label>
        <select id="announcement-audience" class="mt-1">
          <option value="all">All (Teachers & Students)</option>
          <option value="teachers">Specific Teachers</option>
          <option value="students">Specific Classes</option>
        </select>
      </div>
      <div id="teacher-selection" class="mb-2" style="display: none">
        <label>Select Teachers:</label>
        <div id="teacher-checkboxes" class="mt-1"></div>
      </div>
      <div id="class-selection" class="mb-2" style="display: none">
        <label>Select Classes:</label>
        <div id="class-checkboxes" class="mt-1"></div>
      </div>
    </div>
    <div class="modal-footer">
      <button id="modal-cancel" class="btn btn-secondary">Cancel</button>
      <button id="modal-save" class="btn btn-primary">Save</button>
    </div>
  </div>
</div>

<script>
  let announcements = [];
  let editingAnnouncement = null;
  let allTeachers = [];
  let allClasses = [];

  function renderAnnouncements() {
    const container = document.querySelector("#announcements-container");
    container.innerHTML = "";
    if (!announcements.length) {
      container.innerHTML = `<div class="no-announcements text-center">No announcements found</div>`;
      return;
    }

    announcements.forEach((announcement) => {
      const card = document.createElement("div");
      card.className = "announcement-card";

      const createdDate = new Date(
        announcement.created_at
      ).toLocaleDateString();

      // Format audience display
      let audienceDisplay = "";
      switch (announcement.audience_type) {
        case "all":
          audienceDisplay = "All (Teachers & Students)";
          break;
        case "teachers":
          audienceDisplay = "Teachers";
          break;
        case "students":
          audienceDisplay = "Students";
          break;
      }

      card.innerHTML = `
        <div class="announcement-title flex-between">
          <span>${announcement.title}</span>
          <div class="announcement-actions">
            <button class="btn-icon btn-edit" onclick="editAnnouncement(${announcement.id})" title="Edit">
              <i class="fas fa-edit"></i>
            </button>
            <button class="btn-icon btn-delete" onclick="deleteAnnouncement(${announcement.id})" title="Delete">
              <i class="fas fa-trash"></i>
            </button>
          </div>
        </div>
        <div class="announcement-description-container">
          <div class="announcement-description collapsed" id="desc-${announcement.id}">
            ${announcement.description}
          </div>
          <button class="expand-btn" id="expand-${announcement.id}" style="display: none" onclick="toggleDescription(${announcement.id})">
            <span>Show more</span>
            <i class="fas fa-chevron-down"></i>
          </button>
        </div>
        <div class="announcement-meta flex-between">
          <span class="text-sm">Audience: ${audienceDisplay}</span>
          <span class="text-sm">Created: ${createdDate}</span>
        </div>
      `;

      container.appendChild(card);

      // Check if description needs expand button
      setTimeout(() => {
        const descElement = document.getElementById(`desc-${announcement.id}`);
        const expandBtn = document.getElementById(`expand-${announcement.id}`);
        if (
          descElement &&
          expandBtn &&
          descElement.scrollHeight > descElement.clientHeight
        ) {
          expandBtn.style.display = "inline-flex";
        }
      }, 0);
    });
  }

  function fetchAnnouncements() {
    console.log("Fetching announcements...");
    fetch("/api/admin/announcements")
      .then((res) => {
        console.log("API response status:", res.status);
        if (!res.ok) throw new Error("Failed to fetch announcements");
        return res.json();
      })
      .then((data) => {
        console.log("Received announcements data:", data);
        announcements = data;
        console.log("Announcements array after assignment:", announcements);
        renderAnnouncements();
      })
      .catch((err) => {
        console.error("Error fetching announcements:", err);
        const container = document.querySelector("#announcements-container");
        container.innerHTML = `<div class="no-announcements text-center">Error loading announcements</div>`;
      });
  }

  function setupAddButton() {
    const addBtn = document.getElementById("add-announcement-btn");
    const modal = document.getElementById("announcement-modal");
    const closeBtn = document.querySelector("#announcement-modal .modal-close");
    const cancelBtn = document.getElementById("modal-cancel");
    const saveBtn = document.getElementById("modal-save");
    const audienceSelect = document.getElementById("announcement-audience");

    addBtn.addEventListener("click", () => {
      editingAnnouncement = null;
      document.getElementById("modal-title").textContent = "Add Announcement";
      clearModal();
      modal.style.display = "flex";
    });

    const closeModal = () => {
      modal.style.display = "none";
    };

    closeBtn.addEventListener("click", closeModal);
    cancelBtn.addEventListener("click", closeModal);
    audienceSelect.addEventListener("change", handleAudienceChange);

    modal.addEventListener("click", (e) => {
      if (e.target === modal) {
        closeModal();
      }
    });

    saveBtn.addEventListener("click", saveAnnouncement);
  }

  function handleAudienceChange() {
    const audience = document.getElementById("announcement-audience").value;
    const teacherSelection = document.getElementById("teacher-selection");
    const classSelection = document.getElementById("class-selection");

    // Hide all selections first
    teacherSelection.style.display = "none";
    classSelection.style.display = "none";

    // Show relevant selection based on audience
    if (audience === "teachers") {
      teacherSelection.style.display = "block";
      if (!document.querySelector("#teacher-checkboxes .checkbox-item")) {
        loadTeachers();
      }
    } else if (audience === "students") {
      classSelection.style.display = "block";
      if (!document.querySelector("#class-checkboxes .checkbox-item")) {
        loadClasses();
      }
    }
  }

  async function loadTeachers() {
    try {
      const res = await fetch("/api/admin/teachers");
      if (!res.ok) throw new Error("Failed to fetch teachers");
      allTeachers = await res.json();
      renderTeacherCheckboxes();
    } catch (err) {
      console.error("Error loading teachers:", err);
    }
  }

  async function loadClasses() {
    try {
      const res = await fetch("/api/admin/classes");
      if (!res.ok) throw new Error("Failed to fetch classes");
      allClasses = await res.json();
      renderClassCheckboxes();
    } catch (err) {
      console.error("Error loading classes:", err);
    }
  }

  function renderTeacherCheckboxes() {
    const container = document.getElementById("teacher-checkboxes");
    container.innerHTML = "";

    if (!allTeachers.length) {
      container.innerHTML = "<p class='text-sm'>No teachers found</p>";
      return;
    }

    allTeachers.forEach((teacher) => {
      const checkboxDiv = document.createElement("div");
      checkboxDiv.className = "checkbox-item";
      checkboxDiv.innerHTML = `
        <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
          <input type="checkbox" value="${
            teacher.teacher_id
          }" style="margin: 0;">
          <span>${teacher.full_name || teacher.username}</span>
        </label>
      `;
      container.appendChild(checkboxDiv);
    });
  }

  function renderClassCheckboxes() {
    const container = document.getElementById("class-checkboxes");
    container.innerHTML = "";

    if (!allClasses.length) {
      container.innerHTML = "<p class='text-sm'>No classes found</p>";
      return;
    }

    allClasses.forEach((cls) => {
      const checkboxDiv = document.createElement("div");
      checkboxDiv.className = "checkbox-item";
      checkboxDiv.innerHTML = `
        <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
          <input type="checkbox" value="${cls.id}" style="margin: 0;">
          <span>Grade ${cls.grade} - ${cls.name}</span>
        </label>
      `;
      container.appendChild(checkboxDiv);
    });
  }

  function saveAnnouncement() {
    const title = document.getElementById("announcement-title").value.trim();
    const description = document
      .getElementById("announcement-description")
      .value.trim();
    const audience = document.getElementById("announcement-audience").value;

    if (!title || !description) {
      toast("Please fill in all fields.", "fa-solid fa-circle-exclamation");
      return;
    }

    // Validate audience selection
    let teacherIds = [];
    let classIds = [];

    if (audience === "teachers") {
      teacherIds = Array.from(
        document.querySelectorAll("#teacher-checkboxes input:checked")
      ).map((cb) => parseInt(cb.value));
      if (teacherIds.length === 0) {
        toast(
          "Please select at least one teacher.",
          "fa-solid fa-circle-exclamation"
        );
        return;
      }
    } else if (audience === "students") {
      classIds = Array.from(
        document.querySelectorAll("#class-checkboxes input:checked")
      ).map((cb) => parseInt(cb.value));
      if (classIds.length === 0) {
        toast(
          "Please select at least one class.",
          "fa-solid fa-circle-exclamation"
        );
        return;
      }
    }

    const method = editingAnnouncement ? "PUT" : "POST";
    const url = editingAnnouncement
      ? `/api/admin/announcements/${editingAnnouncement.id}`
      : "/api/admin/announcements";

    const body = {
      title,
      description,
      audience_type: audience,
      teacher_ids: teacherIds,
      class_ids: classIds,
    };

    fetch(url, {
      method,
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(body),
    })
      .then((res) => {
        if (!res.ok) throw new Error("Failed to save announcement");
        return res.json();
      })
      .then(() => {
        document.getElementById("announcement-modal").style.display = "none";
        toast("Announcement saved successfully", "fa-solid fa-check-circle");
        fetchAnnouncements();
      })
      .catch((err) => {
        console.error(err);
        toast("Error saving announcement", "fa-solid fa-circle-exclamation");
      });
  }

  function clearModal() {
    document.getElementById("announcement-title").value = "";
    document.getElementById("announcement-description").value = "";
    document.getElementById("announcement-audience").value = "all";
    document.getElementById("teacher-selection").style.display = "none";
    document.getElementById("class-selection").style.display = "none";
    // Clear checkboxes
    document
      .querySelectorAll("#teacher-checkboxes input, #class-checkboxes input")
      .forEach((cb) => (cb.checked = false));
  }

  function editAnnouncement(id) {
    console.log(
      "Edit button clicked for announcement ID:",
      id,
      "type:",
      typeof id
    );
    console.log(
      "Available announcement IDs:",
      announcements.map((a) => ({ id: a.id, type: typeof a.id }))
    );
    const announcement = announcements.find((a) => a.id == id); // Use == for type coercion
    console.log("Found announcement:", announcement);
    if (!announcement) {
      console.error("Announcement not found with ID:", id);
      toast(
        `Announcement with ID ${id} not found.`,
        "fa-solid fa-circle-exclamation"
      );
      return;
    }

    editingAnnouncement = announcement;
    document.getElementById("modal-title").textContent = "Edit Announcement";
    document.getElementById("announcement-title").value = announcement.title;
    document.getElementById("announcement-description").value =
      announcement.description;
    document.getElementById("announcement-audience").value =
      announcement.audience_type;

    // Handle audience change to show appropriate selections
    handleAudienceChange();

    // Load teachers/classes if needed and pre-select based on announcement data
    if (announcement.audience_type === "teachers" && announcement.teachers) {
      if (!allTeachers.length) {
        loadTeachers().then(() => {
          announcement.teachers.forEach((teacher) => {
            const checkbox = document.querySelector(
              `#teacher-checkboxes input[value="${teacher.teacher_id}"]`
            );
            if (checkbox) checkbox.checked = true;
          });
        });
      } else {
        announcement.teachers.forEach((teacher) => {
          const checkbox = document.querySelector(
            `#teacher-checkboxes input[value="${teacher.teacher_id}"]`
          );
          if (checkbox) checkbox.checked = true;
        });
      }
    } else if (
      announcement.audience_type === "students" &&
      announcement.classes
    ) {
      if (!allClasses.length) {
        loadClasses().then(() => {
          announcement.classes.forEach((cls) => {
            const checkbox = document.querySelector(
              `#class-checkboxes input[value="${cls.id}"]`
            );
            if (checkbox) checkbox.checked = true;
          });
        });
      } else {
        announcement.classes.forEach((cls) => {
          const checkbox = document.querySelector(
            `#class-checkboxes input[value="${cls.id}"]`
          );
          if (checkbox) checkbox.checked = true;
        });
      }
    }

    document.getElementById("announcement-modal").style.display = "flex";
    console.log("Modal should now be visible");
  }

  function deleteAnnouncement(id) {
    toast(
      "Are you sure you want to delete this announcement?",
      "fa-solid fa-trash",
      {
        confirm: true,
        confirmText: "Delete",
        cancelText: "Cancel",
        onConfirm: function () {
          fetch(`/api/admin/announcements/${id}`, {
            method: "DELETE",
          })
            .then((res) => {
              if (!res.ok) throw new Error("Failed to delete announcement");
              return res.json();
            })
            .then(() => {
              toast(
                "Announcement deleted successfully",
                "fa-solid fa-check-circle"
              );
              fetchAnnouncements(); // Refresh the list
            })
            .catch((err) => {
              console.error("Error deleting announcement:", err);
              toast(
                "Error deleting announcement",
                "fa-solid fa-circle-exclamation"
              );
            });
        },
        onCancel: function () {
          // Do nothing, just close toast
        },
      }
    );
  }

  function toggleDescription(id) {
    const descElement = document.getElementById(`desc-${id}`);
    const expandBtn = document.getElementById(`expand-${id}`);
    const btnText = expandBtn.querySelector("span");
    const btnIcon = expandBtn.querySelector("i");

    if (descElement.classList.contains("collapsed")) {
      // Expand
      descElement.classList.remove("collapsed");
      descElement.classList.add("expanded");
      btnText.textContent = "Show less";
      expandBtn.classList.add("expanded");
    } else {
      // Collapse
      descElement.classList.remove("expanded");
      descElement.classList.add("collapsed");
      btnText.textContent = "Show more";
      expandBtn.classList.remove("expanded");
    }
  }

  // Initialize
  fetchAnnouncements();
  setupAddButton();
  loadTeachers(); // Pre-load teachers for better UX
  loadClasses(); // Pre-load classes for better UX
</script>

<style>
  /* Modal Styles */
  .modal {
    position: fixed;
    z-index: 1000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.5);
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .modal-content {
    background-color: var(--color-card);
    border-radius: 8px;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
    max-width: 600px;
    width: 90%;
    max-height: 80vh;
    overflow-y: auto;
  }

  .modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 20px;
    border-bottom: 1px solid var(--color-border);
  }

  .modal-header h3 {
    margin: 0;
    color: var(--color-text);
  }

  .modal-close {
    font-size: 28px;
    font-weight: bold;
    color: var(--color-subtext);
    cursor: pointer;
    line-height: 1;
  }

  .modal-close:hover {
    color: var(--color-text);
  }

  .modal-body {
    padding: 20px;
  }

  .modal-footer {
    display: flex;
    justify-content: flex-end;
    gap: 10px;
    padding: 20px;
    border-top: 1px solid var(--color-border);
  }

  /* Stats tiles styling */
  .stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 16px;
    margin-bottom: 24px;
  }

  .stat-tile {
    background: var(--color-card);
    border-radius: 8px;
    padding: 20px;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    border: 1px solid var(--color-border);
    text-align: center;
  }

  .stat-icon {
    font-size: 24px;
    color: var(--color-primary);
    margin-bottom: 8px;
  }

  .stat-number {
    font-size: 28px;
    font-weight: bold;
    color: var(--color-text);
    margin-bottom: 4px;
  }

  .stat-label {
    font-size: 14px;
    color: var(--color-subtext);
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }

  /* Action buttons styling */
  .action-buttons {
    display: flex;
    gap: 5px;
    justify-content: center;
  }

  /* Attendance status styling */
  .status-present {
    font-weight: 500;
  }

  .status-absent {
    font-weight: 500;
  }
</style>

<section class="section">
  <h2 class="heading">
    <i class="fas fa-clipboard-check"></i>
    <span>Attendance Reports</span>
  </h2>

  <!-- Statistics Tiles -->
  <div class="stats-grid">
    <div class="stat-tile">
      <div class="stat-icon">
        <i class="fas fa-users"></i>
      </div>
      <div class="stat-number" id="total-students">-</div>
      <div class="stat-label">Total Students</div>
    </div>
    <div class="stat-tile">
      <div class="stat-icon">
        <i class="fas fa-user-check"></i>
      </div>
      <div class="stat-number" id="present-today">-</div>
      <div class="stat-label">Present Today</div>
    </div>
    <div class="stat-tile">
      <div class="stat-icon">
        <i class="fas fa-user-times"></i>
      </div>
      <div class="stat-number" id="absent-today">-</div>
      <div class="stat-label">Absent Today</div>
    </div>
    <div class="stat-tile">
      <div class="stat-icon">
        <i class="fas fa-percentage"></i>
      </div>
      <div class="stat-number" id="average-attendance">-%</div>
      <div class="stat-label">Average Attendance</div>
    </div>
  </div>

  <div class="card">
    <div class="flex-between mb-2">
      <h1 class="title">Today's Attendance</h1>
      <div class="flex gap-2" style="gap: 16px">
        <button id="export-pdf-btn" class="btn btn-primary">
          <i class="fas fa-file-pdf"></i> Export PDF
        </button>
        <button id="export-btn" class="btn btn-primary">
          <i class="fas fa-download"></i> Export CSV
        </button>
      </div>
    </div>

    <!-- Search Bar and Class Dropdown -->
    <div
      class="flex mb-2 filter-controls"
      style="gap: 16px; align-items: baseline; flex-wrap: wrap"
    >
      <div class="search-group" style="max-width: 350px">
        <input
          type="text"
          id="attendance-search"
          class="search-input"
          placeholder="Search students..."
        />
        <span class="search-icon"><i class="fas fa-search"></i></span>
      </div>
      <div class="input-group">
        <select id="class-filter">
          <option value="">All Classes</option>
        </select>
      </div>
      <div class="input-group">
        <select id="status-filter">
          <option value="">All Status</option>
          <option value="present">Present</option>
          <option value="absent">Absent</option>
        </select>
      </div>
      <div class="input-group">
        <select id="page-size">
          <option value="10">10</option>
          <option value="25" selected>25</option>
          <option value="50">50</option>
          <option value="100">100</option>
        </select>
      </div>
      <div class="input-group">
        <input
          type="date"
          id="attendance-date"
          class="input"
          style="width: auto"
        />
      </div>
    </div>

    <div class="table-responsive">
      <table id="attendance-table">
        <thead>
          <tr>
            <th>Student Name</th>
            <th>Index Number</th>
            <th>Class</th>
            <th>Status</th>
            <th>Time</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          <!-- Attendance records will be loaded here -->
        </tbody>
      </table>
    </div>

    <!-- Pagination Controls -->
    <div
      class="pagination-controls"
      style="
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 10px;
        margin-top: 20px;
      "
    >
      <button id="prev-page" class="btn btn-secondary" disabled>
        <i class="fas fa-chevron-left"></i> Previous
      </button>
      <div id="page-numbers" style="display: flex; gap: 5px"></div>
      <button id="next-page" class="btn btn-secondary" disabled>
        Next <i class="fas fa-chevron-right"></i>
      </button>
      <span
        id="page-info"
        style="margin-left: 20px; color: var(--color-subtext)"
      ></span>
    </div>
  </div>
</section>

<!-- Export Modal -->
<div id="export-modal" class="modal" style="display: none">
  <div class="modal-content">
    <div class="modal-header">
      <h3>Export Attendance to CSV</h3>
      <span class="modal-close">&times;</span>
    </div>
    <div class="modal-body">
      <p>Select the fields you want to include in the CSV export:</p>
      <div class="export-fields">
        <label class="checkbox-label">
          <input type="checkbox" id="export-name" checked />
          <span class="checkmark"></span>
          Student Name
        </label>
        <label class="checkbox-label">
          <input type="checkbox" id="export-index" checked />
          <span class="checkmark"></span>
          Index Number
        </label>
        <label class="checkbox-label">
          <input type="checkbox" id="export-class" checked />
          <span class="checkmark"></span>
          Class
        </label>
        <label class="checkbox-label">
          <input type="checkbox" id="export-status" checked />
          <span class="checkmark"></span>
          Status
        </label>
        <label class="checkbox-label">
          <input type="checkbox" id="export-time" />
          <span class="checkmark"></span>
          Time
        </label>
      </div>
    </div>
    <div class="modal-footer">
      <button id="export-cancel" class="btn btn-secondary">Cancel</button>
      <button id="export-confirm" class="btn btn-primary">Export</button>
    </div>
  </div>
</div>

<!-- Export PDF Modal -->
<div id="export-pdf-modal" class="modal" style="display: none">
  <div class="modal-content">
    <div class="modal-header">
      <h3>Export Attendance to PDF</h3>
      <span class="modal-close">&times;</span>
    </div>
    <div class="modal-body">
      <div class="input-group" style="margin-bottom: 15px">
        <label for="pdf-heading">Heading:</label>
        <input
          type="text"
          id="pdf-heading"
          class="input"
          placeholder="Enter heading..."
        />
      </div>
      <div class="input-group" style="margin-bottom: 15px">
        <label for="pdf-subheading">Subheading:</label>
        <input
          type="text"
          id="pdf-subheading"
          class="input"
          placeholder="Enter subheading..."
        />
      </div>
      <div class="input-group" style="margin-bottom: 15px">
        <label for="pdf-empty-columns"
          >Number of Empty Columns (for signatures, etc.):</label
        >
        <input
          type="number"
          id="pdf-empty-columns"
          class="input"
          placeholder="0"
          min="0"
          max="10"
        />
      </div>
      <div class="input-group" style="margin-bottom: 15px">
        <label for="pdf-empty-titles"
          >Empty Column Titles (comma-separated, e.g., Signature, Date,
          Notes):</label
        >
        <input
          type="text"
          id="pdf-empty-titles"
          class="input"
          placeholder="Signature, Date, Notes"
        />
      </div>
      <p>Select the fields you want to include in the PDF export:</p>
      <div class="export-fields">
        <label class="checkbox-label">
          <input type="checkbox" id="pdf-export-name" checked />
          <span class="checkmark"></span>
          Student Name
        </label>
        <label class="checkbox-label">
          <input type="checkbox" id="pdf-export-index" checked />
          <span class="checkmark"></span>
          Index Number
        </label>
        <label class="checkbox-label">
          <input type="checkbox" id="pdf-export-class" checked />
          <span class="checkmark"></span>
          Class
        </label>
        <label class="checkbox-label">
          <input type="checkbox" id="pdf-export-status" checked />
          <span class="checkmark"></span>
          Status
        </label>
        <label class="checkbox-label">
          <input type="checkbox" id="pdf-export-time" />
          <span class="checkmark"></span>
          Time
        </label>
      </div>
    </div>
    <div class="modal-footer">
      <button id="export-pdf-cancel" class="btn btn-secondary">Cancel</button>
      <button id="export-pdf-confirm" class="btn btn-primary">
        Export PDF
      </button>
    </div>
  </div>
</div>

<!-- Mark Attendance Modal -->
<div id="mark-attendance-modal" class="modal" style="display: none">
  <div class="modal-content">
    <div class="modal-header">
      <h3 id="attendance-modal-title">Mark Attendance</h3>
      <span class="modal-close">&times;</span>
    </div>
    <div class="modal-body">
      <div class="input-group">
        <label for="attendance-status">Status:</label>
        <select id="attendance-status" required>
          <option value="present">Present</option>
          <option value="absent">Absent</option>
        </select>
      </div>
      <div class="input-group">
        <label for="attendance-time">Time:</label>
        <input type="time" id="attendance-time" required />
      </div>
      <div class="input-group">
        <label for="attendance-notes">Notes (Optional):</label>
        <textarea
          id="attendance-notes"
          rows="3"
          placeholder="Additional notes..."
          maxlength="200"
        ></textarea>
      </div>
    </div>
    <div class="modal-footer">
      <button id="attendance-modal-cancel" class="btn btn-secondary">
        Cancel
      </button>
      <button id="attendance-modal-save" class="btn btn-primary">Save</button>
    </div>
  </div>
</div>

<script>
  let allAttendanceRecords = [];
  let allStudents = [];
  let allClasses = [];
  let currentStudentId = null;
  // Pagination variables
  let currentPage = 1;
  let pageSize = 25;
  let totalPages = 1;
  // references to searchable dropdown wrappers so we can destroy/recreate when class lists change
  let searchableClassFilter = null;
  let searchableStatusFilter = null;
  let searchablePageSize = null;

  function updateSearchableDisplay(selectId) {
    const select = document.getElementById(selectId);
    if (!select) return;
    const wrapper = select.previousElementSibling;
    if (wrapper && wrapper.classList.contains("searchable-select")) {
      const displaySpan = wrapper.querySelector(".dropdown-display span");
      const opt =
        select.options[select.selectedIndex] ||
        Array.from(select.options).find((o) => o.value);
      if (displaySpan) displaySpan.textContent = opt ? opt.text : "";
    }
  }

  function renderAttendance(filtered) {
    const tbody = document.querySelector("#attendance-table tbody");
    tbody.innerHTML = "";
    if (!filtered.length) {
      tbody.innerHTML = `<tr><td colspan="6" class="text-center">No attendance records found</td></tr>`;
      updatePaginationControls(0);
      return;
    }

    // Calculate pagination
    totalPages = Math.ceil(filtered.length / pageSize);
    const startIndex = (currentPage - 1) * pageSize;
    const endIndex = startIndex + pageSize;
    const recordsToShow = filtered.slice(startIndex, endIndex);

    recordsToShow.forEach((record) => {
      const statusClass = `status-${record.status}`;

      const row = document.createElement("tr");
      row.innerHTML = `
        <td>${record.student_name || "Unknown Student"}</td>
        <td>${record.username || "N/A"}</td>
        <td>${record.class_name || "N/A"}</td>
        <td><span class="${statusClass}">${
        record.status.charAt(0).toUpperCase() + record.status.slice(1)
      }</span></td>
        <td>${record.time || "N/A"}</td>
        <td>
          <div class="action-buttons">
            <button class="btn-icon btn-edit" onclick="editAttendance(${
              record.id
            })" title="Edit">
              <i class="fas fa-edit"></i>
            </button>
            <button class="btn-icon btn-delete" onclick="deleteAttendance(${
              record.id
            })" title="Delete">
              <i class="fas fa-trash"></i>
            </button>
          </div>
        </td>
      `;
      tbody.appendChild(row);
    });

    updatePaginationControls(filtered.length);
  }

  function updatePaginationControls(totalItems) {
    const prevBtn = document.getElementById("prev-page");
    const nextBtn = document.getElementById("next-page");
    const pageNumbers = document.getElementById("page-numbers");
    const pageInfo = document.getElementById("page-info");

    // Update button states
    prevBtn.disabled = currentPage <= 1;
    nextBtn.disabled = currentPage >= totalPages;

    // Update page info
    const startItem = totalItems > 0 ? (currentPage - 1) * pageSize + 1 : 0;
    const endItem = Math.min(currentPage * pageSize, totalItems);
    pageInfo.textContent = `Showing ${startItem}-${endItem} of ${totalItems} attendance records`;

    // Generate page number buttons
    pageNumbers.innerHTML = "";
    const maxVisiblePages = 5;
    let startPage = Math.max(1, currentPage - Math.floor(maxVisiblePages / 2));
    let endPage = Math.min(totalPages, startPage + maxVisiblePages - 1);

    if (endPage - startPage + 1 < maxVisiblePages) {
      startPage = Math.max(1, endPage - maxVisiblePages + 1);
    }

    // Add first page button if not in range
    if (startPage > 1) {
      const firstBtn = document.createElement("button");
      firstBtn.className = "btn btn-secondary";
      firstBtn.textContent = "1";
      firstBtn.onclick = () => goToPage(1);
      pageNumbers.appendChild(firstBtn);

      if (startPage > 2) {
        const ellipsis = document.createElement("span");
        ellipsis.textContent = "...";
        ellipsis.style.margin = "0 5px";
        pageNumbers.appendChild(ellipsis);
      }
    }

    // Add page number buttons
    for (let i = startPage; i <= endPage; i++) {
      const pageBtn = document.createElement("button");
      pageBtn.className = `btn ${
        i === currentPage ? "btn-primary" : "btn-secondary"
      }`;
      pageBtn.textContent = i;
      pageBtn.onclick = () => goToPage(i);
      pageNumbers.appendChild(pageBtn);
    }

    // Add last page button if not in range
    if (endPage < totalPages) {
      if (endPage < totalPages - 1) {
        const ellipsis = document.createElement("span");
        ellipsis.textContent = "...";
        ellipsis.style.margin = "0 5px";
        pageNumbers.appendChild(ellipsis);
      }

      const lastBtn = document.createElement("button");
      lastBtn.className = "btn btn-secondary";
      lastBtn.textContent = totalPages;
      lastBtn.onclick = () => goToPage(totalPages);
      pageNumbers.appendChild(lastBtn);
    }
  }

  function goToPage(page) {
    if (page >= 1 && page <= totalPages) {
      currentPage = page;
      filterAndRender();
    }
  }

  function filterAndRender(resetPage = false) {
    // Reset to page 1 when filters change
    if (resetPage) {
      currentPage = 1;
    }
    // Fetch filtered records from server
    fetchAttendanceRecords();
  }

  async function fetchAttendanceStats() {
    try {
      const dateInput = document.getElementById("attendance-date");
      const selectedDate =
        dateInput.value || new Date().toISOString().split("T")[0];

      const statsRes = await fetch(
        `/api/admin/attendance/stats?date=${selectedDate}`
      );
      if (statsRes.ok) {
        const stats = await statsRes.json();
        document.getElementById("total-students").textContent =
          stats.totalStudents;
        document.getElementById("present-today").textContent =
          stats.presentToday;
        document.getElementById("absent-today").textContent = stats.absentToday;
        document.getElementById("average-attendance").textContent =
          stats.averageAttendance + "%";
      } else {
        // Fallback to mock data if API fails
        document.getElementById("total-students").textContent = "245";
        document.getElementById("present-today").textContent = "198";
        document.getElementById("absent-today").textContent = "47";
        document.getElementById("average-attendance").textContent = "81%";
      }
    } catch (err) {
      console.error("Error fetching attendance stats:", err);
      // Fallback to mock data if API fails
      document.getElementById("total-students").textContent = "245";
      document.getElementById("present-today").textContent = "198";
      document.getElementById("absent-today").textContent = "47";
      document.getElementById("average-attendance").textContent = "81%";
    }
  }

  async function fetchAttendanceRecords() {
    try {
      const dateInput = document.getElementById("attendance-date");
      const selectedDate =
        dateInput.value || new Date().toISOString().split("T")[0];

      // Build query parameters for filters
      const params = new URLSearchParams({ date: selectedDate });

      const classId = document.getElementById("class-filter").value;
      const status = document.getElementById("status-filter").value;
      const search = document.getElementById("attendance-search").value.trim();

      if (classId) params.append("classId", classId);
      if (status) params.append("status", status);
      if (search) params.append("search", search);

      const recordsRes = await fetch(`/api/admin/attendance/records?${params}`);
      if (recordsRes.ok) {
        allAttendanceRecords = await recordsRes.json();
        renderAttendance(allAttendanceRecords); // Render directly since filtering is done server-side
      } else {
        // Fallback to mock data if API fails
        allAttendanceRecords = [
          {
            id: 1,
            student_id: 1,
            class_id: 1,
            status: "present",
            time: "08:30",
            date: selectedDate,
            student_name: "John Doe",
            username: "john123",
            class_name: "Grade 6 - A",
          },
          {
            id: 2,
            student_id: 2,
            class_id: 1,
            status: "present",
            time: "08:35",
            date: selectedDate,
            student_name: "Jane Smith",
            username: "jane123",
            class_name: "Grade 6 - A",
          },
          {
            id: 3,
            student_id: 3,
            class_id: 1,
            status: "absent",
            time: null,
            date: selectedDate,
            student_name: "Bob Johnson",
            username: "bob123",
            class_name: "Grade 6 - A",
          },
          {
            id: 4,
            student_id: 4,
            class_id: 2,
            status: "present",
            time: "08:45",
            date: selectedDate,
            student_name: "Alice Brown",
            username: "alice123",
            class_name: "Grade 7 - B",
          },
        ];
        renderAttendance(allAttendanceRecords);
      }
    } catch (err) {
      console.error("Error fetching attendance records:", err);
      // Fallback to mock data
      const dateInput = document.getElementById("attendance-date");
      const selectedDate =
        dateInput.value || new Date().toISOString().split("T")[0];
      allAttendanceRecords = [
        {
          id: 1,
          student_id: 1,
          class_id: 1,
          status: "present",
          time: "08:30",
          date: selectedDate,
          student_name: "John Doe",
          username: "john123",
          class_name: "Grade 6 - A",
        },
      ];
      renderAttendance(allAttendanceRecords);
    }
  }

  async function fetchStudents() {
    try {
      const res = await fetch("/api/admin/students");
      if (!res.ok) throw new Error("Failed to fetch students");
      allStudents = await res.json();
    } catch (err) {
      console.error("Error fetching students:", err);
      allStudents = [];
    }
  }

  async function fetchClasses() {
    try {
      const res = await fetch("/api/admin/classes");
      if (!res.ok) throw new Error("Failed to fetch classes");
      allClasses = await res.json();
      populateClassFilter();
      populateStatusFilter();
    } catch (err) {
      console.error("Error fetching classes:", err);
    }
  }

  function populateClassFilter() {
    const select = document.getElementById("class-filter");
    // destroy previous searchable instance if any
    if (
      searchableClassFilter &&
      typeof searchableClassFilter.destroy === "function"
    ) {
      searchableClassFilter.destroy();
      searchableClassFilter = null;
    }
    select.innerHTML = '<option value="">All Classes</option>';
    allClasses.forEach((cls) => {
      const option = document.createElement("option");
      option.value = cls.id;
      option.textContent = `${cls.grade} - ${cls.name}`;
      select.appendChild(option);
    });
    // transform into searchable dropdown
    if (typeof makeSearchableDropdown === "function") {
      searchableClassFilter = makeSearchableDropdown(
        "class-filter",
        (val, text) => {
          // ensure the underlying select value is set and trigger filtering
          const sel = document.getElementById("class-filter");
          if (sel) sel.value = val;
          filterAndRender(true);
        }
      );
    }
  }

  function populateStatusFilter() {
    const select = document.getElementById("status-filter");
    // destroy previous searchable instance if any
    if (
      searchableStatusFilter &&
      typeof searchableStatusFilter.destroy === "function"
    ) {
      searchableStatusFilter.destroy();
      searchableStatusFilter = null;
    }
    select.innerHTML = `
      <option value="">All Status</option>
      <option value="present">Present</option>
      <option value="absent">Absent</option>
    `;
    // transform into searchable dropdown
    if (typeof makeSearchableDropdown === "function") {
      searchableStatusFilter = makeSearchableDropdown(
        "status-filter",
        (val, text) => {
          // ensure the underlying select value is set and trigger filtering
          const sel = document.getElementById("status-filter");
          if (sel) sel.value = val;
          filterAndRender(true);
        }
      );
    }
  }

  function populatePageSizeSelect() {
    const select = document.getElementById("page-size");
    // destroy previous searchable instance if any
    if (
      searchablePageSize &&
      typeof searchablePageSize.destroy === "function"
    ) {
      searchablePageSize.destroy();
      searchablePageSize = null;
    }
    select.innerHTML = "";
    const pageSizeOptions = [
      { value: "10", text: "10" },
      { value: "25", text: "25" },
      { value: "50", text: "50" },
      { value: "100", text: "100" },
    ];
    pageSizeOptions.forEach((option) => {
      const opt = document.createElement("option");
      opt.value = option.value;
      opt.textContent = option.text;
      if (option.value === "25") opt.selected = true; // Default to 25
      select.appendChild(opt);
    });
    // transform into searchable dropdown
    if (typeof makeSearchableDropdown === "function") {
      searchablePageSize = makeSearchableDropdown("page-size", (val, text) => {
        // Update pageSize and refresh display
        pageSize = parseInt(val);
        currentPage = 1; // Reset to first page when page size changes
        filterAndRender();
      });
    }
  }

  function setupSearch() {
    document
      .getElementById("attendance-search")
      .addEventListener("input", () => filterAndRender(true));
    document.getElementById("page-size").addEventListener("change", (e) => {
      pageSize = parseInt(e.target.value);
      currentPage = 1; // Reset to first page when page size changes
      filterAndRender();
    });
    document
      .getElementById("prev-page")
      .addEventListener("click", () => goToPage(currentPage - 1));
    document
      .getElementById("next-page")
      .addEventListener("click", () => goToPage(currentPage + 1));
  }

  function setupDatePicker() {
    const dateInput = document.getElementById("attendance-date");
    // Set default to today
    const today = new Date().toISOString().split("T")[0];
    dateInput.value = today;

    dateInput.addEventListener("change", () => {
      refreshAttendance();
    });
  }

  function setupModal() {
    const modal = document.getElementById("mark-attendance-modal");
    const closeBtn = document.querySelector(
      "#mark-attendance-modal .modal-close"
    );
    const cancelBtn = document.getElementById("attendance-modal-cancel");
    const saveBtn = document.getElementById("attendance-modal-save");

    const closeModal = () => {
      if (modal) modal.style.display = "none";
      currentStudentId = null;
    };

    if (closeBtn) closeBtn.addEventListener("click", closeModal);
    if (cancelBtn) cancelBtn.addEventListener("click", closeModal);

    if (modal) {
      modal.addEventListener("click", (e) => {
        if (e.target === modal) closeModal();
      });
    }

    if (saveBtn) saveBtn.addEventListener("click", saveAttendance);
  }

  function clearAttendanceModal() {
    document.getElementById("attendance-status").value = "present";
    document.getElementById("attendance-time").value = "";
    document.getElementById("attendance-notes").value = "";

    // Set default time to current time
    const now = new Date();
    const timeString = now.toTimeString().slice(0, 5); // HH:MM format
    document.getElementById("attendance-time").value = timeString;
  }

  async function saveAttendance() {
    const status = document.getElementById("attendance-status").value;
    const time = document.getElementById("attendance-time").value;
    const notes = document.getElementById("attendance-notes").value.trim();

    if (!status || !time) {
      toast(
        "Please fill in all required fields",
        "fa-solid fa-circle-exclamation"
      );
      return;
    }

    try {
      const dateInput = document.getElementById("attendance-date");
      const selectedDate =
        dateInput.value || new Date().toISOString().split("T")[0];

      const data = {
        student_id: currentStudentId,
        date: selectedDate,
        status: status,
        time: time,
        notes: notes,
      };

      // Mock save for now - replace with actual API call
      toast("Attendance marked successfully", "fa-solid fa-check-circle");
      document.getElementById("mark-attendance-modal").style.display = "none";
      refreshAttendance();

      // Uncomment when real API endpoint is available:
      /*
      const res = await fetch("/api/admin/attendance", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(data),
      });
      if (!res.ok) throw new Error("Failed to save attendance");
      toast("Attendance marked successfully", "fa-solid fa-check-circle");
      document.getElementById("mark-attendance-modal").style.display = "none";
      refreshAttendance();
      */
    } catch (err) {
      console.error(err);
      toast("Error saving attendance", "fa-solid fa-circle-exclamation");
    }
  }

  function editAttendance(recordId) {
    const record = allAttendanceRecords.find((r) => r.id == recordId);
    if (!record) {
      toast("Attendance record not found", "fa-solid fa-circle-exclamation");
      return;
    }

    currentStudentId = record.student_id;
    document.getElementById("attendance-modal-title").textContent =
      "Edit Attendance";
    document.getElementById("attendance-status").value = record.status;
    document.getElementById("attendance-time").value = record.time || "";
    document.getElementById("attendance-notes").value = record.notes || "";

    document.getElementById("mark-attendance-modal").style.display = "flex";
  }

  function deleteAttendance(recordId) {
    toast(
      "Are you sure you want to delete this attendance record?",
      "fa-solid fa-trash",
      {
        confirm: true,
        confirmText: "Delete",
        cancelText: "Cancel",
        onConfirm: async () => {
          try {
            // Mock delete for now - replace with actual API call
            allAttendanceRecords = allAttendanceRecords.filter(
              (r) => r.id != recordId
            );
            toast(
              "Attendance record deleted successfully",
              "fa-solid fa-check-circle"
            );
            filterAndRender();

            // Uncomment when real API endpoint is available:
            /*
            const res = await fetch(`/api/admin/attendance/${recordId}`, {
              method: "DELETE",
            });
            if (!res.ok) throw new Error("Failed to delete attendance record");
            toast("Attendance record deleted successfully", "fa-solid fa-check-circle");
            refreshAttendance();
            */
          } catch (err) {
            console.error(err);
            toast(
              "Error deleting attendance record",
              "fa-solid fa-circle-exclamation"
            );
          }
        },
      }
    );
  }

  function refreshAttendance() {
    fetchAttendanceStats();
    fetchAttendanceRecords();
  }

  // Setup export functionality
  function setupExport() {
    const exportBtn = document.getElementById("export-btn");
    const modal = document.getElementById("export-modal");
    const closeBtn = document.querySelector("#export-modal .modal-close");
    const cancelBtn = document.getElementById("export-cancel");
    const confirmBtn = document.getElementById("export-confirm");

    // Show modal
    exportBtn.addEventListener("click", () => {
      modal.style.display = "flex";
    });

    // Hide modal
    const closeModal = () => {
      modal.style.display = "none";
    };

    closeBtn.addEventListener("click", closeModal);
    cancelBtn.addEventListener("click", closeModal);

    // Close modal when clicking outside
    modal.addEventListener("click", (e) => {
      if (e.target === modal) {
        closeModal();
      }
    });

    // Export functionality
    confirmBtn.addEventListener("click", () => {
      const selectedFields = getSelectedFields();
      if (selectedFields.length === 0) {
        alert("Please select at least one field to export.");
        return;
      }

      const filteredRecords = getFilteredAttendanceRecords();
      exportToCSV(filteredRecords, selectedFields);
      closeModal();
    });
  }

  // Setup PDF export functionality
  function setupExportPDF() {
    const exportPdfBtn = document.getElementById("export-pdf-btn");
    const modal = document.getElementById("export-pdf-modal");
    const closeBtn = document.querySelector("#export-pdf-modal .modal-close");
    const cancelBtn = document.getElementById("export-pdf-cancel");
    const confirmBtn = document.getElementById("export-pdf-confirm");

    // Show modal
    exportPdfBtn.addEventListener("click", () => {
      modal.style.display = "flex";
    });

    // Hide modal
    const closeModal = () => {
      modal.style.display = "none";
    };

    closeBtn.addEventListener("click", closeModal);
    cancelBtn.addEventListener("click", closeModal);

    // Close modal when clicking outside
    modal.addEventListener("click", (e) => {
      if (e.target === modal) {
        closeModal();
      }
    });

    // Export PDF functionality
    confirmBtn.addEventListener("click", () => {
      const heading = document.getElementById("pdf-heading").value.trim();
      const subheading = document.getElementById("pdf-subheading").value.trim();
      const emptyColumns =
        parseInt(document.getElementById("pdf-empty-columns").value) || 0;
      const emptyTitles = document
        .getElementById("pdf-empty-titles")
        .value.split(",")
        .map((t) => t.trim())
        .filter((t) => t);
      const selectedFields = getSelectedPDFFields();
      if (selectedFields.length === 0) {
        alert("Please select at least one field to export.");
        return;
      }
      const filteredRecords = getFilteredAttendanceRecords();
      exportToPDF(
        filteredRecords,
        selectedFields,
        heading,
        subheading,
        emptyColumns,
        emptyTitles
      );
      closeModal();
    });
  }

  // Get selected fields from checkboxes
  function getSelectedFields() {
    const fields = [];
    const checkboxes = document.querySelectorAll(
      "#export-modal input[type='checkbox']"
    );

    checkboxes.forEach((checkbox) => {
      if (checkbox.checked) {
        const fieldId = checkbox.id.replace("export-", "");
        fields.push(fieldId);
      }
    });

    return fields;
  }

  // Get selected fields from PDF checkboxes
  function getSelectedPDFFields() {
    const fields = [];
    const checkboxes = document.querySelectorAll(
      "#export-pdf-modal input[type='checkbox']"
    );

    checkboxes.forEach((checkbox) => {
      if (checkbox.checked) {
        const fieldId = checkbox.id.replace("pdf-export-", "");
        fields.push(fieldId);
      }
    });

    return fields;
  }

  // Get currently filtered attendance records
  function getFilteredAttendanceRecords() {
    const q = (document.getElementById("attendance-search")?.value || "")
      .trim()
      .toLowerCase();
    const classId = document.getElementById("class-filter").value;
    const status = document.getElementById("status-filter").value;
    let filtered = allAttendanceRecords;

    if (classId) {
      filtered = filtered.filter((r) => String(r.class_id) === String(classId));
    }

    if (status) {
      filtered = filtered.filter((r) => r.status === status);
    }

    if (q) {
      filtered = filtered.filter((record) => {
        return (
          (record.student_name &&
            record.student_name.toLowerCase().includes(q)) ||
          (record.username && record.username.toLowerCase().includes(q)) ||
          (record.class_name && record.class_name.toLowerCase().includes(q))
        );
      });
    }

    return filtered;
  }

  // Export to CSV
  function exportToCSV(records, fields) {
    if (records.length === 0) {
      alert("No attendance records to export.");
      return;
    }

    // Create CSV header
    const headers = fields.map((field) => getAttendanceFieldDisplayName(field));
    let csvContent = headers.join(",") + "\n";

    // Add data rows
    records.forEach((record) => {
      const row = fields.map((field) => {
        let value = getAttendanceFieldValue(record, field);
        // Escape commas and quotes in CSV
        if (
          typeof value === "string" &&
          (value.includes(",") || value.includes('"') || value.includes("\n"))
        ) {
          value = '"' + value.replace(/"/g, '""') + '"';
        }
        return value;
      });
      csvContent += row.join(",") + "\n";
    });

    // Download the file
    const blob = new Blob([csvContent], { type: "text/csv;charset=utf-8;" });
    const link = document.createElement("a");

    if (link.download !== undefined) {
      const url = URL.createObjectURL(blob);
      link.setAttribute("href", url);
      link.setAttribute(
        "download",
        `attendance_export_${new Date().toISOString().split("T")[0]}.csv`
      );
      link.style.visibility = "hidden";
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    }
  }

  // Export to PDF
  function exportToPDF(
    records,
    fields,
    heading,
    subheading,
    emptyColumns,
    emptyTitles
  ) {
    if (records.length === 0) {
      alert("No attendance records to export.");
      return;
    }

    // Create HTML content
    let htmlContent = `
      <html>
        <head>
          <title>Attendance Export</title>
          <style>
            body { font-family: Arial, sans-serif; margin: 20px; }
            h1 { text-align: center; }
            h2 { text-align: center; margin-bottom: 20px; }
            table { width: 100%; border-collapse: collapse; }
            th, td { border: 1px solid #000; padding: 8px; text-align: left; }
            th { background-color: #f2f2f2; }
          </style>
        </head>
        <body>
    `;

    if (heading) {
      htmlContent += `<h1>${heading}</h1>`;
    }
    if (subheading) {
      htmlContent += `<h2>${subheading}</h2>`;
    }

    htmlContent += `
          <table>
            <thead>
              <tr>
    `;

    // Add headers based on selected fields
    fields.forEach((field) => {
      htmlContent += `<th>${getAttendanceFieldDisplayName(field)}</th>`;
    });

    // Add empty column headers with titles
    for (let i = 0; i < emptyColumns; i++) {
      const title = emptyTitles[i] || "";
      htmlContent += `<th>${title}</th>`;
    }

    htmlContent += `
              </tr>
            </thead>
            <tbody>
    `;

    // Add data rows
    records.forEach((record) => {
      htmlContent += `<tr>`;
      fields.forEach((field) => {
        const value = getAttendanceFieldValue(record, field);
        htmlContent += `<td>${value}</td>`;
      });
      // Add empty cells
      for (let i = 0; i < emptyColumns; i++) {
        htmlContent += `<td></td>`;
      }
      htmlContent += `</tr>`;
    });

    htmlContent += `
            </tbody>
          </table>
        </body>
      </html>
    `;

    // Open new window and print
    const printWindow = window.open("", "_blank");
    printWindow.document.write(htmlContent);
    printWindow.document.close();
    printWindow.print();
  }

  // Get display name for attendance field
  function getAttendanceFieldDisplayName(field) {
    const fieldNames = {
      name: "Student Name",
      index: "Index Number",
      class: "Class",
      status: "Status",
      time: "Time",
    };
    return fieldNames[field] || field;
  }

  // Get field value from attendance record
  function getAttendanceFieldValue(record, field) {
    switch (field) {
      case "name":
        return record.student_name || "Unknown Student";
      case "index":
        return record.username || "N/A";
      case "class":
        return record.class_name || "N/A";
      case "status":
        return record.status
          ? record.status.charAt(0).toUpperCase() + record.status.slice(1)
          : "N/A";
      case "time":
        return record.time || "N/A";
      default:
        return "";
    }
  }

  // Initialize
  populatePageSizeSelect();
  pageSize = parseInt(document.getElementById("page-size").value);
  setupDatePicker();
  setupSearch();
  setupModal();
  setupExport();
  setupExportPDF();
  fetchClasses();
  fetchStudents();
  refreshAttendance();
</script>

<div class="card-grid">
  <div class="card greeting-tile" style="grid-column: 1 / -1;">
    <div class="greeting-content">
      <h2 class="greeting-heading" data="clerk.greeting">Welcome, Clerk</h2>
      <p class="greeting-subtext" data="clerk.greeting_2">
        Manage school records efficiently.
      </p>
    </div>
    <img
      src="/assets/images/clerk-clipart.svg"
      alt="Illustration"
      class="greeting-img"
    />
  </div>

  <div class="card dashboard-tile">
    <div class="icon-title">
      <p class="tile-label">Total Students</p>
      <i class="fas fa-graduation-cap icon"></i>
    </div>
    <div>
      <p class="tile-value" id="total-students-tile">0</p>
    </div>
  </div>

  <div class="card dashboard-tile">
    <div class="icon-title">
      <p class="tile-label">Pending Certificates</p>
      <i class="fas fa-file-alt icon"></i>
    </div>
    <div>
      <p class="tile-value">1</p>
    </div>
  </div>

  <div class="card dashboard-tile">
    <div class="icon-title">
      <p class="tile-label">Teachers Count</p>
      <i class="fas fa-chalkboard-user icon"></i>
    </div>
    <div>
      <p class="tile-value" id="teachers-count-tile">0</p>
    </div>
  </div>

  <div class="card dashboard-tile">
    <div class="icon-title">
      <p class="tile-label">Monthly Absences</p>
      <i class="fas fa-user-times icon"></i>
    </div>
    <div>
      <p class="tile-value">1</p>
    </div>
  </div>

  <div class="card dashboard-tile flex-column h-2">
    <div class="icon-title">
      <i class="fas fa-bullhorn icon"></i>
      <p class="tile-label" data-en="Recent Announcements" data-si="අවසාන නිවේදන" data-ta="சமீபத்திய அறிவிப்புகள்">Recent Announcements</p>
    </div>
    <div>
      <ul class="tile-list" id="dashboard-announcements-list">
        <li class="text-sm">Loading...</li>
      </ul>
    </div>
  </div>

  <!-- Teachers Summary Chart -->
  <div class="card dashboard-tile flex-column">
    <div class="icon-title">
      <i class="fas fa-chalkboard-user icon"></i>
      <p class="tile-label">Teachers Summary</p>
    </div>
    <div>
      <canvas id="teachers-chart" style="max-height: 150px;"></canvas>
      <div style="margin-top: 12px; padding-top: 12px; border-top: 1px solid var(--color-border);">
        <p class="text-sm" style="margin: 4px 0;"><strong id="total-teachers">0</strong> Total Teachers</p>
        <p class="text-sm" style="margin: 4px 0;"><strong id="active-teachers">0</strong> Active</p>
      </div>
    </div>
  </div>

  <!-- Students by Grade Chart -->
  <div class="card dashboard-tile flex-column">
    <div class="icon-title">
      <i class="fas fa-chart-bar icon"></i>
      <p class="tile-label">Students by Grade</p>
    </div>
    <div>
      <canvas id="students-by-grade-chart" style="max-height: 150px;"></canvas>
      <div style="margin-top: 12px; padding-top: 12px; border-top: 1px solid var(--color-border);">
        <p class="text-sm" style="margin: 4px 0;"><strong id="total-students-count">0</strong> Total Students</p>
      </div>
    </div>
  </div>

  <!-- Classes Overview -->
  <div class="card dashboard-tile flex-column">
    <div class="icon-title">
      <i class="fas fa-layer-group icon"></i>
      <p class="tile-label">Classes Overview</p>
    </div>
    <div>
      <canvas id="classes-overview-chart" style="max-height: 150px;"></canvas>
      <div style="margin-top: 12px; padding-top: 12px; border-top: 1px solid var(--color-border);">
        <p class="text-sm" style="margin: 4px 0;"><strong id="total-classes">0</strong> Total Classes</p>
      </div>
    </div>
  </div>

  <!-- Gender Distribution -->
  <div class="card dashboard-tile flex-column">
    <div class="icon-title">
      <i class="fas fa-venus-mars icon"></i>
      <p class="tile-label">Gender Distribution</p>
    </div>
    <div style="position: relative; height: 200px; width: 100%;">
      <canvas id="gender-distribution-chart"></canvas>
    </div>
  </div>

  <!-- Password Resets -->
  <div class="card dashboard-tile flex-column">
    <div class="icon-title">
      <i class="fas fa-key icon"></i>
      <p class="tile-label" data-en="Password Resets" data-si="මුරපදය ප්‍රතිසර්ථන" data-ta="கடவுச்சொல் மீட்டமைப்புகள்">Password Resets</p>
    </div>
    <div>
      <ul class="tile-list" id="dashboard-resets-list">
        <li class="text-sm">Loading...</li>
      </ul>
    </div>
  </div>
</div>

<script>
  // Load pending password resets
  async function loadPendingResets() {
    try {
      const response = await fetch("/api/clerk/password-resets/pending");
      if (!response.ok) return;

      const resets = await response.json();
      const resetsList = document.getElementById("dashboard-resets-list");

      if (!resetsList) return;

      resetsList.innerHTML = "";

      if (resets.length === 0) {
        const noResetLi = document.createElement("li");
        noResetLi.className = "text-sm";
        noResetLi.setAttribute("data-en", "No pending requests");
        noResetLi.setAttribute("data-si", "පිටුවිලි ඉල්ලීම් නැත");
        noResetLi.setAttribute("data-ta", "நிலுவையில் உள்ள கோரிக்கைகள் இல்லை");
        noResetLi.textContent = "No pending requests";
        resetsList.appendChild(noResetLi);
        return;
      }

      resets.forEach((reset) => {
        const li = document.createElement("li");
        li.style.cssText = "padding: 12px; border-bottom: 1px solid var(--color-border); display: flex; justify-content: space-between; align-items: center;";
        li.innerHTML = `
          <div>
            <p class="subject-name" style="margin: 0; font-weight: 500;">${reset.username}</p>
            <p class="text-sm" style="margin: 4px 0 0 0; color: #666;">${reset.role}</p>
          </div>
          <div style="display: flex; gap: 8px;">
              <button onclick="approveReset(${reset.id})" class="btn btn-primary" >Approve</button>
              <button onclick="rejectReset(${reset.id})" class="btn btn-secondary" >Reject</button>
          </div>
        `;
        resetsList.appendChild(li);
      });

      if (typeof applyDirectLanguageAttributes === "function") {
        applyDirectLanguageAttributes(localStorage.getItem("lang") || "en");
      }
    } catch (err) {
      console.error("Error loading pending resets:", err);
    }
  }

  // Approve password reset
  async function approveReset(resetId) {
    try {
      const response = await fetch(`/api/clerk/password-resets/${resetId}/approve`, {
        method: "POST",
      });

      if (response.ok) {
        showToast("Password reset approved", "fa-solid fa-check");
        loadPendingResets();
      } else {
        showToast("Failed to approve reset", "fa-solid fa-circle-exclamation");
      }
    } catch (error) {
      console.error("Error approving reset:", error);
      showToast("Error approving reset", "fa-solid fa-circle-exclamation");
    }
  }

  // Reject password reset
  async function rejectReset(resetId) {
    try {
      const response = await fetch(`/api/clerk/password-resets/${resetId}/reject`, {
        method: "POST",
      });

      if (response.ok) {
        showToast("Password reset rejected", "fa-solid fa-check");
        loadPendingResets();
      } else {
        showToast("Failed to reject reset", "fa-solid fa-circle-exclamation");
      }
    } catch (error) {
      console.error("Error rejecting reset:", error);
      showToast("Error rejecting reset", "fa-solid fa-circle-exclamation");
    }
  }

  function showToast(message, icon) {
    if (typeof toast === "function") {
      toast(message, icon);
    } else {
      alert(message);
    }
  }

  // Load recent announcements
  async function loadRecentAnnouncements() {
    try {
      const response = await fetch("/api/clerk/announcements");
      if (!response.ok) return;

      const announcements = await response.json();
      const announcementsList = document.getElementById("dashboard-announcements-list");

      if (!announcementsList) return;

      announcementsList.innerHTML = "";

      if (announcements.length === 0) {
        const noAnnounceLi = document.createElement("li");
        noAnnounceLi.className = "text-sm";
        noAnnounceLi.setAttribute("data-en", "No announcements yet");
        noAnnounceLi.setAttribute("data-si", "තවම නිවේදන නැත");
        noAnnounceLi.setAttribute("data-ta", "இன்னும் அறிவிப்புகள் இல்லை");
        noAnnounceLi.textContent = "No announcements yet";
        announcementsList.appendChild(noAnnounceLi);
        return;
      }

      // Show only first 3 announcements
      announcements.slice(0, 3).forEach((announcement) => {
        const li = document.createElement("li");
        li.style.cssText = "padding: 12px; border-bottom: 1px solid var(--color-border);";
        const createdDate = new Date(announcement.created_at).toLocaleDateString();
        li.innerHTML = `
          <div>
            <p class="subject-name" style="margin: 0; font-weight: 500;">${announcement.title}</p>
            <p class="text-sm" style="margin: 4px 0 0 0; color: #666;">${createdDate}</p>
          </div>
        `;
        announcementsList.appendChild(li);
      });

      if (typeof applyDirectLanguageAttributes === "function") {
        applyDirectLanguageAttributes(localStorage.getItem("lang") || "en");
      }
    } catch (err) {
      console.error("Error loading announcements:", err);
    }
  }

  // Load total students count
  async function loadTotalStudents() {
    try {
      const response = await fetch("/api/clerk/students");
      let totalStudents = 0;

      if (response.ok) {
        const students = await response.json();
        totalStudents = students.length;
      } else {
        totalStudents = 150; // fallback mock data
      }

      document.getElementById("total-students-tile").textContent = totalStudents;
    } catch (err) {
      console.error("Error loading total students:", err);
      document.getElementById("total-students-tile").textContent = "0";
    }
  }

  // Load Teachers Summary Chart
  async function loadTeachersChart() {
    try {
      const response = await fetch("/api/clerk/teachers");
      let totalTeachers = 25;
      let activeTeachers = 22;

      if (response.ok) {
        const teachers = await response.json();
        totalTeachers = teachers.length;
        activeTeachers = teachers.filter((t) => t.status === "active").length;
      }

      document.getElementById("total-teachers").textContent = totalTeachers;
      document.getElementById("active-teachers").textContent = activeTeachers;
      document.getElementById("teachers-count-tile").textContent = totalTeachers;

      setTimeout(() => {
        const rootStyles = getComputedStyle(document.documentElement);
        const primaryColor = rootStyles
          .getPropertyValue("--color-primary")
          .trim();
        const textColor = rootStyles
          .getPropertyValue("--color-text")
          .trim();

        const ctx = document.getElementById("teachers-chart");
        if (ctx) {
          new Chart(ctx, {
            type: "doughnut",
            data: {
              labels: ["Active", "Inactive"],
              datasets: [
                {
                  data: [activeTeachers, totalTeachers - activeTeachers],
                  backgroundColor: [primaryColor, "rgba(107, 114, 128, 0.3)"],
                  borderColor: [primaryColor, "rgba(107, 114, 128, 0.5)"],
                  borderWidth: 2,
                },
              ],
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              plugins: {
                legend: {
                  position: "bottom",
                  labels: { color: textColor },
                },
              },
            },
          });
        }
      }, 100);
    } catch (err) {
      console.error("Error loading teachers chart:", err);
    }
  }

  // Load Students by Grade Chart
  async function loadStudentsByGradeChart() {
    try {
      const response = await fetch("/api/clerk/students");
      let studentsByGrade = {
        "Grade 6": 45,
        "Grade 7": 52,
        "Grade 8": 48,
        "Grade 9": 50,
        "Grade 10": 55,
      };

      if (response.ok) {
        const students = await response.json();
        studentsByGrade = {};
        students.forEach((student) => {
          const grade = student.grade || "Unknown";
          studentsByGrade[grade] = (studentsByGrade[grade] || 0) + 1;
        });
      }

      const totalStudents = Object.values(studentsByGrade).reduce(
        (a, b) => a + b,
        0
      );
      document.getElementById("total-students-count").textContent = totalStudents;

      setTimeout(() => {
        const rootStyles = getComputedStyle(document.documentElement);
        const primaryColor = rootStyles
          .getPropertyValue("--color-primary")
          .trim();
        const textColor = rootStyles
          .getPropertyValue("--color-text")
          .trim();

        const ctx = document.getElementById("students-by-grade-chart");
        if (ctx) {
          new Chart(ctx, {
            type: "bar",
            data: {
              labels: Object.keys(studentsByGrade),
              datasets: [
                {
                  label: "Students",
                  data: Object.values(studentsByGrade),
                  backgroundColor: primaryColor,
                  borderColor: primaryColor,
                  borderWidth: 2,
                  borderRadius: 4,
                },
              ],
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              indexAxis: "y",
              scales: {
                x: {
                  beginAtZero: true,
                  ticks: { stepSize: 10 },
                },
              },
              plugins: {
                legend: { display: false },
              },
            },
          });
        }
      }, 100);
    } catch (err) {
      console.error("Error loading students by grade chart:", err);
    }
  }

  // Load Classes Overview Chart
  async function loadClassesOverviewChart() {
    try {
      const response = await fetch("/api/clerk/classes");
      let classes = [
        { name: "Grade 6-A", students: 35 },
        { name: "Grade 6-B", 1: 40 },
        { name: "Grade 7-A", students: 38 },
        { name: "Grade 7-B", students: 42 },
      ];

      if (response.ok) {
        classes = await response.json();
      }

      document.getElementById("total-classes").textContent = classes.length;

      setTimeout(() => {
        const rootStyles = getComputedStyle(document.documentElement);
        const primaryColor = rootStyles
          .getPropertyValue("--color-primary")
          .trim();
        const textColor = rootStyles
          .getPropertyValue("--color-text")
          .trim();

        const ctx = document.getElementById("classes-overview-chart");
        if (ctx) {
          new Chart(ctx, {
            type: "bar",
            data: {
              labels: classes.map((c) => c.name || c.class_name),
              datasets: [
                {
                  label: "Class Size",
                  data: classes.map((c) => c.students || c.student_count || 0),
                  backgroundColor: primaryColor,
                  borderColor: primaryColor,
                  borderWidth: 2,
                  borderRadius: 4,
                },
              ],
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              scales: {
                y: {
                  beginAtZero: true,
                  ticks: { stepSize: 10 },
                },
              },
              plugins: {
                legend: { display: false },
              },
            },
          });
        }
      }, 100);
    } catch (err) {
      console.error("Error loading classes overview chart:", err);
    }
  }

  // Load Gender Distribution Chart
  async function loadGenderDistributionChart() {
    try {
      const response = await fetch("/api/clerk/students");
      let maleCount = 130;
      let femaleCount = 120;

      if (response.ok) {
        const students = await response.json();
        maleCount = students.filter(
          (s) => s.gender && s.gender.toLowerCase() === "male"
        ).length;
        femaleCount = students.filter(
          (s) => s.gender && s.gender.toLowerCase() === "female"
        ).length;
      }

      // Ensure we have at least some data
      if (maleCount === 0 && femaleCount === 0) {
        maleCount = 130;
        femaleCount = 120;
      }

      setTimeout(() => {
        const rootStyles = getComputedStyle(document.documentElement);
        const primaryColor = rootStyles
          .getPropertyValue("--color-primary")
          .trim();
        const primaryHover = rootStyles
          .getPropertyValue("--color-primary-hover")
          .trim();
        const textColor = rootStyles
          .getPropertyValue("--color-text")
          .trim();

        const canvas = document.getElementById("gender-distribution-chart");
        if (canvas && canvas.getContext) {
          const ctx = canvas.getContext("2d");
          new Chart(ctx, {
            type: "pie",
            data: {
              labels: ["Male", "Female"],
              datasets: [
                {
                  data: [maleCount, femaleCount],
                  backgroundColor: [primaryColor, primaryHover],
                  borderColor: [primaryColor, primaryHover],
                  borderWidth: 2,
                },
              ],
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              plugins: {
                legend: {
                  position: "bottom",
                  labels: { color: textColor },
                },
              },
            },
          });
        }
      }, 100);
    } catch (err) {
      console.error("Error loading gender distribution chart:", err);
    }
  }

  // Initialize dashboard
  function initDashboard() {
    loadTotalStudents();
    loadPendingResets();
    loadRecentAnnouncements();
    loadTeachersChart();
    loadStudentsByGradeChart();
    loadClassesOverviewChart();
    loadGenderDistributionChart();
  }

  initDashboard();


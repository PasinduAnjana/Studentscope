<div class="card-grid">
  <div class="card greeting-tile" style="grid-column: 1 / -1;">
    <div class="greeting-content">
      <h2 class="greeting-heading" data="clerk.greeting">Welcome, Clerk</h2>
      <p class="greeting-subtext" data="clerk.greeting_2">
        Manage school records efficiently.
      </p>
    </div>
    <img src="/assets/images/clerk-clipart.svg" alt="Illustration" class="greeting-img" />
  </div>
  <div class="card dashboard-tile">
    <div class="icon-title">
      <p class="tile-label" data-en="Total Students" data-si="මුළු සිසුන්" data-ta="மொத்த மாணவர்கள்">Total Students</p>
      <i class="fas fa-graduation-cap icon"></i>
    </div>
    <div>
      <p class="tile-value" id="total-students-tile">0</p>
    </div>
  </div>

  <div class="card dashboard-tile">
    <div class="icon-title">
      <p class="tile-label" data-en="Total Teachers" data-si="මුළු ගුරුවරුන්" data-ta="மொத்த ஆசிரியர்கள்">Total Teachers
      </p>
      <i class="fas fa-chalkboard-user icon"></i>
    </div>
    <div>
      <p class="tile-value" id="teachers-count-tile">0</p>
    </div>
  </div>

  <div class="card dashboard-tile">
    <div class="icon-title">
      <p class="tile-label" data-en="Total Classes" data-si="මුළු පන්ති" data-ta="மொத்த வகுப்புகள்">Total Classes</p>
      <i class="fas fa-layer-group icon"></i>
    </div>
    <div>
      <p class="tile-value" id="total-classes-tile">0</p>
    </div>
  </div>

  <!-- Today's Attendance Chart -->
  <div class="card dashboard-tile h-2" id="dashboard-attendance-card">
    <div class="icon-title">
      <i class="fas fa-clipboard-check icon"></i>
      <p class="tile-label" data-en="Today's Attendance" data-si="අද පැමිණීම්" data-ta="இன்றைய வருகை">Today's Attendance
      </p>
    </div>
    <div id="dashboard-attendance-content">
      <!-- Chart will be injected by JS -->
    </div>
  </div>

  <!-- Unmarked Classes -->
  <div class="card dashboard-tile">
    <div class="icon-title">
      <i class="fas fa-exclamation-triangle icon"></i>
      <p class="tile-label" data-en="Unmarked Classes" data-si="සලකුණු නොකළ පන්ති" data-ta="குறிக்கப்படாத வகுப்புகள்">
        Unmarked Classes</p>
    </div>
    <div>
      <p class="tile-value" id="unmarked-classes-count">0</p>
      <button class="btn" style="margin-top: 10px; font-size: 0.85rem;" onclick="showUnmarkedClassesModal()"
        id="view-unmarked-btn">
        <i class="fas fa-eye"></i>
        <span data-en="View List" data-si="ලැයිස්තුව බලන්න" data-ta="பட்டியலைக் காண்க">View List</span>
      </button>
    </div>
  </div>

  <div class="card dashboard-tile flex-column h-2">
    <div class="icon-title">
      <i class="fas fa-bullhorn icon"></i>
      <p class="tile-label" data-en="Recent Announcements" data-si="අවසාන නිවේදන" data-ta="சமீபத்திய அறிவிப்புகள்">
        Recent Announcements</p>
    </div>
    <div>
      <ul class="tile-list" id="dashboard-announcements-list">
        <li class="text-sm">Loading...</li>
      </ul>
    </div>
  </div>

  <!-- Alerts -->
  <div class="card dashboard-tile flex-column h-2">
    <div class="icon-title">
      <i class="fas fa-triangle-exclamation icon"></i>
      <p class="tile-label" data-en="Alerts" data-si="ඇඟවීම්" data-ta="எச்சரிக்கைகள்">Alerts</p>
    </div>
    <div>
      <ul class="tile-list" id="dashboard-alerts-list">
        <li class="text-sm">Loading...</li>
      </ul>
    </div>
  </div>

  <!-- Password Resets -->
  <div class="card dashboard-tile flex-column">
    <div class="icon-title">
      <i class="fas fa-key icon"></i>
      <p class="tile-label" data-en="Password Resets" data-si="මුරපදය ප්‍රතිසර්ථන" data-ta="கடவுச்சொல் மீட்டமைப்புகள்">
        Password Resets</p>
    </div>
    <div>
      <ul class="tile-list" id="dashboard-resets-list">
        <li class="text-sm">Loading...</li>
      </ul>
    </div>
  </div>
</div>

<!-- Unmarked Classes Modal -->
<modal-dialog id="unmarked-classes-modal" title="Classes Without Attendance Today">
  <ul id="unmarked-classes-list" style="list-style: none; padding: 0; margin: 0;">
    <li class="text-sm">Loading...</li>
  </ul>
</modal-dialog>

<script>
  // Load pending password resets
  async function loadPendingResets() {
    try {
      const response = await fetch("/api/clerk/password-resets/pending");
      if (!response.ok) return;

      const resets = await response.json();
      const resetsList = document.getElementById("dashboard-resets-list");

      if (!resetsList) return;

      resetsList.innerHTML = "";

      if (resets.length === 0) {
        const noResetLi = document.createElement("li");
        noResetLi.className = "text-sm";
        noResetLi.setAttribute("data-en", "No pending requests");
        noResetLi.setAttribute("data-si", "පිටුවිලි ඉල්ලීම් නැත");
        noResetLi.setAttribute("data-ta", "நிலுவையில் உள்ள கோரிக்கைகள் இல்லை");
        noResetLi.textContent = "No pending requests";
        resetsList.appendChild(noResetLi);
        return;
      }

      resets.forEach((reset) => {
        const li = document.createElement("li");
        li.style.cssText = "padding: 12px; border-bottom: 1px solid var(--color-border); display: flex; justify-content: space-between; align-items: center;";
        li.innerHTML = `
          <div>
            <p class="subject-name" style="margin: 0; font-weight: 500;">${reset.username}</p>
            <p class="text-sm" style="margin: 4px 0 0 0; color: #666;">${reset.role}</p>
          </div>
          <div style="display: flex; gap: 8px;">
              <button onclick="approveReset(${reset.id})" class="btn btn-primary" >Approve</button>
              <button onclick="rejectReset(${reset.id})" class="btn btn-secondary" >Reject</button>
          </div>
        `;
        resetsList.appendChild(li);
      });

      if (typeof applyDirectLanguageAttributes === "function") {
        applyDirectLanguageAttributes(localStorage.getItem("lang") || "en");
      }
    } catch (err) {
      console.error("Error loading pending resets:", err);
    }
  }

  // Approve password reset
  async function approveReset(resetId) {
    try {
      const response = await fetch(`/api/clerk/password-resets/${resetId}/approve`, {
        method: "POST",
      });

      if (response.ok) {
        showToast("Password reset approved", "fa-solid fa-check");
        loadPendingResets();
      } else {
        showToast("Failed to approve reset", "fa-solid fa-circle-exclamation");
      }
    } catch (error) {
      console.error("Error approving reset:", error);
      showToast("Error approving reset", "fa-solid fa-circle-exclamation");
    }
  }

  // Reject password reset
  async function rejectReset(resetId) {
    try {
      const response = await fetch(`/api/clerk/password-resets/${resetId}/reject`, {
        method: "POST",
      });

      if (response.ok) {
        showToast("Password reset rejected", "fa-solid fa-check");
        loadPendingResets();
      } else {
        showToast("Failed to reject reset", "fa-solid fa-circle-exclamation");
      }
    } catch (error) {
      console.error("Error rejecting reset:", error);
      showToast("Error rejecting reset", "fa-solid fa-circle-exclamation");
    }
  }

  function showToast(message, icon) {
    if (typeof toast === "function") {
      toast(message, icon);
    } else {
      alert(message);
    }
  }

  // Load recent announcements
  async function loadRecentAnnouncements() {
    try {
      const response = await fetch("/api/clerk/announcements");
      if (!response.ok) return;

      const announcements = await response.json();
      const announcementsList = document.getElementById("dashboard-announcements-list");

      if (!announcementsList) return;

      announcementsList.innerHTML = "";

      if (announcements.length === 0) {
        const noAnnounceLi = document.createElement("li");
        noAnnounceLi.className = "text-sm";
        noAnnounceLi.setAttribute("data-en", "No announcements yet");
        noAnnounceLi.setAttribute("data-si", "තවම නිවේදන නැත");
        noAnnounceLi.setAttribute("data-ta", "இன்னும் அறிவிப்புகள் இல்லை");
        noAnnounceLi.textContent = "No announcements yet";
        announcementsList.appendChild(noAnnounceLi);
        return;
      }

      // Show only first 3 announcements
      announcements.slice(0, 3).forEach((announcement) => {
        const li = document.createElement("li");
        li.style.cssText = "padding: 12px; border-bottom: 1px solid var(--color-border);";
        const createdDate = new Date(announcement.created_at).toLocaleDateString();
        li.innerHTML = `
          <div>
            <p class="subject-name" style="margin: 0; font-weight: 500;">${announcement.title}</p>
            <p class="text-sm" style="margin: 4px 0 0 0; color: #666;">${createdDate}</p>
          </div>
        `;
        announcementsList.appendChild(li);
      });

      if (typeof applyDirectLanguageAttributes === "function") {
        applyDirectLanguageAttributes(localStorage.getItem("lang") || "en");
      }
    } catch (err) {
      console.error("Error loading announcements:", err);
    }
  }

  // Load total students count
  async function loadTotalStudents() {
    try {
      const response = await fetch("/api/clerk/students");
      if (response.ok) {
        const students = await response.json();
        document.getElementById("total-students-tile").textContent = students.length;
      }
    } catch (err) {
      console.error("Error loading total students:", err);
      document.getElementById("total-students-tile").textContent = "0";
    }
  }

  // Load total teachers count
  async function loadTotalTeachers() {
    try {
      const response = await fetch("/api/clerk/teachers");
      if (response.ok) {
        const teachers = await response.json();
        const activeTeachers = teachers.filter((t) => t.status === "active").length;
        document.getElementById("teachers-count-tile").textContent = teachers.length;
      }
    } catch (err) {
      console.error("Error loading teachers count:", err);
      document.getElementById("teachers-count-tile").textContent = "0";
    }
  }

  // Load attendance summary chart
  async function loadAttendanceSummary() {
    const container = document.getElementById("dashboard-attendance-content");
    try {
      const response = await fetch("/api/clerk/attendance/stats");
      if (!response.ok) throw new Error("Failed to fetch");
      const stats = await response.json();

      const presentCount = stats.presentToday || 0;
      const absentCount = stats.absentToday || 0;
      const totalStudents = stats.totalStudents || 0;
      const notMarked = totalStudents - presentCount - absentCount;

      container.innerHTML = `<canvas id="clerkAttendanceChart" height="120"></canvas>`;

      setTimeout(() => {
        const rootStyles = getComputedStyle(document.documentElement);
        const primaryColor = rootStyles.getPropertyValue("--color-primary").trim();

        // Center text plugin (same as teacher dashboard)
        const centerTextPlugin = {
          id: "centerText",
          beforeDraw(chart, args, options) {
            if (chart.config.type !== "doughnut") return;
            const { ctx, width, height } = chart;
            ctx.save();
            const fontSize = (height / 160).toFixed(2);
            ctx.font = `${fontSize}em sans-serif`;
            ctx.textBaseline = "middle";
            ctx.textAlign = "center";
            ctx.fillStyle = options.color || primaryColor;
            const text = options.text || "";
            ctx.fillText(
              text,
              width / 2,
              chart.getDatasetMeta(0).data[0]?.y || height / 2
            );
            ctx.restore();
          },
        };

        const currentLang = localStorage.getItem("lang") || "en";
        const labels = [
          { en: "Present", si: "පැමිණි", ta: "வருகை" },
          { en: "Absent", si: "නොපැමිණි", ta: "இல்லை" },
          { en: "Not Marked", si: "සලකුණු නැත", ta: "குறிக்கப்படவில்லை" },
        ];

        const percentage = totalStudents > 0 ? Math.round((presentCount / totalStudents) * 100) : 0;

        new Chart(document.getElementById("clerkAttendanceChart"), {
          type: "doughnut",
          data: {
            labels: labels.map(l => l[currentLang] || l.en),
            datasets: [{
              data: [presentCount, absentCount, notMarked],
              backgroundColor: [primaryColor, primaryColor + "40", primaryColor + "18"],
              borderRadius: 20,
            }],
          },
          options: {
            responsive: true,
            cutout: "80%",
            borderColor: "transparent",
            plugins: {
              legend: { display: false },
              title: {
                display: true,
                text: `${labels[0][currentLang] || "Present"}: ${presentCount} | ${labels[1][currentLang] || "Absent"}: ${absentCount} | ${labels[2][currentLang] || "Not Marked"}: ${notMarked}`,
                font: { size: 12 },
                position: "bottom",
              },
              centerText: {
                text: `${percentage}%`,
                color: primaryColor,
              },
            },
          },
          plugins: [centerTextPlugin],
        });
      }, 100);
    } catch (err) {
      console.error("Error loading attendance summary:", err);
      container.innerHTML = `<p class="text-sm" style="color: #666;">Error loading attendance data</p>`;
    }
  }

  // Load unmarked classes
  let unmarkedClassesData = [];
  async function loadUnmarkedClasses() {
    try {
      const response = await fetch("/api/clerk/attendance/unmarked-classes");
      if (response.ok) {
        const data = await response.json();
        unmarkedClassesData = data.classes || [];
        document.getElementById("unmarked-classes-count").textContent = data.count;

        // Hide button if no unmarked classes
        const btn = document.getElementById("view-unmarked-btn");
        if (btn) btn.style.display = data.count === 0 ? "none" : "";
      }
    } catch (err) {
      console.error("Error loading unmarked classes:", err);
      document.getElementById("unmarked-classes-count").textContent = "0";
    }
  }

  function showUnmarkedClassesModal() {
    const modal = document.getElementById("unmarked-classes-modal");
    const list = document.getElementById("unmarked-classes-list");
    list.innerHTML = "";

    if (unmarkedClassesData.length === 0) {
      list.innerHTML = `<li class="text-sm" style="padding: 12px; color: #666;">All classes have marked attendance today!</li>`;
    } else {
      unmarkedClassesData.forEach(cls => {
        const li = document.createElement("li");
        li.style.cssText = "padding: 12px; border-bottom: 1px solid var(--color-border); display: flex; align-items: center; gap: 10px;";
        li.innerHTML = `
          <i class="fas fa-circle-xmark" style="color: var(--color-primary); opacity: 0.5;"></i>
          <span class="subject-name" style="font-weight: 500;">${cls.name}</span>
        `;
        list.appendChild(li);
      });
    }

    modal.open();
  }

  // Load total classes count
  async function loadTotalClasses() {
    try {
      const response = await fetch("/api/clerk/classes");
      if (response.ok) {
        const classes = await response.json();
        document.getElementById("total-classes-tile").textContent = classes.length;
      }
    } catch (err) {
      console.error("Error loading total classes:", err);
      document.getElementById("total-classes-tile").textContent = "0";
    }
  }

  // Load alerts
  async function loadAlerts() {
    try {
      const response = await fetch("/api/clerk/alerts");
      if (!response.ok) return;

      const alerts = await response.json();
      const alertsList = document.getElementById("dashboard-alerts-list");
      if (!alertsList) return;

      alertsList.innerHTML = "";

      if (alerts.length === 0) {
        const noAlertLi = document.createElement("li");
        noAlertLi.className = "text-sm";
        noAlertLi.style.cssText = "padding: 12px; color: #666; display: flex; align-items: center; gap: 8px;";
        noAlertLi.innerHTML = `<i class="fas fa-circle-check" style="color: var(--color-primary);"></i> No alerts — everything looks good!`;
        alertsList.appendChild(noAlertLi);
        return;
      }

      const currentLang = localStorage.getItem("lang") || "en";

      alerts.forEach(alert => {
        const li = document.createElement("li");

        li.style.cssText = "padding: 10px 12px; display: flex; align-items: center; gap: 10px;";
        li.innerHTML = `
          <i class="${alert.icon}" style="color: var(--color-primary); font-size: 1rem; min-width: 20px;"></i>
          <span style="flex: 1; font-size: 0.9rem; color: var(--color-text);">${alert.message[currentLang] || alert.message.en}</span>
          <span style="background: var(--color-primary); color: var(--color-bg); border-radius: 12px; padding: 2px 10px; font-size: 0.8rem; font-weight: 600; min-width: 24px; text-align: center;">${alert.count}</span>
        `;
        alertsList.appendChild(li);
      });

    } catch (err) {
      console.error("Error loading alerts:", err);
    }
  }

  // Initialize dashboard
  function initDashboard() {
    loadTotalStudents();
    loadTotalTeachers();
    loadTotalClasses();
    loadAttendanceSummary();
    loadUnmarkedClasses();
    loadAlerts();
    loadPendingResets();
    loadRecentAnnouncements();
  }

  initDashboard();
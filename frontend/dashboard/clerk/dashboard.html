<div class="card-grid">
  <div class="card greeting-tile w-2">
    <div class="greeting-content">
      <h2 class="greeting-heading" data="clerk.greeting">Welcome, Clerk</h2>
      <p class="greeting-subtext" data="clerk.greeting_2">
        Manage school records efficiently.
      </p>
    </div>
    <img
      src="/assets/images/clerk-clipart.svg"
      alt="Illustration"
      class="greeting-img"
    />
  </div>

  <div class="card dashboard-tile">
    <div class="icon-title">
      <p class="tile-label">Total Students</p>
      <i class="fas fa-graduation-cap icon"></i>
    </div>
    <div>
      <p class="tile-value">3</p>
    </div>
  </div>

  <div class="card dashboard-tile">
    <div class="icon-title">
      <p class="tile-label">Pending Certificates</p>
      <i class="fas fa-file-alt icon"></i>
    </div>
    <div>
      <p class="tile-value">1</p>
    </div>
  </div>

  <div class="card dashboard-tile">
    <div class="icon-title">
      <p class="tile-label">Unread Notifications</p>
      <i class="fas fa-bell icon"></i>
    </div>
    <div>
      <p class="tile-value">1</p>
    </div>
  </div>

  <div class="card dashboard-tile">
    <div class="icon-title">
      <p class="tile-label">Monthly Absences</p>
      <i class="fas fa-user-times icon"></i>
    </div>
    <div>
      <p class="tile-value">1</p>
    </div>
  </div>

  <div class="card dashboard-tile flex-column h-2">
    <div class="icon-title">
      <i class="fas fa-bullhorn icon"></i>
      <p class="tile-label" data-en="Recent Announcements" data-si="අවසාන නිවේදන" data-ta="சமீபத்திய அறிவிப்புகள்">Recent Announcements</p>
    </div>
    <div>
      <ul class="tile-list" id="dashboard-announcements-list">
        <li class="text-sm">Loading...</li>
      </ul>
    </div>
  </div>

  <div class="card dashboard-tile flex-column h-2">
    <div class="icon-title">
      <i class="fas fa-calendar-alt icon"></i>
      <p class="tile-label">Upcoming Events</p>
    </div>
    <div>
      <ul class="tile-list">
        <li>
          <div>
            <strong>Sports Day</strong>
            <span>1/20/2024 • 8:00 AM</span>
          </div>
          <div>
            <button class="icon-btn" title="Edit">
              <i class="fas fa-edit"></i>
            </button>
            <button class="icon-btn" title="Delete">
              <i class="fas fa-trash-alt"></i>
            </button>
          </div>
        </li>
        <li>
          <div>
            <strong>Parents Meeting</strong>
            <span>1/15/2024 • 2:00 PM</span>
          </div>
          <div>
            <button class="icon-btn" title="Edit">
              <i class="fas fa-edit"></i>
            </button>
            <button class="icon-btn" title="Delete">
              <i class="fas fa-trash-alt"></i>
            </button>
          </div>
        </li>
        <li>
          <div>
            <strong>Exam Results Release</strong>
            <span>1/18/2024 • 10:00 AM</span>
          </div>
          <div>
            <button class="icon-btn" title="Edit">
              <i class="fas fa-edit"></i>
            </button>
            <button class="icon-btn" title="Delete">
              <i class="fas fa-trash-alt"></i>
            </button>
          </div>
        </li>
      </ul>
      <button class="btn">
        <i class="fas fa-plus"></i>
        <span>Add Events</span>
      </button>
    </div>
  </div>

  <!-- Password Resets -->
  <div class="card dashboard-tile flex-column">
    <div class="icon-title">
      <i class="fas fa-key icon"></i>
      <p class="tile-label" data-en="Password Resets" data-si="මුරපදය ප්‍රතිසර්ථන" data-ta="கடவுச்சொல் மீட்டமைப்புகள்">Password Resets</p>
    </div>
    <div>
      <ul class="tile-list" id="dashboard-resets-list">
        <li class="text-sm">Loading...</li>
      </ul>
    </div>
  </div>
</div>

<script>
  // Load pending password resets
  async function loadPendingResets() {
    try {
      const response = await fetch("/api/clerk/password-resets/pending");
      if (!response.ok) return;

      const resets = await response.json();
      const resetsList = document.getElementById("dashboard-resets-list");

      if (!resetsList) return;

      resetsList.innerHTML = "";

      if (resets.length === 0) {
        const noResetLi = document.createElement("li");
        noResetLi.className = "text-sm";
        noResetLi.setAttribute("data-en", "No pending requests");
        noResetLi.setAttribute("data-si", "පිටුවිලි ඉල්ලීම් නැත");
        noResetLi.setAttribute("data-ta", "நிலுவையில் உள்ள கோரிக்கைகள் இல்லை");
        noResetLi.textContent = "No pending requests";
        resetsList.appendChild(noResetLi);
        return;
      }

      resets.forEach((reset) => {
        const li = document.createElement("li");
        li.style.cssText = "padding: 12px; border-bottom: 1px solid var(--color-border); display: flex; justify-content: space-between; align-items: center;";
        li.innerHTML = `
          <div>
            <p class="subject-name" style="margin: 0; font-weight: 500;">${reset.username}</p>
            <p class="text-sm" style="margin: 4px 0 0 0; color: #666;">${reset.role}</p>
          </div>
          <div style="display: flex; gap: 8px;">
              <button onclick="approveReset(${reset.id})" class="btn btn-primary" >Approve</button>
              <button onclick="rejectReset(${reset.id})" class="btn btn-secondary" >Reject</button>
          </div>
        `;
        resetsList.appendChild(li);
      });

      if (typeof applyDirectLanguageAttributes === "function") {
        applyDirectLanguageAttributes(localStorage.getItem("lang") || "en");
      }
    } catch (err) {
      console.error("Error loading pending resets:", err);
    }
  }

  // Approve password reset
  async function approveReset(resetId) {
    try {
      const response = await fetch(`/api/clerk/password-resets/${resetId}/approve`, {
        method: "POST",
      });

      if (response.ok) {
        showToast("Password reset approved", "fa-solid fa-check");
        loadPendingResets();
      } else {
        showToast("Failed to approve reset", "fa-solid fa-circle-exclamation");
      }
    } catch (error) {
      console.error("Error approving reset:", error);
      showToast("Error approving reset", "fa-solid fa-circle-exclamation");
    }
  }

  // Reject password reset
  async function rejectReset(resetId) {
    try {
      const response = await fetch(`/api/clerk/password-resets/${resetId}/reject`, {
        method: "POST",
      });

      if (response.ok) {
        showToast("Password reset rejected", "fa-solid fa-check");
        loadPendingResets();
      } else {
        showToast("Failed to reject reset", "fa-solid fa-circle-exclamation");
      }
    } catch (error) {
      console.error("Error rejecting reset:", error);
      showToast("Error rejecting reset", "fa-solid fa-circle-exclamation");
    }
  }

  function showToast(message, icon) {
    if (typeof toast === "function") {
      toast(message, icon);
    } else {
      alert(message);
    }
  }

  // Load recent announcements
  async function loadRecentAnnouncements() {
    try {
      const response = await fetch("/api/clerk/announcements");
      if (!response.ok) return;

      const announcements = await response.json();
      const announcementsList = document.getElementById("dashboard-announcements-list");

      if (!announcementsList) return;

      announcementsList.innerHTML = "";

      if (announcements.length === 0) {
        const noAnnounceLi = document.createElement("li");
        noAnnounceLi.className = "text-sm";
        noAnnounceLi.setAttribute("data-en", "No announcements yet");
        noAnnounceLi.setAttribute("data-si", "තවම නිවේදන නැත");
        noAnnounceLi.setAttribute("data-ta", "இன்னும் அறிவிப்புகள் இல்லை");
        noAnnounceLi.textContent = "No announcements yet";
        announcementsList.appendChild(noAnnounceLi);
        return;
      }

      // Show only first 3 announcements
      announcements.slice(0, 3).forEach((announcement) => {
        const li = document.createElement("li");
        li.style.cssText = "padding: 12px; border-bottom: 1px solid var(--color-border);";
        const createdDate = new Date(announcement.created_at).toLocaleDateString();
        li.innerHTML = `
          <div>
            <p class="subject-name" style="margin: 0; font-weight: 500;">${announcement.title}</p>
            <p class="text-sm" style="margin: 4px 0 0 0; color: #666;">${createdDate}</p>
          </div>
        `;
        announcementsList.appendChild(li);
      });

      if (typeof applyDirectLanguageAttributes === "function") {
        applyDirectLanguageAttributes(localStorage.getItem("lang") || "en");
      }
    } catch (err) {
      console.error("Error loading announcements:", err);
    }
  }

  // Initialize dashboard
  function initDashboard() {
    loadPendingResets();
    loadRecentAnnouncements();
  }

  initDashboard();


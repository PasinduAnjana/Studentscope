<style>
  /* Action buttons styling */
  .action-buttons {
    display: flex;
    gap: 5px;
    justify-content: center;
  }

  /* Form grid styling */
  .teacher-form-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 15px;
  }

  .teacher-form-grid .input-group {
    margin-bottom: 0;
  }
</style>

<section class="section">
  <h2 class="heading">
    <i class="fas fa-users"></i>
    <span>Teacher Management</span>
  </h2>
  <div class="card">
    <div class="flex-between mb-2">
      <h1 class="title">Teachers</h1>
      <button
        id="add-teacher-btn"
        class="btn btn-primary"
        onclick="openAddTeacherModal()"
      >
        <i class="fas fa-user-plus"></i> Add Teacher
      </button>
    </div>
    <data-table id="teachers-table">
        <div slot="filters">
            <div class="input-group">
                <select id="level-filter">
                    <option value="all">All Grades</option>
                </select>
            </div>
        </div>
    </data-table>
  </div>
</section>

<!-- Add/Edit Teacher Modal -->
<modal-dialog id="teacher-modal" title="Add Teacher">
      <div class="teacher-form-grid">
        <div class="input-group">
          <label for="teacher-full-name">Full Name:</label>
          <input
            type="text"
            id="teacher-full-name"
            placeholder="Enter full name"
            minlength="2"
            maxlength="100"
            pattern="[a-zA-Z\s\-']+"
            title="Name can only contain letters, spaces, hyphens, and apostrophes"
          />
        </div>
        <div class="input-group">
          <label for="teacher-nic">NIC:</label>
          <input
            type="text"
            id="teacher-nic"
            placeholder="Enter NIC"
            minlength="5"
            maxlength="20"
          />
        </div>
        <div class="input-group">
          <label for="teacher-birthday">Birthday:</label>
          <input type="date" id="teacher-birthday" />
        </div>
        <div class="input-group">
          <label for="teacher-level">Grade:</label>
          <select id="teacher-level">
            <option value="">Select Grade</option>
            <option value="1">Grade 1</option>
            <option value="2">Grade 2</option>
            <option value="3">Grade 3</option>
          </select>
        </div>
        <div class="input-group">
          <label for="teacher-address">Address:</label>
          <input
            type="text"
            id="teacher-address"
            placeholder="Enter address"
            maxlength="255"
          />
        </div>
        <div class="input-group">
          <label for="teacher-phone">Phone Number:</label>
          <input
            type="tel"
            id="teacher-phone"
            placeholder="Enter phone number"
            pattern="[0-9\s\-\+\(\)]+"
            title="Phone number can only contain digits, spaces, hyphens, plus sign, and parentheses"
            minlength="7"
            maxlength="20"
          />
        </div>
        <div class="input-group">
          <label for="teacher-past-schools">Past Schools:</label>
          <input
            type="text"
            id="teacher-past-schools"
            placeholder="Enter past schools"
          />
        </div>
        <div class="input-group">
          <label for="teacher-appointment-date">Appointment Date:</label>
          <input type="date" id="teacher-appointment-date" />
        </div>
        <div class="input-group" style="grid-column: span 2">
          <label for="teacher-first-appointment-date"
            >First Appointment Date:</label
          >
          <input type="date" id="teacher-first-appointment-date" />
        </div>
      </div>
    
    <div style="display: flex; justify-content: flex-end; gap: 12px; margin-top: 24px;">
      <button id="modal-cancel" class="btn btn-secondary">Cancel</button>
      <button id="modal-save" class="btn btn-primary">Save</button>
    </div>
</modal-dialog>

<script>
  let allTeachers = [];
  let editingTeacher = null;
  let searchableLevelFilter = null;
  let searchableTeacherLevel = null;

  function initTable() {
    const table = document.getElementById("teachers-table");
    table.setColumns([
        { key: "full_name", header: "Name", searchable: true },
        { key: "nic", header: "NIC", searchable: true },
        { key: "level", header: "Grade" },
        { 
            key: "birthday", 
            header: "Birthday", 
            render: (row) => row.birthday ? new Date(row.birthday).toLocaleDateString() : "" 
        },
        { key: "phone_number", header: "Phone" },
        { 
            key: "appointment_date", 
            header: "Appointment Date", 
            render: (row) => row.appointment_date ? new Date(row.appointment_date).toLocaleDateString() : "" 
        },
        {
            key: "actions",
            header: "Actions",
            render: (row) => {
                const div = document.createElement("div");
                div.className = "action-buttons";
                div.innerHTML = `
                    <button class="btn-icon btn-edit" onclick="editTeacher(${row.teacher_id})" title="Edit">
                      <i class="fas fa-edit"></i>
                    </button>
                    <button class="btn-icon btn-delete" onclick="deleteTeacher(${row.teacher_id})" title="Delete">
                      <i class="fas fa-trash"></i>
                    </button>
                `;
                return div;
            }
        }
    ]);
    
    // Setup Level Filter
    const levelFilter = document.getElementById("level-filter");
    if(levelFilter) {
        levelFilter.addEventListener("change", () => {
             const val = levelFilter.value;
             table.addFilter("level", (row) => {
                 return val === "all" || val === "" || row.level == val;
             });
        });
    }

    table.setEmptyState("No teachers found", "fas fa-users-slash");
  }

  function fetchTeachers() {
      api.clerk.teachers.getAll()
        .then((res) => {
          if (!res.ok) throw new Error("Failed to fetch teachers");
          return res.json();
        })
        .then((data) => {
          allTeachers = data;
          document.getElementById("teachers-table").setData(allTeachers);
        })
        .catch((err) => {
          console.error(err);
          document.getElementById("teachers-table").setData([]);
          document.getElementById("teachers-table").setEmptyState("Error loading teachers", "fas fa-exclamation-triangle");
        });
    }

  // No manual setupSearch needed for data-table

  function setupAddButton() {
    const modal = document.getElementById("teacher-modal");
    const saveBtn = document.getElementById("modal-save");

    // helper to open modal
    function openAddModal() {
      editingTeacher = null;
        if (modal) {
            modal.setTitle("Add Teacher");
            clearModal();
            modal.open();
        }
    }

    // If the button exists at setup time, attach directly. Otherwise use delegation (works when page is injected later).
    const addBtn = document.getElementById("add-teacher-btn");
    if (addBtn) {
      addBtn.addEventListener("click", openAddModal);
    } else {
      // delegation fallback
      document.addEventListener("click", function delegationHandler(e) {
        const target = e.target.closest && e.target.closest("#add-teacher-btn");
        if (target) openAddModal();
      });
    }

    // const closeBtn = document.querySelector("#teacher-modal .modal-close");
    const cancelBtn = document.getElementById("modal-cancel");

    const closeModal = () => {
      if (modal) modal.close();
    };

    // if (closeBtn) closeBtn.addEventListener("click", closeModal);
    if (cancelBtn) cancelBtn.addEventListener("click", closeModal);

    // if (modal) {
    //   modal.addEventListener("click", (e) => {
    //     if (e.target === modal) closeModal();
    //   });
    // }

    if (saveBtn) saveBtn.addEventListener("click", saveTeacher);
  }

  function clearModal() {
    document.getElementById("teacher-full-name").value = "";
    document.getElementById("teacher-nic").value = "";
    document.getElementById("teacher-birthday").value = "";
    document.getElementById("teacher-level").value = "";
    document.getElementById("teacher-address").value = "";
    document.getElementById("teacher-phone").value = "";
    document.getElementById("teacher-past-schools").value = "";
    document.getElementById("teacher-appointment-date").value = "";
    document.getElementById("teacher-first-appointment-date").value = "";
    // update searchable display if present
    updateSearchableDisplay("teacher-level");
  }

  function validateTeacherForm() {
    const fullName = document.getElementById("teacher-full-name").value.trim();
    const nic = document.getElementById("teacher-nic").value.trim();
    const birthday = document.getElementById("teacher-birthday").value;
    const level = document.getElementById("teacher-level").value;
    const phone = document.getElementById("teacher-phone").value.trim();
    const appointmentDate = document.getElementById(
      "teacher-appointment-date"
    ).value;

    // Check required fields
    if (!fullName) {
      toast("Full Name is required", "fa-solid fa-circle-exclamation");
      document.getElementById("teacher-full-name").focus();
      return false;
    }

    if (fullName.length < 2) {
      toast(
        "Full Name must be at least 2 characters",
        "fa-solid fa-circle-exclamation"
      );
      document.getElementById("teacher-full-name").focus();
      return false;
    }

    if (!fullName.match(/^[a-zA-Z\s\-']+$/)) {
      toast(
        "Full Name can only contain letters, spaces, hyphens, and apostrophes",
        "fa-solid fa-circle-exclamation"
      );
      document.getElementById("teacher-full-name").focus();
      return false;
    }

    if (!nic) {
      toast("NIC is required", "fa-solid fa-circle-exclamation");
      document.getElementById("teacher-nic").focus();
      return false;
    }

    if (nic.length < 5) {
      toast(
        "NIC must be at least 5 characters",
        "fa-solid fa-circle-exclamation"
      );
      document.getElementById("teacher-nic").focus();
      return false;
    }

    if (!level) {
      toast("Level is required", "fa-solid fa-circle-exclamation");
      document.getElementById("teacher-level").focus();
      return false;
    }

    // Validate optional fields if provided
    if (birthday) {
      const birthDate = new Date(birthday);
      const today = new Date();
      if (birthDate >= today) {
        toast("Birthday must be in the past", "fa-solid fa-circle-exclamation");
        document.getElementById("teacher-birthday").focus();
        return false;
      }

      const age = today.getFullYear() - birthDate.getFullYear();
      if (age < 18) {
        toast(
          "Teacher must be at least 18 years old",
          "fa-solid fa-circle-exclamation"
        );
        document.getElementById("teacher-birthday").focus();
        return false;
      }
    }

    if (phone && !phone.match(/^[0-9\s\-\+\(\)]+$/) && phone.length > 0) {
      toast("Phone number format is invalid", "fa-solid fa-circle-exclamation");
      document.getElementById("teacher-phone").focus();
      return false;
    }

    if (phone && phone.length < 7) {
      toast(
        "Phone number must be at least 7 characters",
        "fa-solid fa-circle-exclamation"
      );
      document.getElementById("teacher-phone").focus();
      return false;
    }

    if (appointmentDate && birthday) {
      const apptDate = new Date(appointmentDate);
      const birthDate = new Date(birthday);
      if (apptDate < birthDate) {
        toast(
          "Appointment date cannot be before birthday",
          "fa-solid fa-circle-exclamation"
        );
        document.getElementById("teacher-appointment-date").focus();
        return false;
      }
    }

    return true;
  }

  async function saveTeacher() {
    // Run validation before proceeding
    if (!validateTeacherForm()) {
      return;
    }

    const data = {
      full_name: document.getElementById("teacher-full-name").value.trim(),
      nic: document.getElementById("teacher-nic").value.trim(),
      birthday: document.getElementById("teacher-birthday").value,
      level: document.getElementById("teacher-level").value,
      address: document.getElementById("teacher-address").value.trim(),
      phone_number: document.getElementById("teacher-phone").value.trim(),
      past_schools: document
        .getElementById("teacher-past-schools")
        .value.trim(),
      appointment_date: document.getElementById("teacher-appointment-date")
        .value,
      first_appointment_date: document.getElementById(
        "teacher-first-appointment-date"
      ).value,
    };

    const action = editingTeacher
        ? api.clerk.teachers.update(editingTeacher.teacher_id, data)
        : api.clerk.teachers.create(data);

    action
      .then((res) => {
         if (!res.ok) throw new Error("Failed to save teacher");
         document.getElementById("teacher-modal").close();
         toast("Teacher saved successfully", "fa-solid fa-check-circle");
         fetchTeachers();
      })
      .catch((err) => {
        console.error(err);
        toast("Error saving teacher", "fa-solid fa-circle-exclamation");
      });
  }

  function editTeacher(id) {
    const teacher = allTeachers.find((t) => t.teacher_id == id);
    if (!teacher) {
      toast("Teacher not found", "fa-solid fa-circle-exclamation");
      return;
    }
    editingTeacher = teacher;
    // document.getElementById("modal-title").textContent = "Edit Teacher";
    document.getElementById("teacher-full-name").value = teacher.full_name;
    document.getElementById("teacher-nic").value = teacher.nic;
    document.getElementById("teacher-birthday").value = teacher.birthday
      ? new Date(teacher.birthday).toISOString().split("T")[0]
      : "";
    document.getElementById("teacher-level").value = teacher.level;
    document.getElementById("teacher-address").value = teacher.address;
    document.getElementById("teacher-phone").value = teacher.phone_number;
    document.getElementById("teacher-past-schools").value =
      teacher.past_schools;
    document.getElementById("teacher-appointment-date").value =
      teacher.appointment_date
        ? new Date(teacher.appointment_date).toISOString().split("T")[0]
        : "";
    document.getElementById("teacher-first-appointment-date").value =
      teacher.first_appointment_date
        ? new Date(teacher.first_appointment_date).toISOString().split("T")[0]
        : "";
    // update searchable display to reflect selected level
    updateSearchableDisplay("teacher-level");
    const modal = document.getElementById("teacher-modal");
    if(modal) {
        modal.setTitle("Edit Teacher");
        modal.open();
    }
  }

  function deleteTeacher(id) {
    toast(
      "Are you sure you want to delete this teacher?",
      "fa-solid fa-trash",
      {
        confirm: true,
        confirmText: "Delete",
        cancelText: "Cancel",
        onConfirm: () => {
          api.clerk.teachers.delete(id)
            .then((res) => {
                if (!res.ok) throw new Error("Failed to delete teacher");
                toast("Teacher deleted successfully", "fa-solid fa-check-circle");
                fetchTeachers();
            })
            .catch((err) => {
                console.error(err);
                toast("Error deleting teacher", "fa-solid fa-circle-exclamation");
            });
        },
      }
    );
  }

  function setupSearch() {
  }

  function populateLevelFilter() {
    const select = document.getElementById("level-filter");
    // destroy previous searchable instance if any
    if (
      searchableLevelFilter &&
      typeof searchableLevelFilter.destroy === "function"
    ) {
      searchableLevelFilter.destroy();
      searchableLevelFilter = null;
    }
    select.innerHTML = '<option value="all">All Grades</option>';
    const levelOptions = [
      { value: "1", text: "Grade 1" },
      { value: "2", text: "Grade 2" },
      { value: "3", text: "Grade 3" },
    ];
    levelOptions.forEach((option) => {
      const opt = document.createElement("option");
      opt.value = option.value;
      opt.textContent = option.text;
      select.appendChild(opt);
    });
    // transform into searchable dropdown
    if (typeof makeSearchableDropdown === "function") {
      searchableLevelFilter = makeSearchableDropdown(
        "level-filter",
        (val, text) => {
          const sel = document.getElementById("level-filter");
          if (sel) { 
              sel.value = val;
              sel.dispatchEvent(new Event('change'));
          }
        }
      );
    }
  }



  function populateTeacherLevelSelect() {
    const select = document.getElementById("teacher-level");
    // destroy previous searchable instance if any
    if (
      searchableTeacherLevel &&
      typeof searchableTeacherLevel.destroy === "function"
    ) {
      searchableTeacherLevel.destroy();
      searchableTeacherLevel = null;
    }
    select.innerHTML = '<option value="">Select Grade</option>';
    const levelOptions = [
      { value: "1", text: "Grade 1" },
      { value: "2", text: "Grade 2" },
      { value: "3", text: "Grade 3" },
    ];
    levelOptions.forEach((option) => {
      const opt = document.createElement("option");
      opt.value = option.value;
      opt.textContent = option.text;
      select.appendChild(opt);
    });
    // transform into searchable dropdown
    if (typeof makeSearchableDropdown === "function") {
      searchableTeacherLevel = makeSearchableDropdown(
        "teacher-level",
        (val, text) => {
          // nothing extra needed; makeSearchableDropdown will set select.value
        }
      );
    }
  }

  // Initialize
  populateLevelFilter();
  populateTeacherLevelSelect();
  initTable(); 
  fetchTeachers(); 
  setupAddButton();
</script>

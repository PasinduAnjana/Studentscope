<h2 class="heading">
  <i class="fas fa-calendar-day"></i>
  <span>Timetable Assignment</span>
</h2>

<div
  class="flex mb-2"
  style="gap: 16px; align-items: baseline; flex-wrap: wrap"
>
  <div class="input-group">
    <label for="class-select">Select Class:</label>
    <select id="class-select">
      <option value="">Select Class</option>
    </select>
  </div>
</div>

<div class="timetable" id="timetable">
  <!-- Header row -->
  <div class="timetable-row header-row" id="timetable-header-row">
    <div class="timetable-cell header-cell">Time</div>
    <div class="timetable-cell header-cell">Monday</div>
    <div class="timetable-cell header-cell">Tuesday</div>
    <div class="timetable-cell header-cell">Wednesday</div>
    <div class="timetable-cell header-cell">Thursday</div>
    <div class="timetable-cell header-cell">Friday</div>
  </div>
</div>

<!-- Assignment Modal -->
<!-- Assignment Modal -->
<modal-dialog id="assignment-modal" title="Assign to Slot">
    <div style="display: flex; flex-direction: column; gap: 20px;">
        
        <div class="form-group mb-0">
          <label for="assign-subject" style="display: block; font-weight: 600; font-size: 14px; color: var(--color-text); margin-bottom: 8px;">Subject</label>
          <div style="position: relative;">
            <select id="assign-subject" style="width: 100%; padding: 12px; border-radius: 12px; border: 1px solid var(--color-border); background-color: var(--color-bg); font-size: 15px; appearance: none; -webkit-appearance: none;">
              <option value="">Select Subject</option>
            </select>
            <i class="fas fa-book-open" style="position: absolute; right: 16px; top: 50%; transform: translateY(-50%); color: var(--color-subtext); pointer-events: none;"></i>
          </div>
        </div>

        <div class="form-group mb-0">
          <label for="assign-teacher" style="display: block; font-weight: 600; font-size: 14px; color: var(--color-text); margin-bottom: 8px;">Teacher</label>
           <div style="position: relative;">
            <select id="assign-teacher" style="width: 100%; padding: 12px; border-radius: 12px; border: 1px solid var(--color-border); background-color: var(--color-bg); font-size: 15px; appearance: none; -webkit-appearance: none;">
              <option value="">Select Teacher</option>
            </select>
            <i class="fas fa-chalkboard-teacher" style="position: absolute; right: 16px; top: 50%; transform: translateY(-50%); color: var(--color-subtext); pointer-events: none;"></i>
          </div>
        </div>

    </div>

    <div style="display: flex; justify-content: flex-end; gap: 12px; margin-top: 24px;">
      <button onclick="closeModal()" class="btn" style="background: transparent; color: var(--color-subtext); padding: 10px 20px;">Cancel</button>
      <button id="modal-save" class="btn btn-primary" style="padding: 10px 24px; border-radius: 12px; font-weight: 600;">Assign</button>
    </div>
</modal-dialog>

<script>
  let currentClass = null;
  let currentSlot = null;
  let searchableClassSelect = null;
  let searchableSubjectSelect = null;
  let searchableTeacherSelect = null;

  function updateSearchableDisplay(selectId) {
    const select = document.getElementById(selectId);
    if (!select) return;
    const wrapper = select.previousElementSibling;
    if (wrapper && wrapper.classList.contains("searchable-select")) {
      const displaySpan = wrapper.querySelector(".dropdown-display span");
      const opt =
        select.options[select.selectedIndex] ||
        Array.from(select.options).find((o) => o.value);
      if (displaySpan) displaySpan.textContent = opt ? opt.text : "";
    }
  }

  async function loadClasses() {
    try {
      const res = await fetch("/api/clerk/classes");
      if (!res.ok) throw new Error("Failed to fetch classes");
      const classes = await res.json();
      const select = document.getElementById("class-select");
      select.innerHTML = '<option value="">Select Class</option>';
      classes.forEach((cls) => {
        const opt = document.createElement("option");
        opt.value = cls.id;
        opt.textContent = `Grade ${cls.grade} ${cls.class_name}`;
        select.appendChild(opt);
      });
      if (typeof makeSearchableDropdown === "function") {
        if (
          searchableClassSelect &&
          typeof searchableClassSelect.destroy === "function"
        ) {
          searchableClassSelect.destroy();
        }
        searchableClassSelect = makeSearchableDropdown(
          "class-select",
          (val, text) => {
            currentClass = val;
            if (val) {
              loadTimetable();
            } else {
              // Clear timetable when no class is selected
              const timetableContainer = document.getElementById("timetable");
              timetableContainer.innerHTML =
                '<empty-state-message message="Select a class to view timetable" icon="fas fa-chalkboard"></empty-state-message>';
            }
          }
        );
      }
    } catch (err) {
      console.error(err);
    }
  }

  async function loadSubjects() {
    try {
      const res = await fetch("/api/clerk/subjects");
      if (!res.ok) throw new Error("Failed to fetch subjects");
      const subjects = await res.json();
      const select = document.getElementById("assign-subject");
      select.innerHTML = '<option value="">Select Subject</option>';
      subjects.forEach((sub) => {
        const opt = document.createElement("option");
        opt.value = sub.subject_id;
        opt.textContent = sub.subject_name;
        select.appendChild(opt);
      });
      if (typeof makeSearchableDropdown === "function") {
        if (
          searchableSubjectSelect &&
          typeof searchableSubjectSelect.destroy === "function"
        ) {
          searchableSubjectSelect.destroy();
        }
        searchableSubjectSelect = makeSearchableDropdown("assign-subject");
      }
    } catch (err) {
      console.error(err);
    }
  }

  async function loadTeachers() {
    try {
      const res = await fetch("/api/clerk/teachers");
      if (!res.ok) throw new Error("Failed to fetch teachers");
      const teachers = await res.json();
      const select = document.getElementById("assign-teacher");
      select.innerHTML = '<option value="">Select Teacher</option>';
      teachers.forEach((teacher) => {
        const opt = document.createElement("option");
        opt.value = teacher.teacher_id;
        opt.textContent = teacher.full_name;
        select.appendChild(opt);
      });
      if (typeof makeSearchableDropdown === "function") {
        if (
          searchableTeacherSelect &&
          typeof searchableTeacherSelect.destroy === "function"
        ) {
          searchableTeacherSelect.destroy();
        }
        searchableTeacherSelect = makeSearchableDropdown("assign-teacher");
      }
    } catch (err) {
      console.error(err);
    }
  }

  async function loadTimetable() {
    if (!currentClass) {
      const timetableContainer = document.getElementById("timetable");
      timetableContainer.innerHTML =
        '<empty-state-message message="Select a class to view timetable" icon="fas fa-chalkboard"></empty-state-message>';
      return;
    }

    try {
      const [timeData, timetableData] = await Promise.all([
        fetch("../../data/time.json").then((res) => res.json()),
        fetch(`/api/clerk/timetable/class/${currentClass}`).then((res) =>
          res.json()
        ),
      ]);

      const timetableLookup = {};
      if (Array.isArray(timetableData)) {
        timetableData.forEach((entry) => {
          if (!timetableLookup[entry.day_of_week])
            timetableLookup[entry.day_of_week] = {};
          timetableLookup[entry.day_of_week][entry.period_number] = entry;
        });
      }

      const timetableContainer = document.getElementById("timetable");
      timetableContainer.innerHTML = "";

      const headerRow = document.createElement("div");
      headerRow.classList.add("timetable-row", "header-row");
      const headers = [
        "Time",
        "Monday",
        "Tuesday",
        "Wednesday",
        "Thursday",
        "Friday",
      ];
      headers.forEach((day) => {
        const cell = document.createElement("div");
        cell.classList.add("timetable-cell", "header-cell");
        cell.textContent = day;
        headerRow.appendChild(cell);
      });
      timetableContainer.appendChild(headerRow);

      timeData.forEach((slot, index) => {
        const row = document.createElement("div");
        row.classList.add("timetable-row");

        const timeCell = document.createElement("div");
        timeCell.classList.add("timetable-cell", "time-cell");
        timeCell.textContent = `${slot.start}`;
        row.appendChild(timeCell);

        for (let day = 1; day <= 5; day++) {
          const cell = document.createElement("div");
          cell.classList.add("timetable-cell");

          const card = document.createElement("div");
          card.classList.add("card", "slot-card");
          card.style.cursor = "pointer";
          card.onclick = () => openAssignmentModal(day, slot.slot);

          const entry = timetableLookup[day] && timetableLookup[day][slot.slot];

          if (entry) {
            const subjectDiv = document.createElement("div");
            subjectDiv.classList.add("subject");
            subjectDiv.textContent = entry.subject;

            const teacherDiv = document.createElement("div");
            teacherDiv.classList.add("class-name");
            teacherDiv.textContent = entry.teacher_name || "Assigned";

            card.appendChild(subjectDiv);
            card.appendChild(teacherDiv);
          } else {
            const emptyDiv = document.createElement("div");
            emptyDiv.classList.add("empty-slot");
            emptyDiv.textContent = "Click to assign";
            card.appendChild(emptyDiv);
          }

          cell.appendChild(card);
          row.appendChild(cell);
        }

        timetableContainer.appendChild(row);

        if (slot.slot === 4) {
          const breakRow = document.createElement("div");
          breakRow.classList.add("timetable-row", "interval-row");

          const breakCell = document.createElement("h3");
          breakCell.classList.add("timetable-cell", "interval-cell");
          breakCell.style.color = "var(--color-primary)";
          breakCell.textContent = "INTERVAL";
          breakCell.style.gridColumn = "1 / span 6";

          breakRow.appendChild(breakCell);
          timetableContainer.appendChild(breakRow);
        }
      });
    } catch (err) {
      console.error(err);
      const timetableContainer = document.getElementById("timetable");
      timetableContainer.innerHTML =
        '<empty-state-message message="Unable to load timetable" icon="fas fa-exclamation-triangle"></empty-state-message>';
    }
  }

  function openAssignmentModal(day, period) {
    currentSlot = { day, period };
    const days = ["Monday", "Tuesday", "Wednesday", "Thursday", "Friday"];
    const dayName = days[day - 1]; // Assuming day 1-5
    const modal = document.getElementById("assignment-modal");
    
    // Create or update subtitle slot
    const subtitle = document.createElement("p");
    subtitle.style.cssText = "color: var(--color-subtext); font-size: 14px; margin-top: 4px; margin-bottom: 0;";
    // Assuming we have slot text, otherwise default
    subtitle.textContent = `${dayName} â€¢ Select subject and teacher`;
    
    // We can inject this into the slot we defined in the component
    const slot = modal.querySelector("#modal-subtitle-slot");
    if(slot) {
        slot.innerHTML = '';
        slot.appendChild(subtitle);
    }
    
    modal.open();
  }

  function closeModal() {
    const modal = document.getElementById("assignment-modal");
    modal.close();
    currentSlot = null;
  }

  async function saveAssignment() {
    const subject = document.getElementById("assign-subject").value;
    const teacher = document.getElementById("assign-teacher").value;

    if (!subject || !teacher) {
      toast(
        "Please select subject and teacher",
        "fa-solid fa-circle-exclamation"
      );
      return;
    }

    try {
      const res = await fetch("/api/clerk/timetable/assign", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          class_id: currentClass,
          day_of_week: currentSlot.day,
          period_number: currentSlot.period,
          subject_id: subject,
          teacher_id: teacher,
        }),
      });
      if (!res.ok) throw new Error("Failed to assign");
      toast("Assignment saved successfully", "fa-solid fa-check-circle");
      closeModal();
      loadTimetable();
    } catch (err) {
      console.error(err);
      toast("Error saving assignment", "fa-solid fa-circle-exclamation");
    }
  }

  // Initialize
  loadClasses();
  loadSubjects();
  loadTeachers();
  loadTimetable();

  // Modal event listeners
  // document
  //   .querySelector("#assignment-modal .modal-close")
  //   .addEventListener("click", closeModal);
  // document.getElementById("modal-cancel").addEventListener("click", closeModal);
  document
    .getElementById("modal-save")
    .addEventListener("click", saveAssignment);
  // document.getElementById("assignment-modal").addEventListener("click", (e) => {
  //   if (e.target === document.getElementById("assignment-modal")) closeModal();
  // });
</script>


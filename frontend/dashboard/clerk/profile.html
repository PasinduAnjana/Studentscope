<section class="section">
  <h2 class="heading">
    <i class="fas fa-user"></i>
    <span data="sidebar.profile"></span>
  </h2>

  <div class="card-grid">
    <!-- Profile Information -->
    <div class="card w-1 h-1 profile-card">
      <div class="profile-header">
        <div class="profile-avatar">
          <i class="fas fa-user-circle"></i>
        </div>
        <div class="profile-info">
          <h3 id="clerk-name">Loading...</h3>
          <p id="clerk-role" class="text-sm">Clerk</p>
        </div>
      </div>

      <div class="profile-details">
        <div class="detail-row">
          <span class="detail-label" data="profile.username"></span>
          <span id="clerk-username">-</span>
        </div>
        <div class="detail-row">
          <span class="detail-label" data="profile.role"></span>
          <span id="clerk-role-display">Clerk</span>
        </div>
      </div>
    </div>

    <!-- Clerk Personal Details -->
    <div class="card w-1 h-1 profile-card">
      <div class="profile-header">
        <div class="profile-avatar">
          <i class="fas fa-id-card"></i>
        </div>
        <div class="profile-info">
          <h3 data="profile.personalDetails"></h3>
          <p class="text-sm" data="profile.informationContact"></p>
        </div>
      </div>

      <div class="profile-details">
        <div class="detail-row">
          <span class="detail-label" data="profile.fullName"></span>
          <span id="clerk-full-name">-</span>
        </div>
        <div class="detail-row">
          <span class="detail-label" data="profile.nic"></span>
          <span id="clerk-nic">-</span>
        </div>
        <div class="detail-row">
          <span class="detail-label" data="profile.birthday"></span>
          <span id="clerk-birthday">-</span>
        </div>
        <div class="detail-row">
          <span class="detail-label" data="profile.address"></span>
          <span id="clerk-address">-</span>
        </div>
        <div class="detail-row">
          <span class="detail-label" data="profile.phoneNumber"></span>
          <span id="clerk-phone">-</span>
        </div>
      </div>
    </div>

    <!-- Clerk Professional Details -->
    <div class="card w-1 h-1 profile-card">
      <div class="profile-header">
        <div class="profile-avatar">
          <i class="fas fa-briefcase"></i>
        </div>
        <div class="profile-info">
          <h3 data="profile.professionalDetails"></h3>
          <p class="text-sm" data="profile.experienceAppointment"></p>
        </div>
      </div>

      <div class="profile-details">
        <div class="detail-row">
          <span class="detail-label" data="profile.firstAppointmentDate"></span>
          <span id="clerk-first-appointment">-</span>
        </div>
        <div class="detail-row">
          <span class="detail-label" data="profile.appointmentDate"></span>
          <span id="clerk-appointment">-</span>
        </div>
        <div class="detail-row">
          <span class="detail-label" data="profile.pastSchools"></span>
          <span id="clerk-past-schools">-</span>
        </div>
      </div>
    </div>

    <!-- Quick Stats -->
    <div class="card w-1 h-1 dashboard-tile">
      <div class="icon-title">
        <i class="fas fa-chart-bar icon"></i>
        <p class="tile-label" data="profile.quickStats"></p>
      </div>
      <div class="stats-content">
        <div class="stat-item">
          <div class="stat-icon">
            <i class="fas fa-users"></i>
          </div>
          <span class="stat-number" id="total-students">0</span>
          <span class="stat-label" data="profile.students"></span>
        </div>
        <div class="stat-item">
          <div class="stat-icon">
            <i class="fas fa-user-graduate"></i>
          </div>
          <span class="stat-number" id="total-teachers">0</span>
          <span class="stat-label" data="profile.teachers"></span>
        </div>
        <div class="stat-item">
          <div class="stat-icon">
            <i class="fas fa-chalkboard"></i>
          </div>
          <span class="stat-number" id="total-classes">0</span>
          <span class="stat-label" data="profile.classes"></span>
        </div>
      </div>
    </div>

    <!-- Recent Activities -->
    <div class="card w-1 h-1 dashboard-tile">
      <div class="icon-title">
        <i class="fas fa-clock icon"></i>
        <p class="tile-label">Recent Activities</p>
      </div>
      <div id="recent-activities">
        <p class="text-sm">No recent activities</p>
      </div>
    </div>

    <!-- Security PIN -->
    <div class="card w-1 h-1 dashboard-tile">
      <div class="icon-title">
        <i class="fas fa-shield-alt icon"></i>
        <p class="tile-label" data-en="Security PIN" data-si="ආරක්ෂක PIN එක" data-ta="பாதுகாப்பு PIN">Security PIN</p>
      </div>
      <div>
        <p class="text-sm" id="pin-status-text">Checking PIN status...</p>
        <button class="btn" style="margin-top: 15px;" onclick="openPinModal()">
          <i class="fas fa-key"></i> <span id="pin-btn-text" data-en="Set PIN" data-si="PIN එක සකසන්න"
            data-ta="PIN அமை">Set PIN</span>
        </button>
      </div>
    </div>
  </div>
</section>

<!-- Set PIN Modal -->
<modal-dialog id="set-pin-modal" title="Set Security PIN">
  <form id="set-pin-form">
    <div class="form-group">
      <label>Enter 4-Digit PIN</label>
      <input type="password" id="new-pin-input" class="input" pattern="[0-9]{4}" maxlength="4" placeholder="e.g. 1234"
        required style="letter-spacing: 5px; font-size: 1.2rem; text-align: center;">
    </div>
    <div class="form-group">
      <label>Confirm PIN</label>
      <input type="password" id="confirm-pin-input" class="input" pattern="[0-9]{4}" maxlength="4" placeholder="Confirm"
        required style="letter-spacing: 5px; font-size: 1.2rem; text-align: center;">
    </div>
    <button type="submit" class="btn btn-primary" style="width: 100%;">Save PIN</button>
  </form>
</modal-dialog>

<script>
  async function loadProfile() {
    try {
      const response = await fetch("/api/clerk/profile");
      if (!response.ok) throw new Error("Failed to fetch profile");

      const profile = await response.json();

      // Update profile information
      document.getElementById("clerk-name").textContent = profile.username;
      document.getElementById("clerk-username").textContent = profile.username;
      document.getElementById("clerk-role").textContent =
        getNestedValue(window.currentTranslations, "profile.clerk") || "Clerk";

      // Update clerk details if available
      if (profile.details) {
        const details = profile.details;

        // Personal Details
        document.getElementById("clerk-full-name").textContent =
          details.full_name || "-";
        document.getElementById("clerk-nic").textContent = details.nic || "-";
        document.getElementById("clerk-birthday").textContent = details.birthday
          ? new Date(details.birthday).toLocaleDateString()
          : "-";
        document.getElementById("clerk-address").textContent =
          details.address || "-";
        document.getElementById("clerk-phone").textContent =
          details.phone_number || "-";

        // Professional Details
        document.getElementById("clerk-first-appointment").textContent =
          details.first_appointment_date
            ? new Date(details.first_appointment_date).toLocaleDateString()
            : "-";
        document.getElementById("clerk-appointment").textContent =
          details.appointment_date
            ? new Date(details.appointment_date).toLocaleDateString()
            : "-";
        document.getElementById("clerk-past-schools").textContent =
          details.past_schools || "-";
      }

      // Load additional stats
      await loadProfileStats();
    } catch (error) {
      console.error("Error loading profile:", error);
      document.getElementById("clerk-name").textContent =
        "Error loading profile";
    }
  }

  async function loadProfileStats() {
    try {
      // Load total students
      const studentsResponse = await fetch("/api/clerk/students");
      if (studentsResponse.ok) {
        const students = await studentsResponse.json();
        document.getElementById("total-students").textContent = students.length;
      }

      // Load total teachers
      const teachersResponse = await fetch("/api/clerk/teachers");
      if (teachersResponse.ok) {
        const teachers = await teachersResponse.json();
        document.getElementById("total-teachers").textContent = teachers.length;
      }

      // Load total classes
      const classesResponse = await fetch("/api/clerk/classes");
      if (classesResponse.ok) {
        const classes = await classesResponse.json();
        document.getElementById("total-classes").textContent = classes.length;
      }
    } catch (error) {
      console.error("Error loading profile stats:", error);
    }
  }

  async function loadPinStatus() {
    try {
      const response = await fetch("/api/clerk/pin/status");
      if (response.ok) {
        const data = await response.json();
        const statusText = document.getElementById("pin-status-text");
        const btnText = document.getElementById("pin-btn-text");
        const currentLang = localStorage.getItem('lang') || 'en';

        if (data.hasPin) {
          statusText.innerHTML = `<span style="color: var(--color-success); font-weight: bold;"><i class="fas fa-check-circle"></i> PIN is configured.</span> You are protected when modifying records.`;
          const updateBtnLangs = { en: "Change PIN", si: "PIN එක වෙනස් කරන්න", ta: "PIN மாற்று" };
          btnText.textContent = updateBtnLangs[currentLang] || updateBtnLangs.en;
        } else {
          statusText.innerHTML = `<span style="color: var(--color-danger); font-weight: bold;"><i class="fas fa-exclamation-circle"></i> No PIN configured.</span> Please set up a PIN to protect record modifications.`;
          const setBtnLangs = { en: "Set PIN", si: "PIN එක සකසන්න", ta: "PIN அமை" };
          btnText.textContent = setBtnLangs[currentLang] || setBtnLangs.en;
        }
      }
    } catch (error) {
      console.error("Error loading PIN status:", error);
    }
  }

  function openPinModal() {
    document.getElementById("set-pin-form").reset();
    document.getElementById("set-pin-modal").open();
  }

  document.getElementById("set-pin-form").addEventListener("submit", async (e) => {
    e.preventDefault();
    const pin = document.getElementById("new-pin-input").value;
    const confirm = document.getElementById("confirm-pin-input").value;

    if (pin !== confirm) {
      alert("PINs do not match!");
      return;
    }

    try {
      const response = await fetch("/api/clerk/pin/set", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ pin })
      });
      const data = await response.json();

      if (response.ok) {
        alert("Security PIN saved successfully!");
        document.getElementById("set-pin-modal").close();
        loadPinStatus();
      } else {
        alert("Error saving PIN: " + data.error);
      }
    } catch (err) {
      alert("Network error.");
    }
  });

  // Initialize
  loadProfile();
  loadPinStatus();
</script>
<style>
  /* Action buttons styling */
  .action-buttons {
    display: flex;
    gap: 5px;
    justify-content: center;
  }

  /* Form grid styling */
  .student-form-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 15px;
  }

  .student-form-grid .input-group {
    margin-bottom: 0;
  }
</style>
</style>
</style>
</style>

<section class="section">
  <h2 class="heading">
    <i class="fas fa-users"></i>
    <span>Student Management</span>
  </h2>
  <div class="card">
    <div class="flex-between mb-2">
      <h1 class="title">Students</h1>
      <button id="add-student-btn" class="btn btn-primary" onclick="openAddStudentModal()">
        <i class="fas fa-user-plus"></i> Add Student
      </button>
    </div>
    <!-- Search Bar and Class Dropdown -->
    <data-table id="students-table">
      <div slot="filters">
        <div class="input-group">
          <select id="class-filter">
            <option value="">All Classes</option>
          </select>
        </div>
      </div>
    </data-table>
  </div>
</section>

<!-- Add/Edit Student Modal -->
<modal-dialog id="student-modal" title="Add Student">
  <div class="student-form-grid">
    <div class="input-group">
      <label for="student-full-name">Full Name: <span class="required"
          style="color: #e74c3c; font-weight: bold;">*</span></label>
      <input type="text" id="student-full-name" placeholder="Enter full name" required minlength="2" maxlength="100"
        pattern="[a-zA-Z\s\-']+" title="Name can only contain letters, spaces, hyphens, and apostrophes" />
    </div>
    <div class="input-group">
      <label for="student-username">Index Number (Username): <span class="required"
          style="color: #e74c3c; font-weight: bold;">*</span></label>
      <input type="text" id="student-username" placeholder="Enter index number" required minlength="3" maxlength="20"
        pattern="[a-zA-Z0-9_]+" title="Index number can only contain letters, numbers, and underscores" />
    </div>
    <div class="input-group">
      <label for="student-birthday">Birthday: <span class="required"
          style="color: #e74c3c; font-weight: bold;">*</span></label>
      <input type="date" id="student-birthday" required />
    </div>
    <div class="input-group">
      <label for="student-gender">Gender: <span class="required"
          style="color: #e74c3c; font-weight: bold;">*</span></label>
      <select id="student-gender" required>
        <option value="">Select Gender</option>
        <option value="M">Male</option>
        <option value="F">Female</option>
      </select>
    </div>
    <div class="input-group">
      <label for="student-address">Address: <span class="required"
          style="color: #e74c3c; font-weight: bold;">*</span></label>
      <input type="text" id="student-address" placeholder="Enter address" required minlength="10" maxlength="200" />
    </div>
    <div class="input-group">
      <label for="student-class">Class: <span class="required"
          style="color: #e74c3c; font-weight: bold;">*</span></label>
      <select id="student-class" required>
        <option value="">Select Class</option>
      </select>
    </div>
    <div class="input-group">
      <label for="student-nationality">Nationality:</label>
      <input type="text" id="student-nationality" placeholder="Enter nationality" maxlength="50" />
    </div>
    <div class="input-group">
      <label for="parent-name">Parent Name:</label>
      <input type="text" id="parent-name" placeholder="Enter parent name" minlength="2" maxlength="100"
        pattern="[a-zA-Z\s\-']*" title="Name can only contain letters, spaces, hyphens, and apostrophes" />
    </div>
    <div class="input-group" style="grid-column: span 2;">
      <label for="parent-address">Parent Address:</label>
      <input type="text" id="parent-address" placeholder="Enter parent address" minlength="10" maxlength="200" />
    </div>
  </div>

  <div style="display: flex; justify-content: flex-end; gap: 12px; margin-top: 24px;">
    <button id="modal-cancel" class="btn btn-secondary">Cancel</button>
    <button id="modal-save" class="btn btn-primary">Save</button>
  </div>
</modal-dialog>

<script>
  let allStudents = [];
  let allClasses = [];
  let editingStudent = null;
  // References to searchable dropdown wrappers so we can destroy/recreate when class lists change
  let searchableClassFilter = null;
  let searchableClassSelect = null;
  let searchableGenderSelect = null;
  let searchablePageSize = null;

  function updateSearchableDisplay(selectId) {
    const select = document.getElementById(selectId);
    if (!select) return;
    const wrapper = select.previousElementSibling;
    if (wrapper && wrapper.classList.contains("searchable-select")) {
      const displaySpan = wrapper.querySelector(".dropdown-display span");
      const opt =
        select.options[select.selectedIndex] ||
        Array.from(select.options).find((o) => o.value);
      if (displaySpan) displaySpan.textContent = opt ? opt.text : "";
    }
  }

  function initTable() {
    const table = document.getElementById("students-table");
    table.setColumns([
      { key: "full_name", header: "Name", searchable: true },
      { key: "username", header: "Index Number", searchable: true },
      {
        key: "class_id",
        header: "Class",
        render: (row) => {
          const cls = allClasses.find((c) => c.id == row.class_id);
          return cls ? `${cls.grade} - ${cls.class_name}` : "";
        }
      },
      {
        key: "birthday",
        header: "Birthday",
        render: (row) => row.birthday ? new Date(row.birthday).toLocaleDateString() : ""
      },
      { key: "gender", header: "Gender" },
      {
        key: "parent",
        header: "Parent",
        render: (row) => row.parent ? row.parent.name : ""
      },
      {
        key: "actions",
        header: "Actions",
        render: (row) => {
          const div = document.createElement("div");
          div.className = "action-buttons";
          div.innerHTML = `
                    <button class="btn-icon btn-edit" onclick="editStudent(${row.id})" title="Edit">
                      <i class="fas fa-edit"></i>
                    </button>
                    <button class="btn-icon btn-delete" onclick="deleteStudent(${row.id})" title="Delete">
                      <i class="fas fa-trash"></i>
                    </button>
                `;
          return div;
        }
      }
    ]);

    // Setup Class Filter
    const classFilter = document.getElementById("class-filter");
    if (classFilter) {
      classFilter.addEventListener("change", () => {
        const val = classFilter.value;
        table.addFilter("class", (row) => {
          return val === "" || row.class_id == val;
        });
      });
    }

    table.setEmptyState("No students found", "fas fa-users-slash");
  }

  function fetchStudents() {
    api.clerk.students.getAll()
      .then((res) => {
        if (!res.ok) throw new Error("Failed to fetch students");
        return res.json();
      })
      .then((data) => {
        allStudents = data;
        document.getElementById("students-table").setData(allStudents);
      })
      .catch((err) => {
        console.error(err);
        document.getElementById("students-table").setData([]);
        document.getElementById("students-table").setEmptyState("Error loading students", "fas fa-exclamation-triangle");
        toast("Error loading students", "fa-solid fa-circle-exclamation");
      });
  }

  function fetchClasses() {
    api.clerk.classes.getAll()
      .then((res) => {
        if (!res.ok) throw new Error("Failed to fetch classes");
        return res.json();
      })
      .then((data) => {
        allClasses = data;
        populateClassFilter();
        populateClassSelect();
        populateGenderSelect();
        initTable();
      })
      .catch((err) => {
        console.error(err);
        toast("Error loading classes", "fa-solid fa-circle-exclamation");
      });
  }

  function populateClassFilter() {
    const select = document.getElementById("class-filter");
    // destroy previous searchable instance if any
    if (
      searchableClassFilter &&
      typeof searchableClassFilter.destroy === "function"
    ) {
      searchableClassFilter.destroy();
      searchableClassFilter = null;
    }
    select.innerHTML = '<option value="">All Classes</option>';
    allClasses.forEach((cls) => {
      const option = document.createElement("option");
      option.value = cls.id;
      option.textContent = `${cls.grade} - ${cls.class_name}`;
      select.appendChild(option);
    });
    // transform into searchable dropdown
    if (typeof makeSearchableDropdown === "function") {
      searchableClassFilter = makeSearchableDropdown(
        "class-filter",
        (val, text) => {
          // ensure the underlying select value is set and trigger filtering
          const sel = document.getElementById("class-filter");
          if (sel) sel.value = val;
          // Trigger change event to update table filter
          sel.dispatchEvent(new Event('change'));
        }
      );
    }
  }



  function populateClassSelect() {
    const select = document.getElementById("student-class");
    // destroy previous searchable instance if any
    if (
      searchableClassSelect &&
      typeof searchableClassSelect.destroy === "function"
    ) {
      searchableClassSelect.destroy();
      searchableClassSelect = null;
    }
    select.innerHTML = '<option value="">Select Class</option>';
    allClasses.forEach((cls) => {
      const option = document.createElement("option");
      option.value = cls.id;
      option.textContent = `${cls.grade} - ${cls.class_name}`;
      select.appendChild(option);
    });
    // transform into searchable dropdown
    if (typeof makeSearchableDropdown === "function") {
      searchableClassSelect = makeSearchableDropdown(
        "student-class",
        (val, text) => {
          // nothing extra needed; makeSearchableDropdown will set select.value
        }
      );
    }
  }

  function populateGenderSelect() {
    const select = document.getElementById("student-gender");
    // destroy previous searchable instance if any
    if (
      searchableGenderSelect &&
      typeof searchableGenderSelect.destroy === "function"
    ) {
      searchableGenderSelect.destroy();
      searchableGenderSelect = null;
    }
    select.innerHTML = '<option value="">Select Gender</option>';
    const genderOptions = [
      { value: "M", text: "Male" },
      { value: "F", text: "Female" }
    ];
    genderOptions.forEach((option) => {
      const opt = document.createElement("option");
      opt.value = option.value;
      opt.textContent = option.text;
      select.appendChild(opt);
    });
    // transform into searchable dropdown
    if (typeof makeSearchableDropdown === "function") {
      searchableGenderSelect = makeSearchableDropdown(
        "student-gender",
        (val, text) => {
          // nothing extra needed; makeSearchableDropdown will set select.value
        }
      );
    }
  }

  function populatePageSizeSelect() {
    // Clean up manually controlled page size logic as component handles it
    // This function might be called by dashboard.js, so we keep it empty or remove calls
  }



  function setupAddButton() {
    const modal = document.getElementById("student-modal");
    const saveBtn = document.getElementById("modal-save");

    // helper to open modal
    function openAddModal() {
      editingStudent = null;
      if (modal) {
        modal.setTitle("Add Student");
        clearModal();
        modal.open();
      }
    }

    // If the button exists at setup time, attach directly. Otherwise use delegation (works when page is injected later).
    const addBtn = document.getElementById("add-student-btn");
    if (addBtn) {
      addBtn.addEventListener("click", openAddModal);
    } else {
      // delegation fallback
      document.addEventListener("click", function delegationHandler(e) {
        const target = e.target.closest && e.target.closest("#add-student-btn");
        if (target) openAddModal();
      });
    }

    // const closeBtn = document.querySelector("#student-modal .modal-close");
    const cancelBtn = document.getElementById("modal-cancel");

    const closeModal = () => {
      if (modal) modal.close();
    };

    // if (closeBtn) closeBtn.addEventListener("click", closeModal);
    if (cancelBtn) cancelBtn.addEventListener("click", closeModal);

    // if (modal) {
    //   modal.addEventListener("click", (e) => {
    //     if (e.target === modal) closeModal();
    //   });
    // }

    if (saveBtn) saveBtn.addEventListener("click", saveStudent);

    // Add real-time validation
    setupRealTimeValidation();
  }

  function setupRealTimeValidation() {
    // Username validation - check for duplicates
    const usernameInput = document.getElementById("student-username");
    if (usernameInput) {
      usernameInput.addEventListener("input", function () {
        const username = this.value.trim();
        if (username.length >= 3) {
          const existingStudent = editingStudent
            ? allStudents.find(s => s.username.toLowerCase() === username.toLowerCase() && s.id !== editingStudent.id)
            : allStudents.find(s => s.username.toLowerCase() === username.toLowerCase());

          if (existingStudent) {
            this.setCustomValidity("This index number is already in use");
            this.reportValidity();
          } else {
            this.setCustomValidity("");
          }
        }
      });
    }

    // Full name validation
    const fullNameInput = document.getElementById("student-full-name");
    if (fullNameInput) {
      fullNameInput.addEventListener("input", function () {
        const name = this.value.trim();
        if (name && !/^[a-zA-Z\s\-']+$/.test(name)) {
          this.setCustomValidity("Name can only contain letters, spaces, hyphens, and apostrophes");
          this.reportValidity();
        } else {
          this.setCustomValidity("");
        }
      });
    }

    // Birthday validation
    const birthdayInput = document.getElementById("student-birthday");
    if (birthdayInput) {
      birthdayInput.addEventListener("change", function () {
        const birthDate = new Date(this.value);
        const today = new Date();

        if (this.value && birthDate > today) {
          this.setCustomValidity("Birthday cannot be in the future");
          this.reportValidity();
        } else if (this.value) {
          const age = today.getFullYear() - birthDate.getFullYear();
          if (age < 5) {
            this.setCustomValidity("Student must be at least 5 years old");
            this.reportValidity();
          } else if (age > 25) {
            this.setCustomValidity("Please verify the birthday - student appears to be over 25 years old");
            this.reportValidity();
          } else {
            this.setCustomValidity("");
          }
        } else {
          this.setCustomValidity("");
        }
      });
    }
  }

  function clearModal() {
    document.getElementById("student-full-name").value = "";
    document.getElementById("student-username").value = "";
    document.getElementById("student-birthday").value = "";
    document.getElementById("student-address").value = "";
    document.getElementById("student-gender").value = "";
    document.getElementById("student-nationality").value = "";
    document.getElementById("student-class").value = "";
    // update searchable display if present
    updateSearchableDisplay("student-class");
    updateSearchableDisplay("student-gender");
    document.getElementById("parent-name").value = "";
    document.getElementById("parent-address").value = "";

    // Set max date for birthday (today)
    const birthdayInput = document.getElementById("student-birthday");
    if (birthdayInput) {
      const today = new Date().toISOString().split('T')[0];
      birthdayInput.setAttribute('max', today);
    }

    // Clear any custom validity
    const inputs = document.querySelectorAll('#student-modal input, #student-modal select');
    inputs.forEach(input => input.setCustomValidity(''));
  }

  async function saveStudent() {
    const data = {
      full_name: document.getElementById("student-full-name").value.trim(),
      username: document.getElementById("student-username").value.trim(),
      birthday: document.getElementById("student-birthday").value,
      address: document.getElementById("student-address").value.trim(),
      gender: document.getElementById("student-gender").value,
      nationality: document.getElementById("student-nationality").value.trim(),
      class_id: document.getElementById("student-class").value,
      parent_name: document.getElementById("parent-name").value.trim(),
      parent_address: document.getElementById("parent-address").value.trim(),
    };

    // Comprehensive form validation
    const validationErrors = [];

    // Full Name validation
    if (!data.full_name) {
      validationErrors.push("Full name is required");
    } else if (data.full_name.length < 2) {
      validationErrors.push("Full name must be at least 2 characters long");
    } else if (data.full_name.length > 100) {
      validationErrors.push("Full name must be less than 100 characters");
    } else if (!/^[a-zA-Z\s\-']+$/.test(data.full_name)) {
      validationErrors.push("Full name can only contain letters, spaces, hyphens, and apostrophes");
    }

    // Username (Index Number) validation
    if (!data.username) {
      validationErrors.push("Index number (username) is required");
    } else if (data.username.length < 3) {
      validationErrors.push("Index number must be at least 3 characters long");
    } else if (data.username.length > 20) {
      validationErrors.push("Index number must be less than 20 characters");
    } else if (!/^[a-zA-Z0-9_]+$/.test(data.username)) {
      validationErrors.push("Index number can only contain letters, numbers, and underscores");
    }

    // Birthday validation
    if (!data.birthday) {
      validationErrors.push("Birthday is required");
    } else {
      const birthDate = new Date(data.birthday);
      const today = new Date();
      const minAge = 5; // Minimum age 5 years
      const maxAge = 25; // Maximum age 25 years

      if (birthDate > today) {
        validationErrors.push("Birthday cannot be in the future");
      } else {
        const age = today.getFullYear() - birthDate.getFullYear();
        if (age < minAge) {
          validationErrors.push(`Student must be at least ${minAge} years old`);
        } else if (age > maxAge) {
          validationErrors.push(`Please verify the birthday - student appears to be over ${maxAge} years old`);
        }
      }
    }

    // Gender validation
    if (!data.gender) {
      validationErrors.push("Gender is required");
    } else if (!['M', 'F'].includes(data.gender)) {
      validationErrors.push("Please select a valid gender");
    }

    // Address validation
    if (!data.address) {
      validationErrors.push("Address is required");
    } else if (data.address.length < 10) {
      validationErrors.push("Address must be at least 10 characters long");
    } else if (data.address.length > 200) {
      validationErrors.push("Address must be less than 200 characters");
    }

    // Class validation
    if (!data.class_id) {
      validationErrors.push("Class selection is required");
    }

    // Nationality validation (optional but if provided, validate)
    if (data.nationality && data.nationality.length > 50) {
      validationErrors.push("Nationality must be less than 50 characters");
    }

    // Parent Name validation (optional but if provided, validate)
    if (data.parent_name) {
      if (data.parent_name.length < 2) {
        validationErrors.push("Parent name must be at least 2 characters long");
      } else if (data.parent_name.length > 100) {
        validationErrors.push("Parent name must be less than 100 characters");
      } else if (!/^[a-zA-Z\s\-']+$/.test(data.parent_name)) {
        validationErrors.push("Parent name can only contain letters, spaces, hyphens, and apostrophes");
      }
    }

    // Parent Address validation (optional but if provided, validate)
    if (data.parent_address) {
      if (data.parent_address.length < 10) {
        validationErrors.push("Parent address must be at least 10 characters long");
      } else if (data.parent_address.length > 200) {
        validationErrors.push("Parent address must be less than 200 characters");
      }
    }

    // Check for duplicate username (only for new students)
    if (!editingStudent && data.username) {
      const existingStudent = allStudents.find(s => s.username.toLowerCase() === data.username.toLowerCase());
      if (existingStudent) {
        validationErrors.push("This index number is already in use by another student");
      }
    }

    // Check for duplicate username when editing (exclude current student)
    if (editingStudent && data.username) {
      const existingStudent = allStudents.find(s =>
        s.username.toLowerCase() === data.username.toLowerCase() && s.id !== editingStudent.id
      );
      if (existingStudent) {
        validationErrors.push("This index number is already in use by another student");
      }
    }

    // Display validation errors
    if (validationErrors.length > 0) {
      toast(
        validationErrors.join("<br>"),
        "fa-solid fa-circle-exclamation"
      );
      return;
    }

    const actionFunc = () => {
      const action = editingStudent
        ? api.clerk.students.update(editingStudent.id, data)
        : api.clerk.students.create(data);

      action
        .then((res) => {
          if (!res.ok) throw new Error("Failed to save student");
          document.getElementById("student-modal").close(); // Using component method
          toast("Student saved successfully", "fa-solid fa-check-circle");
          fetchStudents();
        })
        .catch((err) => {
          console.error(err);
          toast("Error saving student", "fa-solid fa-circle-exclamation");
        });
    };

    if (editingStudent) {
      window.requirePinPrompt(actionFunc);
    } else {
      actionFunc();
    }
  }

  function editStudent(id) {
    const student = allStudents.find((s) => s.id == id);
    if (!student) {
      toast("Student not found", "fa-solid fa-circle-exclamation");
      return;
    }
    editingStudent = student;
    // document.getElementById("modal-title").textContent = "Edit Student";
    document.getElementById("student-full-name").value = student.full_name;
    document.getElementById("student-username").value = student.username;
    // Format birthday to YYYY-MM-DD format for date input
    if (student.birthday) {
      const birthDate = new Date(student.birthday);
      const year = birthDate.getFullYear();
      const month = String(birthDate.getMonth() + 1).padStart(2, '0');
      const day = String(birthDate.getDate()).padStart(2, '0');
      document.getElementById("student-birthday").value = `${year}-${month}-${day}`;
    } else {
      document.getElementById("student-birthday").value = "";
    }
    document.getElementById("student-address").value = student.address;
    document.getElementById("student-gender").value = student.gender;
    document.getElementById("student-nationality").value = student.nationality;
    document.getElementById("student-class").value = student.class_id;
    // update searchable display to reflect selected class and gender
    updateSearchableDisplay("student-class");
    updateSearchableDisplay("student-gender");

    document.getElementById("parent-name").value = student.parent?.name || "";
    document.getElementById("parent-address").value =
      student.parent?.address || "";

    const modal = document.getElementById("student-modal");
    if (modal) {
      modal.setTitle("Edit Student");
      modal.open();
    }
  }

  function deleteStudent(id) {
    toast(
      "Are you sure you want to delete this student?",
      "fa-solid fa-trash",
      {
        confirm: true,
        confirmText: "Delete",
        cancelText: "Cancel",
        onConfirm: () => {
          window.requirePinPrompt(() => {
            api.clerk.students.delete(id)
              .then((res) => {
                if (!res.ok) throw new Error("Failed to delete student");
                toast("Student deleted successfully", "fa-solid fa-check-circle");
                fetchStudents();
              })
              .catch((err) => {
                console.error(err);
                toast("Error deleting student", "fa-solid fa-circle-exclamation");
              });
          });
        },
      }
    );
  }

  // Initialize

  fetchClasses();
  fetchStudents();

  setupAddButton();
</script>
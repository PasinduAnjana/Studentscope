
  <!-- Import Web Component -->
  <script src="js/components/ToggleSelect.js"></script>

  <h2 class="heading">
    <i class="fas fa-trophy"></i>
    <span>Achievement Management</span>
  </h2>
  <div class="card">
    <div class="flex-between mb-2">
      <h1 class="title">Achievements</h1>
      <button class="btn btn-primary" onclick="openModal()">
        <i class="fas fa-plus"></i> Add Achievement
      </button>
    </div>
    <div class="table-responsive">
      <table>
        <thead>
          <tr>
            <th>Student</th>
            <th>Achievement</th>
            <th>Category</th>
            <th>Date</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody id="achievements-table-body">
          <tr>
            <td colspan="5" class="text-center">Loading...</td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>

  <!-- Modal using shared styles (from announcements.css) -->
  <modal-dialog id="achievementModal" title="Add Achievement">
      <div style="display: flex; flex-direction: column; gap: 15px;">
        <form id="achievementForm" onsubmit="handleSave(event)">
          <input type="hidden" id="achievementId" />
          
          <div class="form-group">
            <label for="studentSelect">Student</label>
            <select id="studentSelect" required style="width: 100%; padding: 8px; border: 1px solid var(--color-border); border-radius: 4px; background: var(--color-bg); color: var(--color-text);">
              <option value="">Select Student...</option>
            </select>
          </div>

          <div class="form-group">
            <label for="titleInput">Title</label>
            <input type="text" id="titleInput" required placeholder="e.g. Mathematics Competition Winner" style="width: 100%; padding: 8px; border: 1px solid var(--color-border); border-radius: 4px; background: var(--color-bg); color: var(--color-text);" />
          </div>

          <div class="form-group">
            <label for="descInput">Description</label>
            <textarea id="descInput" rows="3" required placeholder="Details about the achievement..." style="width: 100%; padding: 8px; border: 1px solid var(--color-border); border-radius: 4px; background: var(--color-bg); color: var(--color-text);"></textarea>
          </div>

          <div class="form-group">
            <label>Category</label>
            <!-- Custom Web Component -->
            <toggle-select id="categoryToggle" onclick="syncCategory()">
                <toggle-option value="academic" icon="fas fa-microscope">Academic</toggle-option>
                <toggle-option value="sports" icon="fas fa-trophy">Sports</toggle-option>
                <toggle-option value="arts" icon="fas fa-palette">Arts</toggle-option>
                <toggle-option value="other" icon="fas fa-star">Other</toggle-option>
            </toggle-select>
            <input type="hidden" id="categorySelect" required />
          </div>

          <div class="form-group">
            <label for="dateInput">Date</label>
            <input type="date" id="dateInput" required style="width: 100%; padding: 8px; border: 1px solid var(--color-border); border-radius: 4px; background: var(--color-bg); color: var(--color-text);" />
          </div>
        </form>
      </div>
      <div style="display: flex; justify-content: flex-end; gap: 12px; margin-top: 24px;">
        <button type="button" class="btn btn-secondary" onclick="closeModal()">Cancel</button>
        <button type="button" class="btn btn-primary" onclick="document.getElementById('achievementForm').dispatchEvent(new Event('submit'))">Save</button>
      </div>
  </modal-dialog>

  <script>
    let students = [];
    let isEditing = false;

    // Sync Web Component value with hidden input for form submission
    function syncCategory() {
        const toggle = document.querySelector('toggle-select');
        document.getElementById('categorySelect').value = toggle.value;
    }

    async function init() {
      await loadStudents();
      loadAchievements();
    }

    async function loadStudents() {
      try {
        const res = await api.clerk.students.getAll();
        if (res.ok) {
          students = await res.json();
          const select = document.getElementById("studentSelect");
          select.innerHTML = '<option value="">Select Student...</option>';
          students.forEach(s => {
            const option = document.createElement("option");
            option.value = s.user_id; 
            option.textContent = `${s.full_name} (${s.username || 'No ID'})`;
            select.appendChild(option);
          });
        }
      } catch (err) {
        console.error("Failed to load students", err);
        toast("Failed to load students", "fa-solid fa-circle-exclamation");
      }
    }

    async function loadAchievements() {
      const tbody = document.getElementById("achievements-table-body");
      try {
        const res = await api.clerk.achievements.getAll();
        if (!res.ok) throw new Error("Failed");
        const data = await res.json();
        
        tbody.innerHTML = "";
        
        if (data.length === 0) {
          tbody.innerHTML = `<tr><td colspan="5" class="text-center">No achievements found</td></tr>`;
          return;
        }

        data.forEach(item => {
          const date = new Date(item.achieved_at).toLocaleDateString();
          const icon = getCategoryIcon(item.category);
          
          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td>${item.student_name || 'Unknown Student'}</td>
            <td>
              <div>${item.title}</div>
              <div class="text-sm">${item.description}</div>
            </td>
            <td>
              <span>
                <i class="fas ${icon}"></i> ${item.category}
              </span>
            </td>
            <td>${date}</td>
            <td>
              <div class="action-buttons flex-center">
                <button class="btn-icon btn-edit" onclick='openEditModal(${JSON.stringify(item).replace(/'/g, "&#39;")})' title="Edit">
                  <i class="fas fa-edit"></i>
                </button>
                <button class="btn-icon btn-delete" onclick="handleDelete(${item.id})" title="Delete">
                  <i class="fas fa-trash"></i>
                </button>
              </div>
            </td>
          `;
          tbody.appendChild(tr);
        });

      } catch (err) {
        tbody.innerHTML = `<tr><td colspan="5" class="text-center text-error">Error loading data</td></tr>`;
        toast("Error loading achievements", "fa-solid fa-circle-exclamation");
      }
    }

    function getCategoryIcon(cat) {
      switch(cat) {
        case 'academic': return 'fa-microscope';
        case 'sports': return 'fa-trophy';
        case 'arts': return 'fa-palette';
        default: return 'fa-star';
      }
    }

    function openModal() {
      isEditing = false;
      const modal = document.getElementById("achievementModal");
      if(modal) {
        modal.setTitle("Add Achievement");
        document.getElementById("achievementForm").reset();
        document.getElementById("achievementId").value = "";
        document.getElementById("dateInput").valueAsDate = new Date();
        
        // Reset Web Component
        const toggle = document.querySelector('toggle-select');
        if(toggle) toggle.value = ""; 
        document.getElementById('categorySelect').value = "";

        modal.open();
      }
    }

    function openEditModal(item) {
      isEditing = true;
      const modal = document.getElementById("achievementModal");
      if(modal) {
          modal.setTitle("Edit Achievement");
          document.getElementById("achievementId").value = item.id;
          document.getElementById("studentSelect").value = item.student_id; 
          document.getElementById("titleInput").value = item.title;
          document.getElementById("descInput").value = item.description;
          document.getElementById("categorySelect").value = item.category;
          document.getElementById("dateInput").value = item.achieved_at.split('T')[0];
          
          // Set Web Component value
          const toggle = document.querySelector('toggle-select');
          if(toggle) toggle.value = item.category;
          
          modal.open();
      }
    }

    function closeModal() {
      const modal = document.getElementById("achievementModal");
      if(modal) modal.close();
    }

    async function handleSave(e) {
      e.preventDefault();
      
      const id = document.getElementById("achievementId").value;
      const data = {
        student_id: document.getElementById("studentSelect").value,
        title: document.getElementById("titleInput").value,
        description: document.getElementById("descInput").value,
        category: document.getElementById("categorySelect").value,
        achieved_at: document.getElementById("dateInput").value
      };

      if (!data.student_id || !data.title || !data.category || !data.achieved_at) {
         toast("Please fill all required fields", "fa-solid fa-circle-exclamation");
         return;
      }

      try {
        let res;
        if (isEditing) {
          res = await api.clerk.achievements.update(id, data);
        } else {
          res = await api.clerk.achievements.create(data);
        }

        if (res.ok) {
          toast(isEditing ? "Updated Successfully" : "Created Successfully", "fa-solid fa-check-circle");
          closeModal();
          loadAchievements();
        } else {
          toast("Failed to save", "fa-solid fa-circle-exclamation");
        }
      } catch (err) {
        console.error(err);
        toast("Error saving", "fa-solid fa-circle-exclamation");
      }
    }

    async function handleDelete(id) {
       toast("Are you sure you want to delete this achievement?", "fa-solid fa-trash", {
         confirm: true,
         confirmText: "Delete",
         onConfirm: async () => {
             try {
                const res = await api.clerk.achievements.delete(id);
                if (res.ok) {
                  loadAchievements();
                  toast("Deleted Successfully", "fa-solid fa-check-circle");
                } else {
                  toast("Failed to delete", "fa-solid fa-circle-exclamation");
                }
            } catch (err) {
                console.error(err);
                toast("Error deleting", "fa-solid fa-circle-exclamation");
            }
         }
       });
    }

    // Initialize
    init();
  </script>
</section>

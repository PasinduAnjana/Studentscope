
  <!-- Import Web Component -->
  <script src="js/components/ToggleSelect.js"></script>

  <h2 class="heading">
    <i class="fas fa-trophy"></i>
    <span>Achievement Management</span>
  </h2>
  <div class="card">
    <div class="flex-between mb-2">
      <h1 class="title">Achievements</h1>
      <button class="btn btn-primary" onclick="openModal()">
        <i class="fas fa-plus"></i> Add Achievement
      </button>
    </div>
    <data-table id="achievements-table">
        <div slot="filters" style="display: flex; gap: 10px; flex-wrap: wrap; align-items: center;">
            <div class="input-group" style="min-width: 150px; margin-bottom: 0;">
                <select id="categoryFilter">
                    <option value="">All Categories</option>
                    <option value="academic">Academic</option>
                    <option value="sports">Sports</option>
                    <option value="arts">Arts</option>
                </select>
            </div>

            <div class="input-group" style="min-width: 150px; margin-bottom: 0;">
                 <input type="date" id="dateFilter" placeholder="Filter by Date" style="margin-bottom: 0;">
            </div>
        </div>
    </data-table>
  </div>

  <!-- Modal using shared styles (from announcements.css) -->
  <modal-dialog id="achievementModal" title="Add Achievement">
      <div style="display: flex; flex-direction: column; gap: 15px;">
        <form id="achievementForm" onsubmit="handleSave(event)">
          <input type="hidden" id="achievementId" />
          
          <div class="form-group">
            <label for="studentSelect">Student</label>
            <select id="studentSelect" required style="width: 100%; padding: 8px; border: 1px solid var(--color-border); border-radius: 4px; background: var(--color-bg); color: var(--color-text);">
              <option value="">Select Student...</option>
            </select>
          </div>

          <div class="form-group">
            <label for="titleInput">Title</label>
            <input type="text" id="titleInput" required placeholder="e.g. Mathematics Competition Winner" style="width: 100%; padding: 8px; border: 1px solid var(--color-border); border-radius: 4px; background: var(--color-bg); color: var(--color-text);" />
          </div>

          <div class="form-group">
            <label for="descInput">Description</label>
            <textarea id="descInput" rows="3" required placeholder="Details about the achievement..." style="width: 100%; padding: 8px; border: 1px solid var(--color-border); border-radius: 4px; background: var(--color-bg); color: var(--color-text);"></textarea>
          </div>

          <div class="form-group">
            <label>Category</label>
            <!-- Custom Web Component -->
            <toggle-select id="categoryToggle" onclick="syncCategory()">
                <toggle-option value="academic" icon="fas fa-microscope">Academic</toggle-option>
                <toggle-option value="sports" icon="fas fa-trophy">Sports</toggle-option>
                <toggle-option value="arts" icon="fas fa-palette">Arts</toggle-option>
                <toggle-option value="other" icon="fas fa-star">Other</toggle-option>
            </toggle-select>
            <input type="hidden" id="categorySelect" required />
          </div>

          <div class="form-group">
            <label for="dateInput">Date</label>
            <input type="date" id="dateInput" required style="width: 100%; padding: 8px; border: 1px solid var(--color-border); border-radius: 4px; background: var(--color-bg); color: var(--color-text);" />
          </div>
        </form>
      </div>
      <div style="display: flex; justify-content: flex-end; gap: 12px; margin-top: 24px;">
        <button type="button" class="btn btn-secondary" onclick="closeModal()">Cancel</button>
        <button type="button" class="btn btn-primary" onclick="document.getElementById('achievementForm').dispatchEvent(new Event('submit'))">Save</button>
      </div>
  </modal-dialog>

  <script>
    let students = [];
    let isEditing = false;

    // Sync Web Component value with hidden input for form submission
    function syncCategory() {
        const toggle = document.querySelector('toggle-select');
        document.getElementById('categorySelect').value = toggle.value;
    }

    async function init() {
      await loadStudents();
      initTable();
      loadAchievements();
    }

    async function loadStudents() {
      try {
        const res = await api.clerk.students.getAll();
        if (res.ok) {
          students = await res.json();
          const select = document.getElementById("studentSelect");
          if(select) {
              select.innerHTML = '<option value="">Select Student...</option>';
              students.forEach(s => {
                const option = document.createElement("option");
                option.value = s.id; // Use s.id based on other files, or s.user_id if different
                option.textContent = `${s.full_name} (${s.username || 'No ID'})`;
                select.appendChild(option);
              });
          }
        }
      } catch (err) {
        console.error("Failed to load students", err);
        toast("Failed to load students", "fa-solid fa-circle-exclamation");
      }
    }

  function initTable() {
    const table = document.getElementById("achievements-table");
    table.setColumns([
        { key: "student_name", header: "Student", searchable: true, render: (row) => row.student_name || 'Unknown Student' },
        { 
            key: "title", 
            header: "Title / Description", 
            searchable: true,
            render: (row) => `<div>${row.title}</div><div class="text-sm">${row.description}</div>`
        },
        { 
            key: "category", 
            header: "Category", 
            render: (row) => {
                const icon = getCategoryIcon(row.category);
                return `<span><i class="fas ${icon}"></i> ${row.category}</span>`;
            }
        },
        { 
            key: "achieved_at", 
            header: "Date", 
            render: (row) => new Date(row.achieved_at).toLocaleDateString()
        },
        {
            key: "actions",
            header: "Actions",
            render: (row) => {
                const div = document.createElement("div");
                div.className = "action-buttons flex-center";
                
                const btnEdit = document.createElement("button");
                btnEdit.className = "btn-icon btn-edit";
                btnEdit.title = "Edit";
                btnEdit.innerHTML = '<i class="fas fa-edit"></i>';
                btnEdit.onclick = () => openEditModal(row);

                const btnDelete = document.createElement("button");
                btnDelete.className = "btn-icon btn-delete";
                btnDelete.title = "Delete";
                btnDelete.innerHTML = '<i class="fas fa-trash"></i>';
                btnDelete.onclick = () => handleDelete(row.id);
                
                div.appendChild(btnEdit);
                div.appendChild(btnDelete);
                return div;
            }
        }
    ]);
    table.setEmptyState("No achievements found", "fas fa-trophy");

    // Filters
    // const studentFilter = document.getElementById("studentFilter");
    const categoryFilter = document.getElementById("categoryFilter");
    const dateFilter = document.getElementById("dateFilter");

    // Make category filter searchable
    if (typeof makeSearchableDropdown === 'function' && categoryFilter) {
        makeSearchableDropdown('categoryFilter', (val) => {
             // Dispatch change event manually or call method
             // makeSearchableDropdown usually updates value but we need to trigger logic
             // But here we can just add filter directly in the callback or rely on the fact that value changes.
             // The callback (val) => ... is usually for selection handling.
             
             // Simplest way: update table filter immediately
             table.addFilter("category", (row) => {
                return val === "" || row.category === val;
            });
        });
    } else if (categoryFilter) {
        // Fallback standard listener
        categoryFilter.addEventListener("change", () => {
            const val = categoryFilter.value;
            table.addFilter("category", (row) => {
                return val === "" || row.category === val;
            });
        });
    }

    if (dateFilter) {
        dateFilter.addEventListener("change", () => {
            const val = dateFilter.value;
            table.addFilter("date", (row) => {
                if(!val) return true;
                return row.achieved_at.startsWith(val);
            });
        });
    }
  }

  async function loadAchievements() {
      try {
        const res = await api.clerk.achievements.getAll();
        if (!res.ok) throw new Error("Failed");
        const data = await res.json();
        document.getElementById("achievements-table").setData(data);
      } catch (err) {
        console.error(err);
        document.getElementById("achievements-table").setData([]);
        document.getElementById("achievements-table").setEmptyState("Error loading achievements", "fas fa-exclamation-triangle");
      }
    }

    function getCategoryIcon(cat) {
      switch(cat) {
        case 'academic': return 'fa-microscope';
        case 'sports': return 'fa-trophy';
        case 'arts': return 'fa-palette';
        default: return 'fa-star';
      }
    }

    function openModal() {
      isEditing = false;
      const modal = document.getElementById("achievementModal");
      if(modal) {
        modal.setTitle("Add Achievement");
        document.getElementById("achievementForm").reset();
        document.getElementById("achievementId").value = "";
        document.getElementById("dateInput").valueAsDate = new Date();
        
        // Reset Web Component
        const toggle = document.querySelector('toggle-select');
        if(toggle) toggle.value = ""; 
        document.getElementById('categorySelect').value = "";

        modal.open();
      }
    }

    function openEditModal(item) {
      isEditing = true;
      const modal = document.getElementById("achievementModal");
      if(modal) {
          modal.setTitle("Edit Achievement");
          document.getElementById("achievementId").value = item.id;
          document.getElementById("studentSelect").value = item.student_id; 
          document.getElementById("titleInput").value = item.title;
          document.getElementById("descInput").value = item.description;
          document.getElementById("categorySelect").value = item.category;
          document.getElementById("dateInput").value = item.achieved_at.split('T')[0];
          
          // Set Web Component value
          const toggle = document.querySelector('toggle-select');
          if(toggle) toggle.value = item.category;
          
          modal.open();
      }
    }

    function closeModal() {
      const modal = document.getElementById("achievementModal");
      if(modal) modal.close();
    }

    async function handleSave(e) {
      e.preventDefault();
      
      const id = document.getElementById("achievementId").value;
      const data = {
        student_id: document.getElementById("studentSelect").value,
        title: document.getElementById("titleInput").value,
        description: document.getElementById("descInput").value,
        category: document.getElementById("categorySelect").value,
        achieved_at: document.getElementById("dateInput").value
      };

      if (!data.student_id || !data.title || !data.category || !data.achieved_at) {
         toast("Please fill all required fields", "fa-solid fa-circle-exclamation");
         return;
      }

      try {
        let res;
        if (isEditing) {
          res = await api.clerk.achievements.update(id, data);
        } else {
          res = await api.clerk.achievements.create(data);
        }

        if (res.ok) {
          toast(isEditing ? "Updated Successfully" : "Created Successfully", "fa-solid fa-check-circle");
          closeModal();
          loadAchievements();
        } else {
          toast("Failed to save", "fa-solid fa-circle-exclamation");
        }
      } catch (err) {
        console.error(err);
        toast("Error saving", "fa-solid fa-circle-exclamation");
      }
    }

    async function handleDelete(id) {
       toast("Are you sure you want to delete this achievement?", "fa-solid fa-trash", {
         confirm: true,
         confirmText: "Delete",
         onConfirm: async () => {
             try {
                const res = await api.clerk.achievements.delete(id);
                if (res.ok) {
                  loadAchievements();
                  toast("Deleted Successfully", "fa-solid fa-check-circle");
                } else {
                  toast("Failed to delete", "fa-solid fa-circle-exclamation");
                }
            } catch (err) {
                console.error(err);
                toast("Error deleting", "fa-solid fa-circle-exclamation");
            }
         }
       });
    }

    // Initialize
    init();
  </script>
</section>

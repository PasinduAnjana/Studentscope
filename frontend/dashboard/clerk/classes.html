<h2 class="heading">
  <i class="fas fa-chalkboard"></i>
  <span data="sidebar.classes"></span>
</h2>

<div class="classes-container" id="classesContainer">
  <!-- Classes grid will be loaded here -->
</div>

<!-- Modal for assigning class teacher -->
<modal-dialog id="assignTeacherModal" title="Assign Class Teacher">
  <div style="display: flex; flex-direction: column; gap: 20px;">

    <div class="form-group mb-0" id="classNameGroup" style="display: none;">
      <label for="classNameInput"
        style="display: block; font-weight: 600; font-size: 14px; color: var(--color-text); margin-bottom: 8px;">Class
        Name</label>
      <div style="position: relative;">
        <input type="text" id="classNameInput" placeholder="Enter class name (e.g. A, B, C)"
          style="width: 100%; padding: 12px; border-radius: 12px; border: 1px solid var(--color-border); background-color: var(--color-bg); font-size: 15px;" />
      </div>
    </div>

    <div class="form-group mb-0">
      <label for="teacherSelect"
        style="display: block; font-weight: 600; font-size: 14px; color: var(--color-text); margin-bottom: 8px;">Teacher</label>
      <div style="position: relative;">
        <select id="teacherSelect"
          style="width: 100%; padding: 12px; border-radius: 12px; background-color: var(--color-bg); border: 1px solid var(--color-border); font-size: 15px; appearance: none; -webkit-appearance: none;">
          <option value="">-- Select a teacher --</option>
        </select>
        <i class="fas fa-chalkboard-teacher"
          style="position: absolute; right: 16px; top: 50%; transform: translateY(-50%); color: var(--color-subtext); pointer-events: none;"></i>
      </div>
    </div>

    <!-- Conditional Buttons (Delete / Remove) -->
    <div id="additionalActions" style="display: flex; gap: 12px; margin-top: 8px;">
      <button class="btn btn-outline" id="removeTeacherBtn" onclick="removeTeacher()"
        style="display: none; width: 100%; justify-content: center; font-size: 14px; border-style: dashed;">
        <i class="fas fa-user-minus"></i> Remove Teacher
      </button>
      <button class="btn btn-outline" id="deleteBtn" onclick="deleteClass()"
        style="display: none; width: 100%; justify-content: center; color: var(--color-error); border-color: var(--color-error); font-size: 14px; border-style: dashed;">
        <i class="fas fa-trash"></i> Delete Class
      </button>
    </div>

    <div style="display: flex; justify-content: flex-end; gap: 12px; margin-top: 10px;">
      <button class="btn" onclick="closeModal()"
        style="background: transparent; color: var(--color-subtext); padding: 10px 20px;">Cancel</button>
      <button class="btn btn-primary" onclick="saveTeacherAssignment()"
        style="padding: 10px 24px; border-radius: 12px; font-weight: 600;">Save</button>
    </div>

  </div>
</modal-dialog>

<script src="/js/ModalDialog.js"></script>
<script>
  let currentClassData = null;
  let allTeachers = [];
  // reference to searchable dropdown wrapper
  let searchableTeacherSelect = null;

  function updateSearchableDisplay(selectId) {
    const select = document.getElementById(selectId);
    if (!select) return;
    const wrapper = select.previousElementSibling;
    if (wrapper && wrapper.classList.contains("searchable-select")) {
      const displaySpan = wrapper.querySelector(".dropdown-display span");
      const opt =
        select.options[select.selectedIndex] ||
        Array.from(select.options).find((o) => o.value);
      if (displaySpan) displaySpan.textContent = opt ? opt.text : "";
    }
  }

  async function loadClasses() {
    try {
      // Fetch classes data and teachers list
      const [classesResponse, teachersResponse] = await Promise.all([
        fetch("/api/clerk/classes").then((res) => res.json()),
        fetch("/api/clerk/teachers").then((res) => res.json()),
      ]);

      if (classesResponse.error) {
        toast(
          "Unable to load classes: " + classesResponse.error,
          "fa-solid fa-exclamation-triangle"
        );
        return;
      }

      allTeachers = Array.isArray(teachersResponse) ? teachersResponse : [];

      // Group classes by grade
      const classesByGrade = {};
      if (Array.isArray(classesResponse)) {
        classesResponse.forEach((classItem) => {
          if (!classesByGrade[classItem.grade]) {
            classesByGrade[classItem.grade] = [];
          }
          classesByGrade[classItem.grade].push(classItem);
        });
      }

      // Sort grades numerically and render
      const sortedGrades = Object.keys(classesByGrade)
        .map((g) => parseInt(g))
        .sort((a, b) => a - b);

      const container = document.getElementById("classesContainer");
      container.innerHTML = "";

      sortedGrades.forEach((grade) => {
        const gradeSection = document.createElement("div");
        gradeSection.classList.add("grade-section");

        const gradeHeader = document.createElement("div");
        gradeHeader.classList.add("grade-header");
        gradeHeader.textContent = `Grade ${grade}`;

        const classesGrid = document.createElement("div");
        classesGrid.classList.add("classes-grid");

        // Render class tiles
        classesByGrade[grade].forEach((classItem) => {
          const classCard = createClassCard(classItem);
          classesGrid.appendChild(classCard);
        });

        // Add button to add new class
        const addClassCard = createAddClassCard(grade);
        classesGrid.appendChild(addClassCard);

        gradeSection.appendChild(gradeHeader);
        gradeSection.appendChild(classesGrid);
        container.appendChild(gradeSection);
      });
    } catch (error) {
      console.error("Error loading classes:", error);
      toast(
        "An error occurred while loading classes",
        "fa-solid fa-exclamation-triangle"
      );
    }
  }

  function createClassCard(classItem) {
    const card = document.createElement("div");
    card.classList.add("class-card");

    const classNameDiv = document.createElement("div");
    classNameDiv.classList.add("class-name");
    classNameDiv.textContent = classItem.class_name || "N/A";

    const teacherDiv = document.createElement("div");
    teacherDiv.classList.add("class-teacher");
    teacherDiv.textContent = classItem.teacher_name || "No teacher assigned";

    card.appendChild(classNameDiv);
    card.appendChild(teacherDiv);

    card.addEventListener("click", () => {
      currentClassData = classItem;
      openModal(classItem);
    });

    return card;
  }

  function createAddClassCard(grade) {
    const card = document.createElement("div");
    card.classList.add("class-card", "empty");

    const addBtn = document.createElement("button");
    addBtn.classList.add("add-class-btn");
    addBtn.innerHTML = '<i class="fas fa-plus"></i>';
    addBtn.onclick = (e) => {
      e.stopPropagation();
      currentClassData = { grade: grade, class_name: null };
      openModal({ grade: grade, class_name: null });
    };

    card.appendChild(addBtn);
    return card;
  }

  function openModal(classItem) {
    const modal = document.getElementById("assignTeacherModal");
    const teacherSelect = document.getElementById("teacherSelect");

    if (classItem.class_name) {
      modal.setTitle(`Assign Teacher - Grade ${classItem.grade} ${classItem.class_name}`);
      document.getElementById("classNameGroup").style.display = "none";
      document.getElementById("deleteBtn").style.display = "flex";

      // Show remove teacher button if a teacher is assigned
      if (classItem.teacher_id) {
        document.getElementById("removeTeacherBtn").style.display = "flex";
      } else {
        document.getElementById("removeTeacherBtn").style.display = "none";
      }
    } else {
      modal.setTitle(`Add New Class - Grade ${classItem.grade}`);
      document.getElementById("classNameGroup").style.display = "block";
      document.getElementById("classNameInput").value = "";
      document.getElementById("deleteBtn").style.display = "none";
      document.getElementById("removeTeacherBtn").style.display = "none";
    }

    // Populate teacher dropdown
    teacherSelect.innerHTML =
      '<option value="">-- Select a teacher --</option>';
    allTeachers.forEach((teacher) => {
      const option = document.createElement("option");
      option.value = teacher.teacher_id;
      option.textContent = teacher.full_name;
      if (classItem.teacher_id === teacher.teacher_id) {
        option.selected = true;
      }
      teacherSelect.appendChild(option);
    });

    // destroy previous searchable instance if any
    if (
      searchableTeacherSelect &&
      typeof searchableTeacherSelect.destroy === "function"
    ) {
      searchableTeacherSelect.destroy();
      searchableTeacherSelect = null;
    }

    // transform into searchable dropdown
    if (typeof makeSearchableDropdown === "function") {
      searchableTeacherSelect = makeSearchableDropdown(
        "teacherSelect",
        (val, text) => {
          // nothing extra needed; makeSearchableDropdown will set select.value
        }
      );
      // update display to reflect selected option
      updateSearchableDisplay("teacherSelect");
    }
    modal.open();
  }

  function closeModal() {
    const modal = document.getElementById("assignTeacherModal");
    modal.close();
    currentClassData = null;
  }

  function closeModal() {
    const modal = document.getElementById("assignTeacherModal");
    modal.classList.remove("active");
    currentClassData = null;
  }

  async function saveTeacherAssignment() {
    const teacherSelect = document.getElementById("teacherSelect");
    const selectedTeacherId = teacherSelect.value;

    if (!selectedTeacherId) {
      toast("Please select a teacher", "fa-solid fa-exclamation-triangle");
      return;
    }

    if (!currentClassData) {
      toast("No class selected", "fa-solid fa-exclamation-triangle");
      return;
    }

    window.requirePinPrompt(async () => {
      try {
        const payload = {
          grade: currentClassData.grade,
          teacher_id: selectedTeacherId,
        };

        if (!currentClassData.class_name) {
          const className = document
            .getElementById("classNameInput")
            .value.trim();
          if (!className) {
            toast(
              "Please enter a class name",
              "fa-solid fa-exclamation-triangle"
            );
            return;
          }
          payload.class_name = className;
        } else {
          payload.class_name = currentClassData.class_name;
        }

        const response = await fetch("/api/clerk/classes/assign-teacher", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify(payload),
        });

        const data = await response.json();

        if (data.error) {
          toast("Error: " + data.error, "fa-solid fa-exclamation-triangle");
          return;
        }

        toast("Teacher assigned successfully!", "fa-solid fa-check-circle");
        closeModal();
        loadClasses();
      } catch (error) {
        console.error("Error saving teacher assignment:", error);
        toast(
          "An error occurred while saving",
          "fa-solid fa-exclamation-triangle"
        );
      }
    });
  }

  async function removeTeacher() {
    if (!currentClassData) return;

    toast("Are you sure you want to remove the teacher from this class?", "fa-solid fa-user-minus", {
      confirm: true,
      onConfirm: async () => {
        window.requirePinPrompt(async () => {
          try {
            const payload = {
              grade: currentClassData.grade,
              class_name: currentClassData.class_name,
              teacher_id: null
            };

            const response = await fetch("/api/clerk/classes/assign-teacher", {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify(payload),
            });

            const data = await response.json();

            if (data.error) {
              toast("Error: " + data.error, "fa-solid fa-exclamation-triangle");
              return;
            }

            toast("Teacher removed successfully!", "fa-solid fa-check-circle");
            closeModal();
            loadClasses();
          } catch (error) {
            console.error("Error removing teacher:", error);
            toast("An error occurred while removing teacher", "fa-solid fa-exclamation-triangle");
          }
        });
      }
    });
  }

  async function deleteClass() {
    if (!currentClassData || !currentClassData.id) {
      toast("No class selected", "fa-solid fa-exclamation-triangle");
      return;
    }

    toast("Are you sure you want to delete this class?", "fa-solid fa-trash", {
      confirm: true,
      onConfirm: async () => {
        window.requirePinPrompt(async () => {
          try {
            const response = await fetch(
              `/api/clerk/classes/${currentClassData.id}`,
              {
                method: "DELETE",
              }
            );

            const data = await response.json();

            if (data.error) {
              toast("Error: " + data.error, "fa-solid fa-exclamation-triangle");
              return;
            }

            toast("Class deleted successfully!", "fa-solid fa-check-circle");
            closeModal();
            loadClasses();
          } catch (error) {
            console.error("Error deleting class:", error);
            toast(
              "An error occurred while deleting",
              "fa-solid fa-exclamation-triangle"
            );
          }
        });
      },
    });
  }

  // Close modal when clicking outside - Handled by ModalDialog component
  // window.addEventListener("click", (event) => {
  //   const modal = document.getElementById("assignTeacherModal");
  //   if (event.target === modal) {
  //     closeModal();
  //   }
  // });

  loadClasses();
</script>
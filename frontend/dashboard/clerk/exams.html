<style>
  .action-buttons {
    display: flex;
    gap: 5px;
    justify-content: center;
  }
  .form-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 15px;
  }
  
  /* Standard Icon Button Styles matching other tables */
  .btn-icon {
    padding: 6px;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    font-size: 14px;
    transition: all 0.2s ease;
    display: flex;
    align-items: center;
    justify-content: center;
    width: 32px;
    height: 32px;
    background-color: transparent;
    color: var(--color-primary);
  }

  .btn-icon:hover {
    color: var(--color-primary-hover);
    background-color: rgba(0, 134, 187, 0.1);
    transform: scale(1.1);
  }
</style>

<section class="section">
  <h2 class="heading">
    <i class="fas fa-file-signature"></i>
    <span>Exam Management</span>
  </h2>
  <div class="card">
    <div class="flex-between mb-2">
      <h1 class="title">Exams</h1>
      <button
        id="add-exam-btn"
        class="btn btn-primary"
        onclick="openAddExamModal()"
      >
        <i class="fas fa-plus"></i> Create Exam
      </button>
    </div>
    
    <data-table id="exams-table">
        <!-- Filters if needed -->
    </data-table>
  </div>
</section>

<!-- Add Exam Modal -->
<modal-dialog id="exam-modal" title="Create Exam">
    <div class="form-grid">
        <div class="input-group">
            <label for="exam-type">Type: <span class="required">*</span></label>
            <select id="exam-type" required onchange="handleTypeChange()">
                <option value="term">Term Test</option>
                <option value="gov">Government Exam</option>
            </select>
        </div>
        
        <div class="input-group">
            <label for="exam-year">Year: <span class="required">*</span></label>
            <input type="number" id="exam-year" required min="2000" max="2100" />
        </div>

        <div class="input-group">
            <label for="exam-sub-type">Exam Name/Term: <span class="required">*</span></label>
            <select id="exam-sub-type" required>
                <!-- Populated dynamically -->
            </select>
        </div>

        <div class="input-group" id="target-grade-group" style="display: none;">
            <label for="target-grade">Target Grade:</label>
            <input type="number" id="target-grade" min="1" max="13" />
        </div>
        
        <div class="input-group" style="grid-column: span 2;">
             <label for="exam-name">Display Name (Auto-generated):</label>
             <input type="text" id="exam-name" readonly />
        </div>
    </div>
    
    <div style="display: flex; justify-content: flex-end; gap: 12px; margin-top: 24px;">
      <button id="modal-cancel" class="btn btn-secondary">Cancel</button>
      <button id="modal-save" class="btn btn-primary">Create</button>
    </div>
</modal-dialog>

<script>
    let allExams = [];

    function initTable() {
        const table = document.getElementById("exams-table");
        table.setColumns([
            { key: "name", header: "Exam Name", searchable: true },
            { key: "type", header: "Type", render: (row) => row.type === 'gov' ? 'Government' : 'Term Test' },
            { key: "year", header: "Year" },
            { 
                key: "actions", 
                header: "Actions", 
                render: (row) => {
                    const div = document.createElement("div");
                    div.className = "action-buttons";
                    
                    if (row.type === 'gov') {
                         div.innerHTML += `
                            <button class="btn-icon" onclick="manageStudents(${row.id})" title="Manage Students">
                                <i class="fas fa-users-cog"></i>
                            </button>
                         `;
                    }
                    
                    div.innerHTML += `
                        <button class="btn-icon" onclick="enterMarks(${row.id}, '${row.type}')" title="Enter Marks">
                            <i class="fas fa-edit"></i>
                        </button>
                    `;
                    
                    return div;
                }
            }
        ]);
        table.setEmptyState("No exams found", "fas fa-folder-open");
    }

    function fetchExams() {
        api.clerk.exams.getAll()
        .then(res => {
            if(!res.ok) throw new Error("Failed");
            return res.json();
        })
        .then(data => {
            allExams = data;
            document.getElementById("exams-table").setData(data);
        })
        .catch(err => {
            console.error(err);
            toast("Error loading exams", "fa-solid fa-circle-exclamation");
        });
    }

    function handleTypeChange() {
        const type = document.getElementById("exam-type").value;
        const subTypeSelect = document.getElementById("exam-sub-type");
        const targetGradeGroup = document.getElementById("target-grade-group");
        const targetGradeInput = document.getElementById("target-grade");
        
        subTypeSelect.innerHTML = "";
        
        if (type === 'term') {
            targetGradeGroup.style.display = 'none';
            targetGradeInput.value = "";
            ['Term1', 'Term2', 'Term3'].forEach(t => {
                const opt = document.createElement("option");
                opt.value = t;
                opt.textContent = t.replace(/(\d)/, ' $1'); // Term 1
                subTypeSelect.appendChild(opt);
            });
        } else {
            targetGradeGroup.style.display = 'block';
             const options = [
                 {val: 'OL', text: 'GCE O/L', grade: 11},
                 {val: 'AL', text: 'GCE A/L', grade: 13},
                 {val: 'Grade5', text: 'Grade 5 Scholarship', grade: 5}
             ];
             
             options.forEach(o => {
                 const opt = document.createElement("option");
                 opt.value = o.val;
                 opt.textContent = o.text;
                 opt.dataset.grade = o.grade;
                 subTypeSelect.appendChild(opt);
             });
             
             // Set default grade
             targetGradeInput.value = options[0].grade;
        }
        updateName();
    }
    
    function updateName() {
        const type = document.getElementById("exam-type").value;
        const subTypeId = document.getElementById("exam-sub-type").value;
        const subTypeNodes = document.getElementById("exam-sub-type").options;
        const subTypeText = subTypeNodes[document.getElementById("exam-sub-type").selectedIndex]?.text || "";
        const year = document.getElementById("exam-year").value;
        
        if (year && subTypeText) {
            document.getElementById("exam-name").value = `${subTypeText} ${year}`;
        }
        
        // Auto update grade if changed
        if (type === 'gov') {
             const selectedOpt = subTypeNodes[document.getElementById("exam-sub-type").selectedIndex];
             if(selectedOpt) {
                 document.getElementById("target-grade").value = selectedOpt.dataset.grade;
             }
        }
    }

    function openAddExamModal() {
        const modal = document.getElementById("exam-modal");
        document.getElementById("exam-year").value = new Date().getFullYear();
        handleTypeChange();
        modal.open();
    }
    
    function saveExam() {
        const data = {
            type: document.getElementById("exam-type").value,
            sub_type: document.getElementById("exam-sub-type").value,
            year: parseInt(document.getElementById("exam-year").value),
            name: document.getElementById("exam-name").value,
            target_grade: document.getElementById("target-grade").value ? parseInt(document.getElementById("target-grade").value) : null
        };
        
        api.clerk.exams.create(data)
        .then(res => {
            if (!res.ok) throw new Error("Failed");
             document.getElementById("exam-modal").close();
             toast("Exam created", "fa-solid fa-check-circle");
             fetchExams();
        })
        .catch(err => {
             console.error(err);
             toast("Error creating exam", "fa-solid fa-circle-exclamation");
        });
    }
    
    // Bind events
    document.getElementById("exam-type").addEventListener("change", handleTypeChange);
    document.getElementById("exam-sub-type").addEventListener("change", updateName);
    document.getElementById("exam-year").addEventListener("input", updateName);
    document.getElementById("modal-save").addEventListener("click", saveExam);
    document.getElementById("modal-cancel").addEventListener("click", () => document.getElementById("exam-modal").close());
    
    function manageStudents(id) {
        // Update URL to match dashboard router expectation
        // We use query params ?page=exam_students&examId=...
        const url = new URL(window.location);
        url.searchParams.set("page", "exam_students");
        url.searchParams.set("examId", id);
        window.history.pushState({}, "", url);
        
        loadPage('clerk', 'exam_students');
    }
    
    function enterMarks(id, type) {
        const url = new URL(window.location);
        url.searchParams.set("page", "exam_marks");
        url.searchParams.set("examId", id);
        url.searchParams.set("type", type);
        window.history.pushState({}, "", url);
        
        loadPage('clerk', 'exam_marks');
    }

    initTable();
    fetchExams();
</script>

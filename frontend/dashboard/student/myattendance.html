<h2 class="heading">
  <i class="fas fa-user-check"></i>
  <span data="student.attendance"></span>
</h2>

<div class="card-grid">
  <!-- Overall Attendance Percentage -->
  <div class="card w-1 h-2 dashboard-tile" id="attendanceSummary">
    <div class="icon-title">
      <i class="fas fa-chart-pie icon"></i>
      <p
        class="tile-label"
        data-en="Attendance Percentage"
        data-si="පැමිණීම් ප්‍රතිශතය"
        data-ta="வருகை சதவீதம்"
      >
        Attendance Percentage
      </p>
    </div>
    <canvas id="attendanceChart" height="150"></canvas>
  </div>

  <!-- Present Days This Month -->
  <div class="card w-1 h-1 dashboard-tile" id="presentDaysCard">
    <div class="icon-title">
      <i class="fas fa-calendar-check icon"></i>
      <p
        class="tile-label"
        data-en="Present Days"
        data-si="පැමිණි දින"
        data-ta="வருகை நாட்கள்"
      >
        Present Days
      </p>
    </div>
    <div class="stats-content">
      <div class="stat-item">
        <div class="stat-icon">
          <i class="fas fa-calendar-day"></i>
        </div>
        <span class="stat-number" id="presentDaysCount">-</span>
        <span
          class="stat-label"
          data-en="This Month"
          data-si="මෙම මාසය"
          data-ta="இந்த மாதம்"
          >This Month</span
        >
      </div>
    </div>
  </div>

  <!-- Attendance Stats -->
  <div class="card w-1 h-1 dashboard-tile" id="attendanceStats">
    <div class="icon-title">
      <i class="fas fa-chart-bar icon"></i>
      <p
        class="tile-label"
        data-en="Attendance Stats"
        data-si="පැමිණීම් සංඛ්‍යා"
        data-ta="வருகை புள்ளிவிவரங்கள்"
      >
        Attendance Stats
      </p>
    </div>
    <div class="stats-content">
      <div class="stat-item">
        <div class="stat-icon">
          <i class="fas fa-check-circle"></i>
        </div>
        <span class="stat-number" id="totalPresent">-</span>
        <span
          class="stat-label"
          data-en="Total Present"
          data-si="මුළු පැමිණි"
          data-ta="மொத்த வருகை"
          >Total Present</span
        >
      </div>
      <div class="stat-item">
        <div class="stat-icon">
          <i class="fas fa-calendar-alt"></i>
        </div>
        <span class="stat-number" id="totalDays">-</span>
        <span
          class="stat-label"
          data-en="Total Days"
          data-si="මුළු දින"
          data-ta="மொத்த நாட்கள்"
          >Total Days</span
        >
      </div>
    </div>
  </div>

  <!-- Monthly Overview -->
  <div class="card w-2 h-1 dashboard-tile">
    <div class="icon-title">
      <i class="fas fa-chart-line icon"></i>
      <p
        class="tile-label"
        data-en="Monthly Overview"
        data-si="මාසික දසුන"
        data-ta="மাসிக மதிப்பாய்வு"
      >
        Monthly Overview
      </p>
    </div>
    <div id="monthlyOverview">
      <p
        class="text-sm"
        data-en="Monthly attendance data will be displayed here"
        data-si="මාසික පැමිණීම් ගිණුම් දත්ත මෙහි පෙන්වනු ඇත"
        data-ta="மாசிக வருகை தரவு இங்கே காட்டப்படும்"
      >
        Monthly attendance data will be displayed here
      </p>
    </div>
  </div>
</div>

<script>
  const rootStyles = getComputedStyle(document.documentElement);
  const primaryColor = rootStyles.getPropertyValue("--color-primary").trim();
  const secondaryColor = rootStyles.getPropertyValue("--color-border").trim();

  async function loadAttendanceData() {
    try {
      // Load overall attendance percentage
      const percentageRes = await fetch("/api/student/attendance/percentage");
      let attendanceData = { totalDays: 0, presentDays: 0 };

      if (percentageRes.ok) {
        attendanceData = await percentageRes.json();
      }

      // Load present days this month
      const presentDaysRes = await fetch(
        "/api/student/attendance/present-days"
      );
      let presentDaysThisMonth = 0;

      if (presentDaysRes.ok) {
        const presentDaysData = await presentDaysRes.json();
        presentDaysThisMonth = presentDaysData.presentDays || 0;
      }

      // Update stats
      document.getElementById("totalPresent").textContent =
        attendanceData.presentDays;
      document.getElementById("totalDays").textContent =
        attendanceData.totalDays;
      document.getElementById("presentDaysCount").textContent =
        presentDaysThisMonth;

      // Calculate percentage
      const totalDays = attendanceData.totalDays;
      const presentDays = attendanceData.presentDays;
      const percentage =
        totalDays > 0 ? Math.round((presentDays / totalDays) * 100) : 0;

      // --- Custom plugin to draw center text in doughnut ---
      const centerTextPlugin = {
        id: "centerText",
        beforeDraw(chart, args, options) {
          if (chart.config.type !== "doughnut") return;
          const { ctx, width, height } = chart;
          ctx.save();
          const fontSize = (height / 160).toFixed(2);
          ctx.font = `${fontSize}em sans-serif`;
          ctx.textBaseline = "middle";
          ctx.textAlign = "center";
          ctx.fillStyle = options.color || primaryColor;
          const text = options.text || "";
          ctx.fillText(
            text,
            width / 2,
            chart.getDatasetMeta(0).data[0]?.y || height / 2
          );
          ctx.restore();
        },
      };

      // --- Attendance Doughnut Chart ---
      const chartData = {
        labels: [
          (() => {
            const lang = localStorage.getItem("lang") || "en";
            const labels = { en: "Present", si: "පැමිණි", ta: "வருகை" };
            return labels[lang] || "Present";
          })(),
          (() => {
            const lang = localStorage.getItem("lang") || "en";
            const labels = { en: "Absent", si: "නොපැමිණි", ta: "வருகை இல்லை" };
            return labels[lang] || "Absent";
          })(),
        ],
        datasets: [
          {
            data: [presentDays, totalDays - presentDays],
            backgroundColor: [primaryColor, primaryColor + "40"],
            borderRadius: 20,
          },
        ],
      };

      const chartText = totalDays > 0 ? `${percentage}%` : "No Data";

      new Chart(document.getElementById("attendanceChart"), {
        type: "doughnut",
        data: chartData,
        options: {
          responsive: true,
          cutout: "85%",
          borderColor: "transparent",
          plugins: {
            legend: { position: "bottom" },
            title: {
              display: true,
              text: (() => {
                const lang = localStorage.getItem("lang") || "en";
                const titles = {
                  en: "Overall Attendance",
                  si: "සමස්ත පැමිණීම්",
                  ta: "ஒட்டுமொத்த வருகை",
                };
                return titles[lang] || "Overall Attendance";
              })(),
              font: { size: 16, weight: "bold" },
              position: "bottom",
            },
            centerText: {
              text: chartText,
              color: primaryColor,
            },
          },
        },
        plugins: [centerTextPlugin],
      });

      // --- Monthly Overview ---
      const monthlyOverview = document.getElementById("monthlyOverview");
      if (totalDays > 0) {
        const lang = localStorage.getItem("lang") || "en";
        const labels = {
          rate: {
            en: "Attendance Rate",
            si: "පැමිණීම් අනුපාතය",
            ta: "வருகை விகிதம்",
          },
          thisMonth: { en: "This Month", si: "මෙම මාසය", ta: "இந்த மாதம்" },
          totalDays: { en: "Total Days", si: "මුළු දින", ta: "மொத்த நாட்கள்" },
        };
        monthlyOverview.innerHTML = `
          <div style="display: flex; justify-content: space-around; align-items: center; height: 100%;">
            <div style="text-align: center;">
              <div style="font-size: 24px; font-weight: bold; color: ${primaryColor};">${percentage}%</div>
              <div style="font-size: 12px; color: var(--color-text-secondary);">${
                labels.rate[lang] || "Attendance Rate"
              }</div>
            </div>
            <div style="text-align: center;">
              <div style="font-size: 24px; font-weight: bold; color: ${primaryColor};">${presentDaysThisMonth}</div>
              <div style="font-size: 12px; color: var(--color-text-secondary);">${
                labels.thisMonth[lang] || "This Month"
              }</div>
            </div>
            <div style="text-align: center;">
              <div style="font-size: 24px; font-weight: bold; color: ${primaryColor};">${totalDays}</div>
              <div style="font-size: 12px; color: var(--color-text-secondary);">${
                labels.totalDays[lang] || "Total Days"
              }</div>
            </div>
          </div>
        `;
      } else {
        const lang = localStorage.getItem("lang") || "en";
        const msg = {
          en: "No attendance data available",
          si: "පැමිණීම් ගිණුම් දත්ත නැත",
          ta: "வருகை தரவு இல்லை",
        };
        monthlyOverview.innerHTML = `
          <div style="display: flex; align-items: center; justify-content: center; height: 100%;">
            <p class="text-sm">${
              msg[lang] || "No attendance data available"
            }</p>
          </div>
        `;
      }
    } catch (error) {
      console.error("Error loading attendance data:", error);
      // Show error state
      document.getElementById("totalPresent").textContent = "Error";
      document.getElementById("totalDays").textContent = "Error";
      document.getElementById("presentDaysCount").textContent = "Error";
    }
  }

  // Load attendance data on page load
  loadAttendanceData();
</script>

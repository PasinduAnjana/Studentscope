<section class="section">
  <h2 class="heading">
    <i class="fas fa-user"></i>
    <span data="sidebar.profile"></span>
  </h2>

  <div class="card-grid">
    <!-- Profile Information -->
    <div class="card w-1 h-1 profile-card">
      <div class="profile-header">
        <div class="profile-avatar">
          <i class="fas fa-user-circle"></i>
        </div>
        <div class="profile-info">
          <h3 id="student-name">Loading...</h3>
          <p
            id="student-role"
            class="text-sm"
            data-en="Student"
            data-si="ශිෂ්‍ය"
            data-ta="மாணவர்"
          >
            Student
          </p>
        </div>
      </div>

      <div class="profile-details">
        <div class="detail-row">
          <span
            class="detail-label"
            data-en="Index Number:"
            data-si="දර්ශක අංකය:"
            data-ta="குறியீட்ட எண்:"
            >Index Number:</span
          >
          <span id="student-username">-</span>
        </div>
        <div class="detail-row">
          <span
            class="detail-label"
            data-en="Class:"
            data-si="පන්තිය:"
            data-ta="வகுப்பு:"
            >Class:</span
          >
          <span id="student-class">-</span>
        </div>
        <div class="detail-row">
          <span
            class="detail-label"
            data-en="Grade:"
            data-si="ශ්‍රේණිය:"
            data-ta="தர:"
            >Grade:</span
          >
          <span id="student-grade">-</span>
        </div>
      </div>
    </div>

    <!-- Student Personal Details -->
    <div class="card w-1 h-1 profile-card">
      <div class="profile-header">
        <div class="profile-avatar">
          <i class="fas fa-id-card"></i>
        </div>
        <div class="profile-info">
          <h3
            data-en="Personal Details"
            data-si="පෞද්ගලික විස්තර"
            data-ta="தனிப்பட்ட விவரங்கள்"
          >
            Personal Details
          </h3>
          <p
            class="text-sm"
            data-en="Student Information"
            data-si="ශිෂ්‍ය විස්තර"
            data-ta="மாணவர் தகவல்"
          >
            Student Information
          </p>
        </div>
      </div>

      <div class="profile-details">
        <div class="detail-row">
          <span
            class="detail-label"
            data-en="Full Name:"
            data-si="සම්පූර්ණ නම:"
            data-ta="முழு பெயர்:"
            >Full Name:</span
          >
          <span id="student-full-name">-</span>
        </div>
        <div class="detail-row">
          <span
            class="detail-label"
            data-en="Birthday:"
            data-si="උපන්න දිනය:"
            data-ta="பிறந்த தேதி:"
            >Birthday:</span
          >
          <span id="student-birthday">-</span>
        </div>
        <div class="detail-row">
          <span
            class="detail-label"
            data-en="Gender:"
            data-si="ස්ත්‍රී පුරුෂ භාවය:"
            data-ta="பாலினம்:"
            >Gender:</span
          >
          <span id="student-gender">-</span>
        </div>
        <div class="detail-row">
          <span
            class="detail-label"
            data-en="Nationality:"
            data-si="ජාතිකත්වය:"
            data-ta="தேசியத்தன்மை:"
            >Nationality:</span
          >
          <span id="student-nationality">-</span>
        </div>
        <div class="detail-row">
          <span
            class="detail-label"
            data-en="Address:"
            data-si="ලිපිනය:"
            data-ta="முகவரி:"
            >Address:</span
          >
          <span id="student-address">-</span>
        </div>
      </div>
    </div>

    <!-- Parent Information -->
    <div class="card w-1 h-1 profile-card">
      <div class="profile-header">
        <div class="profile-avatar">
          <i class="fas fa-users"></i>
        </div>
        <div class="profile-info">
          <h3
            data-en="Parent Information"
            data-si="මව්පිය විස්තර"
            data-ta="பெற்றோர் விவரங்கள்"
          >
            Parent Information
          </h3>
          <p
            class="text-sm"
            data-en="Guardian Details"
            data-si="අභියසක විස්තර"
            data-ta="காவலர் விவரங்கள்"
          >
            Guardian Details
          </p>
        </div>
      </div>

      <div class="profile-details">
        <div class="detail-row">
          <span
            class="detail-label"
            data-en="Parent Name:"
            data-si="පිතුරු නම:"
            data-ta="பெற்றோரின் பெயர்:"
            >Parent Name:</span
          >
          <span id="parent-name">-</span>
        </div>
        <div class="detail-row">
          <span
            class="detail-label"
            data-en="Parent Address:"
            data-si="පිතුරු ලිපිනය:"
            data-ta="பெற்றோரின் முகவரி:"
            >Parent Address:</span
          >
          <span id="parent-address">-</span>
        </div>
      </div>
    </div>

    <!-- Quick Stats -->
    <div class="card w-1 h-1 dashboard-tile">
      <div class="icon-title">
        <i class="fas fa-chart-bar icon"></i>
        <p
          class="tile-label"
          data-en="Quick Stats"
          data-si="ඉක්මන් සංඛ්‍යාංක"
          data-ta="விரைவு புள்ளிவிவரங்கள்"
        >
          Quick Stats
        </p>
      </div>
      <div class="stats-content">
        <div class="stat-item">
          <div class="stat-icon">
            <i class="fas fa-percentage"></i>
          </div>
          <span class="stat-number" id="attendance-percentage">-</span>
          <span
            class="stat-label"
            data-en="Attendance"
            data-si="පැමිණීම"
            data-ta="வருகை"
            >Attendance</span
          >
        </div>
        <div class="stat-item">
          <div class="stat-icon">
            <i class="fas fa-graduation-cap"></i>
          </div>
          <span class="stat-number" id="average-marks">-</span>
          <span
            class="stat-label"
            data-en="Avg Marks"
            data-si="සාමාන්‍ය ලකුණු"
            data-ta="சராசரி மதிப்பெண்கள்"
            >Avg Marks</span
          >
        </div>
        <div class="stat-item">
          <div class="stat-icon">
            <i class="fas fa-calendar-check"></i>
          </div>
          <span class="stat-number" id="present-days">-</span>
          <span
            class="stat-label"
            data-en="Present Days"
            data-si="පැමිණි දින"
            data-ta="வருகை நாட்கள்"
            >Present Days</span
          >
        </div>
      </div>
    </div>

    <!-- Change Password -->
    <div class="card w-2 h-1 profile-card">
      <div class="profile-header">
        <div class="profile-avatar">
          <i class="fas fa-lock"></i>
        </div>
        <div class="profile-info">
          <h3
            data-en="Change Password"
            data-si="මුරපදය වෙනස් කරන්න"
            data-ta="கடவுச்சொல்லை மாற்றவும்"
          >
            Change Password
          </h3>
          <p
            class="text-sm"
            data-en="Update your password"
            data-si="ඔබේ මුරපදය යාවත්කාලීන කරන්න"
            data-ta="உங்கள் கடவுச்சொல்லைப் புதுப்பிக்கவும்"
          >
            Update your password
          </p>
        </div>
      </div>

      <div class="profile-details">
        <div class="detail-row">
          <label
            for="old-password"
            class="detail-label"
            data-en="Old Password:"
            data-si="පැරණි මුරපදය:"
            data-ta="பழைய கடவுச்சொல்:"
          >
            Old Password:
          </label>
          <input
            type="password"
            id="old-password"
            placeholder="Enter old password"
            data-placeholder-en="Enter old password"
            data-placeholder-si="පැරණි මුරපදය ඇතුළු කරන්න"
            data-placeholder-ta="பழைய கடவுச்சொல்லை உள்ளிடவும்"
          />
        </div>

        <div class="detail-row">
          <label
            for="new-password"
            class="detail-label"
            data-en="New Password:"
            data-si="නව මුරපදය:"
            data-ta="புதிய கடவுச்சொல்:"
          >
            New Password:
          </label>
          <input
            type="password"
            id="new-password"
            placeholder="Enter new password"
            data-placeholder-en="Enter new password"
            data-placeholder-si="නව මුරපදය ඇතුළු කරන්න"
            data-placeholder-ta="புதிய கடவுச்சொல்லை உள்ளிடவும்"
          />
        </div>

        <div class="detail-row">
          <label
            for="confirm-password"
            class="detail-label"
            data-en="Confirm Password:"
            data-si="මුරපදය තහවුරු කරන්න:"
            data-ta="கடவுச்சொல்லை உறுதிப்படுத்தவும்:"
          >
            Confirm Password:
          </label>
          <input
            type="password"
            id="confirm-password"
            placeholder="Confirm new password"
            data-placeholder-en="Confirm new password"
            data-placeholder-si="නව මුරපදය තහවුරු කරන්න"
            data-placeholder-ta="புதிய கடவுச்சொல்லை உறுதிப்படுத்தவும்"
          />
        </div>

        <div class="detail-row">
          <button
            id="change-password-btn"
            onclick="changePassword()"
            data-en="Update Password"
            data-si="මුරපදය යාවත්කාලීන කරන්න"
            data-ta="கடவுச்சொல்லைப் புதுப்பிக்கவும்"
            class="btn btn-primary"
          >
            Update Password
          </button>
        </div>
      </div>
    </div>

    <!-- Class Information -->
    <div class="card w-1 h-1 dashboard-tile">
      <div class="icon-title">
        <i class="fas fa-school icon"></i>
        <p
          class="tile-label"
          data-en="Class Details"
          data-si="පන්ති විස්තර"
          data-ta="வகுப்பு விவரங்கள்"
        >
          Class Details
        </p>
      </div>
      <div id="class-info">
        <p
          class="text-sm"
          data-en="Loading class information..."
          data-si="පන්ති තොරතුරු පූරණය වෙමින්..."
          data-ta="வகுப்பு தකவல் ஏற්றப்படுகிறது..."
        >
          Loading class information...
        </p>
      </div>
    </div>
  </div>
</section>

<script>
  async function loadProfile() {
    try {
      const response = await fetch("/api/student/profile");
      if (!response.ok) throw new Error("Failed to fetch profile");

      const profile = await response.json();

      // Update profile information
      document.getElementById("student-name").textContent =
        profile.full_name || profile.username;
      document.getElementById("student-username").textContent =
        profile.username;

      if (profile.class_name && profile.class_grade) {
        document.getElementById(
          "student-class"
        ).textContent = `${profile.class_name}`;
        document.getElementById(
          "student-grade"
        ).textContent = `Grade ${profile.class_grade}`;
      } else {
        document.getElementById("student-class").textContent = "Not assigned";
        document.getElementById("student-grade").textContent = "Not assigned";
      }

      // Update personal details
      document.getElementById("student-full-name").textContent =
        profile.full_name || "-";
      document.getElementById("student-birthday").textContent = profile.birthday
        ? new Date(profile.birthday).toLocaleDateString()
        : "-";
      document.getElementById("student-gender").textContent =
        profile.gender || "-";
      document.getElementById("student-nationality").textContent =
        profile.nationality || "-";
      document.getElementById("student-address").textContent =
        profile.address || "-";

      // Update parent information
      document.getElementById("parent-name").textContent =
        profile.parent_name || "-";
      document.getElementById("parent-address").textContent =
        profile.parent_address || "-";

      // Load additional stats
      await loadProfileStats();
    } catch (error) {
      console.error("Error loading profile:", error);
      document.getElementById("student-name").textContent =
        "Error loading profile";
    }
  }

  async function loadProfileStats() {
    try {
      // Load attendance percentage
      const attendanceResponse = await fetch(
        "/api/student/attendance/percentage"
      );
      if (attendanceResponse.ok) {
        const attendance = await attendanceResponse.json();
        const percentage =
          attendance.totalDays > 0
            ? Math.round((attendance.presentDays / attendance.totalDays) * 100)
            : 0;
        document.getElementById(
          "attendance-percentage"
        ).textContent = `${percentage}%`;
      }

      // Load average marks
      const marksResponse = await fetch("/api/student/marks/average");
      if (marksResponse.ok) {
        const marks = await marksResponse.json();
        const average = marks.average
          ? Math.round(marks.average * 100) / 100
          : "N/A";
        document.getElementById("average-marks").textContent = average;
      }

      // Load present days
      const presentDaysResponse = await fetch(
        "/api/student/attendance/present-days"
      );
      if (presentDaysResponse.ok) {
        const presentDays = await presentDaysResponse.json();
        document.getElementById("present-days").textContent =
          presentDays.presentDays || 0;
      }

      // Load class information
      const classInfo = document.getElementById("class-info");
      const profileResponse = await fetch("/api/student/profile");
      if (profileResponse.ok) {
        const profile = await profileResponse.json();
        const lang = localStorage.getItem("lang") || "en";
        const labels = {
          class: { en: "Class:", si: "පන්තිය:", ta: "வகுப்பு:" },
          grade: { en: "Grade:", si: "ශ්‍රේණිය:", ta: "தர:" },
          notAssigned: {
            en: "No class assigned",
            si: "පන්තිය පවරා නැත",
            ta: "வகுப்பு வழங்கப்படவில்லை",
          },
        };
        if (profile.class_name && profile.class_grade) {
          classInfo.innerHTML = `
            <div class="text-sm">
              <p><strong>${labels.class[lang] || "Class:"}</strong> ${
            profile.class_name
          }</p>
              <p><strong>${labels.grade[lang] || "Grade:"}</strong> ${
            profile.class_grade
          }</p>
            </div>
          `;
        } else {
          classInfo.innerHTML = `<p class="text-sm">${
            labels.notAssigned[lang] || "No class assigned"
          }</p>`;
        }
      }
    } catch (error) {
      console.error("Error loading profile stats:", error);
    }
  }

  // Initialize
  loadProfile();

  function showToast(message, icon) {
    if (typeof toast === "function") {
      toast(message, icon);
    } else {
      alert(message);
    }
  }

  async function changePassword() {
    const oldPassword = document.getElementById("old-password").value;
    const newPassword = document.getElementById("new-password").value;
    const confirmPassword = document.getElementById("confirm-password").value;

    // Validation
    if (!oldPassword || !newPassword || !confirmPassword) {
      showToast("All fields are required", "fa-solid fa-circle-exclamation");
      return;
    }

    if (newPassword !== confirmPassword) {
      showToast("New passwords do not match", "fa-solid fa-circle-exclamation");
      return;
    }

    if (newPassword.length < 6) {
      showToast(
        "New password must be at least 6 characters",
        "fa-solid fa-circle-exclamation"
      );
      return;
    }

    try {
      const response = await fetch("/api/student/change-password", {
        method: "PUT",
        headers: {
          "Content-Type": "application/json",
        },
        body: JSON.stringify({
          oldPassword: oldPassword,
          newPassword: newPassword,
        }),
      });

      if (!response.ok) {
        const error = await response.json();
        showToast(
          error.message || "Failed to change password",
          "fa-solid fa-circle-exclamation"
        );
        return;
      }

      // Clear form
      document.getElementById("old-password").value = "";
      document.getElementById("new-password").value = "";
      document.getElementById("confirm-password").value = "";

      showToast("Password changed successfully", "fa-solid fa-check");
    } catch (error) {
      console.error("Error changing password:", error);
      showToast("Error changing password", "fa-solid fa-circle-exclamation");
    }
  }
</script>

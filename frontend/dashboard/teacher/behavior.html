<h2 class="heading">
  <i class="fas fa-user-shield"></i>
  <span
    data-en="Student Behavior Reports"
    data-si="‡∑Å‡∑í‡∑Ç‡∑ä‚Äç‡∂∫ ‡∑Ñ‡∑ê‡∑É‡∑í‡∂ª‡∑ì‡∂∏‡∑ä ‡∑Ä‡∑è‡∂ª‡∑ä‡∂≠‡∑è"
    data-ta="‡ÆÆ‡Ææ‡Æ£‡Æµ‡Æ∞‡Øç ‡Æ®‡Æü‡Æ§‡Øç‡Æ§‡Øà ‡ÆÖ‡Æ±‡Æø‡Æï‡Øç‡Æï‡Øà‡Æï‡Æ≥‡Øç"
  >
    Student Behavior Reports
  </span>
</h2>

<div style="display: flex; flex-direction: column; gap: 24px">
  <!-- üìã Add Behavior Record Form -->
  <div class="card dashboard-tile">
    <div class="icon-title">
      <i class="fas fa-plus-circle icon"></i>
      <p
        data-en="Add Behavior Record"
        data-si="‡∑Ñ‡∑ê‡∑É‡∑í‡∂ª‡∑ì‡∂∏‡∑ä ‡∑Ä‡∑è‡∂ª‡∑ä‡∂≠‡∑è ‡∂ë‡∂ö‡∑ä ‡∂ö‡∂ª‡∂±‡∑ä‡∂±"
        data-ta="‡Æ®‡Æü‡Æ§‡Øç‡Æ§‡Øà ‡Æ™‡Æ§‡Æø‡Æµ‡Øà‡Æö‡Øç ‡Æö‡Øá‡Æ∞‡Øç‡Æï‡Øç‡Æï‡Æµ‡ØÅ‡ÆÆ‡Øç"
      >
        Add Behavior Record
      </p>
    </div>
    <div class="filter-group">
      <div>
        <label
          data-en="Select Student"
          data-si="‡∑Å‡∑í‡∑Ç‡∑ä‚Äç‡∂∫ ‡∂≠‡∑ù‡∂ª‡∑è ‡∂ú‡∂±‡∑ä‡∂±"
          data-ta="‡ÆÆ‡Ææ‡Æ£‡Æµ‡Æ∞‡Øà‡Æ§‡Øç ‡Æ§‡Øá‡Æ∞‡Øç‡Æ®‡Øç‡Æ§‡ØÜ‡Æü‡ØÅ‡Æï‡Øç‡Æï‡Æµ‡ØÅ‡ÆÆ‡Øç"
        >
          Select Student
        </label>
        <select id="student-select" class="dropdown-select">
          <option value="" data-en="Choose a student">Choose a student</option>
        </select>
      </div>
      <div>
        <label
          data-en="Behavior Type"
          data-si="‡∑Ñ‡∑ê‡∑É‡∑í‡∂ª‡∑ì‡∂∏‡∑ö ‡∑Ä‡∂ª‡∑ä‡∂ú‡∂∫"
          data-ta="‡Æ®‡Æü‡Æ§‡Øç‡Æ§‡Øà ‡Æµ‡Æï‡Øà"
        >
          Behavior Type
        </label>
        <select id="behavior-type" class="dropdown-select">
          <option
            value=""
            data-en="Select Type"
            data-si="‡∑Ä‡∂ª‡∑ä‡∂ú‡∂∫ ‡∂≠‡∑ù‡∂ª‡∂±‡∑ä‡∂±"
            data-ta="‡Æµ‡Æï‡Øà‡ÆØ‡Øà‡Æ§‡Øç ‡Æ§‡Øá‡Æ∞‡Øç‡Æ®‡Øç‡Æ§‡ØÜ‡Æü‡ØÅ"
          >
            Select Type
          </option>
          <option value="Good" data-en="Good" data-si="‡∑Ñ‡∑ú‡∂≥" data-ta="‡Æ®‡Æ≤‡Øç‡Æ≤">
            Good
          </option>
          <option
            value="Disciplinary"
            data-en="Disciplinary"
            data-si="‡∂Ö‡∂∞‡∑ä‚Äç‡∂∫‡∑è‡∂¥‡∂±‡∑í‡∂ö"
            data-ta="‡Æï‡Æü‡Øç‡Æü‡ØÅ‡Æ™‡Øç‡Æ™‡Ææ‡Æü‡Øç‡Æü‡ØÅ"
          >
            Disciplinary
          </option>
          <option
            value="Reward"
            data-en="Reward"
            data-si="‡∂≠‡∑ä‚Äç‡∂∫‡∑è‡∂ú‡∂∫"
            data-ta="‡Æµ‡ØÜ‡Æï‡ØÅ‡ÆÆ‡Æ§‡Æø"
          >
            Reward
          </option>
        </select>
      </div>
      <div>
        <label data-en="Severity" data-si="‡∂∂‡∂ª‡∂¥‡∂≠‡∑î‡∂≠‡∑è‡∑Ä" data-ta="‡Æï‡Æü‡ØÅ‡ÆÆ‡Øà">
          Severity
        </label>
        <select id="behavior-severity" class="dropdown-select">
          <option
            value=""
            data-en="N/A"
            data-si="‡∂±‡∑ú‡∂¥‡∑ê‡∂±‡∑Ä‡∑ì‡∂∏"
            data-ta="‡Æ™‡Øä‡Æ∞‡ØÅ‡Æ®‡Øç‡Æ§‡Ææ‡Æ§‡ØÅ"
          >
            N/A
          </option>
          <option value="Minor" data-en="Minor" data-si="‡∑É‡∑î‡∑Ö‡∑î" data-ta="‡Æö‡Æø‡Æ±‡Æø‡ÆØ">
            Minor
          </option>
          <option
            value="Serious"
            data-en="Serious"
            data-si="‡∂∂‡∑ê‡∂ª‡∑ë‡∂ª‡∑î‡∂∏‡∑ä"
            data-ta="‡Æ§‡ØÄ‡Æµ‡Æø‡Æ∞‡ÆÆ‡Ææ‡Æ©"
          >
            Serious
          </option>
        </select>
      </div>
    </div>
    <div style="margin-bottom: 20px">
      <label data-en="Description" data-si="‡∑Ä‡∑í‡∑É‡∑ä‡∂≠‡∂ª‡∂´" data-ta="‡Æµ‡Æø‡Æ≥‡Æï‡Øç‡Æï‡ÆÆ‡Øç">
        Description
      </label>
      <textarea
        id="behavior-description"
        class="form-input"
        rows="4"
        placeholder="Enter behavior description..."
        data-en="Enter behavior description..."
        data-si="‡∑Ñ‡∑ê‡∑É‡∑í‡∂ª‡∑ì‡∂∏‡∑ä ‡∑Ä‡∑í‡∑É‡∑ä‡∂≠‡∂ª‡∂∫ ‡∂á‡∂≠‡∑î‡∂Ω‡∑ä ‡∂ö‡∂ª‡∂±‡∑ä‡∂±..."
        data-ta="‡Æ®‡Æü‡Æ§‡Øç‡Æ§‡Øà ‡Æµ‡Æø‡Æ≥‡Æï‡Øç‡Æï‡Æ§‡Øç‡Æ§‡Øà ‡Æâ‡Æ≥‡Øç‡Æ≥‡ØÄ‡Æü‡ØÅ ‡Æö‡ØÜ‡ÆØ‡Øç‡ÆØ‡Æµ‡ØÅ‡ÆÆ‡Øç..."
        style="
          width: 100%;
          padding: 10px;
          border: 1px solid var(--color-border);
          border-radius: 4px;
          background-color: var(--color-bg);
          color: var(--color-text);
        "
      ></textarea>
    </div>
    <div style="display: flex; gap: 10px; justify-content: flex-end">
      <button class="btn btn-primary" onclick="submitBehaviorRecord()">
        <i class="fas fa-check"></i>
        <span
          data-en="Submit Record"
          data-si="‡∑Ä‡∑è‡∂ª‡∑ä‡∂≠‡∑è ‡∂â‡∂Ø‡∑í‡∂ª‡∑í‡∂¥‡∂≠‡∑ä ‡∂ö‡∂ª‡∂±‡∑ä‡∂±"
          data-ta="‡Æ™‡Æ§‡Æø‡Æµ‡Øà ‡Æö‡ÆÆ‡Æ∞‡Øç‡Æ™‡Øç‡Æ™‡Æø‡Æï‡Øç‡Æï‡Æµ‡ØÅ‡ÆÆ‡Øç"
        >
          Submit Record
        </span>
      </button>
    </div>
  </div>

  <!-- üìã My Behavior Records -->
  <div class="card dashboard-tile">
    <div class="icon-title">
      <i class="fas fa-list icon"></i>
      <p
        data-en="My Behavior Records"
        data-si="‡∂∏‡∂ú‡∑ö ‡∑Ñ‡∑ê‡∑É‡∑í‡∂ª‡∑ì‡∂∏‡∑ä ‡∑Ä‡∑è‡∂ª‡∑ä‡∂≠‡∑è"
        data-ta="‡Æé‡Æ©‡Æ§‡ØÅ ‡Æ®‡Æü‡Æ§‡Øç‡Æ§‡Øà ‡Æ™‡Æ§‡Æø‡Æµ‡ØÅ‡Æï‡Æ≥‡Øç"
      >
        My Behavior Records
      </p>
    </div>
    <div class="filter-group">
      <div class="search-group" style="max-width: 350px">
        <input
          type="text"
          id="records-search"
          class="search-input"
          placeholder="Search records..."
          data-en="Search records..."
          data-si="‡∑Ä‡∑è‡∂ª‡∑ä‡∂≠‡∑è ‡∑É‡∑ú‡∂∫‡∂±‡∑ä‡∂±..."
          data-ta="‡Æ™‡Æ§‡Æø‡Æµ‡ØÅ‡Æï‡Æ≥‡Øà‡Æ§‡Øç ‡Æ§‡Øá‡Æü‡ØÅ..."
        />
        <span class="search-icon"><i class="fas fa-search"></i></span>
      </div>
      <div>
        <select id="my-records-page-size" class="dropdown-select">
          <option value="5">5</option>
          <option value="10">10</option>
          <option value="25" selected>25</option>
          <option value="50">50</option>
        </select>
      </div>
    </div>
    <div class="table-container">
      <table>
        <thead>
          <tr>
            <th data-en="Class" data-si="‡∂¥‡∂±‡∑ä‡∂≠‡∑í‡∂∫" data-ta="‡Æµ‡Æï‡ØÅ‡Æ™‡Øç‡Æ™‡ØÅ">Class</th>
            <th data-en="Student" data-si="‡∑Å‡∑í‡∑Ç‡∑ä‚Äç‡∂∫" data-ta="‡ÆÆ‡Ææ‡Æ£‡Æµ‡Æ∞‡Øç">Student</th>
            <th data-en="Date" data-si="‡∂Ø‡∑í‡∂±‡∂∫" data-ta="‡Æ§‡Øá‡Æ§‡Æø">Date</th>
            <th data-en="Type" data-si="‡∑Ä‡∂ª‡∑ä‡∂ú‡∂∫" data-ta="‡Æµ‡Æï‡Øà">Type</th>
            <th data-en="Severity" data-si="‡∂∂‡∂ª‡∂¥‡∂≠‡∑î‡∂≠‡∑è‡∑Ä" data-ta="‡Æï‡Æü‡ØÅ‡ÆÆ‡Øà">
              Severity
            </th>
            <th data-en="Description" data-si="‡∑Ä‡∑í‡∑É‡∑ä‡∂≠‡∂ª‡∂´" data-ta="‡Æµ‡Æø‡Æ≥‡Æï‡Øç‡Æï‡ÆÆ‡Øç">
              Description
            </th>
            <th data-en="Action" data-si="‡∂ö‡∑ä‚Äç‡∂ª‡∑í‡∂∫‡∑è‡∑Ä" data-ta="‡Æö‡ØÜ‡ÆØ‡Æ≤‡Øç">Action</th>
          </tr>
        </thead>
        <tbody id="my-records-tbody"></tbody>
      </table>
    </div>
    <!-- Pagination -->
    <div
      class="pagination-controls"
      style="
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 10px;
        margin-top: 20px;
        flex-wrap: nowrap;
      "
    >
      <button
        id="my-records-prev-page"
        class="btn btn-secondary"
        disabled
        title="Previous"
      >
        <i class="fas fa-chevron-left"></i>
      </button>
      <div
        id="my-records-page-numbers"
        style="
          display: flex;
          gap: 5px;
          flex-wrap: wrap;
          justify-content: center;
        "
      ></div>
      <button
        id="my-records-next-page"
        class="btn btn-secondary"
        disabled
        title="Next"
      >
        <i class="fas fa-chevron-right"></i>
      </button>
      <span
        id="my-records-page-info"
        style="
          margin-left: 20px;
          color: var(--color-subtext);
          white-space: nowrap;
        "
      ></span>
    </div>
  </div>
</div>

<script src="../../js/dropdown.js"></script>
<script>
  let classStudents = [];
  let myBehaviorRecords = [];
  let filteredRecords = [];
  let teacherUserId = null;

  // Pagination variables
  let currentPage = 1;
  let pageSize = 25;
  let totalPages = 1;

  // Language variable
  let currentLanguage = localStorage.getItem("lang") || "en";

  // Get teacher ID from localStorage (set during login)
  function getTeacherId() {
    const user = JSON.parse(localStorage.getItem("user") || "{}");
    return user.id;
  }

  // Load students from teacher's class
  async function loadClassStudents() {
    try {
      const response = await fetch("/api/teacher/students");
      if (!response.ok) throw new Error("Failed to fetch students");
      const allStudents = await response.json();

      // Group students by class and sort
      const studentsByClass = {};
      allStudents.forEach((student) => {
        const classKey = `${student.grade} ${student.class_name}`;
        if (!studentsByClass[classKey]) {
          studentsByClass[classKey] = [];
        }
        studentsByClass[classKey].push(student);
      });

      // Populate student dropdown with class grouping
      const studentSelect = document.getElementById("student-select");
      studentSelect.innerHTML = '<option value="">Choose a student</option>';

      // Sort classes
      const sortedClasses = Object.keys(studentsByClass).sort();

      sortedClasses.forEach((classKey) => {
        const optgroup = document.createElement("optgroup");
        optgroup.label = classKey;

        studentsByClass[classKey]
          .sort((a, b) => a.full_name.localeCompare(b.full_name))
          .forEach((student) => {
            const option = document.createElement("option");
            option.value = student.id;
            option.textContent = student.full_name;
            option.dataset.classId = student.class_id;
            optgroup.appendChild(option);
          });

        studentSelect.appendChild(optgroup);
      });

      // Store for later use
      classStudents = allStudents;
    } catch (err) {
      console.error("Error loading students:", err);
      showToast("Error loading students", "fa-solid fa-circle-exclamation");
    }
  }

  // Load teacher's behavior records
  async function loadMyBehaviorRecords() {
    try {
      const response = await fetch("/api/teacher/behavior/records");
      if (!response.ok) throw new Error("Failed to fetch behavior records");
      myBehaviorRecords = await response.json();
      filteredRecords = myBehaviorRecords;
      currentPage = 1;
      renderRecordsTable();
    } catch (err) {
      console.error("Error loading behavior records:", err);
      showToast("Error loading records", "fa-solid fa-circle-exclamation");
    }
  }

  // Submit new behavior record
  async function submitBehaviorRecord() {
    const studentId = document.getElementById("student-select").value;
    const type = document.getElementById("behavior-type").value;
    const severity = document.getElementById("behavior-severity").value;
    const description = document
      .getElementById("behavior-description")
      .value.trim();

    // Validation
    if (!studentId) {
      showToast("Please select a student", "fa-solid fa-circle-exclamation");
      return;
    }
    if (!type) {
      showToast(
        "Please select behavior type",
        "fa-solid fa-circle-exclamation"
      );
      return;
    }
    if (!description || description.length < 5) {
      const messages = {
        en: "Description must be at least 5 characters",
        si: "‡∑Ä‡∑í‡∑É‡∑ä‡∂≠‡∂ª‡∂∫ ‡∂Ö‡∑Ä‡∂∏ ‡∑Ä‡∑Å‡∂∫‡∑ô‡∂±‡∑ä ‡∂Ö‡∂ö‡∑î‡∂ª‡∑î 5 ‡∂ö‡∑ä ‡∑Ä‡∑í‡∂∫ ‡∂∫‡∑î‡∂≠‡∑î‡∂∫",
        ta: "‡Æµ‡Æø‡Æ≥‡Æï‡Øç‡Æï‡ÆÆ‡Øç ‡Æï‡ØÅ‡Æ±‡Øà‡Æ®‡Øç‡Æ§‡Æ§‡ØÅ 5 ‡Æé‡Æ¥‡ØÅ‡Æ§‡Øç‡Æ§‡ØÅ‡Æï‡Æ≥‡Ææ‡Æï ‡Æá‡Æ∞‡ØÅ‡Æï‡Øç‡Æï ‡Æµ‡Øá‡Æ£‡Øç‡Æü‡ØÅ‡ÆÆ‡Øç",
      };
      showToast(
        messages[currentLanguage] || messages.en,
        "fa-solid fa-circle-exclamation"
      );
      return;
    }

    try {
      const student = classStudents.find((s) => s.id == studentId);
      if (!student) {
        const messages = {
          en: "Invalid student selected",
          si: "‡∑Ä‡∂Ω‡∂Ç‡∂ú‡∑î ‡∂±‡∑ú‡∑Ä‡∂± ‡∑Å‡∑í‡∑Ç‡∑ä‚Äç‡∂∫ ‡∂≠‡∑ù‡∂ª‡∑è ‡∂á‡∂≠",
          ta: "‡Æ§‡Æµ‡Æ±‡Ææ‡Æ© ‡ÆÆ‡Ææ‡Æ£‡Æµ‡Æ∞‡Øç ‡Æ§‡Øá‡Æ∞‡Øç‡Æ®‡Øç‡Æ§‡ØÜ‡Æü‡ØÅ‡Æï‡Øç‡Æï‡Æ™‡Øç‡Æ™‡Æü‡Øç‡Æü‡ØÅ‡Æ≥‡Øç‡Æ≥‡Ææ‡Æ∞‡Øç",
        };
        showToast(
          messages[currentLanguage] || messages.en,
          "fa-solid fa-circle-exclamation"
        );
        return;
      }

      const payload = {
        student_id: parseInt(studentId),
        class_id: student.class_id,
        type: type,
        severity: severity || null,
        description: description,
        reported_by_id: getTeacherId(),
      };

      const response = await fetch("/api/teacher/behavior/records", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload),
      });

      if (!response.ok) throw new Error("Failed to submit record");

      const messages = {
        en: "Behavior record submitted successfully",
        si: "‡∑Ñ‡∑ê‡∑É‡∑í‡∂ª‡∑ì‡∂∏‡∑ä ‡∑Ä‡∑è‡∂ª‡∑ä‡∂≠‡∑è ‡∑É‡∑è‡∂ª‡∑ä‡∂Æ‡∂ö‡∑Ä ‡∂â‡∂Ø‡∑í‡∂ª‡∑í‡∂¥‡∂≠‡∑ä ‡∂ö‡∂ª‡∂± ‡∂Ω‡∂Ø‡∑ì",
        ta: "‡Æ®‡Æü‡Æ§‡Øç‡Æ§‡Øà ‡Æ™‡Æ§‡Æø‡Æµ‡ØÅ ‡Æµ‡ØÜ‡Æ±‡Øç‡Æ±‡Æø‡Æï‡Æ∞‡ÆÆ‡Ææ‡Æï ‡Æö‡ÆÆ‡Æ∞‡Øç‡Æ™‡Øç‡Æ™‡Æø‡Æï‡Øç‡Æï‡Æ™‡Øç‡Æ™‡Æü‡Øç‡Æü‡Æ§‡ØÅ",
      };
      showToast(
        messages[currentLanguage] || messages.en,
        "fa-solid fa-check-circle"
      );
      resetBehaviorForm();
      loadMyBehaviorRecords();
    } catch (err) {
      console.error("Error submitting record:", err);
      const messages = {
        en: "Error submitting record",
        si: "‡∑Ä‡∑è‡∂ª‡∑ä‡∂≠‡∑è ‡∂â‡∂Ø‡∑í‡∂ª‡∑í‡∂¥‡∂≠‡∑ä ‡∂ö‡∑í‡∂ª‡∑ì‡∂∏‡∑ö ‡∂Ø‡∑ù‡∑Ç‡∂∫‡∂ö‡∑ä",
        ta: "‡Æ™‡Æ§‡Æø‡Æµ‡Øà ‡Æö‡ÆÆ‡Æ∞‡Øç‡Æ™‡Øç‡Æ™‡Æø‡Æ™‡Øç‡Æ™‡Æ§‡Æø‡Æ≤‡Øç ‡Æ™‡Æø‡Æ¥‡Øà",
      };
      showToast(
        messages[currentLanguage] || messages.en,
        "fa-solid fa-circle-exclamation"
      );
    }
  }

  // Render records table with pagination
  function renderRecordsTable() {
    const tbody = document.getElementById("my-records-tbody");

    if (!filteredRecords.length) {
      const messages = {
        en: "No records found",
        si: "‡∑Ä‡∑è‡∂ª‡∑ä‡∂≠‡∑è ‡∂ö‡∑í‡∑É‡∑í‡∑Ä‡∂ö‡∑ä ‡∑Ñ‡∂∏‡∑î ‡∂±‡∑ú‡∑Ä‡∑ì‡∂∫",
        ta: "‡Æ™‡Æ§‡Æø‡Æµ‡ØÅ‡Æï‡Æ≥‡Øç ‡Æé‡Æ§‡ØÅ‡Æµ‡ØÅ‡ÆÆ‡Øç ‡Æï‡Æø‡Æü‡Øà‡Æï‡Øç‡Æï‡Æµ‡Æø‡Æ≤‡Øç‡Æ≤‡Øà",
      };
      tbody.innerHTML = `<tr><td colspan="7" class="text-center">${
        messages[currentLanguage] || messages.en
      }</td></tr>`;
      updateRecordsPaginationControls(0);
      return;
    }

    totalPages = Math.ceil(filteredRecords.length / pageSize);
    const startIndex = (currentPage - 1) * pageSize;
    const endIndex = startIndex + pageSize;
    const recordsToShow = filteredRecords.slice(startIndex, endIndex);

    tbody.innerHTML = recordsToShow
      .map(
        (record) => `
      <tr>
        <td>${record.class}</td>
        <td>${record.student}</td>
        <td>${record.date}</td>
        <td>${record.type}</td>
        <td>${record.severity || "‚Äî"}</td>
        <td>${record.description}</td>
        <td>
          <button class="btn-icon btn-delete" onclick="deleteRecord(${
            record.id
          })" title="Delete">
            <i class="fas fa-trash"></i>
          </button>
        </td>
      </tr>
    `
      )
      .join("");

    updateRecordsPaginationControls(filteredRecords.length);
  }

  // Update pagination controls
  function updateRecordsPaginationControls(totalItems) {
    const prevBtn = document.getElementById("my-records-prev-page");
    const nextBtn = document.getElementById("my-records-next-page");
    const pageNumbers = document.getElementById("my-records-page-numbers");
    const pageInfo = document.getElementById("my-records-page-info");

    if (!prevBtn || !nextBtn || !pageNumbers || !pageInfo) return;

    prevBtn.disabled = currentPage <= 1;
    nextBtn.disabled = currentPage >= totalPages;

    const startItem = totalItems > 0 ? (currentPage - 1) * pageSize + 1 : 0;
    const endItem = Math.min(currentPage * pageSize, totalItems);
    pageInfo.textContent = `Showing ${startItem}-${endItem} of ${totalItems} records`;

    pageNumbers.innerHTML = "";
    const maxVisiblePages = 5;
    let startPage = Math.max(1, currentPage - Math.floor(maxVisiblePages / 2));
    let endPage = Math.min(totalPages, startPage + maxVisiblePages - 1);

    if (endPage - startPage + 1 < maxVisiblePages) {
      startPage = Math.max(1, endPage - maxVisiblePages + 1);
    }

    if (startPage > 1) {
      const firstBtn = document.createElement("button");
      firstBtn.className = "btn btn-secondary";
      firstBtn.textContent = "1";
      firstBtn.onclick = () => goToPage(1);
      pageNumbers.appendChild(firstBtn);

      if (startPage > 2) {
        const ellipsis = document.createElement("span");
        ellipsis.textContent = "...";
        ellipsis.style.margin = "0 5px";
        pageNumbers.appendChild(ellipsis);
      }
    }

    for (let i = startPage; i <= endPage; i++) {
      const pageBtn = document.createElement("button");
      pageBtn.className = `btn ${
        i === currentPage ? "btn-primary" : "btn-secondary"
      }`;
      pageBtn.textContent = i;
      pageBtn.onclick = () => goToPage(i);
      pageNumbers.appendChild(pageBtn);
    }

    if (endPage < totalPages) {
      if (endPage < totalPages - 1) {
        const ellipsis = document.createElement("span");
        ellipsis.textContent = "...";
        ellipsis.style.margin = "0 5px";
        pageNumbers.appendChild(ellipsis);
      }

      const lastBtn = document.createElement("button");
      lastBtn.className = "btn btn-secondary";
      lastBtn.textContent = totalPages;
      lastBtn.onclick = () => goToPage(totalPages);
      pageNumbers.appendChild(lastBtn);
    }
  }

  // Navigate to page
  function goToPage(page) {
    if (page >= 1 && page <= totalPages) {
      currentPage = page;
      renderRecordsTable();
    }
  }

  // Search behavior records
  function searchRecords(searchTerm) {
    const term = searchTerm.toLowerCase().trim();

    if (!term) {
      filteredRecords = myBehaviorRecords;
    } else {
      filteredRecords = myBehaviorRecords.filter((record) => {
        return (
          record.student.toLowerCase().includes(term) ||
          record.class.toLowerCase().includes(term) ||
          record.type.toLowerCase().includes(term) ||
          record.severity?.toLowerCase().includes(term) ||
          record.description.toLowerCase().includes(term)
        );
      });
    }

    currentPage = 1;
    renderRecordsTable();
  }

  // Delete behavior record
  function deleteRecord(recordId) {
    const messages = {
      en: "Are you sure you want to delete this record?",
      si: "‡∂î‡∂∂‡∂ß ‡∂∏‡∑ô‡∂∏ ‡∑Ä‡∑è‡∂ª‡∑ä‡∂≠‡∑è ‡∂∏‡∂ö‡∑è ‡∂Ø‡∑ê‡∂∏‡∑ì‡∂∏‡∂ß ‡∂Ö‡∑Ä‡∑Å‡∑ä‚Äç‡∂∫ ‡∂∂‡∑Ä ‡∑Ä‡∑í‡∑Å‡∑ä‡∑Ä‡∑è‡∑É‡∂Ø?",
      ta: "‡Æá‡Æ®‡Øç‡Æ§ ‡Æ™‡Æ§‡Æø‡Æµ‡Øà ‡Æ®‡ØÄ‡Æï‡Øç‡Æï ‡Æµ‡Æø‡Æ∞‡ØÅ‡ÆÆ‡Øç‡Æ™‡ØÅ‡Æï‡Æø‡Æ±‡ØÄ‡Æ∞‡Øç‡Æï‡Æ≥‡Ææ?",
    };
    if (confirm(messages[currentLanguage] || messages.en)) {
      deleteRecordConfirmed(recordId);
    }
  }

  async function deleteRecordConfirmed(recordId) {
    try {
      const response = await fetch(
        `/api/teacher/behavior/records?id=${recordId}`,
        {
          method: "DELETE",
        }
      );

      if (!response.ok) throw new Error("Failed to delete record");

      const messages = {
        en: "Record deleted successfully",
        si: "‡∑Ä‡∑è‡∂ª‡∑ä‡∂≠‡∑è ‡∑É‡∑è‡∂ª‡∑ä‡∂Æ‡∂ö‡∑Ä ‡∂∏‡∂ö‡∑è ‡∂Ø‡∂∏‡∂± ‡∂Ω‡∂Ø‡∑ì",
        ta: "‡Æ™‡Æ§‡Æø‡Æµ‡ØÅ ‡Æµ‡ØÜ‡Æ±‡Øç‡Æ±‡Æø‡Æï‡Æ∞‡ÆÆ‡Ææ‡Æï ‡Æ®‡ØÄ‡Æï‡Øç‡Æï‡Æ™‡Øç‡Æ™‡Æü‡Øç‡Æü‡Æ§‡ØÅ",
      };
      showToast(
        messages[currentLanguage] || messages.en,
        "fa-solid fa-check-circle"
      );
      loadMyBehaviorRecords();
    } catch (err) {
      console.error("Error deleting record:", err);
      const messages = {
        en: "Error deleting record",
        si: "‡∑Ä‡∑è‡∂ª‡∑ä‡∂≠‡∑è ‡∂∏‡∂ö‡∑è ‡∂Ø‡∑ê‡∂∏‡∑ì‡∂∏‡∑ö ‡∂Ø‡∑ù‡∑Ç‡∂∫‡∂ö‡∑ä",
        ta: "‡Æ™‡Æ§‡Æø‡Æµ‡Øà ‡Æ®‡ØÄ‡Æï‡Øç‡Æï‡ØÅ‡Æµ‡Æ§‡Æø‡Æ≤‡Øç ‡Æ™‡Æø‡Æ¥‡Øà",
      };
      showToast(
        messages[currentLanguage] || messages.en,
        "fa-solid fa-circle-exclamation"
      );
    }
  }

  // Reset form
  function resetBehaviorForm() {
    document.getElementById("student-select").value = "";
    document.getElementById("behavior-type").value = "";
    document.getElementById("behavior-severity").value = "";
    document.getElementById("behavior-description").value = "";
  }

  // Show toast notification
  function showToast(message, icon) {
    if (typeof toast === "function") {
      toast(message, icon);
    } else {
      alert(message);
    }
  }

  // Initialize searchable dropdowns
  function initializeSearchableDropdowns() {
    const dropdowns = document.querySelectorAll(".dropdown-select");
    dropdowns.forEach((select) => {
      // Skip my-records-page-size as it's handled separately in setupPaginationEvents
      if (select.id === "my-records-page-size") return;

      if (typeof makeSearchableDropdown === "function") {
        makeSearchableDropdown(select.id);
      }
    });
  }

  // Setup pagination events
  function setupPaginationEvents() {
    const pageSizeElement = document.getElementById("my-records-page-size");
    if (pageSizeElement) {
      pageSize = parseInt(pageSizeElement.value);

      // Make page size dropdown searchable with callback
      if (typeof makeSearchableDropdown === "function") {
        makeSearchableDropdown("my-records-page-size", (val, text) => {
          pageSize = parseInt(val);
          currentPage = 1;
          renderRecordsTable();
        });
      }

      // Page size change event (fallback)
      pageSizeElement.addEventListener("change", (e) => {
        pageSize = parseInt(e.target.value);
        currentPage = 1;
        renderRecordsTable();
      });
    }

    const prevBtn = document.getElementById("my-records-prev-page");
    const nextBtn = document.getElementById("my-records-next-page");

    if (prevBtn) {
      prevBtn.addEventListener("click", () => goToPage(currentPage - 1));
    }

    if (nextBtn) {
      nextBtn.addEventListener("click", () => goToPage(currentPage + 1));
    }

    // Setup search input
    const searchInput = document.getElementById("records-search");
    if (searchInput) {
      searchInput.addEventListener("input", (e) => {
        searchRecords(e.target.value);
      });
    }
  }

  // Update language text
  function updateText(lang) {
    document.querySelectorAll("[data-en],[data-si],[data-ta]").forEach((el) => {
      el.textContent =
        el.getAttribute(`data-${lang}`) || el.getAttribute("data-en");
    });
  }

  window.addEventListener("storage", (e) => {
    if (e.key === "lang") {
      currentLanguage = e.newValue || "en";
      updateText(currentLanguage);
    }
  });

  window.addEventListener("languageChange", (e) => {
    currentLanguage = e.detail.lang || "en";
    updateText(currentLanguage);
  });

  let lastLang = localStorage.getItem("lang") || "en";
  setInterval(() => {
    const currentLang = localStorage.getItem("lang") || "en";
    if (currentLang !== lastLang) {
      currentLanguage = currentLang;
      updateText(currentLang);
      lastLang = currentLang;
    }
  }, 300);

  updateText(currentLanguage);

  // Initialize on page load
  async function initializePage() {
    if (document.readyState === "loading") {
      document.addEventListener("DOMContentLoaded", async () => {
        await loadClassStudents();
        await loadMyBehaviorRecords();
        initializeSearchableDropdowns();
        setupPaginationEvents();
      });
    } else {
      await loadClassStudents();
      await loadMyBehaviorRecords();
      initializeSearchableDropdowns();
      setupPaginationEvents();
    }
  }

  initializePage();
</script>

<style>
  .filter-group {
    display: flex !important;
    flex-direction: row !important;
    gap: 20px;
    margin-bottom: 20px;
    align-items: flex-end;
    width: auto;
  }
  .filter-group > div {
    flex: 0 0 auto;
    min-width: 200px;
    display: flex;
    flex-direction: column;
    gap: 0;
  }
  .filter-group label {
    display: block;
    margin-bottom: 5px;
    font-weight: 500;
    color: var(--color-text);
  }
  .pagination-controls {
    display: flex !important;
    flex-direction: row !important;
    justify-content: center;
    align-items: center;
    gap: 10px;
    margin-top: 20px;
    flex-wrap: nowrap;
  }
  #my-records-page-numbers {
    display: flex;
    gap: 5px;
    flex-wrap: wrap;
    justify-content: center;
  }
</style>

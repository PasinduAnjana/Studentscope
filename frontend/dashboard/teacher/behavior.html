<h2 class="heading">
  <i class="fas fa-user-shield"></i>
  <span
    data-en="Student Behavior Reports"
    data-si="à·à·’à·‚à·Šâ€à¶º à·„à·à·ƒà·’à¶»à·“à¶¸à·Š à·€à·à¶»à·Šà¶­à·"
    data-ta="à®®à®¾à®£à®µà®°à¯ à®¨à®Ÿà®¤à¯à®¤à¯ˆ à®…à®±à®¿à®•à¯à®•à¯ˆà®•à®³à¯"
  >
    Student Behavior Reports
  </span>
</h2>

<div style="display: flex; flex-direction: column; gap: 24px">
  <!-- ðŸ“‹ Add Behavior Record Form -->


  <!-- ðŸ“‹ My Behavior Records -->
  <div class="card behavior-list">
    <div class="header-actions" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <h2 class="title" style="margin: 0; font-size: 1.25rem;">
            <i class="fas fa-list icon"></i>
            <span data-en="My Behavior Records" data-si="à¶¸à¶œà·š à·„à·à·ƒà·’à¶»à·“à¶¸à·Š à·€à·à¶»à·Šà¶­à·" data-ta="à®Žà®©à®¤à¯ à®¨à®Ÿà®¤à¯à®¤à¯ˆ à®ªà®¤à®¿à®µà¯à®•à®³à¯">My Behavior Records</span>
        </h2>
        <button id="add-record-btn" class="btn btn-primary">
            <i class="fas fa-plus"></i>
            <span data-en="Add New" data-si="à¶…à¶½à·”à¶­à·Š à¶‘à¶šà¶šà·Š à¶‘à¶šà¶­à·” à¶šà¶»à¶±à·Šà¶±" data-ta="à®ªà¯à®¤à®¿à®¯à®¤à¯ˆà®šà¯ à®šà¯‡à®°à¯">Add New</span>
        </button>
    </div>

    <data-table id="behavior-table">
        <div slot="filters" style="display: flex; gap: 10px; flex-wrap: wrap; align-items: center;">
            <div class="input-group" style="margin-bottom: 0;">
                <select id="filter-type">
                <option value="" data-en="All Types" data-si="à·ƒà·’à¶ºà¶½à·” à·€à¶»à·Šà¶œ" data-ta="à®…à®©à¯ˆà®¤à¯à®¤à¯ à®µà®•à¯ˆà®•à®³à¯à®®à¯">All Types</option>
                <option value="Good" data-en="Good" data-si="à·„à·œà¶³" data-ta="à®¨à®²à¯à®²">Good</option>
                <option value="Disciplinary" data-en="Disciplinary" data-si="à¶…à¶°à·Šâ€à¶ºà·à¶´à¶±à·’à¶š" data-ta="à®•à®Ÿà¯à®Ÿà¯à®ªà¯à®ªà®¾à®Ÿà¯à®Ÿà¯">Disciplinary</option>
                <option value="Reward" data-en="Reward" data-si="à¶­à·Šâ€à¶ºà·à¶œà¶º" data-ta="à®µà¯†à®•à¯à®®à®¤à®¿">Reward</option>
                </select>
            </div>
            <div class="input-group" style="margin-bottom: 0;">
                <select id="filter-severity">
                <option value="" data-en="All Severities" data-si="à·ƒà·’à¶ºà¶½à·” à¶¶à¶»à¶´à¶­à¶½à¶šà¶¸à·Š" data-ta="à®…à®©à¯ˆà®¤à¯à®¤à¯ à®¤à¯€à®µà®¿à®°à®¤à¯à®¤à®©à¯à®®à¯ˆà®¯à¯à®®à¯">All Severities</option>
                <option value="Minor" data-en="Minor" data-si="à·ƒà·”à·…à·”" data-ta="à®šà®¿à®±à®¿à®¯">Minor</option>
                <option value="Serious" data-en="Serious" data-si="à¶¶à·à¶»à·‘à¶»à·”à¶¸à·Š" data-ta="à®¤à¯€à®µà®¿à®°à®®à®¾à®©">Serious</option>
                </select>
            </div>
        </div>
    </data-table>
  </div>
</div>

<!-- Add Behavior Record Modal -->
<modal-dialog id="add-behavior-modal" title="Add Behavior Record">
    <div style="padding: 20px;">
        <div class="filter-group" style="flex-direction: column !important; align-items: stretch;">
          <div style="width: 100%;">
            <label
              data-en="Select Student"
              data-si="à·à·’à·‚à·Šâ€à¶º à¶­à·à¶»à· à¶œà¶±à·Šà¶±"
              data-ta="à®®à®¾à®£à®µà®°à¯ˆà®¤à¯ à®¤à¯‡à®°à¯à®¨à¯à®¤à¯†à®Ÿà¯à®•à¯à®•à®µà¯à®®à¯"
            >
              Select Student
            </label>
            <select id="student-select" class="dropdown-select" style="width: 100%;">
              <option value="" data-en="Choose a student">Choose a student</option>
            </select>
          </div>
          <div style="width: 100%;">
            <label
              data-en="Behavior Type"
              data-si="à·„à·à·ƒà·’à¶»à·“à¶¸à·š à·€à¶»à·Šà¶œà¶º"
              data-ta="à®¨à®Ÿà®¤à¯à®¤à¯ˆ à®µà®•à¯ˆ"
            >
              Behavior Type
            </label>
            <select id="behavior-type" class="dropdown-select" style="width: 100%;">
              <option
                value=""
                data-en="Select Type"
                data-si="à·€à¶»à·Šà¶œà¶º à¶­à·à¶»à¶±à·Šà¶±"
                data-ta="à®µà®•à¯ˆà®¯à¯ˆà®¤à¯ à®¤à¯‡à®°à¯à®¨à¯à®¤à¯†à®Ÿà¯"
              >
                Select Type
              </option>
              <option value="Good" data-en="Good" data-si="à·„à·œà¶³" data-ta="à®¨à®²à¯à®²">
                Good
              </option>
              <option
                value="Disciplinary"
                data-en="Disciplinary"
                data-si="à¶…à¶°à·Šâ€à¶ºà·à¶´à¶±à·’à¶š"
                data-ta="à¶šà®Ÿà¯à®Ÿà¯à¶´à·à¶§à·”"
              >
                Disciplinary
              </option>
              <option
                value="Reward"
                data-en="Reward"
                data-si="à¶­à·Šâ€à¶ºà·à¶œà¶º"
                data-ta="à®µà¯†à®•à¯à®®à®¤à®¿"
              >
                Reward
              </option>
            </select>
          </div>
          <div style="width: 100%;">
            <label data-en="Severity" data-si="à¶¶à¶»à¶´à¶­à·”à¶­à·à·€" data-ta="à®•à®Ÿà¯à®®à¯ˆ">
              Severity
            </label>
            <select id="behavior-severity" class="dropdown-select" style="width: 100%;">
              <option
                value=""
                data-en="N/A"
                data-si="à¶±à·œà¶´à·à¶±à·€à·“à¶¸"
                data-ta="à®ªà¯Šà®°à¯à®¨à¯à®¤à®¾à®¤à¯"
              >
                N/A
              </option>
              <option value="Minor" data-en="Minor" data-si="à·ƒà·”à·…à·”" data-ta="à®šà®¿à®±à®¿à®¯">
                Minor
              </option>
              <option
                value="Serious"
                data-en="Serious"
                data-si="à¶¶à·à¶»à·‘à¶»à·”à¶¸à·Š"
                data-ta="à®¤à¯€à®µà®¿à®°à®®à®¾à®©"
              >
                Serious
              </option>
            </select>
          </div>
        </div>
        <div style="margin-bottom: 20px">
          <label data-en="Description" data-si="à·€à·’à·ƒà·Šà¶­à¶»à¶«" data-ta="à®µà®¿à®³à®•à¯à®•à®®à¯">
            Description
          </label>
          <textarea
            id="behavior-description"
            class="form-input"
            rows="4"
            placeholder="Enter behavior description..."
            data-en="Enter behavior description..."
            data-si="à·„à·à·ƒà·’à¶»à·“à¶¸à·Š à·€à·’à·ƒà·Šà¶­à¶»à¶º à¶‡à¶­à·”à¶½à·Š à¶šà¶»à¶±à·Šà¶±..."
            data-ta="à®¨à®Ÿà®¤à¯à®¤à¯ˆ à®µà®¿à®³à®•à¯à®•à®¤à¯à®¤à¯ˆ à®‰à®³à¯à®³à¯€à®Ÿà¯ à®šà¯†à®¯à¯à®¯à®µà¯à®®à¯..."
           
          ></textarea>
        </div>
    </div>
    <div style="display: flex; justify-content: flex-end; gap: 10px; padding: 20px; border-top: 1px solid var(--color-border);">
      <button
        id="add-behavior-cancel"
        class="btn btn-secondary"
        data-en="Cancel"
        data-si="à¶…à·€à¶½à¶‚à¶œà·” à¶šà¶»à¶±à·Šà¶±"
        data-ta="à®°à®¤à¯à®¤à¯ à®šà¯†à®¯à¯à®¯"
      >
        Cancel
      </button>
      <button
        id="add-behavior-confirm"
        class="btn btn-primary"
        data-en="Submit Record"
        data-si="à·€à·à¶»à·Šà¶­à· à¶‰à¶¯à·’à¶»à·’à¶´à¶­à·Š à¶šà¶»à¶±à·Šà¶±"
        data-ta="à®ªà®¤à®¿à®µà¯ˆ à®šà®®à®°à¯à®ªà¯à®ªà®¿à®•à¯à®•à®µà¯à®®à¯"
      >
        Submit Record
      </button>
    </div>
</modal-dialog>


<script>
  let classStudents = [];
  let myBehaviorRecords = [];
  let teacherUserId = null;

  // Language variable
  let currentLanguage = localStorage.getItem("lang") || "en";

  // Get teacher ID from localStorage (set during login)
  function getTeacherId() {
    const user = JSON.parse(localStorage.getItem("user") || "{}");
    return user.id;
  }

  // Load students from teacher's class
  async function loadClassStudents() {
    try {
      const response = await api.teacher.students.getAll();
      if (!response.ok) throw new Error("Failed to fetch students");
      const allStudents = await response.json();

      // Group students by class and sort
      const studentsByClass = {};
      allStudents.forEach((student) => {
        const classKey = `${student.grade} ${student.class_name}`;
        if (!studentsByClass[classKey]) {
          studentsByClass[classKey] = [];
        }
        studentsByClass[classKey].push(student);
      });

      // Populate student dropdown with class grouping
      const studentSelect = document.getElementById("student-select");
      studentSelect.innerHTML = '<option value="">Choose a student</option>';

      // Sort classes
      const sortedClasses = Object.keys(studentsByClass).sort();

      sortedClasses.forEach((classKey) => {
        const optgroup = document.createElement("optgroup");
        optgroup.label = classKey;

        studentsByClass[classKey]
          .sort((a, b) => a.full_name.localeCompare(b.full_name))
          .forEach((student) => {
            const option = document.createElement("option");
            option.value = student.id;
            option.textContent = student.full_name;
            option.dataset.classId = student.class_id;
            optgroup.appendChild(option);
          });

        studentSelect.appendChild(optgroup);
      });

      // Store for later use
      classStudents = allStudents;
    } catch (err) {
      console.error("Error loading students:", err);
      showToast("Error loading students", "fa-solid fa-circle-exclamation");
    }
  }

  // Load teacher's behavior records
  async function loadMyRecords() {
    const table = document.getElementById("behavior-table");
    try {
      const res = await api.teacher.behavior.getRecords();
      if (!res.ok) throw new Error("Failed to load records");
      myBehaviorRecords = await res.json();
      table.setData(myBehaviorRecords);
    } catch (err) {
      console.error(err);
      table.setEmptyState("Error loading records", "fas fa-exclamation-triangle");
      showToast("Error loading records", "fa-solid fa-circle-exclamation");
    }
  }

  // Submit new behavior record
  async function submitBehaviorRecord() {
    const studentId = document.getElementById("student-select").value;
    const type = document.getElementById("behavior-type").value;
    const severity = document.getElementById("behavior-severity").value;
    const description = document
      .getElementById("behavior-description")
      .value.trim();

    // Validation
    if (!studentId) {
      showToast("Please select a student", "fa-solid fa-circle-exclamation");
      return;
    }
    if (!type) {
      showToast(
        "Please select behavior type",
        "fa-solid fa-circle-exclamation"
      );
      return;
    }
    if (!description || description.length < 5) {
      const messages = {
        en: "Description must be at least 5 characters",
        si: "à·€à·’à·ƒà·Šà¶­à¶»à¶º à¶…à·€à¶¸ à·€à·à¶ºà·™à¶±à·Š à¶…à¶šà·”à¶»à·” 5 à¶šà·Š à·€à·’à¶º à¶ºà·”à¶­à·”à¶º",
        ta: "à®µà®¿à®³à®•à¯à®•à®®à¯ à®•à¯à®±à¯ˆà®¨à¯à®¤à®¤à¯ 5 à®Žà®´à¯à®¤à¯à®¤à¯à®•à®³à®¾à®• à®‡à®°à¯à®•à¯à®• à®µà¯‡à®£à¯à®Ÿà¯à®®à¯",
      };
      showToast(
        messages[currentLanguage] || messages.en,
        "fa-solid fa-circle-exclamation"
      );
      return;
    }

    try {
      const student = classStudents.find((s) => s.id == studentId);
      if (!student) {
        const messages = {
          en: "Invalid student selected",
          si: "à·€à¶½à¶‚à¶œà·” à¶±à·œà·€à¶± à·à·’à·‚à·Šâ€à¶º à¶­à·à¶»à· à¶‡à¶­",
          ta: "à®¤à®µà®±à®¾à®© à®®à®¾à®£à®µà®°à¯ à®¤à¯‡à®°à¯à®¨à¯à®¤à¯†à®Ÿà¯à®•à¯à®•à®ªà¯à®ªà®Ÿà¯à®Ÿà¯à®³à¯à®³à®¾à®°à¯",
        };
        showToast(
          messages[currentLanguage] || messages.en,
          "fa-solid fa-circle-exclamation"
        );
        return;
      }

      const payload = {
        student_id: parseInt(studentId),
        class_id: student.class_id,
        type: type,
        severity: severity || null,
        description: description,
        reported_by_id: getTeacherId(),
      };

      const response = await api.teacher.behavior.addRecord(payload);

      if (!response.ok) throw new Error("Failed to submit record");

      const messages = {
        en: "Behavior record submitted successfully",
        si: "à·„à·à·ƒà·’à¶»à·“à¶¸à·Š à·€à·à¶»à·Šà¶­à· à·ƒà·à¶»à·Šà¶®à¶šà·€ à¶‰à¶¯à·’à¶»à·’à¶´à¶­à·Š à¶šà¶»à¶± à¶½à¶¯à·“",
        ta: "à®¨à®Ÿà®¤à¯à®¤à¯ˆ à®ªà®¤à®¿à®µà¯ à®µà¯†à®±à¯à®±à®¿à®•à®°à®®à®¾à®• à®šà®®à®°à¯à®ªà¯à®ªà®¿à®•à¯à®•à®ªà¯à®ªà®Ÿà¯à®Ÿà®¤à¯",
      };
      showToast(
        messages[currentLanguage] || messages.en,
        "fa-solid fa-check-circle"
      );
      resetBehaviorForm();
      loadMyRecords();
      // Close modal
      const modal = document.getElementById("add-behavior-modal");
      if (modal) modal.close();
    } catch (err) {
      console.error("Error submitting record:", err);
      const messages = {
        en: "Error submitting record",
        si: "à·€à·à¶»à·Šà¶­à· à¶‰à¶¯à·’à¶»à·’à¶´à¶­à·Š à¶šà·’à¶»à·“à¶¸à·š à¶¯à·à·‚à¶ºà¶šà·Š",
        ta: "à®ªà®¤à®¿à®µà¯ˆ à®šà®®à®°à¯à®ªà¯à®ªà®¿à®ªà¯à®ªà®¤à®¿à®²à¯ à®ªà®¿à®´à¯ˆ",
      };
      showToast(
        messages[currentLanguage] || messages.en,
        "fa-solid fa-circle-exclamation"
      );
    }
  }

  function initTable() {
    const table = document.getElementById("behavior-table");
    table.setColumns([
        { 
            key: "date", 
            header: "Date",
            render: (row) => new Date(row.date).toLocaleDateString()
        },
        { key: "student", header: "Student", searchable: true },
        { 
            key: "type", 
            header: "Type", 
            render: (row) => {
                const color = row.type === 'Good' || row.type === 'Reward' ? 'green' : 'red';
                return `<span class="badge badge-${color}">${row.type}</span>`; 
            }
        },
        { key: "severity", header: "Severity", render: (row) => row.severity || '-' },
        { key: "description", header: "Description", searchable: true },
        { 
            key: "actions", 
            header: "Actions",
            render: (row) => {
                 // Inline onclick needs to pass ID carefully
                 return `
                    <button class="btn-icon btn-delete" onclick="deleteRecord(${row.id})" title="Delete">
                        <i class="fas fa-trash"></i>
                    </button>
                 `;
            }
        }
    ]);
    table.setEmptyState("No behavior records found", "fas fa-clipboard-list");

    const filterType = document.getElementById("filter-type");
    const filterSeverity = document.getElementById("filter-severity");

    if (filterType) {
        if (typeof makeSearchableDropdown === "function") {
            makeSearchableDropdown("filter-type", (val) => {
                table.addFilter("type", (row) => val === "" || row.type === val);
            });
        } else {
            filterType.addEventListener("change", () => {
                const val = filterType.value;
                table.addFilter("type", (row) => val === "" || row.type === val);
            });
        }
    }

    if (filterSeverity) {
        if (typeof makeSearchableDropdown === "function") {
            makeSearchableDropdown("filter-severity", (val) => {
                table.addFilter("severity", (row) => val === "" || row.severity === val);
            });
        } else {
            filterSeverity.addEventListener("change", () => {
                const val = filterSeverity.value;
                table.addFilter("severity", (row) => val === "" || row.severity === val);
            });
        }
    }
  }

  // Delete behavior record
  function deleteRecord(recordId) {
    const messages = {
      en: "Are you sure you want to delete this record?",
      si: "à¶”à¶¶à¶§ à¶¸à·™à¶¸ à·€à·à¶»à·Šà¶­à· à¶¸à¶šà· à¶¯à·à¶¸à·“à¶¸à¶§ à¶…à·€à·à·Šâ€à¶º à¶¶à·€ à·€à·’à·à·Šà·€à·à·ƒà¶¯?",
      ta: "à®‡à®¨à¯à®¤ à®ªà®¤à®¿à®µà¯ˆ à®¨à¯€à®•à¯à®• à®µà®¿à®°à¯à®®à¯à®ªà¯à®•à®¿à®±à¯€à®°à¯à®•à®³à®¾?",
    };
    
    const confirmText = {
      en: "Delete",
      si: "à¶¸à¶šà¶±à·Šà¶±",
      ta: "à®¨à¯€à®•à¯à®•à¯"
    };

    const cancelText = {
      en: "Cancel",
      si: "à¶…à·€à¶½à¶‚à¶œà·” à¶šà¶»à¶±à·Šà¶±",
      ta: "à®°à®¤à¯à®¤à¯"
    };

    showToast(
      messages[currentLanguage] || messages.en,
      "fa-solid fa-trash",
      {
        confirm: true,
        confirmText: confirmText[currentLanguage] || "Delete",
        cancelText: cancelText[currentLanguage] || "Cancel",
        onConfirm: () => deleteRecordConfirmed(recordId)
      }
    );
  }

  async function deleteRecordConfirmed(recordId) {
    try {
      const response = await api.teacher.behavior.deleteRecord(recordId);

      if (!response.ok) throw new Error("Failed to delete record");

      const messages = {
        en: "Record deleted successfully",
        si: "à·€à·à¶»à·Šà¶­à· à·ƒà·à¶»à·Šà¶®à¶šà·€ à¶¸à¶šà· à¶¯à¶¸à¶± à¶½à¶¯à·“",
        ta: "à®ªà®¤à®¿à®µà¯ à®µà¯†à®±à¯à®±à®¿à®•à®°à®®à®¾à®• à®¨à¯€à®•à¯à®•à®ªà¯à®ªà®Ÿà¯à®Ÿà®¤à¯",
      };
      showToast(
        messages[currentLanguage] || messages.en,
        "fa-solid fa-check-circle"
      );
      loadMyRecords();
    } catch (err) {
      console.error("Error deleting record:", err);
      const messages = {
        en: "Error deleting record",
        si: "à·€à·à¶»à·Šà¶­à· à¶¸à¶šà· à¶¯à·à¶¸à·“à¶¸à·š à¶¯à·à·‚à¶ºà¶šà·Š",
        ta: "à®ªà®¤à®¿à®µà¯ˆ à®¨à¯€à®•à¯à®•à¯à®µà®¤à®¿à®²à¯ à®ªà®¿à®´à¯ˆ",
      };
      showToast(
        messages[currentLanguage] || messages.en,
        "fa-solid fa-circle-exclamation"
      );
    }
  }

  // Reset form
  function resetBehaviorForm() {
    document.getElementById("student-select").value = "";
    document.getElementById("behavior-type").value = "";
    document.getElementById("behavior-severity").value = "";
    document.getElementById("behavior-description").value = "";
    // Clear searchable dropdown inputs if they exist
    // This part depends on how dropdown.js implementation stores the search text
    // Assuming standard implementation:
    const dropdowns = document.querySelectorAll(".dropdown-select");
     dropdowns.forEach((select) => {
        // Reset displayed text for custom dropdowns
        const container = select.closest('.custom-select-container');
        if(container) {
             const selectedDiv = container.querySelector('.select-selected');
             if(selectedDiv) {
                 // Use the text from the first option (Choose a student/Select Type)
                 selectedDiv.textContent = select.options[0].textContent; 
             }
        }
    });

  }

  // Show toast notification
  function showToast(message, icon, options = {}) {
    if (typeof toast === "function") {
      toast(message, icon, options);
    } else {
      alert(message);
    }
  }

  // Initialize on page load
  async function initializePage() {
      await loadClassStudents();
      initTable();
      await loadMyRecords();
      setupAddBehaviorModal();
      // Initialize dropdowns locally if needed, or let global script handle generic ones
      // initializeSearchableDropdowns(); // Redundant if makeSearchableDropdown used inside initTable
  }

  function setupAddBehaviorModal() {
      const addBtn = document.getElementById("add-record-btn");
      const modal = document.getElementById("add-behavior-modal");
      const cancelBtn = document.getElementById("add-behavior-cancel");
      const confirmBtn = document.getElementById("add-behavior-confirm");

      if (addBtn) {
          addBtn.addEventListener("click", () => {
              // Translations for title
              if (modal.titleElement) {
                  modal.titleElement.setAttribute("data-en", "Add Behavior Record");
                  modal.titleElement.setAttribute("data-si", "à·„à·à·ƒà·’à¶»à·“à¶¸à·Š à·€à·à¶»à·Šà¶­à· à¶‘à¶šà·Š à¶šà¶»à¶±à·Šà¶±");
                  modal.titleElement.setAttribute("data-ta", "à®¨à®Ÿà®¤à¯à®¤à¯ˆ à®ªà®¤à®¿à®µà¯ˆà®šà¯ à®šà¯‡à®°à¯à®•à¯à®•à®µà¯à®®à¯");
              }
               // Apply language if function exists
              if (typeof applyDirectLanguageAttributes === "function") {
                  applyDirectLanguageAttributes(localStorage.getItem("lang") || "en");
              }
              modal.open();
          });
      }

      if (cancelBtn) {
          cancelBtn.addEventListener("click", () => {
              modal.close();
          });
      }

      if (confirmBtn) {
          confirmBtn.addEventListener("click", submitBehaviorRecord);
      }
  }

  initializePage();

</script>




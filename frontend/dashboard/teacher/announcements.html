<section class="section">
  <h2 class="heading">
    <i class="fas fa-bullhorn"></i>
    <span data="sidebar.announcements"></span>
  </h2>
  <style>
    .checkbox-item {
      margin-bottom: 8px;
    }
    .checkbox-item label {
      display: flex;
      align-items: center;
      gap: 8px;
      cursor: pointer;
      padding: 4px;
      border-radius: 4px;
      transition: background-color 0.2s;
    }
    .checkbox-item label:hover {
      background-color: var(--color-hover);
    }

    .section-title {
      font-size: 18px;
      font-weight: 600;
      color: var(--color-text);
      margin-bottom: 15px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .section-title i {
      color: var(--color-primary);
    }
  </style>
  <div class="card-grid">
    <!-- My Announcements Card -->
    <div class="card h-2">
      <div class="flex-between mb-2">
        <h3 class="section-title">
          <i class="fas fa-bullhorn"></i>
          <span
            data-en="My Announcements"
            data-si="මගේ නිවේදන"
            data-ta="எனது அறிவிப்புகள்"
            >My Announcements</span
          >
        </h3>
        <button id="add-announcement-btn" class="btn btn-primary">
          <i class="fas fa-plus"></i>
          <span
            data-en="Add Announcement"
            data-si="නිවේදනයක් එක් කරන්න"
            data-ta="அறிவிப்பைச் சேர்க்க"
            >Add Announcement</span
          >
        </button>
      </div>
      <div class="announcements-container" id="my-announcements-container">
        <!-- My announcements will be loaded here dynamically -->
      </div>
    </div>

    <!-- Received Announcements Card -->
    <div class="card h-2">
      <h3 class="section-title">
        <i class="fas fa-inbox"></i>
        <span
          data-en="Announcements for Me"
          data-si="මට අදාළ නිවේදන"
          data-ta="எனக்கான அறிவிப்புகள்"
          >Announcements for Me</span
        >
      </h3>
      <div
        class="announcements-container"
        id="received-announcements-container"
      >
        <!-- Received announcements will be loaded here dynamically -->
      </div>
    </div>
  </div>
</section>

<!-- Add/Edit Announcement Modal -->
<div id="announcement-modal" class="modal" style="display: none">
  <div class="modal-content">
    <div class="modal-header">
      <h3
        id="modal-title"
        data-en="Add Announcement"
        data-si="නිවේදනයක් එක් කරන්න"
        data-ta="அறிவிப்பைச் சேர்க்க"
      >
        Add Announcement
      </h3>
      <span class="modal-close">&times;</span>
    </div>
    <div class="modal-body">
      <div class="mb-2">
        <label
          for="announcement-title"
          data-en="Title:"
          data-si="මාතෘකාව:"
          data-ta="தலைப்பு:"
          >Title:</label
        >
        <input
          type="text"
          id="announcement-title"
          placeholder="Enter announcement title..."
          class="mt-1"
          data-en="Enter announcement title..."
          data-si="නිවේදන මාතෘකාව ඇතුල් කරන්න..."
          data-ta="அறிவிப்பு தலைப்பை உள்ளீடு செய்ய..."
        />
      </div>
      <div class="mb-2">
        <label
          for="announcement-description"
          data-en="Description:"
          data-si="විස්තරය:"
          data-ta="விவரம்:"
          >Description:</label
        >
        <textarea
          id="announcement-description"
          placeholder="Enter announcement description..."
          class="mt-1"
          data-en="Enter announcement description..."
          data-si="නිවේදන විස්තරය ඇතුල් කරන්න..."
          data-ta="அறிவிப்பு விவரத்தை உள்ளீடு செய்ய..."
        ></textarea>
      </div>
      <div class="mb-2">
        <p class="text-sm" style="color: var(--color-subtext)">
          <i class="fas fa-info-circle"></i>
          <span
            data-en="This announcement will be sent to all students in your class."
            data-si="මෙම නිවේදනය ඔබගේ පන්තියේ සියලුම ශිෂ්‍යයින්ට යවනු ලැබේ."
            data-ta="இந்த அறிவிப்பு உங்கள் வகுப்பில் உள்ள அனைத்து மாணவர்களுக்கும் அனுப்பப்படும்."
            >This announcement will be sent to all students in your class.</span
          >
        </p>
      </div>
    </div>
    <div class="modal-footer">
      <button
        id="modal-cancel"
        class="btn btn-secondary"
        data-en="Cancel"
        data-si="අවලංගු කරන්න"
        data-ta="ரத்து செய்ய"
      >
        Cancel
      </button>
      <button
        id="modal-save"
        class="btn btn-primary"
        data-en="Save"
        data-si="සුරකින්න"
        data-ta="சேமிக்க"
      >
        Save
      </button>
    </div>
  </div>
</div>

<script>
  let myAnnouncements = [];
  let receivedAnnouncements = [];
  let editingAnnouncement = null;

  function renderAnnouncements(announcements, containerId) {
    const container = document.querySelector(`#${containerId}`);
    container.innerHTML = "";
    if (!announcements.length) {
      const noAnnouncementsDiv = document.createElement("div");
      noAnnouncementsDiv.className = "no-announcements text-center";
      noAnnouncementsDiv.setAttribute("data-en", "No announcements found");
      noAnnouncementsDiv.setAttribute(
        "data-si",
        "නිවේදන කිසිවක් සොයා ගත නොහැකි විය"
      );
      noAnnouncementsDiv.setAttribute(
        "data-ta",
        "அறிவிப்புகள் எதுவும் கிடைக்கவில்லை"
      );
      noAnnouncementsDiv.textContent = "No announcements found";
      container.appendChild(noAnnouncementsDiv);
      // Apply current language
      if (typeof applyDirectLanguageAttributes === "function") {
        applyDirectLanguageAttributes(localStorage.getItem("lang") || "en");
      }
      return;
    }

    announcements.forEach((announcement) => {
      const card = document.createElement("div");
      card.className = "announcement-card";

      const createdDate = new Date(
        announcement.created_at
      ).toLocaleDateString();

      // Format audience display
      const currentLang = localStorage.getItem("lang") || "en";
      let audienceDisplay = "";
      switch (announcement.audience_type) {
        case "all":
          audienceDisplay =
            {
              en: "All (Teachers & Students)",
              si: "සියල්ල (ගුරුවරුන් සහ ශිෂ්‍යයින්)",
              ta: "அனைத்தும் (ஆசிரியர்கள் மற்றும் மாணவர்கள்)",
            }[currentLang] || "All (Teachers & Students)";
          break;
        case "teachers":
          audienceDisplay =
            {
              en: `Teachers (${announcement.target_count || 0})`,
              si: `ගුරුවරුන් (${announcement.target_count || 0})`,
              ta: `ஆசிரியர்கள் (${announcement.target_count || 0})`,
            }[currentLang] || `Teachers (${announcement.target_count || 0})`;
          break;
        case "students":
          audienceDisplay =
            {
              en: `Classes (${announcement.target_count || 0})`,
              si: `පන්ති (${announcement.target_count || 0})`,
              ta: `வகுப்புகள் (${announcement.target_count || 0})`,
            }[currentLang] || `Classes (${announcement.target_count || 0})`;
          break;
      }

      card.innerHTML = `
        <div class="announcement-title flex-between">
          <span>${announcement.title}</span>
          <div class="announcement-actions">
            ${
              containerId === "my-announcements-container"
                ? `
              <button class="btn-icon btn-edit" onclick="editAnnouncement(${announcement.id})" title="Edit">
                <i class="fas fa-edit"></i>
              </button>
              <button class="btn-icon btn-delete" onclick="deleteAnnouncement(${announcement.id})" title="Delete">
                <i class="fas fa-trash"></i>
              </button>
            `
                : ""
            }
          </div>
        </div>
        <div class="announcement-description-container">
          <div class="announcement-description collapsed" id="desc-${containerId}-${
        announcement.id
      }">${announcement.description}</div>
          <button class="expand-btn" id="expand-${containerId}-${
        announcement.id
      }" style="display: none;" onclick="toggleDescription('${containerId}', ${
        announcement.id
      })">
            <span data-en="Show more" data-si="තව පෙන්වන්න" data-ta="மேலும் காட்சி">Show more</span>
            <i class="fas fa-chevron-down"></i>
          </button>
        </div>
        <div class="announcement-meta flex-between">
          <span class="text-sm" data-en="Audience:" data-si="ප්‍රේක්ෂකයින්:" data-ta="பார்வையாளர்கள்:">Audience:</span> ${audienceDisplay}
          <span class="text-sm" data-en="Created:" data-si="නිර්මාණය කරන ලදී:" data-ta="உருவாக்கப்பட்டது:">Created:</span> ${createdDate} ${
        announcement.posted_by_name
          ? `<span data-en="• By" data-si="• විසින්" data-ta="• மூலம்">• By</span> ${announcement.posted_by_name}`
          : ""
      }</span>
        </div>
      `;

      container.appendChild(card);

      // Check if description needs expand button
      setTimeout(() => {
        const descElement = card.querySelector(
          `#desc-${containerId}-${announcement.id}`
        );
        const expandBtn = card.querySelector(
          `#expand-${containerId}-${announcement.id}`
        );

        // Check if text is truncated
        if (descElement.scrollHeight > descElement.clientHeight) {
          expandBtn.style.display = "inline-flex";
        }
      }, 0);
    });
  }

  function fetchMyAnnouncements() {
    console.log("Fetching my announcements...");
    fetch("/api/teacher/announcements")
      .then((res) => {
        console.log("API response status:", res.status);
        if (!res.ok) throw new Error("Failed to fetch announcements");
        return res.json();
      })
      .then((data) => {
        console.log("Received my announcements data:", data);
        myAnnouncements = data;
        renderAnnouncements(myAnnouncements, "my-announcements-container");
      })
      .catch((err) => {
        console.error("Error fetching my announcements:", err);
        const container = document.querySelector("#my-announcements-container");
        const errorDiv = document.createElement("div");
        errorDiv.className = "no-announcements text-center";
        errorDiv.setAttribute("data-en", "Error loading announcements");
        errorDiv.setAttribute("data-si", "නිවේදන පූරණය කිරීමේ දෝෂයක්");
        errorDiv.setAttribute("data-ta", "அறிவிப்புகளை ஏற்றுவதில் பிழை");
        errorDiv.textContent = "Error loading announcements";
        container.appendChild(errorDiv);
        // Apply current language
        if (typeof applyDirectLanguageAttributes === "function") {
          applyDirectLanguageAttributes(localStorage.getItem("lang") || "en");
        }
      });
  }

  function fetchReceivedAnnouncements() {
    console.log("Fetching received announcements...");
    fetch("/api/teacher/announcements/received")
      .then((res) => {
        console.log("API response status:", res.status);
        if (!res.ok) throw new Error("Failed to fetch received announcements");
        return res.json();
      })
      .then((data) => {
        console.log("Received announcements data:", data);
        receivedAnnouncements = data;
        renderAnnouncements(
          receivedAnnouncements,
          "received-announcements-container"
        );
      })
      .catch((err) => {
        console.error("Error fetching received announcements:", err);
        const container = document.querySelector(
          "#received-announcements-container"
        );
        const errorDiv = document.createElement("div");
        errorDiv.className = "no-announcements text-center";
        errorDiv.setAttribute("data-en", "Error loading announcements");
        errorDiv.setAttribute("data-si", "නිවේදන පූරණය කිරීමේ දෝෂයක්");
        errorDiv.setAttribute("data-ta", "அறிவிப்புகளை ஏற்றுவதில் பிழை");
        errorDiv.textContent = "Error loading announcements";
        container.appendChild(errorDiv);
        // Apply current language
        if (typeof applyDirectLanguageAttributes === "function") {
          applyDirectLanguageAttributes(localStorage.getItem("lang") || "en");
        }
      });
  }

  function setupAddButton() {
    const addBtn = document.getElementById("add-announcement-btn");
    const modal = document.getElementById("announcement-modal");
    const closeBtn = document.querySelector("#announcement-modal .modal-close");
    const cancelBtn = document.getElementById("modal-cancel");
    const saveBtn = document.getElementById("modal-save");

    addBtn.addEventListener("click", () => {
      editingAnnouncement = null;
      const modalTitle = document.getElementById("modal-title");
      modalTitle.setAttribute("data-en", "Add Announcement");
      modalTitle.setAttribute("data-si", "නිවේදනයක් එක් කරන්න");
      modalTitle.setAttribute("data-ta", "அறிவிப்பைச் சேர்க்க");
      modalTitle.textContent = "Add Announcement";
      // Apply current language
      if (typeof applyDirectLanguageAttributes === "function") {
        applyDirectLanguageAttributes(localStorage.getItem("lang") || "en");
      }
      clearModal();
      modal.style.display = "flex";
    });

    const closeModal = () => {
      modal.style.display = "none";
    };

    closeBtn.addEventListener("click", closeModal);
    cancelBtn.addEventListener("click", closeModal);

    modal.addEventListener("click", (e) => {
      if (e.target === modal) {
        closeModal();
      }
    });

    saveBtn.addEventListener("click", saveAnnouncement);
  }

  function saveAnnouncement() {
    const title = document.getElementById("announcement-title").value.trim();
    const description = document
      .getElementById("announcement-description")
      .value.trim();

    if (!title || !description) {
      toast("Please fill in all fields.", "fa-solid fa-circle-exclamation");
      return;
    }

    // Teachers can only send to their own class
    const method = editingAnnouncement ? "PUT" : "POST";
    const url = editingAnnouncement
      ? `/api/teacher/announcements/${editingAnnouncement.id}`
      : "/api/teacher/announcements";

    const body = {
      title,
      description,
      audience_type: "students",
      class_ids: [], // Will be set by backend based on teacher's class
    };

    fetch(url, {
      method,
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(body),
    })
      .then((res) => {
        if (!res.ok) throw new Error("Failed to save announcement");
        return res.json();
      })
      .then(() => {
        document.getElementById("announcement-modal").style.display = "none";
        toast("Announcement saved successfully", "fa-solid fa-check-circle");
        fetchMyAnnouncements();
      })
      .catch((err) => {
        console.error(err);
        toast("Error saving announcement", "fa-solid fa-circle-exclamation");
      });
  }

  function clearModal() {
    document.getElementById("announcement-title").value = "";
    document.getElementById("announcement-description").value = "";
  }

  function editAnnouncement(id) {
    console.log(
      "Edit button clicked for announcement ID:",
      id,
      "type:",
      typeof id
    );
    console.log(
      "Available announcement IDs:",
      myAnnouncements.map((a) => ({ id: a.id, type: typeof a.id }))
    );
    const announcement = myAnnouncements.find((a) => a.id == id); // Use == for type coercion
    console.log("Found announcement:", announcement);
    if (!announcement) {
      console.error("Announcement not found with ID:", id);
      toast(
        `Announcement with ID ${id} not found.`,
        "fa-solid fa-circle-exclamation"
      );
      return;
    }

    editingAnnouncement = announcement;
    const modalTitle = document.getElementById("modal-title");
    modalTitle.setAttribute("data-en", "Edit Announcement");
    modalTitle.setAttribute("data-si", "නිවේදනය සංස්කරණය කරන්න");
    modalTitle.setAttribute("data-ta", "அறிவிப்பைத் திருத்து");
    modalTitle.textContent = "Edit Announcement";
    // Apply current language
    if (typeof applyDirectLanguageAttributes === "function") {
      applyDirectLanguageAttributes(localStorage.getItem("lang") || "en");
    }
    document.getElementById("announcement-title").value = announcement.title;
    document.getElementById("announcement-description").value =
      announcement.description;

    document.getElementById("announcement-modal").style.display = "flex";
    console.log("Modal should now be visible");
  }

  function deleteAnnouncement(id) {
    toast(
      "Are you sure you want to delete this announcement?",
      "fa-solid fa-trash",
      {
        confirm: true,
        confirmText: "Delete",
        cancelText: "Cancel",
        onConfirm: function () {
          fetch(`/api/teacher/announcements/${id}`, {
            method: "DELETE",
          })
            .then((res) => {
              if (!res.ok) throw new Error("Failed to delete announcement");
              return res.json();
            })
            .then(() => {
              toast(
                "Announcement deleted successfully",
                "fa-solid fa-check-circle"
              );
              fetchMyAnnouncements(); // Refresh the list
            })
            .catch((err) => {
              console.error("Error deleting announcement:", err);
              toast(
                "Error deleting announcement",
                "fa-solid fa-circle-exclamation"
              );
            });
        },
        onCancel: function () {
          // Do nothing, just close toast
        },
      }
    );
  }

  function toggleDescription(containerId, id) {
    const descElement = document.getElementById(`desc-${containerId}-${id}`);
    const expandBtn = document.getElementById(`expand-${containerId}-${id}`);
    const btnText = expandBtn.querySelector("span");
    const btnIcon = expandBtn.querySelector("i");

    if (descElement.classList.contains("collapsed")) {
      // Expand
      descElement.classList.remove("collapsed");
      descElement.classList.add("expanded");
      btnText.setAttribute("data-en", "Show less");
      btnText.setAttribute("data-si", "අඩු කර පෙන්වන්න");
      btnText.setAttribute("data-ta", "குறைவாகக் காட்சி");
      btnText.textContent = "Show less";
      expandBtn.classList.add("expanded");
    } else {
      // Collapse
      descElement.classList.remove("expanded");
      descElement.classList.add("collapsed");
      btnText.setAttribute("data-en", "Show more");
      btnText.setAttribute("data-si", "තව පෙන්වන්න");
      btnText.setAttribute("data-ta", "மேலும் காட்சி");
      btnText.textContent = "Show more";
      expandBtn.classList.remove("expanded");
    }
    // Apply current language
    if (typeof applyDirectLanguageAttributes === "function") {
      applyDirectLanguageAttributes(localStorage.getItem("lang") || "en");
    }
  }

  function setupTabs() {
    // No longer needed - both sections are always visible
  }

  // Initialize
  setupTabs();
  fetchMyAnnouncements();
  fetchReceivedAnnouncements();
  setupAddButton();
</script>

<div class="card-grid">
  <!-- Greeting Tile -->
  <div class="card greeting-tile w-2">
    <div class="greeting-content">
      <h2 class="greeting-heading" data="teacher.greeting"></h2>
      <p class="greeting-subtext" data="teacher.greeting_2"></p>
    </div>
    <img
      src="/assets/images/teacher-clipart.svg"
      alt="Illustration"
      class="greeting-img"
    />
  </div>

  <!-- Today's Timetable -->
  <div class="card dashboard-tile w-1 h-2" id="todays-timetable">
    <div class="icon-title">
      <i class="fas fa-calendar-day icon"></i>
      <p class="tile-label" data="teacher.timetable"></p>
    </div>
    <div>
      <ul class="tile-list">
        <!-- Dynamic timetable entries will appear here -->
      </ul>
    </div>
  </div>

  <!-- Current Class -->
  <div class="card dashboard-tile" id="current-class">
    <div class="icon-title">
      <i class="fas fa-chalkboard icon"></i>
      <p class="tile-label" data="teacher.current_class"></p>
    </div>
    <div>
      <p class="title-primary" style="font-size: 32px" id="current-class-name">
        Grade 10-A
      </p>
      <h1 class="tile-value" style="font-size: 24px" id="current-subject-name">
        Math
      </h1>
      <p class="tile-subtext" id="current-time-range">08:00 AM – 08:45 AM</p>
    </div>
  </div>

  <!-- Attendance Status -->
  <div class="card dashboard-tile" id="dashboard-attendance-card">
    <div class="icon-title">
      <i class="fas fa-clipboard-check icon"></i>
      <p class="tile-label" data="teacher.attendance"></p>
    </div>
    <div id="dashboard-attendance-content">
      <!-- Content will be injected by JS -->
    </div>
  </div>

  <!-- Tasks -->
  <div class="card dashboard-tile flex-column">
    <div class="icon-title">
      <i class="fas fa-tasks icon"></i>
      <p class="tile-label">Pending Tasks</p>
    </div>
    <div>
      <ul class="tile-list">
        <li>Upload results</li>
        <li>Mark attendance</li>
        <li>Assign Student Subjects</li>
        <li>Enter Marks</li>
      </ul>
    </div>
  </div>
</div>

<script>
  async function loadTodaysTimetable(teacherId) {
    try {
      // Hardcoded current time (24-hour format)
      const currentTime = "09:15";

      // Fetch timetable & time slots
      const timetableRes = await fetch(
        `/api/teacher/timetable/today/${teacherId}`
      );
      const timetable = await timetableRes.json();

      const timeRes = await fetch("/data/time.json");
      const timeSlots = await timeRes.json();

      const timetableList = document.querySelector(
        "#todays-timetable .tile-list"
      );
      timetableList.innerHTML = "";

      // Helper to parse "HH:MM" to minutes since midnight for comparison
      function timeToMinutes(t) {
        const [h, m] = t.split(":").map(Number);
        return h * 60 + m;
      }
      const currentMinutes = timeToMinutes(currentTime);

      let activeEntry = null;

      timetable.forEach((entry) => {
        const slotInfo = timeSlots.find((s) => s.slot === entry.slot);
        if (!slotInfo) return;

        // Get start and end times in minutes for current slot
        const startMinutes = timeToMinutes(slotInfo.start);
        const endMinutes = timeToMinutes(slotInfo.end);

        // Check if currentTime is inside this slot range
        const isActive =
          currentMinutes >= startMinutes && currentMinutes < endMinutes;

        // Build li element
        const li = document.createElement("li");
        if (isActive) {
          li.classList.add("active");
          activeEntry = { entry, slotInfo };
        }

        li.innerHTML = `
          <span class="slot-time">${slotInfo.start}</span>
          <span class="subject-name">${entry.subject}</span>
          <span class="class-name">${entry.grade} - ${entry.class_name}</span>
        `;

        timetableList.appendChild(li);
      });

      // Update current class tile with active slot info
      if (activeEntry) {
        document.getElementById(
          "current-class-name"
        ).textContent = `Grade ${activeEntry.entry.grade} - ${activeEntry.entry.class_name}`;
        document.getElementById("current-subject-name").textContent =
          activeEntry.entry.subject;
        document.getElementById(
          "current-time-range"
        ).textContent = `${activeEntry.slotInfo.start} – ${activeEntry.slotInfo.end}`;
      } else {
        // If no active slot, clear or set default text
        document.getElementById("current-class-name").textContent = "-";
        document.getElementById("current-subject-name").textContent =
          "No class now";
        document.getElementById("current-time-range").textContent = "";
      }
    } catch (err) {
      console.error("Error loading timetable:", err);
    }
  }

  // Attendance card logic
  async function loadDashboardAttendance() {
    const dateStr = (() => {
      const today = new Date();
      const yyyy = today.getFullYear();
      const mm = String(today.getMonth() + 1).padStart(2, "0");
      const dd = String(today.getDate()).padStart(2, "0");
      return `${yyyy}-${mm}-${dd}`;
    })();
    let presentCount = 0;
    let absentCount = 0;
    let totalCount = 0;
    let totalStudents = 0;
    let attendanceMarked = false;
    let classId = null;
    try {
      const res = await fetch(`/api/teacher/attendance?date=${dateStr}`);
      if (res.ok) {
        const data = await res.json();
        if (Array.isArray(data) && data.length > 0) {
          attendanceMarked = true;
          presentCount = data.filter(
            (r) => r.status === true || r.status === "present" || r.status === 1
          ).length;
          absentCount = data.filter(
            (r) => r.status === false || r.status === "absent" || r.status === 0
          ).length;
          totalCount = data.length;
          if (data[0].class_id) classId = data[0].class_id;
        }
      }
      if (!classId) {
        const userRes = await fetch("/api/auth/me");
        if (userRes.ok) {
          const userData = await userRes.json();
          if (userData && userData.class_id) classId = userData.class_id;
        }
      }
      if (classId) {
        const studentsRes = await fetch(
          `/api/teacher/students/class/${classId}`
        );
        if (studentsRes.ok) {
          const studentsData = await studentsRes.json();
          if (Array.isArray(studentsData)) {
            totalStudents = studentsData.length;
          }
        }
      }
    } catch (err) {
      // ignore error
    }

    const container = document.getElementById("dashboard-attendance-content");
    container.innerHTML = "";
    if (!attendanceMarked) {
      // Show mark attendance button
      container.innerHTML = `
        <h3 class="tile-value text-error">Attendance not marked</h3>
        <button class="btn" onclick="window.location.href = 'layout.html?role=teacher&page=attendance/mark'">
          <i class="fas fa-user-check"></i>
          <span>Mark Attendance</span>
        </button>
      `;
    } else {
      // Show today's attendance graph
      container.innerHTML = `<canvas id="dashboardAttendanceChart" height="120"></canvas>`;
      // Render chart
      setTimeout(() => {
        const rootStyles = getComputedStyle(document.documentElement);
        const primaryColor = rootStyles
          .getPropertyValue("--color-primary")
          .trim();
        // Center text plugin for doughnut chart
        const centerTextPlugin = {
          id: "centerText",
          beforeDraw(chart, args, options) {
            if (chart.config.type !== "doughnut") return;
            const { ctx, width, height } = chart;
            ctx.save();
            const fontSize = (height / 160).toFixed(2);
            ctx.font = `${fontSize}em sans-serif`;
            ctx.textBaseline = "middle";
            ctx.textAlign = "center";
            ctx.fillStyle = options.color || primaryColor;
            const text = options.text || "";
            ctx.fillText(
              text,
              width / 2,
              chart.getDatasetMeta(0).data[0]?.y || height / 2
            );
            ctx.restore();
          },
        };
        const chartData = {
          labels: ["Present", "Absent"],
          datasets: [
            {
              data: [presentCount, absentCount],
              backgroundColor: [primaryColor, primaryColor + "40"],
              borderRadius: 20,
            },
          ],
        };
        new Chart(document.getElementById("dashboardAttendanceChart"), {
          type: "doughnut",
          data: chartData,
          options: {
            responsive: true,
            cutout: "80%",
            borderColor: "transparent",
            plugins: {
              legend: { display: false },
              title: {
                display: true,
                text: `Attendance: ${presentCount}/${totalCount}`,
                font: { size: 16, weight: "bold" },
                position: "bottom",
              },
              centerText: {
                text: `${presentCount}/${totalCount}`,
                color: primaryColor,
              },
            },
          },
          plugins: [centerTextPlugin],
        });
      }, 100);
    }
  }

  // Load for teacher with ID 1 (replace as needed)
  loadTodaysTimetable(3);
  loadDashboardAttendance();
</script>

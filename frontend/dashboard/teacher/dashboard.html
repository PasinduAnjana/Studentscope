<div class="card-grid">
  <!-- Greeting Tile -->
  <div class="card greeting-tile w-2">
    <div class="greeting-content">
      <h2 class="greeting-heading" data="teacher.greeting"></h2>
      <p class="greeting-subtext" data="teacher.greeting_2"></p>
    </div>
    <img
      src="/assets/images/teacher-clipart.svg"
      alt="Illustration"
      class="greeting-img"
    />
  </div>

  <!-- Today's Timetable -->
  <div class="card dashboard-tile w-1 h-2" id="todays-timetable">
    <div class="icon-title">
      <i class="fas fa-calendar-day icon"></i>
      <p class="tile-label" data="teacher.timetable"></p>
    </div>
    <div>
      <ul class="tile-list">
        <!-- Dynamic timetable entries will appear here -->
      </ul>
    </div>
  </div>

  <!-- Current Class -->
  <div class="card dashboard-tile" id="current-class">
    <div class="icon-title">
      <i class="fas fa-chalkboard icon"></i>
      <p class="tile-label" data="teacher.current_class"></p>
    </div>
    <div>
      <p class="title-primary" style="font-size: 32px" id="current-class-name">
        Grade 10-A
      </p>
      <h1 class="tile-value" style="font-size: 24px" id="current-subject-name">
        Math
      </h1>
      <p class="tile-subtext" id="current-time-range">08:00 AM – 08:45 AM</p>
    </div>
  </div>

  <!-- Attendance Status -->
  <div class="card dashboard-tile" id="dashboard-attendance-card">
    <div class="icon-title">
      <i class="fas fa-clipboard-check icon"></i>
      <p class="tile-label" data="teacher.attendance"></p>
    </div>
    <div id="dashboard-attendance-content">
      <!-- Content will be injected by JS -->
    </div>
  </div>

  <!-- Tasks -->
  <div class="card dashboard-tile flex-column">
    <div class="icon-title">
      <i class="fas fa-tasks icon"></i>
      <p
        class="tile-label"
        data-en="Pending Tasks"
        data-si="අපේක්ෂිත කාර්යයන්"
        data-ta="நிலுவையில் உள்ள பணிகள்"
      >
        Pending Tasks
      </p>
    </div>
    <div>
      <ul class="tile-list" id="dashboard-todos-list">
        <!-- Todos will be loaded here -->
      </ul>
    </div>
  </div>

  <!-- Recent Announcements -->
  <div class="card dashboard-tile flex-column">
    <div class="icon-title">
      <i class="fas fa-bullhorn icon"></i>
      <p class="tile-label" data="sidebar.announcements"></p>
    </div>
    <div>
      <ul class="tile-list" id="announcements-list">
        <!-- Announcements will be loaded here -->
      </ul>
    </div>
  </div>

  <!-- Pending Password Resets -->
  <div class="card dashboard-tile">
    <div class="icon-title">
      <i class="fas fa-key icon"></i>
      <p
        class="tile-label"
        data-en="Password Resets"
        data-si="මුරපදය යළි පිහිටුවීම්"
        data-ta="கடவுச்சொல் மீட்டமைப்புகள්"
      >
        Password Resets
      </p>
    </div>
    <div>
      <ul class="tile-list" id="dashboard-resets-list">
        <li
          class="text-sm"
          data-en="Loading..."
          data-si="පූරණය වෙමින්..."
          data-ta="ஏற்றப்படுகிறது..."
        >
          Loading...
        </li>
      </ul>
    </div>
  </div>

  <script>
    async function loadTodaysTimetable() {
      try {
        // Hardcoded current time (24-hour format)
        const currentTime = "09:15";

        // Check if today is weekend (Saturday = 6, Sunday = 0)
        const today = new Date();
        const dayOfWeek = today.getDay();
        const isWeekend = dayOfWeek === 0 || dayOfWeek === 6;

        let timetable;
        if (isWeekend) {
          // Fetch weekly timetable and filter for Monday (day_of_week = 1)
          const weeklyRes = await api.teacher.timetable.getWeek();
          const weeklyTimetable = await weeklyRes.json();
          // Map weekly format to today format for consistency
          timetable = weeklyTimetable
            .filter((entry) => entry.day_of_week === 1)
            .map((entry) => ({
              slot: entry.period_number,
              subject: entry.subject,
              class_name: entry.class_name,
              grade: entry.grade,
            }));
        } else {
          // Fetch today's timetable
          const timetableRes = await api.teacher.timetable.getToday();
          timetable = await timetableRes.json();
        }

        const timeSlots = await api.data.getTimeSlots();

        const timetableList = document.querySelector(
          "#todays-timetable .tile-list"
        );
        timetableList.innerHTML = "";

        // Update tile label to show which day's timetable is being displayed
        const tileLabel = document.querySelector(
          "#todays-timetable .tile-label"
        );
        if (tileLabel) {
          if (isWeekend) {
            tileLabel.setAttribute("data-en", "Monday's Timetable");
            tileLabel.setAttribute("data-si", "සඳුදා කාලසටහන");
            tileLabel.setAttribute("data-ta", "திங்கட்கிழமை நேர அட்டவணை");
            tileLabel.textContent = isWeekend
              ? "Monday's Timetable"
              : "Today's Timetable";
          } else {
            tileLabel.setAttribute("data-en", "Today's Timetable");
            tileLabel.setAttribute("data-si", "අද කාලසටහන");
            tileLabel.setAttribute("data-ta", "இன்றைய நேர அட்டவணை");
            tileLabel.textContent = isWeekend
              ? "Monday's Timetable"
              : "Today's Timetable";
          }
          // Apply current language
          if (typeof applyDirectLanguageAttributes === "function") {
            applyDirectLanguageAttributes(localStorage.getItem("lang") || "en");
          }
        }

        // Helper to parse "HH:MM" to minutes since midnight for comparison
        function timeToMinutes(t) {
          const [h, m] = t.split(":").map(Number);
          return h * 60 + m;
        }
        const currentMinutes = timeToMinutes(currentTime);

        let activeEntry = null;

        timetable.forEach((entry) => {
          const slotInfo = timeSlots.find((s) => s.slot === entry.slot);
          if (!slotInfo) return;

          // Get start and end times in minutes for current slot
          const startMinutes = timeToMinutes(slotInfo.start);
          const endMinutes = timeToMinutes(slotInfo.end);

          // Check if currentTime is inside this slot range
          const isActive =
            currentMinutes >= startMinutes && currentMinutes < endMinutes;

          // Build li element
          const li = document.createElement("li");
          if (isActive) {
            li.classList.add("active");
            activeEntry = { entry, slotInfo };
          }

          li.innerHTML = `
          <span class="slot-time">${slotInfo.start}</span>
          <span class="subject-name">${entry.subject}</span>
          <span class="class-name">${entry.grade} - ${entry.class_name}</span>
        `;

          timetableList.appendChild(li);
        });

        // Update current class tile with active slot info
        if (isWeekend) {
          // On weekends, show empty state in current class tile
          const currentClassTile = document.getElementById("current-class").querySelector("div:last-child");
          const message = {
             en: "Weekend",
             si: "සති අන්තය",
             ta: "வார இறுதி"
          };
          const lang = localStorage.getItem("lang") || "en";
          currentClassTile.innerHTML = `<empty-state-message message="${message[lang] || message.en}" icon="fas fa-couch"></empty-state-message>`;
        } else if (activeEntry) {
          document.getElementById(
            "current-class-name"
          ).textContent = `Grade ${activeEntry.entry.grade} - ${activeEntry.entry.class_name}`;
          document.getElementById("current-subject-name").textContent =
            activeEntry.entry.subject;
          document.getElementById(
            "current-time-range"
          ).textContent = `${activeEntry.slotInfo.start} – ${activeEntry.slotInfo.end}`;
        } else {
          // If no active slot, clear or set default text
          document.getElementById("current-class-name").textContent = "-";
          const subjectElement = document.getElementById(
            "current-subject-name"
          );
          subjectElement.setAttribute("data-en", "No class now");
          subjectElement.setAttribute("data-si", "දැන් පන්තියක් නැත");
          subjectElement.setAttribute("data-ta", "இப்போது வகுப்பு இல்லை");
          subjectElement.textContent = "No class now";
          document.getElementById("current-time-range").textContent = "";
          // Apply current language
          if (typeof applyDirectLanguageAttributes === "function") {
            applyDirectLanguageAttributes(localStorage.getItem("lang") || "en");
          }
        }
      } catch (err) {
        console.error("Error loading timetable:", err);
      }
    }

    // Attendance card logic
    async function loadDashboardAttendance() {
      const dateStr = (() => {
        const today = new Date();
        const yyyy = today.getFullYear();
        const mm = String(today.getMonth() + 1).padStart(2, "0");
        const dd = String(today.getDate()).padStart(2, "0");
        return `${yyyy}-${mm}-${dd}`;
      })();
      let presentCount = 0;
      let absentCount = 0;
      let totalCount = 0;
      let totalStudents = 0;
      let attendanceMarked = false;
      let classId = null;
      try {
        const res = await api.teacher.attendance.getByDate(dateStr);
        if (res.ok) {
          const data = await res.json();
          if (Array.isArray(data) && data.length > 0) {
            attendanceMarked = true;
            presentCount = data.filter(
              (r) =>
                r.status === true || r.status === "present" || r.status === 1
            ).length;
            absentCount = data.filter(
              (r) =>
                r.status === false || r.status === "absent" || r.status === 0
            ).length;
            totalCount = data.length;
            if (data[0].class_id) classId = data[0].class_id;
          }
        }
        if (!classId) {
          const userRes = await api.auth.me();
          if (userRes.ok) {
            const userData = await userRes.json();
            if (userData && userData.class_id) classId = userData.class_id;
          }
        }
        if (classId) {
          const studentsRes = await api.teacher.students.getByClass(classId);
          if (studentsRes.ok) {
            const studentsData = await studentsRes.json();
            if (Array.isArray(studentsData)) {
              totalStudents = studentsData.length;
            }
          }
        }
      } catch (err) {
        // ignore error
      }

      const container = document.getElementById("dashboard-attendance-content");
      container.innerHTML = "";
      if (!attendanceMarked) {
        // Show mark attendance button with empty state
        const message = {
           en: "Attendance not marked",
           si: "පැමිණීම සලකුණු කර නැත",
           ta: "வருகை குறிக்கப்படவில்லை"
        };
        const lang = localStorage.getItem("lang") || "en";
        
        container.innerHTML = `
          <div style="display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; gap: 10px;">
            <empty-state-message message="${message[lang] || message.en}" icon="fas fa-exclamation-circle" style="height: auto; min-height: unset; padding: 0;"></empty-state-message>
            <button class="btn" onclick="window.location.href = 'layout.html?role=teacher&page=attendance'">
              <i class="fas fa-user-check"></i>
              <span data="teacher.mark_attendance"></span>
            </button>
          </div>
        `;
        if (typeof applyTranslations === "function") applyTranslations();
      } else {
        // Show today's attendance graph
        container.innerHTML = `<canvas id="dashboardAttendanceChart" height="120"></canvas>`;
        // Render chart
        setTimeout(() => {
          const rootStyles = getComputedStyle(document.documentElement);
          const primaryColor = rootStyles
            .getPropertyValue("--color-primary")
            .trim();
          // Center text plugin for doughnut chart
          const centerTextPlugin = {
            id: "centerText",
            beforeDraw(chart, args, options) {
              if (chart.config.type !== "doughnut") return;
              const { ctx, width, height } = chart;
              ctx.save();
              const fontSize = (height / 160).toFixed(2);
              ctx.font = `${fontSize}em sans-serif`;
              ctx.textBaseline = "middle";
              ctx.textAlign = "center";
              ctx.fillStyle = options.color || primaryColor;
              const text = options.text || "";
              ctx.fillText(
                text,
                width / 2,
                chart.getDatasetMeta(0).data[0]?.y || height / 2
              );
              ctx.restore();
            },
          };
          const chartData = {
            labels: [
              { en: "Present", si: "පැමිණි", ta: "வருகை" },
              { en: "Absent", si: "නොපැමිණි", ta: "இல்லை" },
            ],
            datasets: [
              {
                data: [presentCount, absentCount],
                backgroundColor: [primaryColor, primaryColor + "40"],
                borderRadius: 20,
              },
            ],
          };
          new Chart(document.getElementById("dashboardAttendanceChart"), {
            type: "doughnut",
            data: chartData,
            options: {
              responsive: true,
              cutout: "80%",
              borderColor: "transparent",
              plugins: {
                legend: { display: false },
                title: {
                  display: true,
                  text: `Attendance: ${presentCount}/${totalCount}`,
                  font: { size: 16, weight: "bold" },
                  position: "bottom",
                },
                centerText: {
                  text: `${presentCount}/${totalCount}`,
                  color: primaryColor,
                },
              },
            },
            plugins: [centerTextPlugin],
          });

          // Apply language to chart labels
          const currentLang = localStorage.getItem("lang") || "en";
          const chart = Chart.getChart("dashboardAttendanceChart");
          if (chart) {
            chart.data.labels = chartData.labels.map((label) =>
              typeof label === "object" ? label[currentLang] || label.en : label
            );
            chart.update();
          }
        }, 100);
      }
    }

    // Load recent announcements for dashboard tile
    async function loadDashboardAnnouncements() {
      try {
        const res = await api.teacher.announcements.getReceived();
        if (!res.ok) throw new Error("Failed to fetch announcements");

        const announcements = await res.json();
        const announcementsList = document.getElementById("announcements-list");

        if (!announcements || announcements.length === 0) {
          const message = {
             en: "No announcements",
             si: "නිවේදන නැත",
             ta: "அறிவிப்புகள் இல்லை"
          };
          const lang = localStorage.getItem("lang") || "en";
          // Use empty-state-message component
          // Since it expects to live in a flex container for centering, we might want to clear list styles
          // But here we are appending to a UL. We should probably clear UL styling or just put it inside a LI wrapping it?
          // Actually, better to empty the UL and append this element directly if the CSS allows, 
          // OR replace UL content with this. 
          // Let's replace list content.
          announcementsList.innerHTML = `<empty-state-message message="${message[lang] || message.en}" icon="fas fa-bullhorn"></empty-state-message>`;
          return;
        }

        // Show only the first 4 announcements
        const recentAnnouncements = announcements.slice(0, 4);

        announcementsList.innerHTML = recentAnnouncements
          .map(
            (announcement) => `
            <li onclick="window.location.href='layout.html?role=teacher&page=announcements'" style="cursor: pointer;">
              <span class="subject-name">${announcement.title}</span>
            </li>
          `
          )
          .join("");

        // If there are more than 4 announcements, add a "View all" item
        if (announcements.length > 4) {
          const viewAllLi = document.createElement("li");
          viewAllLi.setAttribute(
            "onclick",
            "window.location.href='layout.html?role=teacher&page=announcements'"
          );
          viewAllLi.style.cssText =
            "cursor: pointer; border-top: 1px solid var(--color-border); margin-top: 8px; padding-top: 8px;";
          viewAllLi.innerHTML = `<span class="subject-name text-sm" data-en="View all announcements..." data-si="සියලුම නිවේදන බලන්න..." data-ta="அனைத்து அறிவிப்புகளையும் காண்க...">View all announcements...</span>`;
          announcementsList.appendChild(viewAllLi);
          // Apply current language
          if (typeof applyDirectLanguageAttributes === "function") {
            applyDirectLanguageAttributes(localStorage.getItem("lang") || "en");
          }
        }
      } catch (err) {
        console.error("Error loading announcements:", err);
        const announcementsList = document.getElementById("announcements-list");
        const errorLi = document.createElement("li");
        errorLi.className = "text-sm";
        errorLi.setAttribute("data-en", "Error loading announcements");
        errorLi.setAttribute("data-si", "නිවේදන පූරණය කිරීමේ දෝෂයක්");
        errorLi.setAttribute("data-ta", "அறிவிப்புகளை ஏற்றுவதில் பிழை");
        errorLi.textContent = "Error loading announcements";
        announcementsList.appendChild(errorLi);
        // Apply current language
        if (typeof applyDirectLanguageAttributes === "function") {
          applyDirectLanguageAttributes(localStorage.getItem("lang") || "en");
        }
      }
    }

    // Load recent todos for dashboard tile
    async function loadDashboardTodos() {
      try {
        const res = await api.teacher.todos.getAll();
        if (!res.ok) throw new Error("Failed to fetch todos");

        const allTodos = await res.json();
        // Filter only pending todos
        const todos = allTodos.filter((todo) => todo.status === "pending");
        const todosList = document.getElementById("dashboard-todos-list");

        if (!todos || todos.length === 0) {
          const message = {
             en: "No pending tasks",
             si: "අපේක්ෂිත කාර්යයන් නැත",
             ta: "நிலுவையில் உள்ள பணிகள் இல்லை"
          };
          const lang = localStorage.getItem("lang") || "en";
          todosList.innerHTML = `<empty-state-message message="${message[lang] || message.en}" icon="fas fa-tasks"></empty-state-message>`;
          return;
        }

        // Show only the first 4 pending todos
        const recentTodos = todos.slice(0, 4);

        todosList.innerHTML = recentTodos
          .map(
            (todo) => `
            <li onclick="window.location.href='layout.html?role=teacher&page=todo'" style="cursor: pointer;">
              <span class="subject-name">${todo.text}</span>
            </li>
          `
          )
          .join("");

        // If there are more than 4 pending todos, add a "View all" item
        if (todos.length > 4) {
          const viewAllLi = document.createElement("li");
          viewAllLi.setAttribute(
            "onclick",
            "window.location.href='layout.html?role=teacher&page=todo'"
          );
          viewAllLi.style.cssText =
            "cursor: pointer; border-top: 1px solid var(--color-border); margin-top: 8px; padding-top: 8px;";
          viewAllLi.innerHTML = `<span class="subject-name text-sm" data-en="View all tasks..." data-si="සියලුම කාර්යයන් බලන්න..." data-ta="அனைத்து பணிகளையும் காண்க...">View all tasks...</span>`;
          todosList.appendChild(viewAllLi);
          // Apply current language
          if (typeof applyDirectLanguageAttributes === "function") {
            applyDirectLanguageAttributes(localStorage.getItem("lang") || "en");
          }
        }
      } catch (err) {
        console.error("Error loading todos:", err);
        const todosList = document.getElementById("dashboard-todos-list");
        const errorLi = document.createElement("li");
        errorLi.className = "text-sm";
        errorLi.setAttribute("data-en", "Error loading tasks");
        errorLi.setAttribute("data-si", "කාර්යයන් පූරණය කිරීමේ දෝෂයක්");
        errorLi.setAttribute("data-ta", "பணிகளை ஏற்றுவதில் பிழை");
        errorLi.textContent = "Error loading tasks";
        todosList.appendChild(errorLi);
        // Apply current language
        if (typeof applyDirectLanguageAttributes === "function") {
          applyDirectLanguageAttributes(localStorage.getItem("lang") || "en");
        }
      }
    }

    // Load pending password reset requests
    async function loadPendingResets() {
      try {
        const response = await api.teacher.passwordResets.getPending();
        if (!response.ok) return;

        const resets = await response.json();
        const resetsList = document.getElementById("dashboard-resets-list");

        if (!resetsList) return;

        resetsList.innerHTML = "";

        if (resets.length === 0) {
          const message = {
             en: "No pending requests",
             si: "පිටුවිලි ඉල්ලීම් නැත",
             ta: "நிலுவையில் உள்ள கோரிக்கைகள் இல்லை"
          };
          const lang = localStorage.getItem("lang") || "en";
          resetsList.innerHTML = `<empty-state-message message="${message[lang] || message.en}" icon="fas fa-key"></empty-state-message>`;
          return;
        }

        resets.forEach((reset) => {
          const li = document.createElement("li");
          li.style.cssText =
            "padding: 12px; border-bottom: 1px solid var(--color-border); display: flex; justify-content: space-between; align-items: center;";
          li.innerHTML = `
            <div>
              <p class="subject-name" style="margin: 0; font-weight: 500;">${reset.username}</p>
              <p class="text-sm" style="margin: 4px 0 0 0; color: #666;">${reset.role}</p>
            </div>
            <div style="display: flex; gap: 8px;">
              <button onclick="approveReset(${reset.id})" class="btn btn-primary" >Approve</button>
              <button onclick="rejectReset(${reset.id})" class="btn btn-secondary" >Reject</button>
            </div>
          `;
          resetsList.appendChild(li);
        });

        if (typeof applyDirectLanguageAttributes === "function") {
          applyDirectLanguageAttributes(localStorage.getItem("lang") || "en");
        }
      } catch (err) {
        console.error("Error loading pending resets:", err);
      }
    }

    // Approve password reset
    async function approveReset(resetId) {
      try {
        const response = await api.teacher.passwordResets.approve(resetId);

        if (response.ok) {
          showToast("Password reset approved", "fa-solid fa-check");
          loadPendingResets();
        } else {
          showToast(
            "Failed to approve reset",
            "fa-solid fa-circle-exclamation"
          );
        }
      } catch (error) {
        console.error("Error approving reset:", error);
        showToast("Error approving reset", "fa-solid fa-circle-exclamation");
      }
    }

    // Reject password reset
    async function rejectReset(resetId) {
      try {
        const response = await api.teacher.passwordResets.reject(resetId);

        if (response.ok) {
          showToast("Password reset rejected", "fa-solid fa-check");
          loadPendingResets();
        } else {
          showToast("Failed to reject reset", "fa-solid fa-circle-exclamation");
        }
      } catch (error) {
        console.error("Error rejecting reset:", error);
        showToast("Error rejecting reset", "fa-solid fa-circle-exclamation");
      }
    }

    function showToast(message, icon) {
      if (typeof toast === "function") {
        toast(message, icon);
      } else {
        alert(message);
      }
    }

    // Get teacherId from backend and load timetable
    async function initDashboard() {
      await loadTodaysTimetable();
      loadDashboardAttendance();
      loadDashboardAnnouncements();
      loadDashboardTodos();
      loadPendingResets();
    }
    initDashboard();
  </script>

  <script src="../../js/components/EmptyStateMessage.js"></script>
</div>

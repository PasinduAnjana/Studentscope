<div class="card-grid">
  <!-- Greeting Tile -->
  <div class="card greeting-tile w-2">
    <div class="greeting-content">
      <h2 class="greeting-heading" data="teacher.greeting"></h2>
      <p class="greeting-subtext" data="teacher.greeting_2"></p>
    </div>
    <img
      src="/assets/images/teacher-clipart.svg"
      alt="Illustration"
      class="greeting-img"
    />
  </div>

  <!-- Today's Timetable -->
  <div class="card dashboard-tile w-1 h-2" id="todays-timetable">
    <div class="icon-title">
      <i class="fas fa-calendar-day icon"></i>
      <p class="tile-label" data="teacher.timetable"></p>
    </div>
    <div>
      <ul class="tile-list">
        <!-- Dynamic timetable entries will appear here -->
      </ul>
    </div>
  </div>

  <!-- Current Class -->
  <div class="card dashboard-tile" id="current-class">
    <div class="icon-title">
      <i class="fas fa-chalkboard icon"></i>
      <p class="tile-label" data="teacher.current_class"></p>
    </div>
    <div>
      <p class="title-primary" style="font-size: 32px" id="current-class-name">
        Grade 10-A
      </p>
      <h1 class="tile-value" style="font-size: 24px" id="current-subject-name">
        Math
      </h1>
      <p class="tile-subtext" id="current-time-range">08:00 AM – 08:45 AM</p>
    </div>
  </div>

  <!-- Attendance Status -->
  <div class="card dashboard-tile">
    <div class="icon-title">
      <i class="fas fa-clipboard-check icon"></i>
      <p class="tile-label" data="teacher.attendance"></p>
    </div>
    <div>
      <h3
        class="tile-value text-error"
        data="teacher.attendance_not_marked"
      ></h3>
      <button
        class="btn"
        onclick="window.location.href = 'layout.html?role=teacher&page=attendance'""
      >
        <i class="fas fa-user-check"></i>
        <span data="teacher.mark_attendance"></span>
      </button>
    </div>
  </div>

  <!-- Tasks -->
  <div class="card dashboard-tile flex-column">
    <div class="icon-title">
      <i class="fas fa-tasks icon"></i>
      <p class="tile-label">Pending Tasks</p>
    </div>
    <div>
      <ul class="tile-list">
        <li>Upload results</li>
        <li>Mark attendance</li>
      </ul>
    </div>
  </div>
</div>

<script>
  async function loadTodaysTimetable(teacherId) {
    try {
      // Hardcoded current time (24-hour format)
      const currentTime = "09:15";

      // Fetch timetable & time slots
      const timetableRes = await fetch(
        `/api/teacher/timetable/today/${teacherId}`
      );
      const timetable = await timetableRes.json();

      const timeRes = await fetch("/data/time.json");
      const timeSlots = await timeRes.json();

      const timetableList = document.querySelector(
        "#todays-timetable .tile-list"
      );
      timetableList.innerHTML = "";

      // Helper to parse "HH:MM" to minutes since midnight for comparison
      function timeToMinutes(t) {
        const [h, m] = t.split(":").map(Number);
        return h * 60 + m;
      }
      const currentMinutes = timeToMinutes(currentTime);

      let activeEntry = null;

      timetable.forEach((entry) => {
        const slotInfo = timeSlots.find((s) => s.slot === entry.slot);
        if (!slotInfo) return;

        // Get start and end times in minutes for current slot
        const startMinutes = timeToMinutes(slotInfo.start);
        const endMinutes = timeToMinutes(slotInfo.end);

        // Check if currentTime is inside this slot range
        const isActive =
          currentMinutes >= startMinutes && currentMinutes < endMinutes;

        // Build li element
        const li = document.createElement("li");
        if (isActive) {
          li.classList.add("active");
          activeEntry = { entry, slotInfo };
        }

        li.innerHTML = `
          <span class="slot-time">${slotInfo.start}</span>
          <span class="subject-name">${entry.subject}</span>
          <span class="class-name">${entry.grade} - ${entry.class_name}</span>
        `;

        timetableList.appendChild(li);
      });

      // Update current class tile with active slot info
      if (activeEntry) {
        document.getElementById(
          "current-class-name"
        ).textContent = `Grade ${activeEntry.entry.grade} - ${activeEntry.entry.class_name}`;
        document.getElementById("current-subject-name").textContent =
          activeEntry.entry.subject;
        document.getElementById(
          "current-time-range"
        ).textContent = `${activeEntry.slotInfo.start} – ${activeEntry.slotInfo.end}`;
      } else {
        // If no active slot, clear or set default text
        document.getElementById("current-class-name").textContent = "-";
        document.getElementById("current-subject-name").textContent =
          "No class now";
        document.getElementById("current-time-range").textContent = "";
      }
    } catch (err) {
      console.error("Error loading timetable:", err);
    }
  }

  // Load for teacher with ID 1 (replace as needed)
  loadTodaysTimetable(1);
</script>

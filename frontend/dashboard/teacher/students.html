<style>
  /* Modal Styles */
  /* Modal styles managed by ModalDialog component */

  /* Checkbox Styles */
  .checkbox-label {
    display: block;
    position: relative;
    padding-left: 35px;
    margin-bottom: 12px;
    cursor: pointer;
    font-size: 16px;
    user-select: none;
    color: var(--color-text);
  }

  .checkbox-label input {
    position: absolute;
    opacity: 0;
    cursor: pointer;
    height: 0;
    width: 0;
  }

  .checkmark {
    position: absolute;
    top: 0;
    left: 0;
    height: 20px;
    width: 20px;
    background-color: var(--color-bg);
    border: 2px solid var(--color-border);
    border-radius: 4px;
    transition: all 0.2s ease;
  }

  .checkbox-label:hover input ~ .checkmark {
    background-color: var(--color-primary-light);
  }

  .checkbox-label input:checked ~ .checkmark {
    background-color: var(--color-primary);
    border-color: var(--color-primary);
  }

  .checkbox-label input:checked ~ .checkmark:after {
    content: "";
    position: absolute;
    display: block;
    left: 6px;
    top: 2px;
    width: 6px;
    height: 10px;
    border: solid var(--color-white);
    border-width: 0 2px 2px 0;
    transform: rotate(45deg);
  }

  .export-fields {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 10px;
  }
</style>

<section class="section">
  <h2 class="heading">
    <i class="fas fa-users"></i>
    <span data="sidebar.students"></span>
  </h2>
  <div class="card students">
    <h1 class="title" data="sidebar.students"></h1>
    <data-table id="students-table">
        <div slot="filters" style="display: flex; gap: 10px; align-items: center; flex-wrap: wrap;">
            <div class="input-group" style="width: auto; min-width: 200px; margin-bottom: 0;">
                <select id="class-select" class="dropdown-select">
                    <option value="" data-en="Select Class" data-si="පන්තිය තෝරන්න" data-ta="வகுப்பைத் தேர்ந்தெடுக்கவும்">Select Class</option>
                </select>
            </div>
            <div class="input-group" style="width: auto; margin-bottom: 0;">
                <select id="gender-filter" class="dropdown-select">
                    <option value="" data-en="All Genders" data-si="සියලු ලිංග" data-ta="அனைத்து பாலினங்களும்">All Genders</option>
                    <option value="Male" data-en="Male" data-si="පුරුෂ" data-ta="ஆண்">Male</option>
                    <option value="Female" data-en="Female" data-si="ස්ත්‍රී" data-ta="பெண்">Female</option>
                </select>
            </div>
        </div>
    </data-table>
  </div>
</section>


<script>
  let allStudents = [];
  let selectedClassId = "";

  function initTable() {
    const table = document.getElementById("students-table");
    table.setColumns([
        { key: "full_name", header: "Name", searchable: true },
        { key: "index_number", header: "Index No", searchable: true },
        { key: "class_name", header: "Grade" },
        { 
            key: "birthday", 
            header: "Birthday",
            render: (row) => row.birthday ? new Date(row.birthday).toLocaleDateString() : ""
        },
        { key: "gender", header: "Gender" },
        { key: "nationality", header: "Nationality" },
        { key: "parent_name", header: "Parent Name", searchable: true },
        { key: "address", header: "Address" },
        { key: "parent_address", header: "Parent Address" }
    ]);
    table.setEmptyState("No students found in this class", "fas fa-user-graduate");

    // Add filters
    const classSelect = document.getElementById("class-select");
    const genderSelect = document.getElementById("gender-filter");

    if (classSelect) {
        classSelect.addEventListener("change", () => {
             // Fetch specific class data when class filter changes
             fetchStudents(classSelect.value);
        });
    }

    if (genderSelect) {
         genderSelect.addEventListener("change", () => {
             const val = genderSelect.value;
             table.addFilter("gender", (row) => {
                 return val === "" || row.gender === val;
             });
         });
    }
  }

  async function fetchStudents(classId) {
    if (!classId) return;
    const table = document.getElementById("students-table");
    
    // Show empty state while loading could be handled by component if it had loading state, 
    // or we just clear data.
    table.setData([]); 

    try {
      // Use API module
      const res = await api.teacher.students.getByClass(classId); // Using existing teacher endpoint or generic? teacher.students.getByClass matches previous logic: /api/teacher/students/class/:id
      if (!res.ok) throw new Error("Failed to fetch students");
      allStudents = await res.json();
      
      // Enrich data with class_name if needed, though they are all same class
      const className = document.getElementById("class-select").options[document.getElementById("class-select").selectedIndex]?.text || "";
      const enriched = allStudents.map(s => ({...s, class_name: className}));

      table.setData(enriched);
    } catch (err) {
      console.error(err);
      table.setEmptyState("Error loading students", "fas fa-exclamation-triangle");
      toast("Error loading students", "fa-solid fa-circle-exclamation");
    }
  }

  async function fetchClasses() {
    try {
      const res = await api.teacher.classes.getAll();
      if (!res.ok) throw new Error("Failed to fetch classes");
      const classes = await res.json();
      const classSelect = document.getElementById("class-select");
      classSelect.innerHTML = `<option value="" data-en="Select Class" data-si="පන්තිය තෝරන්න" data-ta="வகுப்பைத் தேர்ந்தெடுக்கவும்">Select Class</option>`;
      classes.forEach(cls => {
        const option = document.createElement("option");
        option.value = cls.id;
        option.textContent = `${cls.name} (Grade ${cls.grade})`;
        classSelect.appendChild(option);
      });

      // If a class is pre-selected (e.g., for class teachers), set it and fetch students
      if (selectedClassId) {
        classSelect.value = selectedClassId;
        fetchStudents(selectedClassId);
      }
    } catch (err) {
      console.error("Error fetching classes:", err);
      toast("Error loading classes", "fa-solid fa-circle-exclamation");
    }
  }

  // Initialize
  fetch("/api/auth/me")
    .then((res) => res.json())
    .then((user) => {
      if (user && user.is_class_teacher && user.class_id) {
        selectedClassId = String(user.class_id);
      }
      // Initial Load
      initTable();
      fetchClasses();
    })
    .catch((err) => {
      console.error("Error fetching user data:", err);
      // Still try to load classes and table even if user data fails
      initTable();
      fetchClasses();
    });

</script>

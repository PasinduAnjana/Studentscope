<section class="section">
  <h2 class="heading">
    <i class="fas fa-users"></i>
    <span data="sidebar.students"></span>
  </h2>
  <div class="card">
    <h1 class="title" data="sidebar.students"></h1>
    <!-- Search Bar and Class Dropdown -->
    <div
      class="flex mb-2"
      style="gap: 16px; align-items: flex-end; flex-wrap: wrap"
    >
      <div class="search-group" style="max-width: 350px">
        <input
          type="text"
          id="student-search"
          class="search-input"
          placeholder="Search students..."
        />
        <span class="search-icon"><i class="fas fa-search"></i></span>
      </div>
      <div class="input-group" style="min-width: 200px">
        <label for="class-select" style="margin-right: 8px; font-weight: 500"
          >Class:</label
        >
        <select id="class-select" class="dropdown-select">
          <option value="">All Classes</option>
        </select>
      </div>
    </div>
    <div class="table-responsive">
      <table id="student-table">
        <thead>
          <tr>
            <th data="table.name">Name</th>
            <th>Index No</th>
            <th>Grade</th>
            <th>Birthday</th>
            <th>Address</th>
            <th>Gender</th>
            <th>Nationality</th>
            <th>Parent Name</th>
            <th>Parent Address</th>
          </tr>
        </thead>
        <tbody>
          <!-- Students will be loaded here dynamically -->
        </tbody>
      </table>
    </div>
  </div>
</section>

<script>
  let allStudents = [];
  let allClasses = [];
  let selectedClassId = "";

  function renderStudents(filtered) {
    const tbody = document.querySelector("#student-table tbody");
    tbody.innerHTML = "";
    if (!filtered.length) {
      tbody.innerHTML = `<tr><td colspan="9" class="text-error">No students found</td></tr>`;
      return;
    }
    function formatDate(dateStr) {
      if (!dateStr) return "";
      const d = new Date(dateStr);
      if (isNaN(d)) return dateStr;
      return d.toLocaleDateString(undefined, {
        year: "numeric",
        month: "short",
        day: "2-digit",
      });
    }
    filtered.forEach((student) => {
      const row = document.createElement("tr");
      row.innerHTML = `
        <td>${student.full_name || student.name || ""}</td>
        <td>${student.index_number || ""}</td>
        <td>${student.grade ?? ""} - ${student.class_name ?? ""}</td>
        <td>${formatDate(student.birthday)}</td>
        <td>${student.address || ""}</td>
        <td>${student.gender || ""}</td>
        <td>${student.nationality || ""}</td>
        <td>${student.parent?.name || ""}</td>
        <td>${student.parent?.address || ""}</td>
      `;
      tbody.appendChild(row);
    });
  }

  function filterAndRender() {
    const q = (document.getElementById("student-search")?.value || "")
      .trim()
      .toLowerCase();
    const classId = selectedClassId;
    let filtered = allStudents;
    if (classId) {
      filtered = filtered.filter((s) => String(s.class_id) === String(classId));
    }
    if (q) {
      filtered = filtered.filter((student) => {
        return (
          (student.full_name && student.full_name.toLowerCase().includes(q)) ||
          (student.index_number &&
            student.index_number.toLowerCase().includes(q)) ||
          (student.grade && String(student.grade).toLowerCase().includes(q)) ||
          (student.class_name && student.class_name.toLowerCase().includes(q))
        );
      });
    }
    renderStudents(filtered);
  }

  function fetchStudents() {
    fetch("/api/teacher/students")
      .then((res) => {
        if (!res.ok) throw new Error(res.body || "Failed to fetch students");
        return res.json();
      })
      .then((data) => {
        allStudents = data;
        filterAndRender();
      })
      .catch((err) => {
        console.error(err);
        const tbody = document.querySelector("#student-table tbody");
        tbody.innerHTML = `<tr><td colspan="3" class="text-error">Error loading students</td></tr>`;
      });
  }

  function fetchClasses() {
    fetch("/api/teacher/classes")
      .then((res) => res.json())
      .then((classes) => {
        allClasses = classes;
        const classSelect = document.getElementById("class-select");
        classSelect.innerHTML = '<option value="">All Classes</option>';
        classes.forEach((cls) => {
          const option = document.createElement("option");
          option.value = cls.id;
          option.textContent = `${cls.name} (Grade ${cls.grade})`;
          classSelect.appendChild(option);
        });
        // Initialize searchable dropdown
        if (window.makeSearchableDropdown) {
          makeSearchableDropdown("class-select", (val) => {
            selectedClassId = val;
            filterAndRender();
          });
        } else {
          // fallback: normal select
          classSelect.addEventListener("change", function () {
            selectedClassId = this.value;
            filterAndRender();
          });
        }
      });
  }

  // Setup search input event
  function setupSearchInput() {
    const searchInput = document.getElementById("student-search");
    if (searchInput) {
      searchInput.addEventListener("input", filterAndRender);
    }
  }

  // On page load (after DOM inserted)
  fetch("/api/auth/me")
    .then((res) => res.json())
    .then((user) => {
      if (user && user.is_class_teacher && user.class_id) {
        selectedClassId = String(user.class_id);
      }
      fetchClasses();
      fetchStudents();
      setupSearchInput();
      // After classes are loaded, select the teacher's class if set
      const interval = setInterval(() => {
        const classSelect = document.getElementById("class-select");
        if (classSelect && selectedClassId && allClasses.length > 0) {
          classSelect.value = selectedClassId;
          filterAndRender();
          // Find the class object
          const myClass = allClasses.find(
            (c) => String(c.id) === String(selectedClassId)
          );

          // Optionally disable dropdown to prevent changing
          classSelect.disabled = true;
          clearInterval(interval);
        }
      }, 100);
    })
    .catch(() => {
      fetchClasses();
      fetchStudents();
      setupSearchInput();
    });
</script>

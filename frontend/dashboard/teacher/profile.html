<section class="section">
  <h2 class="heading">
    <i class="fas fa-user"></i>
    <span data="sidebar.profile"></span>
  </h2>

  <div class="card-grid">
    <!-- Profile Information -->
    <div class="card w-1 h-1 profile-card">
      <div class="profile-header">
        <div class="profile-avatar">
          <i class="fas fa-user-circle"></i>
        </div>
        <div class="profile-info">
          <h3 id="teacher-name">Loading...</h3>
          <p
            id="teacher-role"
            class="text-sm"
            data-en="Teacher"
            data-si="ගුරුවරයා"
            data-ta="ஆசிரியர்"
          >
            Teacher
          </p>
        </div>
      </div>

      <div class="profile-details">
        <div class="detail-row">
          <span class="detail-label" data="profile.username"></span>
          <span id="teacher-username">-</span>
        </div>
        <div class="detail-row">
          <span class="detail-label" data="profile.class"></span>
          <span id="teacher-class">-</span>
        </div>
        <div class="detail-row">
          <span class="detail-label" data="profile.classTeacher"></span>
          <span id="is-class-teacher">-</span>
        </div>
      </div>
    </div>

    <!-- Teacher Personal Details -->
    <div class="card w-1 h-1 profile-card">
      <div class="profile-header">
        <div class="profile-avatar">
          <i class="fas fa-id-card"></i>
        </div>
        <div class="profile-info">
          <h3 data="profile.personalDetails"></h3>
          <p class="text-sm" data="profile.informationContact"></p>
        </div>
      </div>

      <div class="profile-details">
        <div class="detail-row">
          <span class="detail-label" data="profile.fullName"></span>
          <span id="teacher-full-name">-</span>
        </div>
        <div class="detail-row">
          <span class="detail-label" data="profile.nic"></span>
          <span id="teacher-nic">-</span>
        </div>
        <div class="detail-row">
          <span class="detail-label" data="profile.birthday"></span>
          <span id="teacher-birthday">-</span>
        </div>
        <div class="detail-row">
          <span class="detail-label" data="profile.address"></span>
          <span id="teacher-address">-</span>
        </div>
        <div class="detail-row">
          <span class="detail-label" data="profile.phoneNumber"></span>
          <span id="teacher-phone">-</span>
        </div>
      </div>
    </div>

    <!-- Teacher Professional Details -->
    <div class="card w-1 h-1 profile-card">
      <div class="profile-header">
        <div class="profile-avatar">
          <i class="fas fa-briefcase"></i>
        </div>
        <div class="profile-info">
          <h3 data="profile.professionalDetails"></h3>
          <p class="text-sm" data="profile.experienceAppointment"></p>
        </div>
      </div>

      <div class="profile-details">
        <div class="detail-row">
          <span class="detail-label" data="profile.level"></span>
          <span id="teacher-level">-</span>
        </div>
        <div class="detail-row">
          <span class="detail-label" data="profile.firstAppointmentDate"></span>
          <span id="teacher-first-appointment">-</span>
        </div>
        <div class="detail-row">
          <span class="detail-label" data="profile.appointmentDate"></span>
          <span id="teacher-appointment">-</span>
        </div>
        <div class="detail-row">
          <span class="detail-label" data="profile.pastSchools"></span>
          <span id="teacher-past-schools">-</span>
        </div>
      </div>
    </div>

    <!-- Quick Stats -->
    <div class="card w-1 h-1 dashboard-tile">
      <div class="icon-title">
        <i class="fas fa-chart-bar icon"></i>
        <p class="tile-label" data="profile.quickStats"></p>
      </div>
      <div class="stats-content">
        <div class="stat-item">
          <div class="stat-icon">
            <i class="fas fa-chalkboard-teacher"></i>
          </div>
          <span class="stat-number" id="total-classes">-</span>
          <span class="stat-label" data="profile.classes"></span>
        </div>
        <div class="stat-item">
          <div class="stat-icon">
            <i class="fas fa-users"></i>
          </div>
          <span class="stat-number" id="total-students">-</span>
          <span class="stat-label" data="profile.students"></span>
        </div>
      </div>
    </div>

    <!-- Teaching Classes -->
    <div class="card w-1 h-1 dashboard-tile">
      <div class="icon-title">
        <i class="fas fa-chalkboard icon"></i>
        <p class="tile-label" data="profile.teachingClasses"></p>
      </div>
      <div id="classes-list">
        <p class="text-sm" data="profile.loadingClasses"></p>
      </div>
    </div>
  </div>
</section>

<script>
  async function loadProfile() {
    try {
      const response = await fetch("/api/teacher/profile");
      if (!response.ok) throw new Error("Failed to fetch profile");

      const profile = await response.json();

      // Update profile information
      const teacherNameElement = document.getElementById("teacher-name");
      teacherNameElement.textContent = profile.username;
      teacherNameElement.setAttribute("data-en", profile.username);
      teacherNameElement.setAttribute("data-si", profile.username);
      teacherNameElement.setAttribute("data-ta", profile.username);

      document.getElementById("teacher-username").textContent =
        profile.username;
      const teacherRoleElement = document.getElementById("teacher-role");
      teacherRoleElement.textContent =
        getNestedValue(window.currentTranslations, "profile.teacher") ||
        "Teacher";
      teacherRoleElement.setAttribute("data-en", "Teacher");
      teacherRoleElement.setAttribute("data-si", "ගුරුවරයා");
      teacherRoleElement.setAttribute("data-ta", "ஆசிரியர்");

      if (profile.class_name && profile.class_grade) {
        const teacherClassElement = document.getElementById("teacher-class");
        const classText = `Grade ${profile.class_grade} - ${profile.class_name}`;
        teacherClassElement.textContent = classText;
        teacherClassElement.setAttribute("data-en", classText);
        teacherClassElement.setAttribute("data-si", classText);
        teacherClassElement.setAttribute("data-ta", classText);
      } else {
        const teacherClassElement = document.getElementById("teacher-class");
        const notAssignedText =
          getNestedValue(window.currentTranslations, "profile.notAssigned") ||
          "Not assigned";
        teacherClassElement.textContent = notAssignedText;
        teacherClassElement.setAttribute("data-en", "Not assigned");
        teacherClassElement.setAttribute("data-si", "පවරා නොමැත");
        teacherClassElement.setAttribute("data-ta", "ஒதுக்கப்படவில்லை");
      }

      const isClassTeacherElement = document.getElementById("is-class-teacher");
      const isClassTeacher = profile.is_class_teacher
        ? getNestedValue(window.currentTranslations, "profile.yes") || "Yes"
        : getNestedValue(window.currentTranslations, "profile.no") || "No";
      isClassTeacherElement.textContent = isClassTeacher;
      if (profile.is_class_teacher) {
        isClassTeacherElement.setAttribute("data-en", "Yes");
        isClassTeacherElement.setAttribute("data-si", "ඔව්");
        isClassTeacherElement.setAttribute("data-ta", "ஆம்");
      } else {
        isClassTeacherElement.setAttribute("data-en", "No");
        isClassTeacherElement.setAttribute("data-si", "නැත");
        isClassTeacherElement.setAttribute("data-ta", "இல்லை");
      }

      // Update teacher details if available
      if (profile.details) {
        const details = profile.details;

        // Personal Details
        document.getElementById("teacher-full-name").textContent =
          details.full_name || "-";
        document.getElementById("teacher-nic").textContent = details.nic || "-";
        document.getElementById("teacher-birthday").textContent =
          details.birthday
            ? new Date(details.birthday).toLocaleDateString()
            : "-";
        document.getElementById("teacher-address").textContent =
          details.address || "-";
        document.getElementById("teacher-phone").textContent =
          details.phone_number || "-";

        // Professional Details
        document.getElementById("teacher-level").textContent =
          details.level || "-";
        document.getElementById("teacher-first-appointment").textContent =
          details.first_appointment_date
            ? new Date(details.first_appointment_date).toLocaleDateString()
            : "-";
        document.getElementById("teacher-appointment").textContent =
          details.appointment_date
            ? new Date(details.appointment_date).toLocaleDateString()
            : "-";
        document.getElementById("teacher-past-schools").textContent =
          details.past_schools || "-";
      }

      // Load additional stats
      await loadProfileStats(profile);
    } catch (error) {
      console.error("Error loading profile:", error);
      const teacherNameElement = document.getElementById("teacher-name");
      teacherNameElement.textContent = "Error loading profile";
      teacherNameElement.setAttribute("data-en", "Error loading profile");
      teacherNameElement.setAttribute("data-si", "පැතිකඩ පූරණය කිරීමේ දෝෂයක්");
      teacherNameElement.setAttribute("data-ta", "சுயவிவரத்தை ஏற்றுவதில் பிழை");
    }
  }

  async function loadProfileStats(profile) {
    try {
      // Load teaching classes
      const classesResponse = await fetch("/api/teacher/profile/classes");
      if (classesResponse.ok) {
        const classes = await classesResponse.json();
        const classesList = document.getElementById("classes-list");

        if (classes && classes.length > 0) {
          classesList.innerHTML = `
            <ul class="tile-list">
              ${classes
                .map(
                  (classItem) => `
                  <li>
                    <i class="fas fa-graduation-cap"></i>
                    <span>Grade ${classItem.grade} - ${classItem.name}</span>
                  </li>
                `
                )
                .join("")}
            </ul>
          `;
        } else {
          const noClassesElement = document.createElement("p");
          noClassesElement.className = "text-sm";
          noClassesElement.textContent =
            getNestedValue(
              window.currentTranslations,
              "profile.noClassesAssigned"
            ) || "No classes assigned";
          noClassesElement.setAttribute("data-en", "No classes assigned");
          noClassesElement.setAttribute("data-si", "පන්ති කිසිවක් පවරා නොමැත");
          noClassesElement.setAttribute(
            "data-ta",
            "வகுப்புகள் ஒதுக்கப்படவில்லை"
          );
          classesList.appendChild(noClassesElement);
        }

        // Load classes count
        document.getElementById("total-classes").textContent = classes
          ? classes.length
          : "0";
      } else {
        // Load classes count if API fails
        document.getElementById("total-classes").textContent = "0";
      }

      // Load students count for the class
      if (profile.class_id) {
        const studentsResponse = await fetch(
          `/api/teacher/students/class/${profile.class_id}`
        );
        if (studentsResponse.ok) {
          const students = await studentsResponse.json();
          document.getElementById("total-students").textContent =
            students.length;
        }
      } else {
        document.getElementById("total-students").textContent = "0";
      }
    } catch (error) {
      console.error("Error loading profile stats:", error);
    }
  }

  // Initialize
  loadProfile();
</script>

<h2 class="heading">
  <i class="fas fa-pen"></i>
  <span
    id="pageTitle"
    data-en="Enter Marks"
    data-si="ලකුණු ඇතුල් කරන්න"
    data-ta="மதிப்பெண்கள் உள்ளிடுக"
    >Enter Marks</span
  >

</h2>

<div class="marks-entry">
  <div class="marks-entry-header">
    <div id="classInfo">
      <!-- Class/subject info will be populated here -->
    </div>
    <div class="exam-selector">
      <div class="input-group">
        <label data-en="Exam:" data-si="පරීක්ෂණය:" data-ta="தேர்வு:"
          >Exam:</label
        >
        <div class="searchable-select" id="examDropdown">
          <div class="dropdown-display">
            <span
              id="selectedExam"
              data-en="Select Exam Type"
              data-si="පරීක්ෂණ වර්ගය තෝරන්න"
              data-ta="தேர்வு வகையைத் தேர்ந்தெடுக்கவும்"
              >Select Exam Type</span
            >
            <i class="fas fa-chevron-down dropdown-arrow"></i>
          </div>
          <div class="dropdown-list" style="display: none">
            <input
              type="text"
              class="dropdown-search"
              placeholder="Search exam type..."
              data-en="Search exam type..."
              data-si="පරීක්ෂණ වර්ගය සොයන්න..."
              data-ta="தேர்வு வகையைத் தேடு..."
            />
            <div class="dropdown-options" id="examOptions">
              <!-- Options populated via JS -->
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="marks-table-container">
    <table class="marks-table">
      <!-- Will be populated dynamically -->
    </table>
  </div>

  <div class="action-buttons">

    <button
      type="button"
      class="btn-primary"
      id="submitBtn"
      data-en="Submit"
      data-si="ඉදිරිපත් කරන්න"
      data-ta="சமர்ப்பிக்கவும்"
    >
      Submit
    </button>
  </div>
</div>

<script>
  const urlParams = new URLSearchParams(window.location.search);
  const className = urlParams.get("class");
  const subject = urlParams.get("subject");
  const type = urlParams.get("type");
  let students = [],
    subjects = [],
    classInfo = {},
    classId = null;

  async function getClassId(className) {
    try {
      const response = await api.teacher.classes.getAll();
      const classes = await response.json();
      const classObj = classes.find((c) => `${c.grade}${c.name}` === className);
      return classObj ? classObj.id : null;
    } catch (err) {
      console.error("Error getting class ID:", err);
      return null;
    }
  }

  async function loadData() {
    try {
      // Get class ID from class name
      classId = await getClassId(className);
      if (!classId) {
        console.error("Class not found:", className);
        return;
      }

      // Helper function to handle API responses
      const handleResponse = async (response) => {
        if (!response.ok) {
          throw new Error(
            `API error: ${response.status} ${response.statusText}`
          );
        }
        return response.json();
      };

      // Get subjects based on teacher type
      let subjectsPromise;
      if (type === "class_teacher") {
        subjectsPromise = api.teacher.classes
          .getAllSubjects(classId)
          .then(handleResponse);
      } else {
        subjectsPromise = api.teacher.classes
          .getTeacherSubjects(classId)
          .then(handleResponse);
      }

      [students, subjects, classInfo] = await Promise.all([
        api.teacher.students.getByClass(classId).then(handleResponse),
        subjectsPromise,
        api.teacher.classes.getInfo(classId).then(handleResponse),
      ]);

      setupPage();
      renderTable();
    } catch (err) {
      console.error("Error loading data:", err);
      // Set default empty values to prevent further errors
      students = [];
      subjects = [];
      classInfo = {};
    }
  }

  function setupPage() {
    const infoDiv = document.getElementById("classInfo");
    const pageTitle = document.getElementById("pageTitle");

    if (type === "class_teacher") {
      pageTitle.textContent = `Enter Marks - Class ${className}`;
      infoDiv.innerHTML = `
        <h3>Class ${className}</h3>
        <p>Class Teacher - All Subjects</p>
      `;
    } else {
      pageTitle.textContent = `Enter Marks - Class ${className} ${subject}`;
      infoDiv.innerHTML = `
        <h3>Class ${className}</h3>
        <p>Subject Teacher - ${subject}</p>
      `;
    }
  }

  function renderTable() {
    const table = document.querySelector(".marks-table");
    // Students are already filtered by class from the API
    const classStudents = students;

    // Subjects are already filtered based on teacher type in loadData
    const tableSubjects = subjects;

    // Create header row
    const headerRow = document.createElement("tr");
    headerRow.innerHTML = `
      <th data-en="Index No" data-si="දර්ශක අංකය" data-ta="குறியீட்டு எண்">Index No</th>
      <th data-en="Name" data-si="නම" data-ta="பெயர்">Name</th>
      ${tableSubjects.map((s) => `<th>${s.name}</th>`).join("")}
    `;
    table.innerHTML = "";
    table.appendChild(headerRow);

    // Create student rows
    classStudents.forEach((student) => {
      const row = document.createElement("tr");
      row.innerHTML = `
        <td>${student.index_number}</td>
        <td class="student-name">${student.full_name}</td>
        ${tableSubjects
          .map(
            (s) => `
          <td>
            <input type="number" 
              class="mark-input" 
              min="0" 
              max="100"
              data-student="${student.id}"
              data-subject="${s.id}"
            />
          </td>
        `
          )
          .join("")}
      `;
      table.appendChild(row);
    });

    addInputHighlighting();
    limitMarks();
    enableArrowNavigation();
  }

  function limitMarks() {
    document.querySelectorAll(".mark-input").forEach((input) => {
      input.addEventListener("input", (e) => {
        let val = input.value;
        // Remove non-digits
        val = val.replace(/\D/g, "");
        // Prevent value > 100
        if (parseInt(val) > 100) {
          val = val.slice(0, -1);
        }
        input.value = val;
      });
    });
  }

  function enableArrowNavigation() {
    const table = document.querySelector(".marks-table");
    
    table.addEventListener("keydown", (e) => {
      // Only handle arrow keys on inputs
      if (!e.target.classList.contains("mark-input")) return;
      if (!["ArrowUp", "ArrowDown", "ArrowLeft", "ArrowRight"].includes(e.key)) return;

      e.preventDefault();
      
      const currentInput = e.target;
      const currentCell = currentInput.closest("td");
      const currentRow = currentCell.closest("tr");
      
      const rows = Array.from(table.rows);
      // Skip header row (index 0)
      const currentRowIndex = rows.indexOf(currentRow);
      
      const cells = Array.from(currentRow.children);
      const currentCellIndex = cells.indexOf(currentCell);

      let targetRowIndex = currentRowIndex;
      let targetCellIndex = currentCellIndex;

      switch(e.key) {
        case "ArrowUp":
          targetRowIndex = Math.max(1, currentRowIndex - 1);
          break;
        case "ArrowDown":
          targetRowIndex = Math.min(rows.length - 1, currentRowIndex + 1);
          break;
        case "ArrowLeft":
          // Find previous input cell
          targetCellIndex = Math.max(2, currentCellIndex - 1); // Skip index(0) and name(1)
          break;
        case "ArrowRight":
           // Find next input cell
          targetCellIndex = Math.min(cells.length - 1, currentCellIndex + 1);
          break;
      }

      // If we are moving horizontally and hit a non-input cell (like name), adjust
      if (targetCellIndex < 2) targetCellIndex = 2;

      const targetRow = rows[targetRowIndex];
      const targetCell = targetRow.children[targetCellIndex];
      const targetInput = targetCell.querySelector(".mark-input");

      if (targetInput) {
        targetInput.focus();
        targetInput.select(); // Select content for easy overwriting
      }
    });
  }

  async function loadMarks(examId) {
    if (!classId || !subjects.length || !examId) return;

    try {
      // Clear current inputs
      document.querySelectorAll(".mark-input").forEach(input => input.value = "");

      // For each subject, fetch marks
      for (const subject of subjects) {
        const response = await api.teacher.marks.get(classId, subject.id, examId);
        if (response.ok) {
          const marks = await response.json();
          // Populate inputs
          marks.forEach(record => {
            const input = document.querySelector(`.mark-input[data-student="${record.student_id}"][data-subject="${subject.id}"]`);
            if (input) {
              input.value = record.marks;
            }
          });
        }
      }
    } catch (err) {
      console.error("Error loading marks:", err);
      const messages = {
        en: "Error loading marks",
        si: "ලකුණු ලබා ගැනීමේ දෝෂයක්",
        ta: "மதிப்பெண்களை ஏற்றுவதில் பிழை",
      };
      toast(messages[getLang()] || messages.en, "fas fa-exclamation-circle");
    }
  }

  function addInputHighlighting() {
    const table = document.querySelector(".marks-table");
    table.addEventListener("focusin", (e) => {
      if (e.target.classList.contains("mark-input")) {
        const input = e.target;

        // Clear old highlights
        table
          .querySelectorAll(".highlight-student, .highlight-subject")
          .forEach((el) =>
            el.classList.remove("highlight-student", "highlight-subject")
          );

        // Highlight student name
        const row = input.closest("tr");
        const studentNameCell = row.querySelector(".student-name");
        if (studentNameCell) studentNameCell.classList.add("highlight-student");

        // Highlight subject header
        const cell = input.closest("td");
        const colIndex = Array.from(cell.parentNode.children).indexOf(cell);
        const headerCell = table.querySelector(
          `tr:first-child th:nth-child(${colIndex + 1})`
        );
        if (headerCell) headerCell.classList.add("highlight-subject");
      }
    });

    table.addEventListener("focusout", (e) => {
      if (e.target.classList.contains("mark-input")) {
        setTimeout(() => {
          if (!table.contains(document.activeElement)) {
            table
              .querySelectorAll(".highlight-student, .highlight-subject")
              .forEach((el) =>
                el.classList.remove("highlight-student", "highlight-subject")
              );
          }
        }, 50);
      }
    });
  }

  async function initExamDropdown() {
    const container = document.querySelector("#examDropdown");
    const display = container.querySelector(".dropdown-display");
    const list = container.querySelector(".dropdown-list");
    const search = container.querySelector(".dropdown-search");
    const options = container.querySelector(".dropdown-options");
    const arrow = container.querySelector(".dropdown-arrow");
    const span = container.querySelector("#selectedExam");
    let selectedValue = "";

    // Load exams from API
    try {
      const response = await api.teacher.exams.getAll(); // We need to add this to api wrapper or calls fetch directly
      if(!response.ok) throw new Error("Failed to load exams");
      const exams = await response.json();
      
      options.innerHTML = exams.map(exam => `
        <div class="dropdown-item" data-value="${exam.id}">${exam.name}</div>
      `).join('');
    } catch(err) {
      console.error("Error loading exams:", err);
      // Fallback or explicit fetch if api wrapper isn't updated
      try {
          const res = await fetch('/api/teacher/exams', { headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }});
          const exams = await res.json();
          options.innerHTML = exams.map(exam => `
            <div class="dropdown-item" data-value="${exam.id}">${exam.name}</div>
          `).join('');
      } catch(e) { console.error("Double fail", e); }
    }


    // Toggle dropdown
    display.addEventListener("click", () => {
      const isOpen = list.style.display === "block";
      list.style.display = isOpen ? "none" : "block";
      arrow.classList.toggle("open", !isOpen);
      if (!isOpen) {
        search.focus();
      }
    });

    // Handle search
    search.addEventListener("input", (e) => {
      const value = e.target.value.toLowerCase();
      const items = options.querySelectorAll(".dropdown-item");

      items.forEach((item) => {
        const text = item.textContent.toLowerCase();
        item.style.display = text.includes(value) ? "" : "none";
      });
    });

    // Handle item selection
    options.addEventListener("click", (e) => {
      const item = e.target.closest(".dropdown-item");
      if (item) {
        selectedValue = item.dataset.value;
        span.textContent = item.textContent;
        span.dataset.selectedId = selectedValue; // Store ID
        list.style.display = "none";
        arrow.classList.remove("open");
        
        // Load marks for this exam
        loadMarks(selectedValue);
      }
    });

    // Close dropdown when clicking outside
    document.addEventListener("click", (e) => {
      if (!container.contains(e.target)) {
        list.style.display = "none";
        arrow.classList.remove("open");
      }
    });
  }



  function submitMarks() {
    const table = document.querySelector(".marks-table");
    const selectedExamId = document.querySelector("#selectedExam").dataset.selectedId;

    if (!selectedExamId) {
      const messages = {
        en: "Please select an exam first",
        si: "කරුණාකර පළමුව පරීක්ෂණයක් තෝරන්න",
        ta: "முதலில் ஒரு தேர்வைத் தேர்ந்தெடுக்கவும்",
      };
      alert(messages[getLang()] || messages.en);
      return;
    }

    const inputs = table.querySelectorAll(".mark-input");
    const data = Array.from(inputs).map((input) => ({
      student_id: input.dataset.student,
      subject_id: input.dataset.subject,
      mark: input.value ? parseInt(input.value) : null,
      exam_id: selectedExamId,
    }));

    const confirmMessages = {
      en: "Are you sure you want to submit marks?",
      si: "ලකුණු ඉදිරිපත් කිරීමට ඔබට විශ්වාසද?",
      ta: "மதிப்பெண்களைச் சமர்ப்பிக்க விரும்புகிறீர்களா?",
    };

    toast(
      confirmMessages[getLang()] || confirmMessages.en,
      "fas fa-question-circle",
      {
        confirm: true,
        center: true,
        onConfirm: () => {
          // Send to backend
          api.teacher.marks
            .save(data)
            .then((response) => {
              if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
              }
              return response.json();
            })
            .then((result) => {
              console.log("Marks submitted:", result);
              const messages = {
                en: "Submitted",
                si: "ඉදිරිපත් කරන ලදී",
                ta: "சமர்ப்பிக்கப்பட்டது",
              };
              toast(messages[getLang()] || messages.en, "fas fa-check-circle");
            })
            .catch((err) => {
              console.error("Error submitting marks:", err);
              const messages = {
                en: "Error submitting marks",
                si: "ලකුණු ඉදිරිපත් කිරීමේ දෝෂයක්",
                ta: "மதிப்பெண்களை சமர்ப்பிப்பதில் பிழை",
              };
              toast(messages[getLang()] || messages.en, "fas fa-exclamation-triangle");
            });
        }
      }
    );
  }

  // Get current language safely
  function getLang() {
    return window.currentLanguage || 'en';
  }

  // Initialize
  loadData();
  initExamDropdown();
  
  // Attach event listeners
  document.getElementById("submitBtn").addEventListener("click", submitMarks);
</script>

<h2 class="heading"><i class="fas fa-user-check"></i> Mark Attendance</h2>

<div class="attendance-container" id="attendanceContainer"></div>

<div class="actions" id="paginationControls">
  <button class="btn" id="backBtn" onclick="prevPage()" disabled>
    <i class="fas fa-arrow-left"></i> Back
  </button>
  <button class="btn" id="nextBtn" onclick="nextPage()">
    Next <i class="fas fa-arrow-right"></i>
  </button>
</div>

<script>
  let students = [];
  const studentsPerPage = 10;
  let currentPage = 1;
  let currentClassId = null;
  let selectedDate = null; // YYYY-MM-DD

  function getSelectedDate() {
    const params = new URLSearchParams(window.location.search);
    const dateParam = params.get("date");
    const today = new Date();
    const yyyy = today.getFullYear();
    const mm = String(today.getMonth() + 1).padStart(2, "0");
    const dd = String(today.getDate()).padStart(2, "0");
    const todayStr = `${yyyy}-${mm}-${dd}`;
    if (dateParam && /^\d{4}-\d{2}-\d{2}$/.test(dateParam)) return dateParam;
    return todayStr;
  }

  async function loadTeacherAndStudents() {
    try {
      // 1) Get logged-in user (teacher) info
      const meRes = await fetch("/api/auth/me", { credentials: "include" });
      if (meRes.status === 401) {
        toast(
          "Your session has expired. Please log in again.",
          "fa-solid fa-circle-exclamation"
        );
        window.location.href = "/login.html";
        return;
      }
      if (!meRes.ok) throw new Error("Failed to load user info");

      const me = await meRes.json();
      if (me.role !== "teacher") {
        renderMessage(
          "Only teachers can mark attendance. Please log in as a teacher."
        );
        return;
      }

      if (!me.class_id) {
        renderMessage(
          "No class is assigned to your account. Contact the administrator."
        );
        return;
      }

      currentClassId = me.class_id;

      // 2) Load students for the teacher's class
      const stuRes = await fetch(
        `/api/teacher/students/class/${currentClassId}`,
        { credentials: "include" }
      );
      if (!stuRes.ok) throw new Error("Failed to load students for class");

      const data = await stuRes.json();
      students = (Array.isArray(data) ? data : []).map((s) => ({
        id: s.id,
        name: s.full_name,
        index: s.index_number || `STU${String(s.id).padStart(4, "0")}`,
        status: null,
      }));

      if (students.length === 0) {
        renderMessage("No students found for your class.");
        return;
      }

      // Determine date to load and then preload existing attendance
      selectedDate = getSelectedDate();
      await preloadAttendance(selectedDate);
      renderStudents();
    } catch (err) {
      console.error(err);
      renderMessage("An error occurred while loading data.");
    }
  }

  function renderMessage(message) {
    const container = document.getElementById("attendanceContainer");
    container.innerHTML = `<div class="card">${message}</div>`;
    // Disable Next if there are no students
    const nextBtn = document.getElementById("nextBtn");
    nextBtn.disabled = true;
  }

  function renderStudents() {
    const container = document.getElementById("attendanceContainer");
    container.innerHTML = "";

    const start = (currentPage - 1) * studentsPerPage;
    const end = start + studentsPerPage;
    const currentStudents = students.slice(start, end);

    currentStudents.forEach((student) => {
      const row = document.createElement("div");
      row.classList.add("student-row", "slot-card");
      if (student.status) row.classList.add(student.status);

      console.log(student);

      const info = document.createElement("div");
      info.classList.add("student-info");
      // Use full_name if available, fallback to name or index_number
      const displayName =
        student.full_name ||
        student.name ||
        student.index ||
        student.index_number ||
        "Unnamed";
      info.innerHTML = `<strong>${displayName}</strong> <small>(${
        student.index || student.index_number || ""
      })</small>`;

      const actions = document.createElement("div");
      actions.classList.add("attendance-actions");

      const presentBtn = document.createElement("button");
      presentBtn.classList.add("btn", "btn-present");
      presentBtn.innerHTML = '<i class="fas fa-check"></i> Present';
      presentBtn.onclick = () => {
        student.status = "present";
        renderStudents(); // refresh row
      };

      const absentBtn = document.createElement("button");
      absentBtn.classList.add("btn", "btn-absent");
      absentBtn.innerHTML = '<i class="fas fa-times"></i> Absent';
      absentBtn.onclick = () => {
        student.status = "absent";
        renderStudents(); // refresh row
      };

      actions.appendChild(presentBtn);
      actions.appendChild(absentBtn);

      row.appendChild(info);
      row.appendChild(actions);
      container.appendChild(row);
    });

    updatePagination();
  }

  function updatePagination() {
    const backBtn = document.getElementById("backBtn");
    const nextBtn = document.getElementById("nextBtn");

    backBtn.disabled = currentPage === 1;

    if (currentPage * studentsPerPage >= students.length) {
      nextBtn.innerHTML = '<i class="fas fa-upload"></i> Submit';
      nextBtn.onclick = submitAttendance;
    } else {
      nextBtn.innerHTML = 'Next <i class="fas fa-arrow-right"></i>';
      nextBtn.onclick = nextPage;
    }
  }

  async function preloadAttendance(dateStr) {
    try {
      const res = await fetch(
        `/api/teacher/attendance?date=${encodeURIComponent(dateStr)}`,
        {
          credentials: "include",
        }
      );
      if (!res.ok) return; // silently skip if none
      const records = await res.json();
      const map = new Map(records.map((r) => [r.student_id, r.status]));
      students = students.map((s) => {
        if (map.has(s.id)) {
          const isPresent = !!map.get(s.id);
          return { ...s, status: isPresent ? "present" : "absent" };
        }
        return s;
      });
    } catch (e) {
      console.error("Failed to preload attendance:", e);
    }
  }

  function prevPage() {
    if (currentPage > 1) {
      currentPage--;
      renderStudents();
    }
  }

  function nextPage() {
    if (currentPage * studentsPerPage < students.length) {
      currentPage++;
      renderStudents();
    }
  }

  function submitAttendance() {
    // Prepare payload: selected date and records
    const dateStr = selectedDate || getSelectedDate();
    const records = students.map((s) => ({
      student_id: s.id,
      status: s.status === "present" ? true : false,
    }));

    // Show confirmation toast before submitting
    toast("Are you sure you want to submit attendance?", "fa-solid fa-upload", {
      confirm: true,
      confirmText: "Submit",
      cancelText: "Cancel",
      onConfirm: function () {
        fetch("/api/teacher/attendance", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          credentials: "include",
          body: JSON.stringify({ date: dateStr, records }),
        })
          .then((res) => {
            if (!res.ok) throw new Error("Failed to save attendance");
            return res.json();
          })
          .then(() => {
            localStorage.setItem("attendanceMarked", "true");
            toast("Attendance submitted", "fa-solid fa-check-circle");
            setTimeout(function () {
              window.location.href = "layout.html?role=teacher&page=attendance";
            }, 2000);
          })
          .catch((err) => {
            console.error(err);
            toast(
              "Error saving attendance. Please try again.",
              "fa-solid fa-circle-exclamation"
            );
          });
      },
      onCancel: function () {
        // Do nothing, just close toast
      },
    });
  }

  // Kick off loading from backend
  loadTeacherAndStudents();
</script>

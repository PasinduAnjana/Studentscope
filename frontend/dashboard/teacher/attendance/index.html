<h2 class="heading">
  <i class="fas fa-user-check"></i>
  <span data="sidebar.attendance"></span>
</h2>

<div class="card-grid">
  <!-- Today's Attendance -->
  <div class="card w-1 h-2 dashboard-tile" id="attendanceSummary">
    <div class="icon-title">
      <i class="fas fa-clipboard-check icon"></i>
      <p class="tile-label" data="teacher.todayAttendance"></p>
    </div>
    <canvas id="attendanceChart" height="150"></canvas>
  </div>

  <!-- Mark/Edit Attendance Card -->
  <div class="card w-1 h-1 dashboard-tile" id="attendanceActionCard">
    <div class="icon-title">
      <i class="fas fa-user-check icon"></i>
      <p class="tile-label" data="teacher.attendanceAction"></p>
    </div>
    <div>
      <h3 class="tile-value" id="attendanceActionText"></h3>
      <button class="btn" id="attendanceActionBtn">
        <i class="fas fa-pen"></i>
        <span id="attendanceActionBtnText"></span>
      </button>
      <!-- delete attendance -->
      <button class="btn btn-danger" id="deleteAttendanceBtn" onclick="deleteAttendance()">
        <i class="fas fa-trash"></i>
        <span data="teacher.deleteAttendanceBtn"></span>
      </button>
    </div>
  </div>

  <!-- Weekly Attendance -->
  <div class="card w-1 h-1 dashboard-tile">
    <div class="icon-title">
      <i class="fas fa-calendar-week icon"></i>
      <p class="tile-label" data="teacher.weeklyAttendance"></p>
    </div>
    <canvas id="weeklyChart" height="150"></canvas>
  </div>

  <!-- Monthly Attendance -->
  <div class="card w-2 h-1 dashboard-tile">
    <div class="icon-title">
      <i class="fas fa-calendar-alt icon"></i>
      <p class="tile-label" data="teacher.monthlyAttendance"></p>
    </div>
    <canvas id="monthlyChart" height="150"></canvas>
  </div>
</div>

<script>
  const rootStyles = getComputedStyle(document.documentElement);
  const primaryColor = rootStyles.getPropertyValue("--color-primary").trim();
  const secondaryColor = rootStyles.getPropertyValue("--color-border").trim();

  // --- Attendance Action Card ---
  const actionText = document.getElementById("attendanceActionText");
  const actionBtn = document.getElementById("attendanceActionBtn");
  const actionBtnText = document.getElementById("attendanceActionBtnText");

  // Get today's date in YYYY-MM-DD
  function getTodayStr() {
    const today = new Date();
    const yyyy = today.getFullYear();
    const mm = String(today.getMonth() + 1).padStart(2, "0");
    const dd = String(today.getDate()).padStart(2, "0");
    return `${yyyy}-${mm}-${dd}`;
  }

  // Get the dates for the current week (Mon-Fri)
  function getWeekDates() {
    const today = new Date();
    const monday = new Date(today);
    monday.setDate(today.getDate() - today.getDay() + 1); // Monday
    const dates = [];
    for (let i = 0; i < 5; i++) {
      const date = new Date(monday);
      date.setDate(monday.getDate() + i);
      dates.push(date.toISOString().split("T")[0]);
    }
    return dates;
  }

  // Get the dates for the current month
  function getMonthDates() {
    const today = new Date();
    const year = today.getFullYear();
    const month = today.getMonth();
    const daysInMonth = new Date(year, month + 1, 0).getDate();
    const dates = [];
    for (let day = 1; day <= daysInMonth; day++) {
      const date = new Date(year, month, day);
      dates.push(date.toISOString().split("T")[0]);
    }
    return dates;
  }

  async function loadTodayAttendance() {
    // Show loaders and get hide functions
    const hideTodayLoader = loader("attendanceSummary");
    const hideWeeklyLoader = loader(document.querySelector(".card.w-1.h-1.dashboard-tile:nth-child(3)"));
    const hideMonthlyLoader = loader(document.querySelector(".card.w-2.h-1.dashboard-tile"));

    const dateStr = getTodayStr();
    let presentCount = 0;
    let absentCount = 0;
    let totalCount = 0;
    let totalStudents = 0;
    let attendanceMarked = false;
    let attendanceRecords = [];
    // Get current class ID from backend (using attendance API response)
    let classId = null;
    try {
      // Try to get classId from attendance records if available
      const res = await api.teacher.attendance.getByDate(dateStr);
      if (res.ok) {
        const data = await res.json();
        if (Array.isArray(data) && data.length > 0) {
          attendanceMarked = true;
          attendanceRecords = data;
          presentCount = data.filter(
            (r) => r.status === true || r.status === "present" || r.status === 1
          ).length;
          absentCount = data.filter(
            (r) => r.status === false || r.status === "absent" || r.status === 0
          ).length;
          totalCount = data.length;
          // Try to get classId from first record
          if (data[0].class_id) classId = data[0].class_id;
        }
      }
      // If attendance not marked, get classId from user info endpoint
      if (!classId) {
        try {
          const userRes = await api.auth.me();
          if (userRes.ok) {
            const userData = await userRes.json();
            if (userData && userData.class_id) classId = userData.class_id;
          }
        } catch (err) {
          // ignore error
        }
      }
      // Get students for the current class
      if (classId) {
        try {
          const studentsRes = await api.teacher.students.getByClass(classId);
          if (studentsRes.ok) {
            const studentsData = await studentsRes.json();
            if (Array.isArray(studentsData)) {
              totalStudents = studentsData.length;
            }
          }
        } catch (err) {
          // ignore error
        }
      }
    } catch (err) {
      // ignore error, treat as not marked
    }

    // --- Attendance Action Card ---
    if (!attendanceMarked) {
      actionText.setAttribute("data", "teacher.attendance_not_marked_today");
      actionText.innerText = "You have not marked attendance today";
      actionBtnText.setAttribute("data", "teacher.mark_attendance");
      actionBtnText.innerText = "Mark Attendance";
    } else {
      actionText.setAttribute(
        "data",
        "teacher.attendance_already_marked_today"
      );
      actionText.innerText = "Attendance already marked today";
      actionBtnText.setAttribute("data", "teacher.editAttendanceBtn");
      actionBtnText.innerText = "Edit Attendance";
    }
    actionBtn.onclick = () => {
      window.location.href = "layout.html?role=teacher&page=attendance/mark";
    };
    if (typeof applyTranslations === "function") applyTranslations();

    // --- Load Weekly Attendance Data ---
    let weeklyData = { labels: [], present: [], absent: [] };
    try {
      const res = await api.teacher.attendance.getWeekly();
      if (res.ok) {
        weeklyData = await res.json();
      }
    } catch (err) {
      console.error('Error loading weekly attendance:', err);
    }

    // --- Load Monthly Attendance Data ---
    let monthlyData = { dates: [], present: [] };
    try {
      const res = await api.teacher.attendance.getMonthly();
      if (res.ok) {
        monthlyData = await res.json();
      }
    } catch (err) {
      console.error('Error loading monthly attendance:', err);
    }

    // --- Custom plugin to draw center text in doughnut ---
    const centerTextPlugin = {
      id: "centerText",
      beforeDraw(chart, args, options) {
        if (chart.config.type !== "doughnut") return;
        const { ctx, width, height } = chart;
        ctx.save();
        const fontSize = (height / 160).toFixed(2);
        ctx.font = `${fontSize}em sans-serif`;
        ctx.textBaseline = "middle";
        ctx.textAlign = "center";
        ctx.fillStyle = options.color || primaryColor;
        const text = options.text || "";
        ctx.fillText(
          text,
          width / 2,
          chart.getDatasetMeta(0).data[0]?.y || height / 2
        );
        ctx.restore();
      },
    };

    // --- Today's Attendance Doughnut Chart ---
    const currentLang = localStorage.getItem("lang") || "en";
    let chartData, chartText;
    if (!attendanceMarked) {
      chartData = {
        labels: [
          { en: "Present", si: "පැමිණි", ta: "வருகை" },
          { en: "Absent", si: "නොපැමිණි", ta: "இல்லை" },
        ],
        datasets: [
          {
            data: [0, totalStudents],
            backgroundColor: [primaryColor, primaryColor + "40"],
            borderRadius: 20,
          },
        ],
      };
      chartText =
        {
          en: "Not Marked",
          si: "සලකුණු කර නැත",
          ta: "குறிக்கப்படவில்லை",
        }[currentLang] || "Not Marked";
    } else {
      chartData = {
        labels: [
          { en: "Present", si: "පැමිණි", ta: "வருகை" },
          { en: "Absent", si: "නොපැමිණි", ta: "இல்லை" },
        ],
        datasets: [
          {
            data: [presentCount, absentCount],
            backgroundColor: [primaryColor, primaryColor + "40"],
            borderRadius: 20,
          },
        ],
      };
      chartText = `${presentCount}/${totalCount}`;
    }
    new Chart(document.getElementById("attendanceChart"), {
      type: "doughnut",
      data: chartData,
      options: {
        responsive: true,
        cutout: "85%",
        borderColor: "transparent",
        plugins: {
          legend: { position: "bottom" },
          title: {
            display: true,
            text:
              {
                en: "Today's Attendance",
                si: "අද දිනයේ පැමිණීම",
                ta: "இன்றைய வருகை",
              }[currentLang] || "Today's Attendance",
            font: { size: 20, weight: "bold" },
            position: "bottom",
          },
          centerText: {
            text: chartText,
            color: primaryColor,
          },
        },
      },
      plugins: [centerTextPlugin],
    });

    // Apply language to chart labels
    const chart = Chart.getChart("attendanceChart");
    if (chart) {
      chart.data.labels = chartData.labels.map((label) =>
        typeof label === "object" ? label[currentLang] || label.en : label
      );
      chart.update();
      chart.update();
    }

    // Hide today's loader
    if (hideTodayLoader) hideTodayLoader();

    // --- Weekly Attendance Bar Chart ---
    const weeklyChartData = {
      labels: [
        { en: "Mon", si: "සඳුදා", ta: "திங்" },
        { en: "Tue", si: "අඟහරුවාදා", ta: "செவ்" },
        { en: "Wed", si: "බදාදා", ta: "புத" },
        { en: "Thu", si: "බ්‍රහස්පතින්දා", ta: "வியா" },
        { en: "Fri", si: "සිකුරාදා", ta: "வெள்" },
      ],
      datasets: [
        {
          label:
            {
              en: "Present",
              si: "පැමිණි",
              ta: "வருகை",
            }[currentLang] || "Present",
          data: weeklyData.present || [],
          backgroundColor: primaryColor,
        },
        {
          label:
            {
              en: "Absent",
              si: "නොපැමිණි",
              ta: "இல்லை",
            }[currentLang] || "Absent",
          data: weeklyData.absent || [],
          backgroundColor: primaryColor + "40",
        },
      ],
    };
    new Chart(document.getElementById("weeklyChart"), {
      type: "bar",
      data: weeklyChartData,
      options: {
        responsive: true,
        plugins: {
          legend: { position: "top" },
          title: {
            display: true,
            text:
              {
                en: "Weekly Attendance",
                si: "සතිපතා පැමිණීම",
                ta: "வாராந்திர வருகை",
              }[currentLang] || "Weekly Attendance",
          },
        },
        scales: { y: { beginAtZero: true } },
      },
    });

    // Apply language to weekly chart labels
    const weeklyChart = Chart.getChart("weeklyChart");
    if (weeklyChart) {
      weeklyChart.data.labels = weeklyData.labels.map((label) =>
        typeof label === "object" ? label[currentLang] || label.en : label
      );
      weeklyChart.update();
    }

    // Hide weekly loader
    if (hideWeeklyLoader) hideWeeklyLoader();

    // --- Monthly Attendance Line Chart ---
    const monthlyLabels = (monthlyData.dates || []).map(dateStr => {
      const date = new Date(dateStr);
      return `${date.getMonth() + 1}/${date.getDate()}`;
    });
    const monthlyChartData = {
      labels: monthlyLabels,
      datasets: [
        {
          label:
            {
              en: "Present",
              si: "පැමිණි",
              ta: "வருகை",
            }[currentLang] || "Present",
          data: monthlyData.present || [],
          borderColor: primaryColor,
          backgroundColor: primaryColor + "33",
          tension: 0.4,
          fill: true,
        },
      ],
    };
    new Chart(document.getElementById("monthlyChart"), {
      type: "line",
      data: monthlyChartData,
      options: {
        responsive: true,
        plugins: {
          legend: { position: "top" },
          title: {
            display: true,
            text:
              {
                en: "Monthly Attendance",
                si: "මාසික පැමිණීම",
                ta: "மாதாந்திர வருகை",
              }[currentLang] || "Monthly Attendance",
          },
        },
        scales: { y: { beginAtZero: true } },
      },
    });

    // Hide monthly loader
    if (hideMonthlyLoader) hideMonthlyLoader();
  }

  // Load attendance on page load
  loadTodayAttendance();

  function deleteAttendance() {
    const currentLang = localStorage.getItem("lang") || "en";
    const confirmMessage =
      {
        en: "Are you sure you want to delete today's attendance?",
        si: "ඔබට අද දිනයේ පැමිණීම මකා දැමීමට අවශ්‍ය බව විශ්වාසද?",
        ta: "இன்றைய வருகையை நீக்க விரும்புகிறீர்களா?",
      }[currentLang] || "Are you sure you want to delete today's attendance?";

    const confirmText =
      {
        en: "Delete",
        si: "මකන්න",
        ta: "நீக்கு",
      }[currentLang] || "Delete";

    const cancelText =
      {
        en: "Cancel",
        si: "අවලංගු කරන්න",
        ta: "ரத்து செய்ய",
      }[currentLang] || "Cancel";

    toast(confirmMessage, "fa-solid fa-trash", {
      confirm: true,
      confirmText: confirmText,
      cancelText: cancelText,
      onConfirm: function () {
        const today = new Date();
        const yyyy = today.getFullYear();
        const mm = String(today.getMonth() + 1).padStart(2, "0");
        const dd = String(today.getDate()).padStart(2, "0");
        const dateStr = `${yyyy}-${mm}-${dd}`;

        api.teacher.attendance
          .delete(dateStr)
          .then((res) => {
            if (!res.ok) throw new Error("Failed to delete attendance");
            return res.json();
          })
          .then(() => {
            localStorage.removeItem("attendanceMarked");
            const successMessage =
              {
                en: "Today's attendance deleted.",
                si: "අද දිනයේ පැමිණීම මකා දමන ලදී.",
                ta: "இன்றைய வருகை நீக்கப்பட்டது.",
              }[currentLang] || "Today's attendance deleted.";
            toast(successMessage, "fa-solid fa-check-circle");
            setTimeout(function () {
              location.reload();
            }, 2000);
          })
          .catch((err) => {
            console.error(err);
            const errorMessage =
              {
                en: "Error deleting attendance. Please try again.",
                si: "පැමිණීම මකා දැමීමේ දෝෂයක්. කරුණාකර නැවත උත්සාහ කරන්න.",
                ta: "வருகையை நீக்குவதில் பிழை. மீண்டும் முயற்சிக்கவும்.",
              }[currentLang] || "Error deleting attendance. Please try again.";
            toast(errorMessage, "fa-solid fa-circle-exclamation");
          });
      },
      onCancel: function () {
        // Do nothing, just close toast
      },
    });
  }
</script>
<h2 class="heading">
  <i class="fas fa-user-check"></i>
  <span data="sidebar.attendance"></span>
</h2>

<div class="card-grid">
  <!-- Today's Attendance -->
  <div class="card w-1 h-2 dashboard-tile" id="attendanceSummary">
    <div class="icon-title">
      <i class="fas fa-clipboard-check icon"></i>
      <p class="tile-label" data="teacher.todayAttendance"></p>
    </div>
    <canvas id="attendanceChart" height="150"></canvas>
  </div>

  <!-- Mark/Edit Attendance Card -->
  <div class="card w-1 dashboard-tile" id="attendanceActionCard">
    <div class="icon-title">
      <i class="fas fa-user-check icon"></i>
      <p class="tile-label" data="teacher.attendanceAction"></p>
    </div>
    <div>
      <h3 class="tile-value" id="attendanceActionText"></h3>
      <button class="btn" id="attendanceActionBtn">
        <i class="fas fa-pen"></i>
        <span id="attendanceActionBtnText"></span>
      </button>
      <!-- delete attendance -->
      <button
        class="btn btn-danger"
        id="deleteAttendanceBtn"
        onclick="deleteAttendance()"
      >
        <i class="fas fa-trash"></i>
        <span data="teacher.deleteAttendanceBtn"></span>
      </button>
    </div>
  </div>

  <!-- Weekly Attendance -->
  <div class="card w-1 dashboard-tile">
    <div class="icon-title">
      <i class="fas fa-calendar-week icon"></i>
      <p class="tile-label" data="teacher.weeklyAttendance"></p>
    </div>
    <canvas id="weeklyChart" height="150"></canvas>
  </div>

  <!-- Monthly Attendance -->
  <div class="card w-2 h-1 dashboard-tile">
    <div class="icon-title">
      <i class="fas fa-calendar-alt icon"></i>
      <p class="tile-label" data="teacher.monthlyAttendance"></p>
    </div>
    <canvas id="monthlyChart" height="150"></canvas>
  </div>
</div>

<script>
  const rootStyles = getComputedStyle(document.documentElement);
  const primaryColor = rootStyles.getPropertyValue("--color-primary").trim();
  const secondaryColor = rootStyles.getPropertyValue("--color-border").trim();

  // Example student data
  const students = Array.from({ length: 44 }, (_, i) => ({
    id: i + 1,
    name: `Student ${i + 1}`,
    status: i % 4 === 0 ? "absent" : "present",
  }));

  const presentCount = students.filter((s) => s.status === "present").length;
  const absentCount = students.filter((s) => s.status === "absent").length;

  // Check if attendance already marked today
  let attendanceMarked = localStorage.getItem("attendanceMarked") === "true";

  // --- Attendance Action Card ---
  const actionText = document.getElementById("attendanceActionText");
  const actionBtn = document.getElementById("attendanceActionBtn");
  const actionBtnText = document.getElementById("attendanceActionBtnText");

  if (!attendanceMarked) {
    actionText.innerText = "You have not marked attendance today";
    actionBtnText.innerText = "Mark Attendance";
  } else {
    actionText.innerText = "Attendance already marked today";
    actionBtnText.innerText = "Edit Attendance";
  }

  actionBtn.onclick = () => {
    window.location.href = "layout.html?role=teacher&page=attendance/mark";
  };

  // --- Custom plugin to draw center text in doughnut ---
  const centerTextPlugin = {
    id: "centerText",
    beforeDraw(chart, args, options) {
      if (chart.config.type !== "doughnut") return;
      const { ctx, width, height } = chart;
      ctx.save();
      const fontSize = (height / 114).toFixed(2);
      ctx.font = `${fontSize}em sans-serif`;
      ctx.textBaseline = "middle";
      ctx.textAlign = "center";
      ctx.fillStyle = options.color || primaryColor;
      const text = options.text || "";
      ctx.fillText(text, width / 2, chart.getDatasetMeta(0).data[0].y);
      ctx.restore();
    },
  };

  // --- Today's Attendance Doughnut Chart ---
  new Chart(document.getElementById("attendanceChart"), {
    type: "doughnut",
    data: {
      labels: ["Present", "Absent"],
      datasets: [
        {
          data: [presentCount, absentCount],
          backgroundColor: [primaryColor, primaryColor + "40"],
          borderRadius: 20,
        },
      ],
    },
    options: {
      responsive: true,
      cutout: "85%",
      borderColor: "transparent",
      plugins: {
        legend: { position: "bottom" },
        title: {
          display: true,
          text: "Today's Attendance",
          font: { size: 20, weight: "bold" },
          position: "bottom",
        },

        centerText: {
          text: `${presentCount}/${presentCount + absentCount}`,
          color: primaryColor,
        },
      },
    },
    plugins: [centerTextPlugin],
  });

  // --- Weekly Attendance Bar Chart ---
  const weeklyData = {
    labels: ["Mon", "Tue", "Wed", "Thu", "Fri"],
    datasets: [
      {
        label: "Present",
        data: [40, 42, 38, 44, 41],
        backgroundColor: primaryColor,
      },
      {
        label: "Absent",
        data: [4, 2, 6, 0, 3],
        backgroundColor: primaryColor + "40",
      },
    ],
  };

  new Chart(document.getElementById("weeklyChart"), {
    type: "bar",
    data: weeklyData,
    options: {
      responsive: true,
      plugins: {
        legend: { position: "top" },
        title: { display: true, text: "Weekly Attendance" },
      },
      scales: { y: { beginAtZero: true } },
    },
  });

  // --- Monthly Attendance Line Chart ---
  const monthlyData = {
    labels: Array.from({ length: 30 }, (_, i) => `Sep ${i + 1}`),
    datasets: [
      {
        label: "Present",
        data: Array.from({ length: 30 }, () =>
          Math.floor(Math.random() * 20 + 25)
        ),
        borderColor: primaryColor,
        backgroundColor: primaryColor + "33",
        tension: 0.4,
        fill: true,
      },
    ],
  };

  new Chart(document.getElementById("monthlyChart"), {
    type: "line",
    data: monthlyData,
    options: {
      responsive: true,
      plugins: {
        legend: { position: "top" },
        title: { display: true, text: "Monthly Attendance" },
      },
      scales: { y: { beginAtZero: true } },
    },
  });

  function deleteAttendance() {
    if (confirm("Are you sure you want to delete today's attendance?")) {
      localStorage.removeItem("attendanceMarked");
      alert("Today's attendance deleted.");
      location.reload();
    }
  }
</script>

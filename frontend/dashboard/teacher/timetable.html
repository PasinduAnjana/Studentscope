<h2 class="heading">
  <i class="fas fa-calendar-day"></i>
  <span data="sidebar.timeTable"></span>
</h2>

<div class="timetable" id="timetable">
  <!-- Header row -->
  <div class="timetable-row header-row" id="timetable-header-row">
    <div
      class="timetable-cell header-cell"
      data-en="Time"
      data-si="වේලාව"
      data-ta="நேரம்"
    >
      Time
    </div>
    <div
      class="timetable-cell header-cell"
      data-en="Monday"
      data-si="සඳුදා"
      data-ta="திங்கட்கிழமை"
    >
      Monday
    </div>
    <div
      class="timetable-cell header-cell"
      data-en="Tuesday"
      data-si="අඟහරුවාදා"
      data-ta="செவ்வாய்க்கிழமை"
    >
      Tuesday
    </div>
    <div
      class="timetable-cell header-cell"
      data-en="Wednesday"
      data-si="බදාදා"
      data-ta="புதன்கிழமை"
    >
      Wednesday
    </div>
    <div
      class="timetable-cell header-cell"
      data-en="Thursday"
      data-si="බ්‍රහස්පතින්දා"
      data-ta="வியாழக்கிழமை"
    >
      Thursday
    </div>
    <div
      class="timetable-cell header-cell"
      data-en="Friday"
      data-si="සිකුරාදා"
      data-ta="வெள்ளிக்கிழமை"
    >
      Friday
    </div>
  </div>
</div>

<script>
  async function loadTimetable() {
    // Fetch time slots and teacher's weekly timetable from backend
    const [timeData, timetableData, todayTimetableData, teacherClassesData] =
      await Promise.all([
        fetch("../../data/time.json").then((res) => res.json()),
        fetch("/api/teacher/timetable/week").then((res) => res.json()),
        fetch("/api/teacher/timetable/today").then((res) => res.json()),
        fetch("/api/teacher/classes/teacher").then((res) => res.json()),
      ]);
    // You can now use todayTimetableData and teacherClassesData as needed

    // Build a lookup: { day_of_week: { slot: entry } }
    const timetableLookup = {};
    if (!Array.isArray(timetableData)) {
      const timetableContainer = document.getElementById("timetable");
      const errorDiv = document.createElement("div");
      errorDiv.className = "error";
      errorDiv.setAttribute(
        "data-en",
        "Unable to load timetable: " + (timetableData.error || "Unknown error")
      );
      errorDiv.setAttribute(
        "data-si",
        "කාලසටහන පූරණය කළ නොහැකි විය: " +
          (timetableData.error || "නොදන්නා දෝෂයක්")
      );
      errorDiv.setAttribute(
        "data-ta",
        "நேர அட்டவணையை ஏற்ற முடியவில்லை: " +
          (timetableData.error || "தெரியாத பிழை")
      );
      errorDiv.textContent =
        "Unable to load timetable: " + (timetableData.error || "Unknown error");
      timetableContainer.appendChild(errorDiv);
      // Apply current language
      if (typeof applyDirectLanguageAttributes === "function") {
        applyDirectLanguageAttributes(localStorage.getItem("lang") || "en");
      }
      return;
    }
    timetableData.forEach((entry) => {
      if (!timetableLookup[entry.day_of_week])
        timetableLookup[entry.day_of_week] = {};
      timetableLookup[entry.day_of_week][entry.period_number] = entry;
    });

    const timetableContainer = document.getElementById("timetable");
    timetableContainer.innerHTML = "";

    // Render header row dynamically to ensure it always appears
    const headerRow = document.createElement("div");
    headerRow.classList.add("timetable-row", "header-row");
    const headers = [
      { en: "Time", si: "වේලාව", ta: "நேரம்" },
      { en: "Monday", si: "සඳුදා", ta: "திங்கட்கிழமை" },
      { en: "Tuesday", si: "අඟහරුවාදා", ta: "செவ்வாய்க்கிழமை" },
      { en: "Wednesday", si: "බදාදා", ta: "புதன்கிழமை" },
      { en: "Thursday", si: "බ්‍රහස්පතින්දා", ta: "வியாழக்கிழமை" },
      { en: "Friday", si: "සිකුරාදා", ta: "வெள்ளிக்கிழமை" },
    ];
    const currentLang = localStorage.getItem("lang") || "en";
    headers.forEach((day) => {
      const cell = document.createElement("div");
      cell.classList.add("timetable-cell", "header-cell");
      cell.textContent =
        typeof day === "object" ? day[currentLang] || day.en : day;
      headerRow.appendChild(cell);
    });
    timetableContainer.appendChild(headerRow);

    timeData.forEach((slot, index) => {
      const row = document.createElement("div");
      row.classList.add("timetable-row");

      // Time cell
      const timeCell = document.createElement("div");
      timeCell.classList.add("timetable-cell", "time-cell");
      timeCell.textContent = `${slot.start}`;
      row.appendChild(timeCell);

      // Monday to Friday
      for (let day = 1; day <= 5; day++) {
        const cell = document.createElement("div");
        cell.classList.add("timetable-cell");

        // Use backend data if available
        const entry = timetableLookup[day] && timetableLookup[day][slot.slot];

        const card = document.createElement("div");
        card.classList.add("card", "slot-card");

        if (entry) {
          const subjectDiv = document.createElement("div");
          subjectDiv.classList.add("subject");
          subjectDiv.textContent = entry.subject;

          const classNameDiv = document.createElement("div");
          classNameDiv.classList.add("class-name");
          classNameDiv.textContent = `Grade ${entry.grade} ${entry.class_name}`;

          card.appendChild(subjectDiv);
          card.appendChild(classNameDiv);
        } else {
          // Empty slot placeholder
          const emptyDiv = document.createElement("div");
          emptyDiv.classList.add("empty-slot");
          emptyDiv.textContent = "-";
          card.appendChild(emptyDiv);
        }

        cell.appendChild(card);
        row.appendChild(cell);
      }

      timetableContainer.appendChild(row);

      // Insert Interval row after 4th period
      if (slot.slot === 4) {
        const breakRow = document.createElement("div");
        breakRow.classList.add("timetable-row", "interval-row");

        const breakCell = document.createElement("h3");
        breakCell.classList.add("timetable-cell", "interval-cell");
        breakCell.style.color = "var(--color-primary)";
        breakCell.setAttribute("data-en", "INTERVAL");
        breakCell.setAttribute("data-si", "විරාමය");
        breakCell.setAttribute("data-ta", "இடைவேளை");
        breakCell.textContent = "INTERVAL";
        breakCell.colSpan = 6; // Full width (time + 5 days)

        // Span across all columns
        breakCell.style.gridColumn = "1 / span 6";

        breakRow.appendChild(breakCell);
        timetableContainer.appendChild(breakRow);
        // Apply current language
        if (typeof applyDirectLanguageAttributes === "function") {
          applyDirectLanguageAttributes(localStorage.getItem("lang") || "en");
        }
      }
    });
  }

  loadTimetable();
</script>

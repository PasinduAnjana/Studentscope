<h2 class="heading">
  <i class="fas fa-calendar-day"></i>
  <span data="sidebar.timeTable"></span>
</h2>

<div class="timetable" id="timetable">
  <!-- Header row -->
  <div class="timetable-row header-row" id="timetable-header-row">
    <div class="timetable-cell header-cell">Time</div>
    <div class="timetable-cell header-cell">Monday</div>
    <div class="timetable-cell header-cell">Tuesday</div>
    <div class="timetable-cell header-cell">Wednesday</div>
    <div class="timetable-cell header-cell">Thursday</div>
    <div class="timetable-cell header-cell">Friday</div>
  </div>
</div>

<script>
  async function loadTimetable() {
    // Get teacherId from backend
    let teacherId = null;
    try {
      const userRes = await fetch("/api/auth/me");
      if (userRes.ok) {
        const userData = await userRes.json();
        teacherId = userData && userData.userId ? userData.userId : null;
      }
    } catch (err) {}
    if (!teacherId) {
      document.getElementById("timetable").innerHTML +=
        '<div class="error">Unable to load timetable: No teacher ID</div>';
      return;
    }

    // Fetch time slots and teacher's weekly timetable from backend
    const [timeData, timetableData] = await Promise.all([
      fetch("../../data/time.json").then((res) => res.json()),
      fetch(`/api/teacher/timetable/week/${teacherId}`).then((res) =>
        res.json()
      ),
    ]);

    // Build a lookup: { day_of_week: { slot: entry } }
    const timetableLookup = {};
    timetableData.forEach((entry) => {
      if (!timetableLookup[entry.day_of_week])
        timetableLookup[entry.day_of_week] = {};
      timetableLookup[entry.day_of_week][entry.period_number] = entry;
    });

    const timetableContainer = document.getElementById("timetable");
    timetableContainer.innerHTML = "";

    // Render header row dynamically to ensure it always appears
    const headerRow = document.createElement("div");
    headerRow.classList.add("timetable-row", "header-row");
    const headers = [
      "Time",
      "Monday",
      "Tuesday",
      "Wednesday",
      "Thursday",
      "Friday",
    ];
    headers.forEach((day) => {
      const cell = document.createElement("div");
      cell.classList.add("timetable-cell", "header-cell");
      cell.textContent = day;
      headerRow.appendChild(cell);
    });
    timetableContainer.appendChild(headerRow);

    timeData.forEach((slot, index) => {
      const row = document.createElement("div");
      row.classList.add("timetable-row");

      // Time cell
      const timeCell = document.createElement("div");
      timeCell.classList.add("timetable-cell", "time-cell");
      timeCell.textContent = `${slot.start}`;
      row.appendChild(timeCell);

      // Monday to Friday
      for (let day = 1; day <= 5; day++) {
        const cell = document.createElement("div");
        cell.classList.add("timetable-cell");

        // Use backend data if available
        const entry = timetableLookup[day] && timetableLookup[day][slot.slot];

        const card = document.createElement("div");
        card.classList.add("card", "slot-card");

        if (entry) {
          const subjectDiv = document.createElement("div");
          subjectDiv.classList.add("subject");
          subjectDiv.textContent = entry.subject;

          const classNameDiv = document.createElement("div");
          classNameDiv.classList.add("class-name");
          classNameDiv.textContent = `Grade ${entry.grade} ${entry.class_name}`;

          card.appendChild(subjectDiv);
          card.appendChild(classNameDiv);
        } else {
          // Empty slot placeholder
          const emptyDiv = document.createElement("div");
          emptyDiv.classList.add("empty-slot");
          emptyDiv.textContent = "-";
          card.appendChild(emptyDiv);
        }

        cell.appendChild(card);
        row.appendChild(cell);
      }

      timetableContainer.appendChild(row);

      // Insert Interval row after 4th period
      if (slot.slot === 4) {
        const breakRow = document.createElement("div");
        breakRow.classList.add("timetable-row", "interval-row");

        const breakCell = document.createElement("h3");
        breakCell.classList.add("timetable-cell", "interval-cell");
        breakCell.style.color = "var(--color-primary)";
        breakCell.textContent = "INTERVAL";
        breakCell.colSpan = 6; // Full width (time + 5 days)

        // Span across all columns
        breakCell.style.gridColumn = "1 / span 6";

        breakRow.appendChild(breakCell);
        timetableContainer.appendChild(breakRow);
      }
    });
  }

  loadTimetable();
</script>
